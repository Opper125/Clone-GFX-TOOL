<!DOCTYPE html>
<html lang="my">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>FPS GFX Tool - Admin</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Share+Tech+Mono&family=Noto+Sans+Myanmar:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
/* Custom Fonts */
body {
  font-family: 'Noto Sans Myanmar', 'Inter', sans-serif;
}
h1, h2, h3, .font-orbitron {
  font-family: 'Orbitron', sans-serif;
}
.font-share-tech {
  font-family: 'Share Tech Mono', monospace;
}

/* New Color Palette */
:root {
  --primary-bg: hsl(220 20% 8%); /* Deep Dark Blue-Grey */
  --secondary-bg: hsl(220 20% 12%); /* Slightly Lighter Dark Blue-Grey */
  --accent-purple: hsl(280 80% 60%); /* Vibrant Purple */
  --accent-green: hsl(160 80% 50%); /* Neon Green */
  --accent-red: hsl(0 80% 60%); /* Vibrant Red */
  --text-primary: hsl(220 20% 90%); /* Light Grey */
  --text-secondary: hsl(220 15% 60%); /* Medium Grey */
  --border-color: hsl(220 15% 20%); /* Dark Grey */
  --card-bg: rgba(20, 25, 35, 0.7); /* Dark Translucent */
  --input-bg: rgba(30, 35, 45, 0.6); /* Darker Translucent */
  --table-header-bg: rgba(var(--accent-purple-rgb), 0.15);
  --table-row-hover-bg: rgba(var(--accent-purple-rgb), 0.08);

  /* RGB values for easier use in rgba() */
  --accent-purple-rgb: 199, 56, 255; /* From hsl(280 80% 60%) */
  --accent-green-rgb: 0, 204, 136; /* From hsl(160 80% 50%) */
  --accent-red-rgb: 255, 51, 51; /* From hsl(0 80% 60%) */
}

body {
  background: linear-gradient(135deg, var(--primary-bg) 0%, var(--secondary-bg) 100%);
  min-height: 100vh;
  position: relative;
  overflow-x: hidden;
  color: var(--text-primary);
}

.myanmar-pattern {
  background-image: 
    radial-gradient(circle at 25% 25%, rgba(var(--accent-purple-rgb), 0.15) 0%, transparent 50%),
    radial-gradient(circle at 75% 75%, rgba(var(--accent-green-rgb), 0.15) 0%, transparent 50%),
    radial-gradient(circle at 50% 50%, rgba(var(--accent-red-rgb), 0.1) 0%, transparent 50%);
  animation: patternMove 25s ease-in-out infinite;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: -2;
}

@keyframes patternMove {
  0%, 100% { background-position: 0% 0%, 100% 100%, 50% 50%; }
  33% { background-position: 100% 100%, 0% 0%, 75% 25%; }
  66% { background-position: 50% 50%, 75% 25%, 25% 75%; }
}

.myanmar-waves {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  height: 80px;
  background: linear-gradient(45deg, 
    rgba(var(--accent-purple-rgb), 0.2), 
    rgba(var(--accent-green-rgb), 0.2), 
    rgba(var(--accent-red-rgb), 0.2));
  clip-path: polygon(0 100%, 0 60%, 25% 40%, 50% 60%, 75% 30%, 100% 50%, 100% 100%);
  animation: waveFloat 12s ease-in-out infinite;
  z-index: -1;
}

@keyframes waveFloat {
  0%, 100% { transform: translateY(0px) scaleY(1); }
  50% { transform: translateY(-10px) scaleY(1.1); }
}

.app-card {
  backdrop-filter: blur(20px);
  background: var(--card-bg);
  border: 1px solid var(--border-color);
  box-shadow: 
    0 20px 40px -12px rgba(0, 0, 0, 0.8),
    0 0 0 1px rgba(var(--accent-purple-rgb), 0.1),
    inset 0 1px 0 rgba(255, 255, 255, 0.05);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  border-radius: 16px;
}

.app-card:hover {
  transform: translateY(-2px);
  box-shadow: 
    0 25px 50px -12px rgba(var(--accent-purple-rgb), 0.25),
    0 0 0 1px rgba(var(--accent-purple-rgb), 0.2),
    inset 0 1px 0 rgba(255, 255, 255, 0.1);
  border-color: rgba(var(--accent-purple-rgb), 0.5);
}

.myanmar-btn {
  background: linear-gradient(135deg, var(--accent-purple), var(--accent-green));
  color: #000;
  font-weight: 700;
  position: relative;
  overflow: hidden;
  transition: all 0.3s ease;
  text-shadow: 0 1px 2px rgba(0,0,0,0.1);
  border: none;
  border-radius: 12px;
  padding: 12px 20px;
  cursor: pointer;
  box-shadow: 0 5px 15px rgba(var(--accent-purple-rgb), 0.2);
}

.myanmar-btn::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
  transition: left 0.6s ease;
}

.myanmar-btn:hover::before {
  left: 100%;
}

.myanmar-btn:hover {
  background: linear-gradient(135deg, var(--accent-green), var(--accent-purple));
  transform: translateY(-1px);
  box-shadow: 0 10px 25px rgba(var(--accent-green-rgb), 0.4);
}

.btn-danger {
  background: linear-gradient(135deg, var(--accent-red), #FF6B6B);
  color: white;
  box-shadow: 0 5px 15px rgba(var(--accent-red-rgb), 0.2);
}

.btn-danger:hover {
  background: linear-gradient(135deg, #FF6B6B, var(--accent-red));
  box-shadow: 0 10px 25px rgba(var(--accent-red-rgb), 0.4);
}

.connection-status {
  position: fixed;
  top: 15px;
  right: 15px;
  z-index: 1000;
  padding: 8px 16px;
  border-radius: 20px;
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  backdrop-filter: blur(10px);
  animation: statusPulse 2s infinite;
  color: var(--text-primary);
}

.status-online {
  background: linear-gradient(135deg, var(--accent-green), #4ADE80);
  color: white;
  box-shadow: 0 0 20px rgba(var(--accent-green-rgb), 0.5);
}

.status-offline {
  background: linear-gradient(135deg, var(--accent-red), #EF4444);
  color: white;
  animation: statusShake 0.5s ease-in-out;
}

.status-connecting {
  background: linear-gradient(135deg, var(--accent-purple), #FCD34D);
  color: #000;
  animation: statusSpin 1s linear infinite;
}

@keyframes statusPulse {
  0%, 100% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.8; transform: scale(1.05); }
}

@keyframes statusShake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-3px); }
  75% { transform: translateX(3px); }
}

@keyframes statusSpin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

.stats-card {
  background: rgba(255, 255, 255, 0.05);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.1);
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
  border-radius: 12px;
}

.stats-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(90deg, var(--accent-purple), var(--accent-green), var(--accent-red));
  opacity: 0;
  transition: opacity 0.3s ease;
}

.stats-card:hover::before {
  opacity: 1;
}

.stats-card:hover {
  transform: translateY(-3px) scale(1.02);
  box-shadow: 0 15px 35px rgba(var(--accent-purple-rgb), 0.2);
  border-color: rgba(var(--accent-purple-rgb), 0.3);
}

.app-input {
  background: var(--input-bg);
  border: 2px solid var(--border-color);
  backdrop-filter: blur(10px);
  color: var(--text-primary);
  transition: all 0.3s ease;
  border-radius: 12px;
  padding: 12px 16px;
}

.app-input:focus {
  border-color: var(--accent-purple);
  background: rgba(30, 35, 45, 0.8);
  outline: none;
  box-shadow: 0 0 25px rgba(var(--accent-purple-rgb), 0.3);
}

.app-input::placeholder {
  color: var(--text-secondary);
}

.app-table {
  backdrop-filter: blur(10px);
  background: rgba(255, 255, 255, 0.03);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 12px;
  overflow: hidden;
}

.app-table th {
  background: var(--table-header-bg);
  color: var(--accent-purple);
  font-weight: 700;
  text-transform: uppercase;
  font-size: 12px;
  letter-spacing: 0.5px;
  padding: 12px 8px;
}

.app-table td {
  padding: 12px 8px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.05);
  color: var(--text-primary);
}

.app-table tr:hover {
  background: var(--table-row-hover-bg);
}

.loading-spinner {
  border: 3px solid rgba(var(--accent-purple-rgb), 0.3);
  border-top: 3px solid var(--accent-purple);
  border-radius: 50%;
  width: 24px;
  height: 24px;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.notification {
  position: fixed;
  top: 15px;
  right: 15px;
  left: 15px;
  max-width: 400px;
  margin: 0 auto;
  padding: 12px 16px;
  border-radius: 10px;
  color: white;
  font-weight: 600;
  z-index: 1001;
  animation: slideInRight 0.4s ease-out;
  backdrop-filter: blur(15px);
  box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}

@keyframes slideInRight {
  from { transform: translateX(100%); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

.nav-btn {
  transition: all 0.3s ease;
  position: relative;
  border-radius: 8px;
  padding: 8px 12px;
  font-size: 14px;
  color: var(--text-secondary);
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.nav-btn.active {
  background: linear-gradient(135deg, var(--accent-purple), var(--accent-green)) !important;
  color: #000 !important;
  box-shadow: 0 5px 15px rgba(var(--accent-purple-rgb), 0.4);
  border-color: var(--accent-purple) !important;
}

.nav-btn:not(.active):hover {
  background: rgba(var(--accent-purple-rgb), 0.1);
  color: var(--accent-purple);
  border-color: rgba(var(--accent-purple-rgb), 0.3);
}

.fade-in {
  animation: fadeInUp 0.6s ease-out forwards;
}

@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

.status-active { color: var(--accent-green); }
.status-inactive { color: var(--accent-red); }
.status-banned { color: var(--accent-red); }

.news-card {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 12px;
  transition: all 0.3s ease;
  margin-bottom: 16px;
}

.news-card:hover {
  border-color: rgba(var(--accent-purple-rgb), 0.3);
  transform: translateY(-2px);
}

.modal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.8);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 2000;
  padding: 20px;
}

.modal-content {
  background: var(--card-bg);
  border: 1px solid var(--border-color);
  border-radius: 16px;
  padding: 24px;
  max-width: 90vw;
  max-height: 90vh;
  overflow-y: auto;
  backdrop-filter: blur(20px);
  box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}

/* Mobile optimizations */
@media (max-width: 768px) {
  .container { padding: 8px; }
  .app-card { padding: 16px; margin: 8px; }
  .connection-status { top: 10px; right: 10px; font-size: 9px; padding: 6px 12px; }
  .notification { top: 50px; right: 10px; left: 10px; max-width: none; }
  .stats-card { margin-bottom: 12px; }
  .myanmar-btn { padding: 10px 16px; font-size: 14px; }
  .app-table { font-size: 12px; }
  .app-table th, .app-table td { padding: 8px 4px; }
  h1 { font-size: 20px; }
  h2 { font-size: 18px; }
  h3 { font-size: 16px; }
  .nav-btn { padding: 6px 10px; font-size: 12px; margin: 2px; }
  .modal-content { padding: 16px; max-width: 95vw; }
}

@media (max-width: 480px) {
  .myanmar-pattern { opacity: 0.7; }
  .myanmar-waves { height: 60px; }
  .app-card { padding: 12px; margin: 4px; }
  .grid { gap: 8px; }
  .stats-card { padding: 12px; }
  .app-table th, .app-table td { padding: 6px 2px; font-size: 11px; }
}

/* Scrollbar styling */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: rgba(255,255,255,0.1); }
::-webkit-scrollbar-thumb { background: var(--accent-purple); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--accent-green); }

/* Loading overlay */
.loading-overlay {
  backdrop-filter: blur(8px);
  background: rgba(0,0,0,0.7);
}

.btn-small {
  padding: 6px 12px;
  font-size: 12px;
  border-radius: 8px;
}

.table-actions {
  display: flex;
  gap: 4px;
  flex-wrap: wrap;
}

.hidden { display: none !important; }

/* Search input specific styles */
.search-input-container {
  position: relative;
}
.search-input-container .app-input {
  padding-left: 40px; /* Space for icon */
}
.search-input-container .search-icon {
  position: absolute;
  left: 12px;
  top: 50%;
  transform: translateY(-50%);
  color: var(--text-secondary);
  pointer-events: none;
}
</style>
</head>
<body class="text-white">
<div class="myanmar-pattern"></div>
<div class="myanmar-waves"></div>

<!-- Connection Status -->
<div id="connection-status" class="connection-status status-connecting">
<i class="fas fa-wifi"></i> ချိတ်ဆက်နေသည်...
</div>

<!-- Main Container -->
<div class="container mx-auto px-2 py-4 max-w-6xl">
<!-- Header -->
<div class="text-center mb-6 fade-in">
  <h1 class="text-2xl md:text-3xl lg:text-4xl font-orbitron font-bold mb-2 text-accent-purple">
    <i class="fas fa-shield-alt mr-2"></i>
    FPS GFX Tool
  </h1>
  <h2 class="text-lg md:text-xl lg:text-2xl font-orbitron font-semibold text-accent-green mb-2">
    ADMIN PANEL
  </h2>
  <div class="inline-block px-4 py-2 bg-gradient-to-r from-accent-purple to-accent-green text-black rounded-full font-bold text-sm">
    <i class="fas fa-user-shield mr-1"></i> ADMINISTRATOR
  </div>
</div>

<!-- Notification Container -->
<div id="notification-container"></div>

<!-- Login Section -->
<div id="login-section" class="max-w-md mx-auto fade-in">
  <div class="app-card p-6">
    <h3 class="text-xl md:text-2xl font-orbitron font-bold text-center mb-6 text-accent-purple">
      <i class="fas fa-sign-in-alt mr-2"></i>
      ADMIN LOGIN
    </h3>
    <div class="space-y-4">
      <div class="relative search-input-container">
        <input 
          type="text" 
          id="admin-key-input" 
          placeholder="Admin Key" 
          class="app-input w-full"
        >
        <i class="fas fa-key search-icon"></i>
      </div>
      <button 
        onclick="adminLogin()" 
        id="admin-login-btn"
        class="myanmar-btn w-full flex items-center justify-center space-x-2"
      >
        <i class="fas fa-sign-in-alt"></i>
        <span id="admin-login-text">LOGIN</span>
      </button>
    </div>
  </div>
</div>

<!-- Main Admin Content -->
<div id="admin-content" class="hidden">
  <!-- Navigation -->
  <div class="flex flex-wrap justify-center gap-2 md:gap-4 mb-6">
    <button onclick="showSection('dashboard', this)" class="nav-btn active">
      <i class="fas fa-tachometer-alt mr-1"></i>
      <span class="hidden sm:inline">DASHBOARD</span>
      <span class="sm:hidden">Dash</span>
    </button>
    <button onclick="showSection('keys', this)" class="nav-btn">
      <i class="fas fa-key mr-1"></i>
      <span class="hidden sm:inline">KEYS</span>
      <span class="sm:hidden">Keys</span>
    </button>
    <button onclick="showSection('users', this)" class="nav-btn">
      <i class="fas fa-users mr-1"></i>
      <span class="hidden sm:inline">USERS</span>
      <span class="sm:hidden">Users</span>
    </button>
    <button onclick="showSection('news', this)" class="nav-btn">
      <i class="fas fa-newspaper mr-1"></i>
      <span class="hidden sm:inline">NEWS</span>
      <span class="sm:hidden">News</span>
    </button>
    <button onclick="showSection('products', this)" class="nav-btn">
      <i class="fas fa-box-open mr-1"></i>
      <span class="hidden sm:inline">PRODUCTS</span>
      <span class="sm:hidden">Prod</span>
    </button>
    <button onclick="showSection('orders', this)" class="nav-btn">
      <i class="fas fa-receipt mr-1"></i>
      <span class="hidden sm:inline">ORDERS</span>
      <span class="sm:hidden">Orders</span>
    </button>
    <button onclick="showSection('user-products', this)" class="nav-btn">
      <i class="fas fa-store mr-1"></i>
      <span class="hidden sm:inline">USER PRODUCTS</span>
      <span class="sm:hidden">U-Prod</span>
    </button>
    <button onclick="showSection('user-orders', this)" class="nav-btn">
      <i class="fas fa-shopping-bag mr-1"></i>
      <span class="hidden sm:inline">USER ORDERS</span>
      <span class="sm:hidden">U-Orders</span>
    </button>
    <button onclick="showSection('payment-methods', this)" class="nav-btn">
      <i class="fas fa-wallet mr-1"></i>
      <span class="hidden sm:inline">PAYMENT METHODS</span>
      <span class="sm:hidden">Payments</span>
    </button>
    <button onclick="showSection('chat', this)" class="nav-btn">
      <i class="fas fa-comments mr-1"></i>
      <span class="hidden sm:inline">CHAT</span>
      <span class="sm:hidden">Chat</span>
    </button>
    <button onclick="showSection('support', this)" class="nav-btn">
      <i class="fas fa-headset mr-1"></i>
      <span class="hidden sm:inline">SUPPORT</span>
      <span class="sm:hidden">Support</span>
    </button>
    <button onclick="showSection('about', this)" class="nav-btn">
      <i class="fas fa-info-circle mr-1"></i>
      <span class="hidden sm:inline">ABOUT</span>
      <span class="sm:hidden">About</span>
    </button>
    <button onclick="adminLogout()" class="nav-btn btn-danger">
      <i class="fas fa-sign-out-alt mr-1"></i>
      <span class="hidden sm:inline">LOGOUT</span>
      <span class="sm:hidden">Logout</span>
    </button>
  </div>

  <!-- Dashboard Section -->
  <div id="dashboard-section" class="admin-section">
    <div class="app-card p-4 md:p-8 text-center">
      <h3 class="text-lg md:text-xl font-orbitron font-bold mb-4 text-accent-purple">
        <i class="fas fa-tachometer-alt mr-2"></i>
        ADMIN DASHBOARD OVERVIEW
      </h3>
      <p class="text-text-secondary">
        Welcome, <span id="admin-name" class="font-semibold text-accent-green">Admin</span>!
      </p>
      <div class="mt-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        <div class="stats-card p-4">
          <i class="fas fa-key text-2xl text-blue-400 mb-2"></i>
          <h4 class="text-sm font-semibold text-text-secondary">TOTAL KEYS</h4>
          <p id="total-keys" class="text-lg font-bold text-accent-purple">0</p>
        </div>
        <div class="stats-card p-4">
          <i class="fas fa-users text-2xl text-purple-400 mb-2"></i>
          <h4 class="text-sm font-semibold text-text-secondary">TOTAL PROFILES</h4>
          <p id="total-profiles" class="text-lg font-bold text-accent-green">0</p>
        </div>
        <div class="stats-card p-4">
          <i class="fas fa-newspaper text-2xl text-yellow-400 mb-2"></i>
          <h4 class="text-sm font-semibold text-text-secondary">TOTAL NEWS POSTS</h4>
          <p id="total-news" class="text-lg font-bold text-accent-purple">0</p>
        </div>
        <div class="stats-card p-4">
          <i class="fas fa-box-open text-2xl text-orange-400 mb-2"></i>
          <h4 class="text-sm font-semibold text-text-secondary">TOTAL ADMIN PRODUCTS</h4>
          <p id="total-products" class="text-lg font-bold text-accent-green">0</p>
        </div>
        <div class="stats-card p-4">
          <i class="fas fa-store text-2xl text-red-400 mb-2"></i>
          <h4 class="text-sm font-semibold text-text-secondary">TOTAL USER PRODUCTS</h4>
          <p id="total-user-products" class="text-lg font-bold text-accent-purple">0</p>
        </div>
        <div class="stats-card p-4">
          <i class="fas fa-receipt text-2xl text-teal-400 mb-2"></i>
          <h4 class="text-sm font-semibold text-text-secondary">TOTAL ORDERS (Admin Products)</h4>
          <p id="total-orders" class="text-lg font-bold text-accent-green">0</p>
        </div>
        <div class="stats-card p-4">
          <i class="fas fa-shopping-bag text-2xl text-pink-400 mb-2"></i>
          <h4 class="text-sm font-semibold text-text-secondary">TOTAL ORDERS (User Products)</h4>
          <p id="total-user-orders" class="text-lg font-bold text-accent-purple">0</p>
        </div>
        <div class="stats-card p-4">
          <i class="fas fa-comments text-2xl text-cyan-400 mb-2"></i>
          <h4 class="text-sm font-semibold text-text-secondary">TOTAL CHAT MESSAGES</h4>
          <p id="total-chat-messages" class="text-lg font-bold text-accent-green">0</p>
        </div>
        <div class="stats-card p-4">
          <i class="fas fa-headset text-2xl text-lime-400 mb-2"></i>
          <h4 class="text-sm font-semibold text-text-secondary">TOTAL SUPPORT TICKETS</h4>
          <p id="total-support-tickets" class="text-lg font-bold text-accent-purple">0</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Keys Section -->
  <div id="keys-section" class="admin-section hidden">
    <div class="app-card p-4 md:p-8">
      <h3 class="text-lg md:text-xl font-orbitron font-bold mb-6 text-accent-purple flex items-center">
        <i class="fas fa-key mr-3"></i>
        MANAGE KEYS
      </h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6 mb-6">
        <div>
          <label class="block text-sm font-medium mb-2 text-text-secondary">KEY TEXT</label>
          <input type="text" id="new-key-text" placeholder="Unique Key Text" class="app-input w-full">
        </div>
        <div>
          <label class="block text-sm font-medium mb-2 text-text-secondary">EXPIRY DATE</label>
          <input type="date" id="new-key-expiry" class="app-input w-full">
        </div>
        <div>
          <label class="block text-sm font-medium mb-2 text-text-secondary">IS ACTIVE?</label>
          <select id="new-key-is-active" class="app-input w-full">
            <option value="true">Yes</option>
            <option value="false">No</option>
          </select>
        </div>
        <div class="flex items-end">
          <button onclick="addKey()" class="myanmar-btn w-full flex items-center justify-center space-x-2">
            <i class="fas fa-plus"></i>
            <span>ADD NEW KEY</span>
          </button>
        </div>
      </div>

      <h4 class="text-md font-orbitron font-bold mb-4 text-accent-green flex items-center">
        <i class="fas fa-list-alt mr-2"></i>
        EXISTING KEYS
      </h4>
      <div class="relative search-input-container mb-4">
        <input type="text" id="search-keys" placeholder="Search Keys..." class="app-input w-full" onkeyup="filterTable('keys-table-body', this.value)">
        <i class="fas fa-search search-icon"></i>
      </div>
      <div class="overflow-x-auto">
        <table class="app-table w-full">
          <thead>
            <tr>
              <th class="text-left">KEY</th>
              <th class="text-left">EXPIRY</th>
              <th class="text-left">STATUS</th>
              <th class="text-left">ACTIONS</th>
            </tr>
          </thead>
          <tbody id="keys-table-body">
            <tr>
              <td colspan="4" class="text-center text-text-secondary py-8">
                <div class="loading-spinner mx-auto mb-2"></div>
                Loading keys...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Users Section -->
  <div id="users-section" class="admin-section hidden">
    <div class="app-card p-4 md:p-8">
      <h3 class="text-lg md:text-xl font-orbitron font-bold mb-6 text-accent-purple flex items-center">
        <i class="fas fa-users mr-3"></i>
        MANAGE USERS
      </h3>
      <h4 class="text-md font-orbitron font-bold mb-4 text-accent-green flex items-center">
        <i class="fas fa-list-alt mr-2"></i>
        ALL USER PROFILES
      </h4>
      <div class="relative search-input-container mb-4">
        <input type="text" id="search-users" placeholder="Search Users..." class="app-input w-full" onkeyup="filterTable('users-table-body', this.value)">
        <i class="fas fa-search search-icon"></i>
      </div>
      <div class="overflow-x-auto">
        <table class="app-table w-full">
          <thead>
            <tr>
              <th class="text-left">USERNAME</th>
              <th class="text-left">NAME</th>
              <th class="text-left">KEY</th>
              <th class="text-left">STATUS</th>
              <th class="text-left">ACTIONS</th>
            </tr>
          </thead>
          <tbody id="users-table-body">
            <tr>
              <td colspan="5" class="text-center text-text-secondary py-8">
                <div class="loading-spinner mx-auto mb-2"></div>
                Loading users...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- News Section -->
  <div id="news-section" class="admin-section hidden">
    <div class="app-card p-4 md:p-8">
      <h3 class="text-lg md:text-xl font-orbitron font-bold mb-6 text-accent-purple flex items-center">
        <i class="fas fa-newspaper mr-3"></i>
        MANAGE NEWS
      </h3>
      <h4 class="text-md font-orbitron font-bold mb-4 text-accent-green flex items-center">
        <i class="fas fa-plus-circle mr-2"></i>
        CREATE NEW NEWS POST
      </h4>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6 mb-6">
        <div>
          <label class="block text-sm font-medium mb-2 text-text-secondary">NEWS TITLE</label>
          <input type="text" id="news-title" placeholder="News Title" class="app-input w-full">
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm font-medium mb-2 text-text-secondary">NEWS CONTENT</label>
          <textarea id="news-content" placeholder="News Content..." rows="4" class="app-input w-full resize-none"></textarea>
        </div>
        <div>
          <label class="block text-sm font-medium mb-2 text-text-secondary">MEDIA (IMAGE/VIDEO) OPTIONAL</label>
          <input type="file" id="news-media" accept="image/*,video/*,audio/*" multiple class="app-input w-full">
        </div>
        <div>
          <label class="block text-sm font-medium mb-2 text-text-secondary">YOUTUBE LINK (OPTIONAL)</label>
          <input type="url" id="news-youtube" placeholder="https://youtube.com/..." class="app-input w-full">
        </div>
        <div>
          <label class="block text-sm font-medium mb-2 text-text-secondary">TIKTOK LINK (OPTIONAL)</label>
          <input type="url" id="news-tiktok" placeholder="https://tiktok.com/@..." class="app-input w-full">
        </div>
        <div>
          <label class="block text-sm font-medium mb-2 text-text-secondary">TELEGRAM LINK (OPTIONAL)</label>
          <input type="url" id="news-telegram" placeholder="https://t.me/..." class="app-input w-full">
        </div>
        <div>
          <label class="block text-sm font-medium mb-2 text-text-secondary">FACEBOOK LINK (OPTIONAL)</label>
          <input type="url" id="news-facebook" placeholder="https://facebook.com/..." class="app-input w-full">
        </div>
        <div class="flex items-end">
          <button onclick="postNews()" class="myanmar-btn w-full flex items-center justify-center space-x-2">
            <i class="fas fa-paper-plane"></i>
            <span>POST NEWS</span>
          </button>
        </div>
      </div>

      <h4 class="text-md font-orbitron font-bold mb-4 mt-8 text-accent-green flex items-center">
        <i class="fas fa-list-alt mr-2"></i>
        ALL NEWS POSTS
      </h4>
      <div class="relative search-input-container mb-4">
        <input type="text" id="search-news" placeholder="Search News..." class="app-input w-full" onkeyup="filterTable('news-table-body', this.value)">
        <i class="fas fa-search search-icon"></i>
      </div>
      <div class="overflow-x-auto">
        <table class="app-table w-full">
          <thead>
            <tr>
              <th class="text-left">TITLE</th>
              <th class="text-left">AUTHOR</th>
              <th class="text-left">VIEWS</th>
              <th class="text-left">LIKES</th>
              <th class="text-left">DATE</th>
              <th class="text-left">ACTIONS</th>
            </tr>
          </thead>
          <tbody id="news-table-body">
            <tr>
              <td colspan="6" class="text-center text-text-secondary py-8">
                <div class="loading-spinner mx-auto mb-2"></div>
                Loading news...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Products Section -->
  <div id="products-section" class="admin-section hidden">
    <div class="app-card p-4 md:p-8">
      <h3 class="text-lg md:text-xl font-orbitron font-bold mb-6 text-accent-purple flex items-center">
        <i class="fas fa-box-open mr-3"></i>
        MANAGE PRODUCTS & APKS
      </h3>
      <h4 class="text-md font-orbitron font-bold mb-4 text-accent-green flex items-center">
        <i class="fas fa-plus-circle mr-2"></i>
        UPLOAD NEW PRODUCT
      </h4>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6 mb-6">
        <div>
          <label class="block text-sm font-medium mb-2 text-text-secondary">PRODUCT NAME</label>
          <input type="text" id="product-name" placeholder="Product Name" class="app-input w-full">
        </div>
        <div>
          <label class="block text-sm font-medium mb-2 text-text-secondary">PRODUCT PRICE (MMK)</label>
          <input type="number" id="product-price" placeholder="0.00" min="0" step="0.01" class="app-input w-full">
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm font-medium mb-2 text-text-secondary">DESCRIPTION</label>
          <textarea id="product-description" placeholder="Product Description..." rows="3" class="app-input w-full resize-none"></textarea>
        </div>
        <div>
          <label class="block text-sm font-medium mb-2 text-text-secondary">APK FILE</label>
          <input type="file" id="product-apk-file" accept=".apk" class="app-input w-full">
        </div>
        <div>
          <label class="block text-sm font-medium mb-2 text-text-secondary">APK ICON (IMAGE)</label>
          <input type="file" id="product-apk-icon" accept="image/*" class="app-input w-full">
        </div>
        <div class="md:col-span-2">
          <button onclick="uploadProduct()" class="myanmar-btn w-full flex items-center justify-center space-x-2">
            <i class="fas fa-upload"></i>
            <span>UPLOAD PRODUCT</span>
          </button>
        </div>
      </div>

      <h4 class="text-md font-orbitron font-bold mb-4 mt-8 text-accent-green flex items-center">
        <i class="fas fa-list-alt mr-2"></i>
        ALL LISTED PRODUCTS
      </h4>
      <div class="relative search-input-container mb-4">
        <input type="text" id="search-products" placeholder="Search Products..." class="app-input w-full" onkeyup="filterTable('products-table-body', this.value)">
        <i class="fas fa-search search-icon"></i>
      </div>
      <div class="overflow-x-auto">
        <table class="app-table w-full">
          <thead>
            <tr>
              <th class="text-left">ICON</th>
              <th class="text-left">NAME</th>
              <th class="text-left">PRICE</th>
              <th class="text-left">STATUS</th>
              <th class="text-left">ACTIONS</th>
            </tr>
          </thead>
          <tbody id="products-table-body">
            <tr>
              <td colspan="5" class="text-center text-text-secondary py-8">
                <div class="loading-spinner mx-auto mb-2"></div>
                Loading products...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Orders Section (Admin Products) -->
  <div id="orders-section" class="admin-section hidden">
    <div class="app-card p-4 md:p-8">
      <h3 class="text-lg md:text-xl font-orbitron font-bold mb-6 text-accent-purple flex items-center">
        <i class="fas fa-receipt mr-3"></i>
        MANAGE ADMIN PRODUCT ORDERS
      </h3>
      <h4 class="text-md font-orbitron font-bold mb-4 text-accent-green flex items-center">
        <i class="fas fa-list-alt mr-2"></i>
        ALL ORDERS
      </h4>
      <div class="relative search-input-container mb-4">
        <input type="text" id="search-orders" placeholder="Search Orders..." class="app-input w-full" onkeyup="filterTable('orders-table-body', this.value)">
        <i class="fas fa-search search-icon"></i>
      </div>
      <div class="overflow-x-auto">
        <table class="app-table w-full">
          <thead>
            <tr>
              <th class="text-left">BUYER</th>
              <th class="text-left">PRODUCT</th>
              <th class="text-left">AMOUNT</th>
              <th class="text-left">RECEIPT</th>
              <th class="text-left">STATUS</th>
              <th class="text-left">ACTIONS</th>
            </tr>
          </thead>
          <tbody id="orders-table-body">
            <tr>
              <td colspan="6" class="text-center text-text-secondary py-8">
                <div class="loading-spinner mx-auto mb-2"></div>
                Loading orders...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- User Products Section -->
  <div id="user-products-section" class="admin-section hidden">
    <div class="app-card p-4 md:p-8">
      <h3 class="text-lg md:text-xl font-orbitron font-bold mb-6 text-accent-purple flex items-center">
        <i class="fas fa-store mr-3"></i>
        MANAGE USER PRODUCTS
      </h3>
      <h4 class="text-md font-orbitron font-bold mb-4 text-accent-green flex items-center">
        <i class="fas fa-list-alt mr-2"></i>
        ALL USER LISTED PRODUCTS
      </h4>
      <div class="relative search-input-container mb-4">
        <input type="text" id="search-user-products" placeholder="Search User Products..." class="app-input w-full" onkeyup="filterTable('user-products-table-body', this.value)">
        <i class="fas fa-search search-icon"></i>
      </div>
      <div class="overflow-x-auto">
        <table class="app-table w-full">
          <thead>
            <tr>
              <th class="text-left">IMAGE</th>
              <th class="text-left">NAME</th>
              <th class="text-left">SELLER</th>
              <th class="text-left">PRICE</th>
              <th class="text-left">STATUS</th>
              <th class="text-left">ACTIONS</th>
            </tr>
          </thead>
          <tbody id="user-products-table-body">
            <tr>
              <td colspan="6" class="text-center text-text-secondary py-8">
                <div class="loading-spinner mx-auto mb-2"></div>
                Loading user products...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- User Orders Section -->
  <div id="user-orders-section" class="admin-section hidden">
    <div class="app-card p-4 md:p-8">
      <h3 class="text-lg md:text-xl font-orbitron font-bold mb-6 text-accent-purple flex items-center">
        <i class="fas fa-shopping-bag mr-3"></i>
        MANAGE USER PRODUCT ORDERS
      </h3>
      <h4 class="text-md font-orbitron font-bold mb-4 text-accent-green flex items-center">
        <i class="fas fa-list-alt mr-2"></i>
        ALL USER ORDERS
      </h4>
      <div class="relative search-input-container mb-4">
        <input type="text" id="search-user-orders" placeholder="Search User Orders..." class="app-input w-full" onkeyup="filterTable('user-orders-table-body', this.value)">
        <i class="fas fa-search search-icon"></i>
      </div>
      <div class="overflow-x-auto">
        <table class="app-table w-full">
          <thead>
            <tr>
              <th class="text-left">PRODUCT</th>
              <th class="text-left">BUYER</th>
              <th class="text-left">SELLER</th>
              <th class="text-left">AMOUNT</th>
              <th class="text-left">RECEIPT</th>
              <th class="text-left">STATUS</th>
              <th class="text-left">ACTIONS</th>
            </tr>
          </thead>
          <tbody id="user-orders-table-body">
            <tr>
              <td colspan="7" class="text-center text-text-secondary py-8">
                <div class="loading-spinner mx-auto mb-2"></div>
                Loading user orders...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Payment Methods Section -->
  <div id="payment-methods-section" class="admin-section hidden">
    <div class="app-card p-4 md:p-8">
      <h3 class="text-lg md:text-xl font-orbitron font-bold mb-6 text-accent-purple flex items-center">
        <i class="fas fa-wallet mr-3"></i>
        MANAGE PAYMENT METHODS
      </h3>
      <h4 class="text-md font-orbitron font-bold mb-4 text-accent-green flex items-center">
        <i class="fas fa-plus-circle mr-2"></i>
        ADD NEW PAYMENT METHOD
      </h4>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6 mb-6">
        <div>
          <label class="block text-sm font-medium mb-2 text-text-secondary">METHOD NAME</label>
          <input type="text" id="payment-method-name" placeholder="KBZ Pay / Wave Money" 
                 class="app-input w-full">
      </div>
      <div>
        <label class="block text-sm font-medium mb-2 text-text-secondary">ACCOUNT INFO</label>
        <input type="text" id="payment-account-info" placeholder="Phone Number / Account Number" 
               class="app-input w-full">
      </div>
      <div class="md:col-span-2">
        <label class="block text-sm font-medium mb-2 text-text-secondary">INSTRUCTIONS</label>
        <textarea id="payment-instructions" placeholder="Instructions for transfer..." rows="2"
                  class="app-input w-full resize-none"></textarea>
      </div>
      <div>
        <label class="block text-sm font-medium mb-2 text-text-secondary">QR CODE IMAGE (OPTIONAL)</label>
        <input type="file" id="payment-qr-code" accept="image/*" 
               class="app-input w-full">
      </div>
      <div class="flex items-end">
        <button onclick="addPaymentMethod()" 
                class="myanmar-btn w-full flex items-center justify-center space-x-2">
          <i class="fas fa-plus"></i>
          <span>ADD NEW METHOD</span>
        </button>
      </div>
    </div>

    <h4 class="text-md font-orbitron font-bold mb-4 mt-8 text-accent-green flex items-center">
      <i class="fas fa-list-alt mr-2"></i>
      ALL PAYMENT METHODS
    </h4>
    <div class="relative search-input-container mb-4">
      <input type="text" id="search-payment-methods" placeholder="Search Payment Methods..." class="app-input w-full" onkeyup="filterTable('payment-methods-table-body', this.value)">
      <i class="fas fa-search search-icon"></i>
    </div>
    <div class="overflow-x-auto">
      <table class="app-table w-full">
        <thead>
          <tr>
            <th class="text-left">METHOD</th>
            <th class="text-left">ACCOUNT INFO</th>
            <th class="text-left">QR CODE</th>
            <th class="text-left">STATUS</th>
            <th class="text-left">ACTIONS</th>
          </tr>
        </thead>
        <tbody id="payment-methods-table-body">
          <tr>
            <td colspan="5" class="text-center text-text-secondary py-8">
              <div class="loading-spinner mx-auto mb-2"></div>
              Loading payment methods...
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Chat Section -->
  <div id="chat-section" class="admin-section hidden">
    <div class="app-card p-4 md:p-8">
      <h3 class="text-lg md:text-xl font-orbitron font-bold mb-6 text-accent-purple flex items-center">
        <i class="fas fa-comments mr-3"></i>
        GLOBAL CHAT
      </h3>
      <h4 class="text-md font-orbitron font-bold mb-4 text-accent-green flex items-center">
        <i class="fas fa-list-alt mr-2"></i>
        ALL CHAT MESSAGES
      </h4>
      <div id="chat-messages" class="bg-black bg-opacity-30 rounded-xl p-4 h-96 overflow-y-auto mb-6 border border-gray-700">
        <div class="loading-spinner mx-auto mb-4"></div>
        <p class="text-center text-text-secondary">Loading messages...</p>
      </div>
      <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-4">
        <textarea id="chat-input" placeholder="Type your message..." rows="3"
                  class="app-input flex-1 resize-none"></textarea>
        <button onclick="sendChatMessage()" 
                class="myanmar-btn flex items-center justify-center space-x-2 md:self-end">
          <i class="fas fa-paper-plane"></i>
          <span>SEND</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Support Section -->
  <div id="support-section" class="admin-section hidden">
    <div class="app-card p-4 md:p-8">
      <h3 class="text-lg md:text-xl font-orbitron font-bold mb-6 text-accent-purple flex items-center">
        <i class="fas fa-headset mr-3"></i>
        MANAGE SUPPORT TICKETS
      </h3>
      <h4 class="text-md font-orbitron font-bold mb-4 text-accent-green flex items-center">
        <i class="fas fa-list-alt mr-2"></i>
        ALL SUPPORT TICKETS
      </h4>
      <div class="relative search-input-container mb-4">
        <input type="text" id="search-support-tickets" placeholder="Search Support Tickets..." class="app-input w-full" onkeyup="filterTable('support-tickets-table-body', this.value)">
        <i class="fas fa-search search-icon"></i>
      </div>
      <div class="overflow-x-auto">
        <table class="app-table w-full">
          <thead>
            <tr>
              <th class="text-left">TICKET ID</th>
              <th class="text-left">USER</th>
              <th class="text-left">SUBJECT</th>
              <th class="text-left">STATUS</th>
              <th class="text-left">DATE</th>
              <th class="text-left">ACTIONS</th>
            </tr>
          </thead>
          <tbody id="support-tickets-table-body">
            <tr>
              <td colspan="6" class="text-center text-text-secondary py-8">
                <div class="loading-spinner mx-auto mb-2"></div>
                Loading support tickets...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- About Section -->
  <div id="about-section" class="admin-section hidden">
    <div class="app-card p-4 md:p-8 text-center">
      <h3 class="text-lg md:text-xl font-orbitron font-bold mb-4 text-accent-purple">
        <i class="fas fa-info-circle mr-2"></i>
        ABOUT THIS PANEL
      </h3>
      <p class="text-text-secondary mb-4">
        This Admin Panel is designed to manage the FPS GFX Tool application,
        including user keys, news updates, product listings, orders, and more.
      </p>
      <p class="text-text-secondary mb-2">
        Developed by <span class="font-semibold text-accent-green">Your Name/Team</span>
      </p>
      <p class="text-text-secondary text-sm">
        Version: 1.0.0 | Last Updated: <span id="last-updated">2023-10-27</span>
      </p>
    </div>
  </div>
</div>

</div>

<!-- Modals -->
<!-- View News Modal -->
<div id="view-news-modal" class="modal hidden">
  <div class="modal-content w-full max-w-2xl">
    <h3 class="text-xl font-orbitron font-bold mb-4 text-accent-purple flex items-center justify-between">
      <i class="fas fa-newspaper mr-2"></i>
      NEWS DETAILS
      <button onclick="closeModal('view-news-modal')" class="text-text-secondary hover:text-accent-red text-2xl">
        &times;
      </button>
    </h3>
    <div class="space-y-4 text-text-primary">
      <p><strong>Title:</strong> <span id="modal-news-title"></span></p>
      <p><strong>Content:</strong> <span id="modal-news-content"></span></p>
      <div id="modal-news-media-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
      <p><strong>YouTube:</strong> <a id="modal-news-youtube" href="#" target="_blank" class="text-accent-green hover:underline"></a></p>
      <p><strong>TikTok:</strong> <a id="modal-news-tiktok" href="#" target="_blank" class="text-accent-green hover:underline"></a></p>
      <p><strong>Telegram:</strong> <a id="modal-news-telegram" href="#" target="_blank" class="text-accent-green hover:underline"></a></p>
      <p><strong>Facebook:</strong> <a id="modal-news-facebook" href="#" target="_blank" class="text-accent-green hover:underline"></a></p>
      <p><strong>Author:</strong> <span id="modal-news-author"></span></p>
      <p><strong>Views:</strong> <span id="modal-news-views"></span></p>
      <p><strong>Likes:</strong> <span id="modal-news-likes"></span></p>
      <p><strong>Date:</strong> <span id="modal-news-date"></span></p>
    </div>
  </div>
</div>

<!-- Edit News Modal -->
<div id="edit-news-modal" class="modal hidden">
  <div class="modal-content w-full max-w-2xl">
    <h3 class="text-xl font-orbitron font-bold mb-4 text-accent-purple flex items-center justify-between">
      <i class="fas fa-edit mr-2"></i>
      EDIT NEWS POST
      <button onclick="closeModal('edit-news-modal')" class="text-text-secondary hover:text-accent-red text-2xl">
        &times;
      </button>
    </h3>
    <input type="hidden" id="edit-news-id">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6 mb-6">
      <div>
        <label class="block text-sm font-medium mb-2 text-text-secondary">NEWS TITLE</label>
        <input type="text" id="edit-news-title" class="app-input w-full">
      </div>
      <div class="md:col-span-2">
        <label class="block text-sm font-medium mb-2 text-text-secondary">NEWS CONTENT</label>
        <textarea id="edit-news-content" rows="4" class="app-input w-full resize-none"></textarea>
      </div>
      <div>
        <label class="block text-sm font-medium mb-2 text-text-secondary">YOUTUBE LINK (OPTIONAL)</label>
        <input type="url" id="edit-news-youtube" class="app-input w-full">
      </div>
      <div>
        <label class="block text-sm font-medium mb-2 text-text-secondary">TIKTOK LINK (OPTIONAL)</label>
        <input type="url" id="edit-news-tiktok" class="app-input w-full">
      </div>
      <div>
        <label class="block text-sm font-medium mb-2 text-text-secondary">TELEGRAM LINK (OPTIONAL)</label>
        <input type="url" id="edit-news-telegram" class="app-input w-full">
      </div>
      <div>
        <label class="block text-sm font-medium mb-2 text-text-secondary">FACEBOOK LINK (OPTIONAL)</label>
        <input type="url" id="edit-news-facebook" class="app-input w-full">
      </div>
      <div class="md:col-span-2">
        <button onclick="updateNews()" class="myanmar-btn w-full flex items-center justify-center space-x-2">
          <i class="fas fa-save"></i>
          <span>SAVE CHANGES</span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- View Product Modal -->
<div id="view-product-modal" class="modal hidden">
  <div class="modal-content w-full max-w-2xl">
    <h3 class="text-xl font-orbitron font-bold mb-4 text-accent-purple flex items-center justify-between">
      <i class="fas fa-box-open mr-2"></i>
      PRODUCT DETAILS
      <button onclick="closeModal('view-product-modal')" class="text-text-secondary hover:text-accent-red text-2xl">
        &times;
      </button>
    </h3>
    <div class="space-y-4 text-text-primary">
      <div class="flex items-center space-x-4 mb-4">
        <img id="modal-product-icon" src="/placeholder.svg" alt="Product Icon" class="w-20 h-20 object-contain rounded-lg border border-gray-700 p-1">
        <div>
          <p><strong>Name:</strong> <span id="modal-product-name"></span></p>
          <p><strong>Price:</strong> <span id="modal-product-price"></span> MMK</p>
        </div>
      </div>
      <p><strong>Description:</strong> <span id="modal-product-description"></span></p>
      <p><strong>APK File:</strong> <a id="modal-product-apk-url" href="#" target="_blank" class="text-accent-green hover:underline">Download APK</a></p>
      <p><strong>Status:</strong> <span id="modal-product-status"></span></p>
      <p><strong>Created At:</strong> <span id="modal-product-created-at"></span></p>
    </div>
  </div>
</div>

<!-- Edit Product Modal -->
<div id="edit-product-modal" class="modal hidden">
  <div class="modal-content w-full max-w-2xl">
    <h3 class="text-xl font-orbitron font-bold mb-4 text-accent-purple flex items-center justify-between">
      <i class="fas fa-edit mr-2"></i>
      EDIT PRODUCT
      <button onclick="closeModal('edit-product-modal')" class="text-text-secondary hover:text-accent-red text-2xl">
        &times;
      </button>
    </h3>
    <input type="hidden" id="edit-product-id">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6 mb-6">
      <div>
        <label class="block text-sm font-medium mb-2 text-text-secondary">PRODUCT NAME</label>
        <input type="text" id="edit-product-name" class="app-input w-full">
      </div>
      <div>
        <label class="block text-sm font-medium mb-2 text-text-secondary">PRODUCT PRICE (MMK)</label>
        <input type="number" id="edit-product-price" min="0" step="0.01" class="app-input w-full">
      </div>
      <div class="md:col-span-2">
        <label class="block text-sm font-medium mb-2 text-text-secondary">DESCRIPTION</label>
        <textarea id="edit-product-description" rows="3" class="app-input w-full resize-none"></textarea>
      </div>
      <div>
        <label class="block text-sm font-medium mb-2 text-text-secondary">STATUS</label>
        <select id="edit-product-status" class="app-input w-full">
          <option value="active">Active</option>
          <option value="inactive">Inactive</option>
        </select>
      </div>
      <div class="md:col-span-2">
        <button onclick="updateProduct()" class="myanmar-btn w-full flex items-center justify-center space-x-2">
          <i class="fas fa-save"></i>
          <span>SAVE CHANGES</span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- View Order Modal -->
<div id="view-order-modal" class="modal hidden">
  <div class="modal-content w-full max-w-2xl">
    <h3 class="text-xl font-orbitron font-bold mb-4 text-accent-purple flex items-center justify-between">
      <i class="fas fa-receipt mr-2"></i>
      ORDER DETAILS
      <button onclick="closeModal('view-order-modal')" class="text-text-secondary hover:text-accent-red text-2xl">
        &times;
      </button>
    </h3>
    <div class="space-y-4 text-text-primary">
      <p><strong>Order ID:</strong> <span id="modal-order-id"></span></p>
      <p><strong>Buyer:</strong> <span id="modal-order-buyer"></span></p>
      <p><strong>Product:</strong> <span id="modal-order-product"></span></p>
      <p><strong>Amount:</strong> <span id="modal-order-amount"></span> MMK</p>
      <p><strong>Payment Method:</strong> <span id="modal-order-payment-method"></span></p>
      <p><strong>Receipt Image:</strong> <a id="modal-order-receipt-url" href="#" target="_blank" class="text-accent-green hover:underline">View Receipt</a></p>
      <p><strong>Status:</strong> <span id="modal-order-status"></span></p>
      <p><strong>Order Date:</strong> <span id="modal-order-date"></span></p>
    </div>
  </div>
</div>

<!-- Edit Order Modal -->
<div id="edit-order-modal" class="modal hidden">
  <div class="modal-content w-full max-w-2xl">
    <h3 class="text-xl font-orbitron font-bold mb-4 text-accent-purple flex items-center justify-between">
      <i class="fas fa-edit mr-2"></i>
      EDIT ORDER STATUS
      <button onclick="closeModal('edit-order-modal')" class="text-text-secondary hover:text-accent-red text-2xl">
        &times;
      </button>
    </h3>
    <input type="hidden" id="edit-order-id">
    <input type="hidden" id="edit-order-type"> <!-- 'admin' or 'user' -->
    <div class="space-y-4">
      <div>
        <label class="block text-sm font-medium mb-2 text-text-secondary">ORDER STATUS</label>
        <select id="edit-order-status-select" class="app-input w-full">
          <option value="pending">Pending</option>
          <option value="completed">Completed</option>
          <option value="cancelled">Cancelled</option>
        </select>
      </div>
      <button onclick="updateOrderStatus()" class="myanmar-btn w-full flex items-center justify-center space-x-2">
        <i class="fas fa-save"></i>
        <span>UPDATE STATUS</span>
      </button>
    </div>
  </div>
</div>

<!-- View User Product Modal -->
<div id="view-user-product-modal" class="modal hidden">
  <div class="modal-content w-full max-w-2xl">
    <h3 class="text-xl font-orbitron font-bold mb-4 text-accent-purple flex items-center justify-between">
      <i class="fas fa-store mr-2"></i>
      USER PRODUCT DETAILS
      <button onclick="closeModal('view-user-product-modal')" class="text-text-secondary hover:text-accent-red text-2xl">
        &times;
      </button>
    </h3>
    <div class="space-y-4 text-text-primary">
      <div class="flex items-center space-x-4 mb-4">
        <img id="modal-user-product-image" src="/placeholder.svg" alt="Product Image" class="w-20 h-20 object-cover rounded-lg border border-gray-700 p-1">
        <div>
          <p><strong>Name:</strong> <span id="modal-user-product-name"></span></p>
          <p><strong>Price:</strong> <span id="modal-user-product-price"></span> MMK</p>
        </div>
      </div>
      <p><strong>Description:</strong> <span id="modal-user-product-description"></span></p>
      <p><strong>Seller:</strong> <span id="modal-user-product-seller"></span></p>
      <p><strong>Contact Info:</strong> <span id="modal-user-product-contact"></span></p>
      <p><strong>Status:</strong> <span id="modal-user-product-status"></span></p>
      <p><strong>Created At:</strong> <span id="modal-user-product-created-at"></span></p>
    </div>
  </div>
</div>

<!-- Edit User Product Modal -->
<div id="edit-user-product-modal" class="modal hidden">
  <div class="modal-content w-full max-w-2xl">
    <h3 class="text-xl font-orbitron font-bold mb-4 text-accent-purple flex items-center justify-between">
      <i class="fas fa-edit mr-2"></i>
      EDIT USER PRODUCT
      <button onclick="closeModal('edit-user-product-modal')" class="text-text-secondary hover:text-accent-red text-2xl">
        &times;
      </button>
    </h3>
    <input type="hidden" id="edit-user-product-id">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6 mb-6">
      <div>
        <label class="block text-sm font-medium mb-2 text-text-secondary">PRODUCT NAME</label>
        <input type="text" id="edit-user-product-name" class="app-input w-full">
      </div>
      <div>
        <label class="block text-sm font-medium mb-2 text-text-secondary">PRODUCT PRICE (MMK)</label>
        <input type="number" id="edit-user-product-price" min="0" step="0.01" class="app-input w-full">
      </div>
      <div class="md:col-span-2">
        <label class="block text-sm font-medium mb-2 text-text-secondary">DESCRIPTION</label>
        <textarea id="edit-user-product-description" rows="3" class="app-input w-full resize-none"></textarea>
      </div>
      <div>
        <label class="block text-sm font-medium mb-2 text-text-secondary">STATUS</label>
        <select id="edit-user-product-status" class="app-input w-full">
          <option value="active">Active</option>
          <option value="inactive">Inactive</option>
          <option value="sold_out">Sold Out</option>
        </select>
      </div>
      <div class="md:col-span-2">
        <button onclick="updateUserProduct()" class="myanmar-btn w-full flex items-center justify-center space-x-2">
          <i class="fas fa-save"></i>
          <span>SAVE CHANGES</span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- View Payment Method Modal -->
<div id="view-payment-method-modal" class="modal hidden">
  <div class="modal-content w-full max-w-2xl">
    <h3 class="text-xl font-orbitron font-bold mb-4 text-accent-purple flex items-center justify-between">
      <i class="fas fa-wallet mr-2"></i>
      PAYMENT METHOD DETAILS
      <button onclick="closeModal('view-payment-method-modal')" class="text-text-secondary hover:text-accent-red text-2xl">
        &times;
      </button>
    </h3>
    <div class="space-y-4 text-text-primary">
      <p><strong>Method Name:</strong> <span id="modal-payment-method-name"></span></p>
      <p><strong>Account Info:</strong> <span id="modal-payment-account-info"></span></p>
      <p><strong>Instructions:</strong> <span id="modal-payment-instructions"></span></p>
      <p><strong>QR Code:</strong> <img id="modal-payment-qr-code" src="/placeholder.svg?height=192&width=192" alt="QR Code" class="w-48 h-48 object-contain mt-2 border border-gray-700 p-1"></p>
      <p><strong>Status:</strong> <span id="modal-payment-status"></span></p>
      <p><strong>Created At:</strong> <span id="modal-payment-created-at"></span></p>
    </div>
  </div>
</div>

<!-- Edit Payment Method Modal -->
<div id="edit-payment-method-modal" class="modal hidden">
  <div class="modal-content w-full max-w-2xl">
    <h3 class="text-xl font-orbitron font-bold mb-4 text-accent-purple flex items-center justify-between">
      <i class="fas fa-edit mr-2"></i>
      EDIT PAYMENT METHOD
      <button onclick="closeModal('edit-payment-method-modal')" class="text-text-secondary hover:text-accent-red text-2xl">
        &times;
      </button>
    </h3>
    <input type="hidden" id="edit-payment-method-id">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6 mb-6">
      <div>
        <label class="block text-sm font-medium mb-2 text-text-secondary">METHOD NAME</label>
        <input type="text" id="edit-payment-method-name" class="app-input w-full">
      </div>
      <div>
        <label class="block text-sm font-medium mb-2 text-text-secondary">ACCOUNT INFO</label>
        <input type="text" id="edit-payment-account-info" class="app-input w-full">
      </div>
      <div class="md:col-span-2">
        <label class="block text-sm font-medium mb-2 text-text-secondary">INSTRUCTIONS</label>
        <textarea id="edit-payment-instructions" rows="2" class="app-input w-full resize-none"></textarea>
      </div>
      <div>
        <label class="block text-sm font-medium mb-2 text-text-secondary">STATUS</label>
        <select id="edit-payment-method-status" class="app-input w-full">
          <option value="active">Active</option>
          <option value="inactive">Inactive</option>
        </select>
      </div>
      <div class="md:col-span-2">
        <button onclick="updatePaymentMethod()" class="myanmar-btn w-full flex items-center justify-center space-x-2">
          <i class="fas fa-save"></i>
          <span>SAVE CHANGES</span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- View Chat Conversation Modal -->
<div id="view-chat-modal" class="modal hidden">
  <div class="modal-content w-full max-w-2xl">
    <h3 class="text-xl font-orbitron font-bold mb-4 text-accent-purple flex items-center justify-between">
      <i class="fas fa-comments mr-2"></i>
      CHAT CONVERSATION
      <button onclick="closeModal('view-chat-modal')" class="text-text-secondary hover:text-accent-red text-2xl">
        &times;
      </button>
    </h3>
    <div id="chat-conversation-messages" class="bg-black bg-opacity-30 rounded-xl p-4 h-96 overflow-y-auto mb-6 border border-gray-700">
      <div class="loading-spinner mx-auto mb-4"></div>
      <p class="text-center text-text-secondary">Loading conversation...</p>
    </div>
    <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-4">
      <textarea id="chat-reply-input" placeholder="Type your reply..." rows="3"
                class="app-input flex-1 resize-none"></textarea>
      <button onclick="sendChatReply()" 
            class="myanmar-btn flex items-center justify-center space-x-2 md:self-end">
        <i class="fas fa-paper-plane"></i>
        <span>REPLY</span>
      </button>
    </div>
  </div>
</div>

<!-- View Support Ticket Modal -->
<div id="view-support-modal" class="modal hidden">
  <div class="modal-content w-full max-w-2xl">
    <h3 class="text-xl font-orbitron font-bold mb-4 text-accent-purple flex items-center justify-between">
      <i class="fas fa-headset mr-2"></i>
      SUPPORT TICKET DETAILS
      <button onclick="closeModal('view-support-modal')" class="text-text-secondary hover:text-accent-red text-2xl">
        &times;
      </button>
    </h3>
    <div class="space-y-4 text-text-primary">
      <p><strong>Ticket ID:</strong> <span id="modal-support-id"></span></p>
      <p><strong>User:</strong> <span id="modal-support-user"></span></p>
      <p><strong>Subject:</strong> <span id="modal-support-subject"></span></p>
      <p><strong>Message:</strong> <span id="modal-support-message"></span></p>
      <p><strong>Status:</strong> <span id="modal-support-status"></span></p>
      <p><strong>Created At:</strong> <span id="modal-support-created-at"></span></p>
    </div>
    <div class="mt-6">
      <label class="block text-sm font-medium mb-2 text-text-secondary">UPDATE STATUS</label>
      <select id="edit-support-status" class="app-input w-full mb-4">
        <option value="open">Open</option>
        <option value="closed">Closed</option>
        <option value="pending">Pending</option>
      </select>
      <button onclick="updateSupportTicketStatus()" class="myanmar-btn w-full flex items-center justify-center space-x-2">
        <i class="fas fa-save"></i>
        <span>UPDATE TICKET STATUS</span>
      </button>
    </div>
  </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
<script>
// Configuration
const CONFIG = {
  SUPABASE_URL: 'https://rmeudvhvqlddqqkiziyo.supabase.co',
  SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJtZXVkdmh2cWxkZHFxa2l6aXlvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM5OTMxOTIsImV4cCI6MjA2OTU2OTE5Mn0.xFgMv-K5o5yyTpe4U2YJK5jC9GPJp98G4cgD9p5W4ak',
  ADMIN_KEY: 'Opper_FPS',
  MAX_RETRY_ATTEMPTS: 3,
  RETRY_DELAY: 2000
};

// State
let state = {
  supabase: null,
  isConnected: false,
  reconnectAttempts: 0,
  adminProfileId: 'a0eebc99-9c0b-4ef8-bb6d-6bb9bd380a11', // Dummy profile_id for Admin Global Chat. Ensure this ID exists in your 'profiles' table for data integrity.
};

// Utility Functions
function showNotification(message, type = 'success', duration = 3000) {
  const container = document.getElementById('notification-container');
  const notification = document.createElement('div');
  
  const bgColors = {
    success: 'bg-green-600',
    error: 'bg-red-600',
    info: 'bg-blue-600',
    warning: 'bg-yellow-600'
  };
  
  const icons = {
    success: 'fa-check-circle',
    error: 'fa-exclamation-triangle',
    info: 'fa-info-circle',
    warning: 'fa-exclamation-circle'
  };
  
  notification.className = `notification ${bgColors[type]}`;
  notification.innerHTML = `
    <div class="flex items-center justify-between">
      <div class="flex items-center">
        <i class="fas ${icons[type]} mr-2"></i>
        <span>${message}</span>
      </div>
      <button onclick="this.parentElement.parentElement.remove()" class="ml-4 hover:text-gray-200">
        &times;
      </button>
    </div>
  `;
  
  container.appendChild(notification);
  
  setTimeout(() => {
    if (notification.parentElement) {
      notification.remove();
    }
  }, duration);
}

function showLoading(buttonId, textId, loading = true) {
  const button = document.getElementById(buttonId);
  const text = document.getElementById(textId);
  if (loading) {
    button.disabled = true;
    text.innerHTML = '<div class="loading-spinner"></div>';
  } else {
    button.disabled = false;
    text.innerHTML = text.dataset.originalText;
  }
}

function updateConnectionStatus(status) {
  const statusElement = document.getElementById('connection-status');
  statusElement.className = 'connection-status';
  
  switch (status) {
    case 'online':
      statusElement.classList.add('status-online');
      statusElement.innerHTML = '<i class="fas fa-check-circle"></i> အွန်လိုင်း';
      break;
    case 'offline':
      statusElement.classList.add('status-offline');
      statusElement.innerHTML = '<i class="fas fa-exclamation-triangle"></i> အော့ဖ်လိုင်း';
      break;
    case 'connecting':
      statusElement.classList.add('status-connecting');
      statusElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ချိတ်ဆက်နေသည်...';
      break;
  }
}

function showSection(sectionId, buttonElement) {
  document.querySelectorAll('.admin-section').forEach(section => {
    section.classList.add('hidden');
  });
  document.getElementById(sectionId + '-section').classList.remove('hidden');

  document.querySelectorAll('.nav-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  buttonElement.classList.add('active');

  // Load data for the section
  switch (sectionId) {
    case 'dashboard':
      loadDashboardStats();
      break;
    case 'keys':
      loadKeys();
      break;
    case 'users':
      loadUsers();
      break;
    case 'news':
      loadNews();
      break;
    case 'products':
      loadProducts();
      break;
    case 'orders':
      loadOrders();
      break;
    case 'user-products':
      loadUserProducts();
      break;
    case 'user-orders':
      loadUserOrders();
      break;
    case 'payment-methods':
      loadPaymentMethods();
      break;
    case 'chat':
      loadChatMessages();
      break;
    case 'support':
      loadSupportTickets();
      break;
  }
}

function filterTable(tableBodyId, searchTerm) {
  const tableBody = document.getElementById(tableBodyId);
  const rows = tableBody.getElementsByTagName('tr');
  const filter = searchTerm.toLowerCase();

  for (let i = 0; i < rows.length; i++) {
    let row = rows[i];
    let cells = row.getElementsByTagName('td');
    let found = false;
    for (let j = 0; j < cells.length; j++) {
      let cell = cells[j];
      if (cell) {
        let textValue = cell.textContent || cell.innerText;
        if (textValue.toLowerCase().indexOf(filter) > -1) {
          found = true;
          break;
        }
      }
    }
    if (found) {
      row.style.display = '';
    } else {
      row.style.display = 'none';
    }
  }
}

function openModal(modalId) {
  document.getElementById(modalId).classList.remove('hidden');
}

function closeModal(modalId) {
  document.getElementById(modalId).classList.add('hidden');
}

// Initialize App (Supabase Connection)
async function initializeApp() {
  updateConnectionStatus('connecting');
  
  try {
    if (!CONFIG.SUPABASE_URL || CONFIG.SUPABASE_URL === 'YOUR_SUPABASE_URL_HERE') {
      throw new Error('Supabase URL လိုအပ်ပါတယ်! CONFIG အပိုင်းထဲမှာ သင့် Supabase URL ကို ထည့်ပါ။');
    }

    if (!CONFIG.SUPABASE_ANON_KEY || CONFIG.SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY_HERE') {
      throw new Error('Supabase Anon Key လိုအပ်ပါတယ်! CONFIG အပိုင်းထဲမှာ သင့် Supabase Anon Key ကို ထည့်ပါ။');
    }

    // Check if Supabase global object is available
    if (typeof Supabase === 'undefined') {
      throw new Error('Supabase library မတင်လို့ရပါ');
    }

    state.supabase = Supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY, {
      auth: { persistSession: false },
      realtime: { params: { eventsPerSecond: 10 } }
    });

    // Test connection by selecting from a public table (e.g., 'profiles')
    const { data, error } = await state.supabase.from('profiles').select('id').limit(1);
    
    if (error && error.code !== 'PGRST116') { // PGRST116 means no rows found, which is fine for a test
      throw new Error(`Database connection failed: ${error.message}`);
    }

    updateConnectionStatus('online');
    showNotification('Database connected successfully! Admin panel is ready.', 'success');
    
    state.isConnected = true;
    state.reconnectAttempts = 0;

    // Check if admin is already logged in
    if (localStorage.getItem('adminLoggedIn') === 'true') {
      document.getElementById('login-section').classList.add('hidden');
      document.getElementById('admin-content').classList.remove('hidden');
      document.getElementById('admin-name').textContent = localStorage.getItem('adminUsername'); // This will be 'Admin' or a placeholder
      showSection('dashboard', document.querySelector('.nav-btn.active'));
    } else {
      document.getElementById('login-section').classList.remove('hidden');
      document.getElementById('admin-content').classList.add('hidden');
    }
    
  } catch (error) {
    console.error('Initialization error:', error);
    updateConnectionStatus('offline');
    showNotification(`Connection failed: ${error.message}`, 'error');
    
    // Retry connection
    if (state.reconnectAttempts < CONFIG.MAX_RETRY_ATTEMPTS) {
      state.reconnectAttempts++;
      setTimeout(() => {
        console.log(`Retrying connection (${state.reconnectAttempts}/${CONFIG.MAX_RETRY_ATTEMPTS})...`);
        initializeApp();
      }, CONFIG.RETRY_DELAY);
    }
  }
}

// Admin Login/Logout
async function adminLogin() {
  if (!state.isConnected) {
    showNotification('Waiting for database connection...', 'warning');
    return;
  }

  const adminKey = document.getElementById('admin-key-input').value;
  const loginBtn = document.getElementById('admin-login-btn');
  const loginText = document.getElementById('admin-login-text');

  loginText.dataset.originalText = loginText.textContent;
  showLoading('admin-login-btn', 'admin-login-text', true);

  if (adminKey === CONFIG.ADMIN_KEY) {
    localStorage.setItem('adminLoggedIn', 'true');
    localStorage.setItem('adminUsername', 'Admin'); // Set a generic admin name for display
    showNotification('Login successful!', 'success');
    setTimeout(() => {
      document.getElementById('login-section').classList.add('hidden');
      document.getElementById('admin-content').classList.remove('hidden');
      document.getElementById('admin-name').textContent = localStorage.getItem('adminUsername');
      showSection('dashboard', document.querySelector('.nav-btn.active')); // Load dashboard by default
      showLoading('admin-login-btn', 'admin-login-text', false);
    }, 500);
  } else {
    showNotification('Invalid Admin Key.', 'error');
    showLoading('admin-login-btn', 'admin-login-text', false);
  }
}

function adminLogout() {
  localStorage.removeItem('adminLoggedIn');
  localStorage.removeItem('adminUsername');
  document.getElementById('admin-content').classList.add('hidden');
  document.getElementById('login-section').classList.remove('hidden');
  document.getElementById('admin-key-input').value = '';
  showNotification('Logout successful!', 'info');
}

// Dashboard Stats
async function loadDashboardStats() {
  try {
    const { count: keysCount } = await state.supabase.from('keys').select('*', { count: 'exact' });
    const { count: profilesCount } = await state.supabase.from('profiles').select('*', { count: 'exact' });
    const { count: newsCount } = await state.supabase.from('profile_news').select('*', { count: 'exact' });
    const { count: productsCount } = await state.supabase.from('products').select('*', { count: 'exact' });
    const { count: userProductsCount } = await state.supabase.from('user_products').select('*', { count: 'exact' });
    const { count: ordersCount } = await state.supabase.from('orders').select('*', { count: 'exact' }); // Admin products orders
    const { count: userOrdersCount } = await state.supabase.from('user_orders').select('*', { count: 'exact' }); // User products orders
    const { count: chatMessagesCount } = await state.supabase.from('buyer_seller_messages').select('*', { count: 'exact' });
    const { count: supportTicketsCount } = await state.supabase.from('support_messages').select('*', { count: 'exact' });

    document.getElementById('total-keys').textContent = keysCount || 0;
    document.getElementById('total-profiles').textContent = profilesCount || 0;
    document.getElementById('total-news').textContent = newsCount || 0;
    document.getElementById('total-products').textContent = productsCount || 0;
    document.getElementById('total-user-products').textContent = userProductsCount || 0;
    document.getElementById('total-orders').textContent = ordersCount || 0; 
    document.getElementById('total-user-orders').textContent = userOrdersCount || 0; 
    document.getElementById('total-chat-messages').textContent = chatMessagesCount || 0;
    document.getElementById('total-support-tickets').textContent = supportTicketsCount || 0;

  } catch (error) {
    console.error('Error loading dashboard stats:', error.message);
    showNotification('Failed to load dashboard stats.', 'error');
  }
}

// Keys Management
async function addKey() {
  const keyText = document.getElementById('new-key-text').value;
  const expiryDate = document.getElementById('new-key-expiry').value;
  const isActive = document.getElementById('new-key-is-active').value === 'true';

  if (!keyText || !expiryDate) {
    showNotification('Please fill in all key fields.', 'error');
    return;
  }

  try {
    const { data, error } = await state.supabase
      .from('keys')
      .insert([{ key_text: keyText, expiry_date: expiryDate, is_active: isActive }]);

    if (error) throw error;
    showNotification('Key added successfully!', 'success');
    document.getElementById('new-key-text').value = '';
    document.getElementById('new-key-expiry').value = '';
    document.getElementById('new-key-is-active').value = 'true';
    loadKeys();
  } catch (error) {
    console.error('Error adding key:', error.message);
    showNotification('Failed to add key.', 'error');
  }
}

async function loadKeys() {
  const tableBody = document.getElementById('keys-table-body');
  tableBody.innerHTML = `<tr><td colspan="4" class="text-center text-text-secondary py-8"><div class="loading-spinner mx-auto mb-2"></div>Loading keys...</td></tr>`;
  try {
    const { data: keys, error } = await state.supabase
      .from('keys')
      .select('*')
      .order('created_at', { ascending: false });

    if (error) throw error;

    tableBody.innerHTML = '';
    if (keys.length === 0) {
      tableBody.innerHTML = `<tr><td colspan="4" class="text-center text-text-secondary py-4">No keys found.</td></tr>`;
      return;
    }

    keys.forEach(key => {
      const row = tableBody.insertRow();
      const statusText = key.is_active ? 'Active' : 'Inactive';
      const statusClass = key.is_active ? 'status-active' : 'status-inactive';
      row.innerHTML = `
        <td class="break-all">${key.key_text}</td>
        <td>${new Date(key.expiry_date).toLocaleDateString()}</td>
        <td>
          <span class="${statusClass}">
            ${statusText}
          </span>
        </td>
        <td class="table-actions">
          <button onclick="toggleKeyStatus('${key.id}', ${key.is_active})" class="myanmar-btn btn-small ${key.is_active ? 'btn-danger' : ''}">
            ${key.is_active ? 'Deactivate' : 'Activate'}
          </button>
          <button onclick="deleteKey('${key.id}')" class="myanmar-btn btn-small btn-danger">
            Delete
          </button>
        </td>
      `;
    });
  } catch (error) {
    console.error('Error loading keys:', error.message);
    tableBody.innerHTML = `<tr><td colspan="4" class="text-center text-accent-red py-4">Failed to load keys.</td></tr>`;
    showNotification('Failed to load keys.', 'error');
  }
}

async function toggleKeyStatus(keyId, currentStatus) {
  try {
    const { data, error } = await state.supabase
      .from('keys')
      .update({ is_active: !currentStatus })
      .eq('id', keyId);

    if (error) throw error;
    showNotification(`Key status updated to ${!currentStatus ? 'Active' : 'Inactive'}!`, 'success');
    loadKeys();
  } catch (error) {
    console.error('Error toggling key status:', error.message);
    showNotification('Failed to update key status.', 'error');
  }
}

async function deleteKey(keyId) {
  if (!confirm('Are you sure you want to delete this key?')) return;
  try {
    const { data, error } = await state.supabase
      .from('keys')
      .delete()
      .eq('id', keyId);

    if (error) throw error;
    showNotification('Key deleted successfully!', 'success');
    loadKeys();
  } catch (error) {
    console.error('Error deleting key:', error.message);
    showNotification('Failed to delete key.', 'error');
  }
}

// Users Management
async function loadUsers() {
  const tableBody = document.getElementById('users-table-body');
  tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-text-secondary py-8"><div class="loading-spinner mx-auto mb-2"></div>Loading users...</td></tr>`;
  try {
    const { data: profiles, error } = await state.supabase
      .from('profiles')
      .select(`
        id,
        username,
        name,
        is_banned,
        key_id,
        keys (key_text)
      `)
      .order('created_at', { ascending: false });

    if (error) throw error;

    tableBody.innerHTML = '';
    if (profiles.length === 0) {
      tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-text-secondary py-4">No user profiles found.</td></tr>`;
      return;
    }

    profiles.forEach(profile => {
      const row = tableBody.insertRow();
      const statusText = profile.is_banned ? 'Banned' : 'Active';
      const statusClass = profile.is_banned ? 'status-banned' : 'status-active';
      row.innerHTML = `
        <td>${profile.username || 'N/A'}</td>
        <td>${profile.name || 'N/A'}</td>
        <td>${profile.keys ? profile.keys.key_text : 'No Key'}</td>
        <td>
          <span class="${statusClass}">
            ${statusText}
          </span>
        </td>
        <td class="table-actions">
          <button onclick="editUser('${profile.id}', '${profile.username}', '${profile.name}', ${profile.is_banned})" class="myanmar-btn btn-small">
            Edit
          </button>
          <button onclick="toggleUserStatus('${profile.id}', ${profile.is_banned})" class="myanmar-btn btn-small ${profile.is_banned ? '' : 'btn-danger'}">
            ${profile.is_banned ? 'Unban' : 'Ban'}
          </button>
          <button onclick="deleteUser('${profile.id}')" class="myanmar-btn btn-small btn-danger">
            Delete
          </button>
        </td>
      `;
    });
  } catch (error) {
    console.error('Error loading users:', error.message);
    tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-accent-red py-4">Failed to load users.</td></tr>`;
    showNotification('Failed to load users.', 'error');
  }
}

function editUser(id, username, name, isBanned) {
  // For now, we'll just show a notification. A full edit modal would be more complex.
  showNotification(`Editing user: ${username}. Banned: ${isBanned}`, 'info');
  // You would typically open a modal here with pre-filled data
  // For example: openModal('edit-user-modal');
  // document.getElementById('edit-user-id').value = id;
  // document.getElementById('edit-user-username').value = username;
  // document.getElementById('edit-user-full-name').value = fullName;
  // document.getElementById('edit-user-status-select').value = status;
}

async function toggleUserStatus(userId, currentIsBanned) {
  try {
    const { data, error } = await state.supabase
      .from('profiles')
      .update({ is_banned: !currentIsBanned })
      .eq('id', userId);

    if (error) throw error;
    showNotification(`User status updated to ${!currentIsBanned ? 'Banned' : 'Active'}!`, 'success');
    loadUsers();
  } catch (error) {
    console.error('Error toggling user status:', error.message);
    showNotification('Failed to update user status.', 'error');
  }
}

async function deleteUser(userId) {
  if (!confirm('Are you sure you want to delete this user and all associated data (news, products, orders, messages)? This action cannot be undone.')) return;
  try {
    // Supabase RLS should handle cascading deletes if set up correctly,
    // but for safety, you might want to delete related data explicitly if RLS isn't perfect.
    // For this example, we'll rely on RLS or direct deletion of the profile.
    const { data, error } = await state.supabase
      .from('profiles')
      .delete()
      .eq('id', userId);

    if (error) throw error;
    showNotification('User and associated data deleted successfully!', 'success');
    loadUsers();
  } catch (error) {
    console.error('Error deleting user:', error.message);
    showNotification('Failed to delete user.', 'error');
  }
}

// News Management
async function postNews() {
  const title = document.getElementById('news-title').value;
  const content = document.getElementById('news-content').value;
  const mediaFiles = document.getElementById('news-media').files;
  const youtubeLink = document.getElementById('news-youtube').value;
  const tiktokLink = document.getElementById('news-tiktok').value;
  const telegramLink = document.getElementById('news-telegram').value;
  const facebookLink = document.getElementById('news-facebook').value;

  if (!title || !content) {
    showNotification('Please fill in news title and content.', 'error');
    return;
  }

  let mediaUrls = [];
  if (mediaFiles.length > 0) {
    for (const file of mediaFiles) {
      const filePath = `profile_news_media/${Date.now()}_${file.name}`; // Use the correct bucket name
      const { data, error } = await state.supabase.storage.from('profile_news_media').upload(filePath, file);
      if (error) {
        console.error('Error uploading media:', error.message);
        showNotification(`Failed to upload media: ${file.name}`, 'error');
        return;
      }
      const { data: publicUrl } = state.supabase.storage.from('profile_news_media').getPublicUrl(filePath);
      mediaUrls.push({ url: publicUrl.publicUrl, type: file.type, size: file.size }); // Store as object
    }
  }

  try {
    const { data, error } = await state.supabase
      .from('profile_news') // Use profile_news table for all news
      .insert([{
        title: title,
        content: content,
        media_urls: mediaUrls,
        youtube_link: youtubeLink || null,
        tiktok_link: tiktokLink || null,
        telegram_link: telegramLink || null,
        facebook_link: facebookLink || null,
        profile_id: state.adminProfileId, // Assign to a dummy admin profile ID
        is_published: true,
        views: 0,
        likes: 0
      }]);

    if (error) throw error;
    showNotification('News posted successfully!', 'success');
    document.getElementById('news-title').value = '';
    document.getElementById('news-content').value = '';
    document.getElementById('news-media').value = '';
    document.getElementById('news-youtube').value = '';
    document.getElementById('news-tiktok').value = '';
    document.getElementById('news-telegram').value = '';
    document.getElementById('news-facebook').value = '';
    loadNews();
  } catch (error) {
    console.error('Error posting news:', error.message);
    showNotification('Failed to post news.', 'error');
  }
}

async function loadNews() {
  const tableBody = document.getElementById('news-table-body');
  tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-text-secondary py-8"><div class="loading-spinner mx-auto mb-2"></div>Loading news...</td></tr>`;
  try {
    const { data: news, error } = await state.supabase
      .from('profile_news') // Use profile_news table for all news
      .select(`
        id,
        title,
        content,
        media_urls,
        youtube_link,
        tiktok_link,
        telegram_link,
        facebook_link,
        views,
        likes,
        created_at,
        profiles (username)
      `)
      .order('created_at', { ascending: false });

    if (error) throw error;

    tableBody.innerHTML = '';
    if (news.length === 0) {
      tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-text-secondary py-4">No news posts found.</td></tr>`;
      return;
    }

    news.forEach(post => {
      const row = tableBody.insertRow();
      row.innerHTML = `
        <td>${post.title}</td>
        <td>${post.profiles ? post.profiles.username : 'Unknown'}</td>
        <td>${post.views}</td>
        <td>${post.likes}</td>
        <td>${new Date(post.created_at).toLocaleDateString()}</td>
        <td class="table-actions">
          <button onclick="viewNews('${post.id}')" class="myanmar-btn btn-small">
            View
          </button>
          <button onclick="openEditNewsModal('${post.id}')" class="myanmar-btn btn-small">
            Edit
          </button>
          <button onclick="deleteNews('${post.id}')" class="myanmar-btn btn-small btn-danger">
            Delete
          </button>
        </td>
      `;
    });
  } catch (error) {
    console.error('Error loading news:', error.message);
    tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-accent-red py-4">Failed to load news.</td></tr>`;
    showNotification('Failed to load news.', 'error');
  }
}

async function viewNews(newsId) {
  try {
    const { data: post, error } = await state.supabase
      .from('profile_news') // Use profile_news table
      .select(`
        id,
        title,
        content,
        media_urls,
        youtube_link,
        tiktok_link,
        telegram_link,
        facebook_link,
        views,
        likes,
        created_at,
        profiles (username)
      `)
      .eq('id', newsId)
      .single();

    if (error) throw error;

    document.getElementById('modal-news-title').textContent = post.title;
    document.getElementById('modal-news-content').textContent = post.content;
    document.getElementById('modal-news-author').textContent = post.profiles ? post.profiles.username : 'Unknown';
    document.getElementById('modal-news-views').textContent = post.views;
    document.getElementById('modal-news-likes').textContent = post.likes;
    document.getElementById('modal-news-date').textContent = new Date(post.created_at).toLocaleString();

    const mediaContainer = document.getElementById('modal-news-media-container');
    mediaContainer.innerHTML = '';
    if (post.media_urls && post.media_urls.length > 0) {
      post.media_urls.forEach(media => {
        if (media.type.startsWith('image/')) {
          mediaContainer.innerHTML += `<img src="${media.url}" class="w-full h-auto object-contain rounded-lg border border-gray-700">`;
        } else if (media.type.startsWith('video/')) {
          mediaContainer.innerHTML += `<video controls src="${media.url}" class="w-full h-auto rounded-lg border border-gray-700"></video>`;
        } else if (media.type.startsWith('audio/')) {
          mediaContainer.innerHTML += `<audio controls src="${media.url}" class="w-full"></audio>`;
        }
      });
    }

    document.getElementById('modal-news-youtube').href = post.youtube_link || '#';
    document.getElementById('modal-news-youtube').textContent = post.youtube_link ? 'View on YouTube' : 'N/A';
    document.getElementById('modal-news-tiktok').href = post.tiktok_link || '#';
    document.getElementById('modal-news-tiktok').textContent = post.tiktok_link ? 'View on TikTok' : 'N/A';
    document.getElementById('modal-news-telegram').href = post.telegram_link || '#';
    document.getElementById('modal-news-telegram').textContent = post.telegram_link ? 'View on Telegram' : 'N/A';
    document.getElementById('modal-news-facebook').href = post.facebook_link || '#';
    document.getElementById('modal-news-facebook').textContent = post.facebook_link ? 'View on Facebook' : 'N/A';

    openModal('view-news-modal');
  } catch (error) {
    console.error('Error viewing news:', error.message);
    showNotification('Failed to load news details.', 'error');
  }
}

async function openEditNewsModal(newsId) {
  try {
    const { data: post, error } = await state.supabase
      .from('profile_news') // Use profile_news table
      .select('*')
      .eq('id', newsId)
      .single();

    if (error) throw error;

    document.getElementById('edit-news-id').value = post.id;
    document.getElementById('edit-news-title').value = post.title;
    document.getElementById('edit-news-content').value = post.content;
    document.getElementById('edit-news-youtube').value = post.youtube_link || '';
    document.getElementById('edit-news-tiktok').value = post.tiktok_link || '';
    document.getElementById('edit-news-telegram').value = post.telegram_link || '';
    document.getElementById('edit-news-facebook').value = post.facebook_link || '';

    openModal('edit-news-modal');
  } catch (error) {
    console.error('Error opening edit news modal:', error.message);
    showNotification('Failed to load news for editing.', 'error');
  }
}

async function updateNews() {
  const newsId = document.getElementById('edit-news-id').value;
  const title = document.getElementById('edit-news-title').value;
  const content = document.getElementById('edit-news-content').value;
  const youtubeLink = document.getElementById('edit-news-youtube').value;
  const tiktokLink = document.getElementById('edit-news-tiktok').value;
  const telegramLink = document.getElementById('edit-news-telegram').value;
  const facebookLink = document.getElementById('edit-news-facebook').value;

  try {
    const { data, error } = await state.supabase
      .from('profile_news') // Use profile_news table
      .update({
        title: title,
        content: content,
        youtube_link: youtubeLink || null,
        tiktok_link: tiktokLink || null,
        telegram_link: telegramLink || null,
        facebook_link: facebookLink || null,
      })
      .eq('id', newsId);

    if (error) throw error;
    showNotification('News updated successfully!', 'success');
    closeModal('edit-news-modal');
    loadNews();
  } catch (error) {
    console.error('Error updating news:', error.message);
    showNotification('Failed to update news.', 'error');
  }
}

async function deleteNews(newsId) {
  if (!confirm('Are you sure you want to delete this news post?')) return;
  try {
    const { data, error } = await state.supabase
      .from('profile_news') // Use profile_news table
      .delete()
      .eq('id', newsId);

    if (error) throw error;
    showNotification('News post deleted successfully!', 'success');
    loadNews();
  } catch (error) {
    console.error('Error deleting news:', error.message);
    showNotification('Failed to delete news post.', 'error');
  }
}

// Products Management (Admin Products)
async function uploadProduct() {
  const name = document.getElementById('product-name').value;
  const price = parseFloat(document.getElementById('product-price').value);
  const description = document.getElementById('product-description').value;
  const apkFile = document.getElementById('product-apk-file').files[0];
  const apkIcon = document.getElementById('product-apk-icon').files[0];

  if (!name || isNaN(price) || !description || !apkFile || !apkIcon) {
    showNotification('Please fill in all product fields and upload files.', 'error');
    return;
  }

  let apkUrl = null;
  let iconUrl = null;

  try {
    // Upload APK file
    const apkPath = `apks/${Date.now()}_${apkFile.name}`;
    const { data: apkData, error: apkError } = await state.supabase.storage.from('apks').upload(apkPath, apkFile);
    if (apkError) throw apkError;
    const { data: publicApkUrl } = state.supabase.storage.from('apks').getPublicUrl(apkPath);
    apkUrl = publicApkUrl.publicUrl;

    // Upload APK icon
    const iconPath = `apk_icons/${Date.now()}_${apkIcon.name}`;
    const { data: iconData, error: iconError } = await state.supabase.storage.from('apk_icons').upload(iconPath, apkIcon);
    if (iconError) throw iconError;
    const { data: publicIconUrl } = state.supabase.storage.from('apk_icons').getPublicUrl(iconPath);
    iconUrl = publicIconUrl.publicUrl;

    const { data, error } = await state.supabase
      .from('products')
      .insert([{
        name: name,
        description: description,
        price: price,
        file_url: apkUrl, // Changed from apk_url to file_url based on schema
        apk_icon_url: iconUrl, // Changed from icon_url to apk_icon_url
        is_active: true // Changed from status to is_active
      }]);

    if (error) throw error;
    showNotification('Product uploaded successfully!', 'success');
    document.getElementById('product-name').value = '';
    document.getElementById('product-price').value = '';
    document.getElementById('product-description').value = '';
    document.getElementById('product-apk-file').value = '';
    document.getElementById('product-apk-icon').value = '';
    loadProducts();
  } catch (error) {
    console.error('Error uploading product:', error.message);
    showNotification('Failed to upload product.', 'error');
  }
}

async function loadProducts() {
  const tableBody = document.getElementById('products-table-body');
  tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-text-secondary py-8"><div class="loading-spinner mx-auto mb-2"></div>Loading products...</td></tr>`;
  try {
    const { data: products, error } = await state.supabase
      .from('products')
      .select('*')
      .order('created_at', { ascending: false });

    if (error) throw error;

    tableBody.innerHTML = '';
    if (products.length === 0) {
      tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-text-secondary py-4">No products found.</td></tr>`;
      return;
    }

    products.forEach(product => {
      const row = tableBody.insertRow();
      const statusText = product.is_active ? 'Active' : 'Inactive';
      const statusClass = product.is_active ? 'status-active' : 'status-inactive';
      row.innerHTML = `
        <td><img src="${product.apk_icon_url || '/placeholder.svg?height=40&width=40'}" alt="Icon" class="w-10 h-10 object-contain rounded-md"></td>
        <td>${product.name}</td>
        <td>${product.price} MMK</td>
        <td>
          <span class="${statusClass}">
            ${statusText}
          </span>
        </td>
        <td class="table-actions">
          <button onclick="viewProduct('${product.id}')" class="myanmar-btn btn-small">
            View
          </button>
          <button onclick="openEditProductModal('${product.id}')" class="myanmar-btn btn-small">
            Edit
          </button>
          <button onclick="deleteProduct('${product.id}')" class="myanmar-btn btn-small btn-danger">
            Delete
          </button>
        </td>
      `;
    });
  } catch (error) {
    console.error('Error loading products:', error.message);
    tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-accent-red py-4">Failed to load products.</td></tr>`;
    showNotification('Failed to load products.', 'error');
  }
}

async function viewProduct(productId) {
  try {
    const { data: product, error } = await state.supabase
      .from('products')
      .select('*')
      .eq('id', productId)
      .single();

    if (error) throw error;

    document.getElementById('modal-product-icon').src = product.apk_icon_url || '/placeholder.svg?height=80&width=80';
    document.getElementById('modal-product-name').textContent = product.name;
    document.getElementById('modal-product-price').textContent = product.price;
    document.getElementById('modal-product-description').textContent = product.description;
    document.getElementById('modal-product-apk-url').href = product.file_url || '#';
    document.getElementById('modal-product-status').textContent = product.is_active ? 'Active' : 'Inactive';
    document.getElementById('modal-product-created-at').textContent = new Date(product.created_at).toLocaleString();

    openModal('view-product-modal');
  } catch (error) {
    console.error('Error viewing product:', error.message);
    showNotification('Failed to load product details.', 'error');
  }
}

async function openEditProductModal(productId) {
  try {
    const { data: product, error } = await state.supabase
      .from('products')
      .select('*')
      .eq('id', productId)
      .single();

    if (error) throw error;

    document.getElementById('edit-product-id').value = product.id;
    document.getElementById('edit-product-name').value = product.name;
    document.getElementById('edit-product-price').value = product.price;
    document.getElementById('edit-product-description').value = product.description;
    document.getElementById('edit-product-status').value = product.is_active ? 'active' : 'inactive';

    openModal('edit-product-modal');
  } catch (error) {
    console.error('Error opening edit product modal:', error.message);
    showNotification('Failed to load product for editing.', 'error');
  }
}

async function updateProduct() {
  const productId = document.getElementById('edit-product-id').value;
  const name = document.getElementById('edit-product-name').value;
  const price = parseFloat(document.getElementById('edit-product-price').value);
  const description = document.getElementById('edit-product-description').value;
  const isActive = document.getElementById('edit-product-status').value === 'active';

  try {
    const { data, error } = await state.supabase
      .from('products')
      .update({
        name: name,
        price: price,
        description: description,
        is_active: isActive
      })
      .eq('id', productId);

    if (error) throw error;
    showNotification('Product updated successfully!', 'success');
    closeModal('edit-product-modal');
    loadProducts();
  } catch (error) {
    console.error('Error updating product:', error.message);
    showNotification('Failed to update product.', 'error');
  }
}

async function deleteProduct(productId) {
  if (!confirm('Are you sure you want to delete this product? This will also delete associated APK and icon files.')) return;
  try {
    // First, get the product to retrieve file URLs
    const { data: product, error: fetchError } = await state.supabase
      .from('products')
      .select('file_url, apk_icon_url')
      .eq('id', productId)
      .single();

    if (fetchError) throw fetchError;

    // Delete from storage
    if (product.file_url) {
      const filePath = product.file_url.split('/apks/')[1];
      await state.supabase.storage.from('apks').remove([filePath]);
    }
    if (product.apk_icon_url) {
      const iconPath = product.apk_icon_url.split('/apk_icons/')[1];
      await state.supabase.storage.from('apk_icons').remove([iconPath]);
    }

    // Then, delete from database
    const { data, error } = await state.supabase
      .from('products')
      .delete()
      .eq('id', productId);

    if (error) throw error;
    showNotification('Product deleted successfully!', 'success');
    loadProducts();
  } catch (error) {
    console.error('Error deleting product:', error.message);
    showNotification('Failed to delete product.', 'error');
  }
}

// Orders Management (Admin Products)
async function loadOrders() {
  const tableBody = document.getElementById('orders-table-body');
  tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-text-secondary py-8"><div class="loading-spinner mx-auto mb-2"></div>Loading orders...</td></tr>`;
  try {
    const { data: orders, error } = await state.supabase
      .from('orders') // Changed to 'orders' table for admin products
      .select(`
        id,
        profile_id,
        product_id,
        amount,
        payment_method_id,
        receipt_url,
        status,
        created_at,
        products (name),
        profiles (username),
        payment_methods (method_name)
      `)
      .order('created_at', { ascending: false });

    if (error) throw error;

    tableBody.innerHTML = '';
    if (orders.length === 0) {
      tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-text-secondary py-4">No orders found.</td></tr>`;
      return;
    }

    orders.forEach(order => {
      const row = tableBody.insertRow();
      const statusClass = {
        'pending': 'text-yellow-400',
        'approved': 'text-accent-green',
        'rejected': 'text-accent-red',
        'delivered': 'text-blue-400',
        'cancelled': 'text-gray-400'
      }[order.status] || 'text-text-secondary';
      row.innerHTML = `
        <td>${order.profiles ? order.profiles.username : 'Unknown'}</td>
        <td>${order.products ? order.products.name : 'Unknown Product'}</td>
        <td>${order.amount} MMK</td>
        <td>${order.receipt_url ? '<a href="' + order.receipt_url + '" target="_blank" class="text-accent-green hover:underline">View</a>' : 'N/A'}</td>
        <td>
          <span class="${statusClass}">
            ${order.status}
          </span>
        </td>
        <td class="table-actions">
          <button onclick="viewOrder('${order.id}', 'admin')" class="myanmar-btn btn-small">
            View
          </button>
          <button onclick="openEditOrderModal('${order.id}', 'admin', '${order.status}')" class="myanmar-btn btn-small">
            Edit Status
          </button>
          <button onclick="deleteOrder('${order.id}', 'admin')" class="myanmar-btn btn-small btn-danger">
            Delete
          </button>
        </td>
      `;
    });
  } catch (error) {
    console.error('Error loading orders:', error.message);
    tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-accent-red py-4">Failed to load orders.</td></tr>`;
    showNotification('Failed to load orders.', 'error');
  }
}

async function viewOrder(orderId, orderType) {
  try {
    let order;
    if (orderType === 'admin') {
      const { data, error } = await state.supabase
        .from('orders') // Changed to 'orders' table
        .select(`
          id,
          profile_id,
          product_id,
          amount,
          payment_method_id,
          receipt_url,
          status,
          created_at,
          products (name),
          profiles (username),
          payment_methods (method_name)
        `)
        .eq('id', orderId)
        .single();
      if (error) throw error;
      order = data;
    } else if (orderType === 'user') {
      const { data, error } = await state.supabase
        .from('user_orders')
        .select(`
          id,
          user_product_id,
          buyer_profile_id,
          seller_profile_id,
          amount,
          receipt_url,
          status,
          ordered_at,
          user_products (name),
          buyer_profile:profiles!buyer_profile_id(username),
          seller_profile:profiles!seller_profile_id(username)
        `)
        .eq('id', orderId)
        .single();
      if (error) throw error;
      order = data;
    }

    document.getElementById('modal-order-id').textContent = order.id;
    document.getElementById('modal-order-buyer').textContent = orderType === 'admin' ? (order.profiles ? order.profiles.username : 'Unknown') : (order.buyer_profile ? order.buyer_profile.username : 'Unknown');
    document.getElementById('modal-order-product').textContent = orderType === 'admin' ? (order.products ? order.products.name : 'Unknown') : (order.user_products ? order.user_products.name : 'Unknown');
    document.getElementById('modal-order-amount').textContent = order.amount + ' MMK';
    document.getElementById('modal-order-payment-method').textContent = orderType === 'admin' ? (order.payment_methods ? order.payment_methods.method_name : 'N/A') : 'User Payment'; // Simplified for user orders
    document.getElementById('modal-order-receipt-url').href = order.receipt_url || '#';
    document.getElementById('modal-order-receipt-url').textContent = order.receipt_url ? 'View Receipt' : 'No Receipt';
    document.getElementById('modal-order-status').textContent = order.status;
    document.getElementById('modal-order-date').textContent = new Date(order.created_at || order.ordered_at).toLocaleString();

    openModal('view-order-modal');
  } catch (error) {
    console.error('Error viewing order:', error.message);
    showNotification('Failed to load order details.', 'error');
  }
}

function openEditOrderModal(orderId, orderType, currentStatus) {
  document.getElementById('edit-order-id').value = orderId;
  document.getElementById('edit-order-type').value = orderType;
  document.getElementById('edit-order-status-select').value = currentStatus;
  openModal('edit-order-modal');
}

async function updateOrderStatus() {
  const orderId = document.getElementById('edit-order-id').value;
  const orderType = document.getElementById('edit-order-type').value;
  const newStatus = document.getElementById('edit-order-status-select').value;

  try {
    let tableName = orderType === 'admin' ? 'orders' : 'user_orders';
    const { data, error } = await state.supabase
      .from(tableName)
      .update({ status: newStatus })
      .eq('id', orderId);

    if (error) throw error;
    showNotification('Order status updated successfully!', 'success');
    closeModal('edit-order-modal');
    if (orderType === 'admin') {
      loadOrders();
    } else if (orderType === 'user') {
      loadUserOrders();
    }
  } catch (error) {
    console.error('Error updating order status:', error.message);
    showNotification('Failed to update order status.', 'error');
  }
}

async function deleteOrder(orderId, orderType) {
  if (!confirm('Are you sure you want to delete this order?')) return;
  try {
    let tableName = orderType === 'admin' ? 'orders' : 'user_orders';
    const { data, error } = await state.supabase
      .from(tableName)
      .delete()
      .eq('id', orderId);

    if (error) throw error;
    showNotification('Order deleted successfully!', 'success');
    if (orderType === 'admin') {
      loadOrders();
    } else if (orderType === 'user') {
      loadUserOrders();
    }
  } catch (error) {
    console.error('Error deleting order:', error.message);
    showNotification('Failed to delete order.', 'error');
  }
}

// User Products Management
async function loadUserProducts() {
  const tableBody = document.getElementById('user-products-table-body');
  tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-text-secondary py-8"><div class="loading-spinner mx-auto mb-2"></div>Loading user products...</td></tr>`;
  try {
    const { data: userProducts, error } = await state.supabase
      .from('user_products')
      .select(`
        id,
        name,
        description,
        price,
        image_urls,
        is_active,
        is_sold_out,
        created_at,
        seller_profile_id,
        profiles (username)
      `)
      .order('created_at', { ascending: false });

    if (error) throw error;

    tableBody.innerHTML = '';
    if (userProducts.length === 0) {
      tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-text-secondary py-4">No user products found.</td></tr>`;
      return;
    }

    userProducts.forEach(product => {
      const row = tableBody.insertRow();
      const statusText = product.is_active ? (product.is_sold_out ? 'Sold Out' : 'Active') : 'Inactive';
      const statusClass = product.is_active ? (product.is_sold_out ? 'status-inactive' : 'status-active') : 'status-inactive';
      const imageUrl = product.image_urls && product.image_urls.length > 0 ? product.image_urls[0].url : '/placeholder.svg?height=40&width=40';
      row.innerHTML = `
        <td><img src="${imageUrl}" alt="Image" class="w-10 h-10 object-cover rounded-md"></td>
        <td>${product.name}</td>
        <td>${product.profiles ? product.profiles.username : 'Unknown'}</td>
        <td>${product.price} MMK</td>
        <td>
          <span class="${statusClass}">
            ${statusText}
          </span>
        </td>
        <td class="table-actions">
          <button onclick="viewUserProduct('${product.id}')" class="myanmar-btn btn-small">
            View
          </button>
          <button onclick="openEditUserProductModal('${product.id}')" class="myanmar-btn btn-small">
            Edit Status
          </button>
          <button onclick="deleteUserProduct('${product.id}')" class="myanmar-btn btn-small btn-danger">
            Delete
          </button>
        </td>
      `;
    });
  } catch (error) {
    console.error('Error loading user products:', error.message);
    tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-accent-red py-4">Failed to load user products.</td></tr>`;
    showNotification('Failed to load user products.', 'error');
  }
}

async function viewUserProduct(productId) {
  try {
    const { data: product, error } = await state.supabase
      .from('user_products')
      .select(`
        id,
        name,
        description,
        price,
        image_urls,
        is_active,
        is_sold_out,
        created_at,
        seller_profile_id,
        profiles (username, contact_info)
      `)
      .eq('id', productId)
      .single();

    if (error) throw error;

    const imageUrl = product.image_urls && product.image_urls.length > 0 ? product.image_urls[0].url : '/placeholder.svg?height=80&width=80';
    document.getElementById('modal-user-product-image').src = imageUrl;
    document.getElementById('modal-user-product-name').textContent = product.name;
    document.getElementById('modal-user-product-price').textContent = product.price;
    document.getElementById('modal-user-product-description').textContent = product.description;
    document.getElementById('modal-user-product-seller').textContent = product.profiles ? product.profiles.username : 'Unknown';
    document.getElementById('modal-user-product-contact').textContent = product.profiles && product.profiles.contact_info ? JSON.stringify(product.profiles.contact_info) : 'N/A';
    document.getElementById('modal-user-product-status').textContent = product.is_active ? (product.is_sold_out ? 'Sold Out' : 'Active') : 'Inactive';
    document.getElementById('modal-user-product-created-at').textContent = new Date(product.created_at).toLocaleString();

    openModal('view-user-product-modal');
  } catch (error) {
    console.error('Error viewing user product:', error.message);
    showNotification('Failed to load user product details.', 'error');
  }
}

async function openEditUserProductModal(productId) {
  try {
    const { data: product, error } = await state.supabase
      .from('user_products')
      .select('*')
      .eq('id', productId)
      .single();

    if (error) throw error;

    document.getElementById('edit-user-product-id').value = product.id;
    document.getElementById('edit-user-product-name').value = product.name;
    document.getElementById('edit-user-product-price').value = product.price;
    document.getElementById('edit-user-product-description').value = product.description;
    // Assuming status dropdown maps to is_active and is_sold_out
    let statusValue = 'active';
    if (!product.is_active) {
      statusValue = 'inactive';
    } else if (product.is_sold_out) {
      statusValue = 'sold_out'; // Add this option to your select if needed
    }
    document.getElementById('edit-user-product-status').value = statusValue;

    openModal('edit-user-product-modal');
  } catch (error) {
    console.error('Error opening edit user product modal:', error.message);
    showNotification('Failed to load user product for editing.', 'error');
  }
}

async function updateUserProduct() {
  const productId = document.getElementById('edit-user-product-id').value;
  const name = document.getElementById('edit-user-product-name').value;
  const price = parseFloat(document.getElementById('edit-user-product-price').value);
  const description = document.getElementById('edit-user-product-description').value;
  const status = document.getElementById('edit-user-product-status').value; // 'active', 'inactive', 'sold_out'

  let isActive = true;
  let isSoldOut = false;

  if (status === 'inactive') {
    isActive = false;
  } else if (status === 'sold_out') {
    isSoldOut = true;
  }

  try {
    const { data, error } = await state.supabase
      .from('user_products')
      .update({
        name: name,
        price: price,
        description: description,
        is_active: isActive,
        is_sold_out: isSoldOut
      })
      .eq('id', productId);

    if (error) throw error;
    showNotification('User product updated successfully!', 'success');
    closeModal('edit-user-product-modal');
    loadUserProducts();
  } catch (error) {
    console.error('Error updating user product:', error.message);
    showNotification('Failed to update user product.', 'error');
  }
}

async function deleteUserProduct(productId) {
  if (!confirm('Are you sure you want to delete this user product? This will also delete associated image files.')) return;
  try {
    // First, get the product to retrieve image URL
    const { data: product, error: fetchError } = await state.supabase
      .from('user_products')
      .select('image_urls')
      .eq('id', productId)
      .single();

    if (fetchError) throw fetchError;

    // Delete from storage
    if (product.image_urls && product.image_urls.length > 0) {
      for (const img of product.image_urls) {
        const imagePath = img.url.split('/user_product_images/')[1];
        await state.supabase.storage.from('user_product_images').remove([imagePath]);
      }
    }

    // Then, delete from database
    const { data, error } = await state.supabase
      .from('user_products')
      .delete()
      .eq('id', productId);

    if (error) throw error;
    showNotification('User product deleted successfully!', 'success');
    loadUserProducts();
  } catch (error) {
    console.error('Error deleting user product:', error.message);
    showNotification('Failed to delete user product.', 'error');
  }
}

// User Orders Management
async function loadUserOrders() {
  const tableBody = document.getElementById('user-orders-table-body');
  tableBody.innerHTML = `<tr><td colspan="7" class="text-center text-text-secondary py-8"><div class="loading-spinner mx-auto mb-2"></div>Loading user orders...</td></tr>`;
  try {
    const { data: orders, error } = await state.supabase
      .from('user_orders')
      .select(`
        id,
        user_product_id,
        buyer_profile_id,
        seller_profile_id,
        amount,
        receipt_url,
        status,
        ordered_at,
        user_products (name),
        buyer_profile:profiles!buyer_profile_id(username),
        seller_profile:profiles!seller_profile_id(username)
      `)
      .order('ordered_at', { ascending: false });

    if (error) throw error;

    tableBody.innerHTML = '';
    if (orders.length === 0) {
      tableBody.innerHTML = `<tr><td colspan="7" class="text-center text-text-secondary py-4">No user orders found.</td></tr>`;
      return;
    }

    orders.forEach(order => {
      const row = tableBody.insertRow();
      const statusClass = {
        'pending': 'text-yellow-400',
        'approved': 'text-accent-green',
        'rejected': 'text-accent-red',
        'delivered': 'text-blue-400',
        'cancelled': 'text-gray-400'
      }[order.status] || 'text-text-secondary';
      row.innerHTML = `
        <td>${order.user_products ? order.user_products.name : 'Unknown Product'}</td>
        <td>${order.buyer_profile ? order.buyer_profile.username : 'Unknown Buyer'}</td>
        <td>${order.seller_profile ? order.seller_profile.username : 'Unknown Seller'}</td>
        <td>${order.amount} MMK</td>
        <td>${order.receipt_url ? '<a href="' + order.receipt_url + '" target="_blank" class="text-accent-green hover:underline">View</a>' : 'N/A'}</td>
        <td>
          <span class="${statusClass}">
            ${order.status}
          </span>
        </td>
        <td class="table-actions">
          <button onclick="viewOrder('${order.id}', 'user')" class="myanmar-btn btn-small">
            View
          </button>
          <button onclick="openEditOrderModal('${order.id}', 'user', '${order.status}')" class="myanmar-btn btn-small">
            Edit Status
          </button>
          <button onclick="deleteOrder('${order.id}', 'user')" class="myanmar-btn btn-small btn-danger">
            Delete
          </button>
        </td>
      `;
    });
  } catch (error) {
    console.error('Error loading user orders:', error.message);
    tableBody.innerHTML = `<tr><td colspan="7" class="text-center text-accent-red py-4">Failed to load user orders.</td></tr>`;
    showNotification('Failed to load user orders.', 'error');
  }
}

// Payment Methods Management
async function addPaymentMethod() {
  const methodName = document.getElementById('payment-method-name').value;
  const accountInfo = document.getElementById('payment-account-info').value;
  const instructions = document.getElementById('payment-instructions').value;
  const qrCodeFile = document.getElementById('payment-qr-code').files[0];

  if (!methodName || !accountInfo) {
    showNotification('Please fill in method name and account info.', 'error');
    return;
  }

  let qrCodeUrl = null;
  if (qrCodeFile) {
    try {
      const filePath = `payment_qrcodes/${Date.now()}_${qrCodeFile.name}`;
      const { data, error } = await state.supabase.storage.from('payment_qrcodes').upload(filePath, qrCodeFile);
      if (error) throw error;
      const { data: publicUrl } = state.supabase.storage.from('payment_qrcodes').getPublicUrl(filePath);
      qrCodeUrl = publicUrl.publicUrl;
    } catch (error) {
      console.error('Error uploading QR code:', error.message);
      showNotification('Failed to upload QR code.', 'error');
      return;
    }
  }

  try {
    const { data, error } = await state.supabase
      .from('payment_methods') // Changed to 'payment_methods' table for admin payment methods
      .insert([{
        method_name: methodName,
        account_info: accountInfo,
        instructions: instructions || null,
        qr_code_url: qrCodeUrl,
        is_active: true, // Default to active
      }]);

    if (error) throw error;
    showNotification('Payment method added successfully!', 'success');
    document.getElementById('payment-method-name').value = '';
    document.getElementById('payment-account-info').value = '';
    document.getElementById('payment-instructions').value = '';
    document.getElementById('payment-qr-code').value = '';
    loadPaymentMethods();
  } catch (error) {
    console.error('Error adding payment method:', error.message);
    showNotification('Failed to add payment method.', 'error');
  }
}

async function loadPaymentMethods() {
  const tableBody = document.getElementById('payment-methods-table-body');
  tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-text-secondary py-8"><div class="loading-spinner mx-auto mb-2"></div>Loading payment methods...</td></tr>`;
  try {
    const { data: methods, error } = await state.supabase
      .from('payment_methods') // Changed to 'payment_methods' table
      .select('*')
      .order('created_at', { ascending: false });

    if (error) throw error;

    tableBody.innerHTML = '';
    if (methods.length === 0) {
      tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-text-secondary py-4">No payment methods found.</td></tr>`;
      return;
    }

    methods.forEach(method => {
      const row = tableBody.insertRow();
      const statusText = method.is_active ? 'Active' : 'Inactive';
      const statusClass = method.is_active ? 'status-active' : 'status-inactive';
      row.innerHTML = `
        <td>${method.method_name}</td>
        <td>${method.account_info}</td>
        <td>${method.qr_code_url ? '<a href="' + method.qr_code_url + '" target="_blank" class="text-accent-green hover:underline">View QR</a>' : 'N/A'}</td>
        <td>
          <span class="${statusClass}">
            ${statusText}
          </span>
        </td>
        <td class="table-actions">
          <button onclick="viewPaymentMethod('${method.id}')" class="myanmar-btn btn-small">
            View
          </button>
          <button onclick="openEditPaymentMethodModal('${method.id}')" class="myanmar-btn btn-small">
            Edit
          </button>
          <button onclick="deletePaymentMethod('${method.id}')" class="myanmar-btn btn-small btn-danger">
            Delete
          </button>
        </td>
      `;
    });
  } catch (error) {
    console.error('Error loading payment methods:', error.message);
    tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-accent-red py-4">Failed to load payment methods.</td></tr>`;
    showNotification('Failed to load payment methods.', 'error');
  }
}

async function viewPaymentMethod(methodId) {
  try {
    const { data: method, error } = await state.supabase
      .from('payment_methods') // Changed to 'payment_methods' table
      .select('*')
      .eq('id', methodId)
      .single();

    if (error) throw error;

    document.getElementById('modal-payment-method-name').textContent = method.method_name;
    document.getElementById('modal-payment-account-info').textContent = method.account_info;
    document.getElementById('modal-payment-instructions').textContent = method.instructions || 'N/A';
    document.getElementById('modal-payment-qr-code').src = method.qr_code_url || '/placeholder.svg?height=192&width=192';
    document.getElementById('modal-payment-status').textContent = method.is_active ? 'Active' : 'Inactive';
    document.getElementById('modal-payment-created-at').textContent = new Date(method.created_at).toLocaleString();

    openModal('view-payment-method-modal');
  } catch (error) {
    console.error('Error viewing payment method:', error.message);
    showNotification('Failed to load payment method details.', 'error');
  }
}

async function openEditPaymentMethodModal(methodId) {
  try {
    const { data: method, error } = await state.supabase
      .from('payment_methods') // Changed to 'payment_methods' table
      .select('*')
      .eq('id', methodId)
      .single();

    if (error) throw error;

    document.getElementById('edit-payment-method-id').value = method.id;
    document.getElementById('edit-payment-method-name').value = method.method_name;
    document.getElementById('edit-payment-method-account-info').value = method.account_info;
    document.getElementById('edit-payment-instructions').value = method.instructions || '';
    document.getElementById('edit-payment-method-status').value = method.is_active ? 'active' : 'inactive';

    openModal('edit-payment-method-modal');
  } catch (error) {
    console.error('Error opening edit payment method modal:', error.message);
    showNotification('Failed to load payment method for editing.', 'error');
  }
}

async function updatePaymentMethod() {
  const methodId = document.getElementById('edit-payment-method-id').value;
  const methodName = document.getElementById('edit-payment-method-name').value;
  const accountInfo = document.getElementById('edit-payment-account-info').value;
  const instructions = document.getElementById('edit-payment-instructions').value;
  const isActive = document.getElementById('edit-payment-method-status').value === 'active';

  try {
    const { data, error } = await state.supabase
      .from('payment_methods') // Changed to 'payment_methods' table
      .update({
        method_name: methodName,
        account_info: accountInfo,
        instructions: instructions || null,
        is_active: isActive
      })
      .eq('id', methodId);

    if (error) throw error;
    showNotification('Payment method updated successfully!', 'success');
    closeModal('edit-payment-method-modal');
    loadPaymentMethods();
  } catch (error) {
    console.error('Error updating payment method:', error.message);
    showNotification('Failed to update payment method.', 'error');
  }
}

async function deletePaymentMethod(methodId) {
  if (!confirm('Are you sure you want to delete this payment method?')) return;
  try {
    // Get method to delete QR code if exists
    const { data: method, error: fetchError } = await state.supabase
      .from('payment_methods') // Changed to 'payment_methods' table
      .select('qr_code_url')
      .eq('id', methodId)
      .single();

    if (fetchError) throw fetchError;

    if (method.qr_code_url) {
      const qrPath = method.qr_code_url.split('/payment_qrcodes/')[1];
      await state.supabase.storage.from('payment_qrcodes').remove([qrPath]);
    }

    const { data, error } = await state.supabase
      .from('payment_methods') // Changed to 'payment_methods' table
      .delete()
      .eq('id', methodId);

    if (error) throw error;
    showNotification('Payment method deleted successfully!', 'success');
    loadPaymentMethods();
  } catch (error) {
    console.error('Error deleting payment method:', error.message);
    showNotification('Failed to delete payment method.', 'error');
  }
}

// Chat Management
async function loadChatMessages() {
  const chatMessagesDiv = document.getElementById('chat-messages');
  chatMessagesDiv.innerHTML = `<div class="loading-spinner mx-auto mb-4"></div><p class="text-center text-text-secondary">Loading messages...</p>`;
  try {
    // Fetch all conversations involving the adminProfileId
    const { data: conversations, error: convError } = await state.supabase
      .from('buyer_seller_conversations')
      .select(`
        id,
        profile1_id,
        profile2_id,
        profile1:profiles!profile1_id(username, name),
        profile2:profiles!profile2_id(username, name)
      `)
      .or(`profile1_id.eq.${state.adminProfileId},profile2_id.eq.${state.adminProfileId}`);

    if (convError) throw convError;

    if (!conversations || conversations.length === 0) {
      chatMessagesDiv.innerHTML = `<p class="text-center text-text-secondary py-4">No chat conversations found.</p>`;
      return;
    }

    let allMessages = [];
    for (const conv of conversations) {
      const { data: messages, error: msgError } = await state.supabase
        .from('buyer_seller_messages')
        .select(`
          *,
          sender_profile:profiles!sender_profile_id(username, name)
        `)
        .eq('conversation_id', conv.id)
        .order('created_at', { ascending: true });

      if (msgError) {
        console.error(`Error loading messages for conversation ${conv.id}:`, msgError.message);
        continue;
      }
      allMessages = allMessages.concat(messages);
    }

    // Sort all messages by created_at
    allMessages.sort((a, b) => new Date(a.created_at).getTime() - new Date(b.created_at).getTime());

    chatMessagesDiv.innerHTML = '';
    if (allMessages.length === 0) {
      chatMessagesDiv.innerHTML = `<p class="text-center text-text-secondary py-4">No chat messages found.</p>`;
      return;
    }

    allMessages.forEach(msg => {
      const senderName = msg.sender_profile ? msg.sender_profile.name || msg.sender_profile.username : 'Unknown';
      const messageTime = new Date(msg.created_at).toLocaleTimeString('my-MM', { hour: '2-digit', minute: '2-digit' });
      const isSenderAdmin = msg.sender_profile_id === state.adminProfileId;

      let contentHtml = '';
      if (msg.message_type === 'text') {
        contentHtml = `<p class="text-text-primary whitespace-pre-wrap">${msg.content}</p>`;
      } else if (msg.message_type === 'image') {
        contentHtml = `<img src="${msg.file_url}" class="max-w-xs max-h-48 rounded-lg object-contain" alt="Image">`;
      } else if (msg.message_type === 'file') {
        contentHtml = `
          <a href="${msg.file_url}" target="_blank" download class="text-accent-purple hover:underline flex items-center">
            <i class="fas fa-file mr-2"></i> ${msg.file_name || 'File'} (${msg.file_size ? (msg.file_size / 1024).toFixed(2) + ' KB' : ''})
          </a>
        `;
      } else if (msg.message_type === 'order_list') {
        contentHtml = `
          <div class="bg-gray-800 p-3 rounded-lg border border-accent-purple">
            <p class="font-semibold text-accent-green mb-1"><i class="fas fa-clipboard-list mr-1"></i> Order List:</p>
            <p class="text-sm text-text-secondary whitespace-pre-wrap">${msg.content}</p>
          </div>
        `;
      }

      const messageElement = document.createElement('div');
      messageElement.className = `flex ${isSenderAdmin ? 'justify-end' : 'justify-start'} mb-4`;
      messageElement.innerHTML = `
        <div class="flex ${isSenderAdmin ? 'flex-row-reverse' : 'flex-row'} items-start space-x-2 ${isSenderAdmin ? 'space-x-reverse' : ''}">
          <div class="p-3 rounded-lg ${isSenderAdmin ? 'bg-accent-purple text-black' : 'bg-secondary-bg text-text-primary'} max-w-xs md:max-w-md">
            <p class="font-semibold text-sm ${isSenderAdmin ? 'text-black' : 'text-accent-green'}">${senderName}</p>
            ${contentHtml}
            <p class="text-xs text-right ${isSenderAdmin ? 'text-gray-800' : 'text-text-secondary'} mt-1">${messageTime}</p>
          </div>
        </div>
      `;
      chatMessagesDiv.appendChild(messageElement);
    });
    chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight; // Scroll to bottom
  } catch (error) {
    console.error('Error loading chat messages:', error.message);
    chatMessagesDiv.innerHTML = `<p class="text-center text-accent-red py-4">Failed to load chat messages.</p>`;
    showNotification('Failed to load chat messages.', 'error');
  }
}

async function sendChatMessage() {
  const chatInput = document.getElementById('chat-input');
  const messageContent = chatInput.value.trim();

  if (!messageContent) {
    showNotification('Message cannot be empty.', 'error');
    return;
  }

  chatInput.value = ''; // Clear input immediately

  try {
    // For admin global chat, we need to decide which conversation to send to.
    // For simplicity, let's assume admin can send to any active conversation,
    // or we can create a specific "admin-global-chat" conversation if it doesn't exist.
    // For now, let's just insert a message from adminProfileId without a specific conversation.
    // This might need adjustment based on how you want admin to interact in global chat.
    // If it's truly "global", it might not need a conversation_id.
    // If it's for specific buyer-seller chats, admin needs to select a conversation.

    // Let's use a dummy conversation ID for now, or the first one found.
    let conversationId = 'admin_global_chat_id'; // A fixed ID for admin's global messages

    // Check if this dummy conversation exists, if not, create it (simplified)
    const { data: existingConv, error: convCheckError } = await state.supabase
      .from('buyer_seller_conversations')
      .select('id')
      .eq('id', conversationId)
      .single();

    if (convCheckError && convCheckError.code === 'PGRST116') { // No rows found
      // Create a dummy conversation for admin's global messages
      const { error: createConvError } = await state.supabase
        .from('buyer_seller_conversations')
        .insert({ id: conversationId, profile1_id: state.adminProfileId, profile2_id: state.adminProfileId }); // Admin chatting with self for global messages
      if (createConvError) throw createConvError;
    } else if (convCheckError) {
      throw convCheckError;
    }

    const { error } = await state.supabase
      .from('buyer_seller_messages')
      .insert({
        conversation_id: conversationId,
        sender_profile_id: state.adminProfileId,
        content: messageContent,
        message_type: 'text'
      });

    if (error) throw error;
    showNotification('Message sent!', 'success');
    loadChatMessages(); // Reload messages to show the new one
  } catch (error) {
    console.error('Error sending chat message:', error.message);
    showNotification('Failed to send message.', 'error');
  }
}

// Support Tickets Management
async function loadSupportTickets() {
  const tableBody = document.getElementById('support-tickets-table-body');
  tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-text-secondary py-8"><div class="loading-spinner mx-auto mb-2"></div>Loading support tickets...</td></tr>`;
  try {
    const { data: tickets, error } = await state.supabase
      .from('support_messages') // Changed to support_messages table
      .select(`
        id,
        profile_id,
        admin_profile_id,
        content,
        is_from_user,
        priority,
        status,
        created_at,
        profile:profiles!profile_id(username, name)
      `)
      .order('created_at', { ascending: false });

    if (error) throw error;

    tableBody.innerHTML = '';
    if (tickets.length === 0) {
      tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-text-secondary py-4">No support tickets found.</td></tr>`;
      return;
    }

    tickets.forEach(ticket => {
      const row = tableBody.insertRow();
      const statusClass = {
        'open': 'status-active',
        'closed': 'status-inactive',
        'pending': 'text-yellow-400'
      }[ticket.status] || 'text-text-secondary';
      const subject = ticket.content.substring(0, 50) + (ticket.content.length > 50 ? '...' : ''); // Use content as subject for display
      row.innerHTML = `
        <td>${ticket.id.substring(0, 8)}...</td>
        <td>${ticket.profile ? ticket.profile.username : 'Unknown'}</td>
        <td>${subject}</td>
        <td>
          <span class="${statusClass}">
            ${ticket.status}
          </span>
        </td>
        <td>${new Date(ticket.created_at).toLocaleDateString()}</td>
        <td class="table-actions">
          <button onclick="viewSupportTicket('${ticket.id}')" class="myanmar-btn btn-small">
            View
          </button>
          <button onclick="deleteSupportTicket('${ticket.id}')" class="myanmar-btn btn-small btn-danger">
            Delete
          </button>
        </td>
      `;
    });
  } catch (error) {
    console.error('Error loading support tickets:', error.message);
    tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-accent-red py-4">Failed to load support tickets.</td></tr>`;
    showNotification('Failed to load support tickets.', 'error');
  }
}

async function viewSupportTicket(ticketId) {
  try {
    const { data: ticket, error } = await state.supabase
      .from('support_messages') // Changed to support_messages table
      .select(`
        id,
        profile_id,
        admin_profile_id,
        content,
        is_from_user,
        priority,
        status,
        created_at,
        profile:profiles!profile_id(username, name)
      `)
      .eq('id', ticketId)
      .single();

    if (error) throw error;

    document.getElementById('modal-support-id').textContent = ticket.id;
    document.getElementById('modal-support-user').textContent = ticket.profile ? ticket.profile.username : 'Unknown';
    document.getElementById('modal-support-subject').textContent = ticket.content.substring(0, 100) + (ticket.content.length > 100 ? '...' : ''); // Display part of content as subject
    document.getElementById('modal-support-message').textContent = ticket.content;
    document.getElementById('modal-support-status').textContent = ticket.status;
    document.getElementById('modal-support-created-at').textContent = new Date(ticket.created_at).toLocaleString();
    document.getElementById('edit-support-status').value = ticket.status; // Pre-fill status for editing

    openModal('view-support-modal');
  } catch (error) {
    console.error('Error viewing support ticket:', error.message);
    showNotification('Failed to load support ticket details.', 'error');
  }
}

async function updateSupportTicketStatus() {
  const ticketId = document.getElementById('modal-support-id').textContent; // Get ID from modal
  const newStatus = document.getElementById('edit-support-status').value;

  try {
    const { data, error } = await state.supabase
      .from('support_messages') // Changed to support_messages table
      .update({ status: newStatus })
      .eq('id', ticketId);

    if (error) throw error;
    showNotification('Support ticket status updated successfully!', 'success');
    closeModal('view-support-modal');
    loadSupportTickets();
  } catch (error) {
    console.error('Error updating support ticket status:', error.message);
    showNotification('Failed to update support ticket status.', 'error');
  }
}

async function deleteSupportTicket(ticketId) {
  if (!confirm('Are you sure you want to delete this support ticket?')) return;
  try {
    const { data, error } = await state.supabase
      .from('support_messages') // Changed to support_messages table
      .delete()
      .eq('id', ticketId);

    if (error) throw error;
    showNotification('Support ticket deleted successfully!', 'success');
    loadSupportTickets();
  } catch (error) {
    console.error('Error deleting support ticket:', error.message);
    showNotification('Failed to delete support ticket.', 'error');
  }
}


// Initial Load
window.onload = () => { // Changed from DOMContentLoaded to window.onload
  initializeApp(); // Call the new initialization function
  // Store original button texts for loading states
  document.querySelectorAll('.myanmar-btn').forEach(btn => {
    const span = btn.querySelector('span');
    if (span) {
      span.dataset.originalText = span.textContent;
    }
  });
};

</script>
</body>
</html>
