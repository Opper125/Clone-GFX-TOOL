<!DOCTYPE html>
<html lang="my">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>FPS GFX Tool - Admin Panel</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Share+Tech+Mono&family=Noto+Sans+Myanmar:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
/* Custom Fonts */
body {
 font-family: 'Noto Sans Myanmar', 'Inter', sans-serif;
}
h1, h2, h3, .font-orbitron {
 font-family: 'Orbitron', sans-serif;
}
.font-share-tech {
 font-family: 'Share Tech Mono', monospace;
}

/* New Color Palette */
:root {
 --primary-bg: hsl(220 20% 8%); /* Deep Dark Blue-Grey */
 --secondary-bg: hsl(220 20% 12%); /* Slightly Lighter Dark Blue-Grey */
 --accent-purple: hsl(280 80% 60%); /* Vibrant Purple */
 --accent-green: hsl(160 80% 50%); /* Neon Green */
 --accent-red: hsl(0 80% 60%); /* Vibrant Red */
 --text-primary: hsl(220 20% 90%); /* Light Grey */
 --text-secondary: hsl(220 15% 60%); /* Medium Grey */
 --border-color: hsl(220 15% 20%); /* Dark Grey */
 --card-bg: rgba(20, 25, 35, 0.7); /* Dark Translucent */
 --input-bg: rgba(30, 35, 45, 0.6); /* Darker Translucent */
 --table-header-bg: rgba(var(--accent-purple-rgb), 0.15);
 --table-row-hover-bg: rgba(var(--accent-purple-rgb), 0.08);

 /* RGB values for easier use in rgba() */
 --accent-purple-rgb: 199, 56, 255; /* From hsl(280 80% 60%) */
 --accent-green-rgb: 0, 204, 136; /* From hsl(160 80% 50%) */
 --accent-red-rgb: 255, 51, 51; /* From hsl(0 80% 60%) */
}

body {
 background: linear-gradient(135deg, var(--primary-bg) 0%, var(--secondary-bg) 100%);
 min-height: 100vh;
 position: relative;
 overflow-x: hidden;
 color: var(--text-primary);
}

/* Machine operating background animation */
.myanmar-pattern {
 background-image:
   radial-gradient(circle at 25% 25%, rgba(var(--accent-purple-rgb), 0.15) 0%, transparent 50%),
   radial-gradient(circle at 75% 75%, rgba(var(--accent-green-rgb), 0.15) 0%, transparent 50%),
   radial-gradient(circle at 50% 50%, rgba(var(--accent-red-rgb), 0.1) 0%, transparent 50%);
 animation: patternMove 25s ease-in-out infinite;
 position: fixed;
 top: 0;
 left: 0;
 right: 0;
 bottom: 0;
 z-index: -2;
}

@keyframes patternMove {
 0%, 100% { background-position: 0% 0%, 100% 100%, 50% 50%; }
 33% { background-position: 100% 100%, 0% 0%, 75% 25%; }
 66% { background-position: 50% 50%, 75% 25%, 25% 75%; }
}

.myanmar-waves {
 position: fixed;
 bottom: 0;
 left: 0;
 right: 0;
 height: 80px;
 background: linear-gradient(45deg,
   rgba(var(--accent-purple-rgb), 0.2),
   rgba(var(--accent-green-rgb), 0.2),
   rgba(var(--accent-red-rgb), 0.2));
 clip-path: polygon(0 100%, 0 60%, 25% 40%, 50% 60%, 75% 30%, 100% 50%, 100% 100%);
 animation: waveFloat 12s ease-in-out infinite;
 z-index: -1;
}

@keyframes waveFloat {
 0%, 100% { transform: translateY(0px) scaleY(1); }
 50% { transform: translateY(-10px) scaleY(1.1); }
}

.app-card {
 backdrop-filter: blur(20px);
 background: var(--card-bg);
 border: 1px solid var(--border-color);
 box-shadow:
   0 20px 40px -12px rgba(0, 0, 0, 0.8),
   0 0 0 1px rgba(var(--accent-purple-rgb), 0.1),
   inset 0 1px 0 rgba(255, 255, 255, 0.05);
 transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
 border-radius: 16px;
}

.app-card:hover {
 transform: translateY(-2px);
 box-shadow:
   0 25px 50px -12px rgba(var(--accent-purple-rgb), 0.25),
   0 0 0 1px rgba(var(--accent-purple-rgb), 0.2),
   inset 0 1px 0 rgba(255, 255, 255, 0.1);
 border-color: rgba(var(--accent-purple-rgb), 0.5);
}

.myanmar-btn {
 background: linear-gradient(135deg, var(--accent-purple), var(--accent-green));
 color: #000;
 font-weight: 700;
 position: relative;
 overflow: hidden;
 transition: all 0.3s ease;
 text-shadow: 0 1px 2px rgba(0,0,0,0.1);
 border: none;
 border-radius: 12px;
 padding: 12px 20px;
 cursor: pointer;
 box-shadow: 0 5px 15px rgba(var(--accent-purple-rgb), 0.2);
}

.myanmar-btn::before {
 content: '';
 position: absolute;
 top: 0;
 left: -100%;
 width: 100%;
 height: 100%;
 background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
 transition: left 0.6s ease;
}

.myanmar-btn:hover::before {
 left: 100%;
}

.myanmar-btn:hover {
 background: linear-gradient(135deg, var(--accent-green), var(--accent-purple));
 transform: translateY(-1px);
 box-shadow: 0 10px 25px rgba(var(--accent-green-rgb), 0.4);
}

.btn-danger {
 background: linear-gradient(135deg, var(--accent-red), #FF6B6B);
 color: white;
 box-shadow: 0 5px 15px rgba(var(--accent-red-rgb), 0.2);
}

.btn-danger:hover {
 background: linear-gradient(135deg, #FF6B6B, var(--accent-red));
 box-shadow: 0 10px 25px rgba(var(--accent-red-rgb), 0.4);
}

.connection-status {
 position: fixed;
 top: 15px;
 right: 15px;
 z-index: 1000;
 padding: 8px 16px;
 border-radius: 20px;
 font-size: 11px;
 font-weight: 700;
 text-transform: uppercase;
 backdrop-filter: blur(10px);
 animation: statusPulse 2s infinite;
 color: var(--text-primary);
}

.status-online {
 background: linear-gradient(135deg, var(--accent-green), #4ADE80);
 color: white;
 box-shadow: 0 0 20px rgba(var(--accent-green-rgb), 0.5);
}

.status-offline {
 background: linear-gradient(135deg, var(--accent-red), #EF4444);
 color: white;
 animation: statusShake 0.5s ease-in-out;
}

.status-connecting {
 background: linear-gradient(135deg, var(--accent-purple), #FCD34D);
 color: #000;
 animation: statusSpin 1s linear infinite;
}

@keyframes statusPulse {
 0%, 100% { opacity: 1; transform: scale(1); }
 50% { opacity: 0.8; transform: scale(1.05); }
}

@keyframes statusShake {
 0%, 100% { transform: translateX(0); }
 25% { transform: translateX(-3px); }
 75% { transform: translateX(3px); }
}

@keyframes statusSpin {
 from { transform: rotate(0deg); }
 to { transform: rotate(360deg); }
}

.stats-card {
 background: rgba(255, 255, 255, 0.05);
 backdrop-filter: blur(10px);
 border: 1px solid rgba(255, 255, 255, 0.1);
 transition: all 0.3s ease;
 position: relative;
 overflow: hidden;
 border-radius: 12px;
}

.stats-card::before {
 content: '';
 position: absolute;
 top: 0;
 left: 0;
 right: 0;
 height: 3px;
 background: linear-gradient(90deg, var(--accent-purple), var(--accent-green), var(--accent-red));
 opacity: 0;
 transition: opacity 0.3s ease;
}

.stats-card:hover::before {
 opacity: 1;
}

.stats-card:hover {
 transform: translateY(-3px) scale(1.02);
 box-shadow: 0 15px 35px rgba(var(--accent-purple-rgb), 0.2);
 border-color: rgba(var(--accent-purple-rgb), 0.3);
}

.app-input {
 background: var(--input-bg);
 border: 2px solid var(--border-color);
 backdrop-filter: blur(10px);
 color: var(--text-primary);
 transition: all 0.3s ease;
 border-radius: 12px;
 padding: 12px 16px;
}

.app-input:focus {
 border-color: var(--accent-purple);
 background: rgba(30, 35, 45, 0.8);
 outline: none;
 box-shadow: 0 0 25px rgba(var(--accent-purple-rgb), 0.3);
}

.app-input::placeholder {
 color: var(--text-secondary);
}

.app-table {
 backdrop-filter: blur(10px);
 background: rgba(255, 255, 255, 0.03);
 border: 1px solid rgba(255, 255, 255, 0.1);
 border-radius: 12px;
 overflow: hidden;
}

.app-table th {
 background: var(--table-header-bg);
 color: var(--accent-purple);
 font-weight: 700;
 text-transform: uppercase;
 font-size: 12px;
 letter-spacing: 0.5px;
 padding: 12px 8px;
}

.app-table td {
 padding: 12px 8px;
 border-bottom: 1px solid rgba(255, 255, 255, 0.05);
 color: var(--text-primary);
}

.app-table tr:hover {
 background: var(--table-row-hover-bg);
}

/* Machine repairing loading spinner */
.loading-spinner {
 width: 40px;
 height: 40px;
 border: 4px solid rgba(var(--accent-purple-rgb), 0.3);
 border-top: 4px solid var(--accent-purple);
 border-radius: 50%;
 animation: spin 1s linear infinite;
 position: relative;
 display: inline-block;
}

.loading-spinner::before {
 content: '';
 position: absolute;
 top: 50%;
 left: 50%;
 width: 10px;
 height: 10px;
 background: var(--accent-green);
 border-radius: 50%;
 transform: translate(-50%, -50%);
 animation: pulse 1s infinite alternate;
}

@keyframes spin {
 0% { transform: rotate(0deg); }
 100% { transform: rotate(360deg); }
}

@keyframes pulse {
 0% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
 100% { transform: translate(-50%, -50%) scale(1.2); opacity: 0.7; }
}

.notification {
 position: fixed;
 top: 70px;
 right: 15px;
 left: 15px;
 max-width: 400px;
 margin: 0 auto;
 padding: 12px 16px;
 border-radius: 10px;
 color: white;
 font-weight: 600;
 z-index: 1001;
 animation: slideInRight 0.4s ease-out;
 backdrop-filter: blur(15px);
 box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}

@keyframes slideInRight {
 from { transform: translateX(100%); opacity: 0; }
 to { transform: translateX(0); opacity: 1; }
}

.nav-btn {
 transition: all 0.3s ease;
 position: relative;
 border-radius: 8px;
 padding: 8px 12px;
 font-size: 14px;
 color: var(--text-secondary);
 background: rgba(255, 255, 255, 0.05);
 border: 1px solid rgba(255, 255, 255, 0.1);
}

.nav-btn.active {
 background: linear-gradient(135deg, var(--accent-purple), var(--accent-green)) !important;
 color: #000 !important;
 box-shadow: 0 5px 15px rgba(var(--accent-purple-rgb), 0.4);
 border-color: var(--accent-purple) !important;
}

.nav-btn:not(.active):hover {
 background: rgba(var(--accent-purple-rgb), 0.1);
 color: var(--accent-purple);
 border-color: rgba(var(--accent-purple-rgb), 0.3);
}

.fade-in {
 animation: fadeInUp 0.6s ease-out forwards;
}

@keyframes fadeInUp {
 from { opacity: 0; transform: translateY(20px); }
 to { opacity: 1; transform: translateY(0); }
}

.status-active { color: var(--accent-green); }
.status-inactive { color: var(--accent-red); }
.status-banned { color: var(--accent-red); }

.news-card {
 background: rgba(255, 255, 255, 0.05);
 border: 1px solid rgba(255, 255, 255, 0.1);
 border-radius: 12px;
 transition: all 0.3s ease;
 margin-bottom: 16px;
}

.news-card:hover {
 border-color: rgba(var(--accent-purple-rgb), 0.3);
 transform: translateY(-2px);
}

.modal {
 position: fixed;
 top: 0;
 left: 0;
 right: 0;
 bottom: 0;
 background: rgba(0, 0, 0, 0.8);
 display: flex;
 align-items: center;
 justify-content: center;
 z-index: 2000;
 padding: 20px;
}

.modal-content {
 background: var(--card-bg);
 border: 1px solid var(--border-color);
 border-radius: 16px;
 padding: 24px;
 max-width: 90vw;
 max-height: 90vh;
 overflow-y: auto;
 backdrop-filter: blur(20px);
 box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}

/* Mobile optimizations */
@media (max-width: 768px) {
 .container { padding: 8px; }
 .app-card { padding: 16px; margin: 8px; }
 .connection-status { top: 10px; right: 10px; font-size: 9px; padding: 6px 12px; }
 .notification { top: 50px; right: 10px; left: 10px; max-width: none; }
 .stats-card { margin-bottom: 12px; }
 .myanmar-btn { padding: 10px 16px; font-size: 14px; }
 .app-table { font-size: 12px; }
 .app-table th, .app-table td { padding: 8px 4px; }
 h1 { font-size: 20px; }
 h2 { font-size: 18px; }
 h3 { font-size: 16px; }
 .nav-btn { padding: 6px 10px; font-size: 12px; margin: 2px; }
 .modal-content { padding: 16px; max-width: 95vw; }
}

@media (max-width: 480px) {
 .myanmar-pattern { opacity: 0.7; }
 .myanmar-waves { height: 60px; }
 .app-card { padding: 12px; margin: 4px; }
 .grid { gap: 8px; }
 .stats-card { padding: 12px; }
 .app-table th, .app-table td { padding: 6px 2px; font-size: 11px; }
}

/* Scrollbar styling */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: rgba(255,255,255,0.1); }
::-webkit-scrollbar-thumb { background: var(--accent-purple); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--accent-green); }

/* Loading overlay */
.loading-overlay {
 backdrop-filter: blur(8px);
 background: rgba(0,0,0,0.7);
}

.btn-small {
 padding: 6px 12px;
 font-size: 12px;
 border-radius: 8px;
}

.table-actions {
 display: flex;
 gap: 4px;
 flex-wrap: wrap;
}

.hidden { display: none !important; }

/* Search input specific styles */
.search-input-container {
 position: relative;
}
.search-input-container .app-input {
 padding-left: 40px; /* Space for icon */
}
.search-input-container .search-icon {
 position: absolute;
 left: 12px;
 top: 50%;
 transform: translateY(-50%);
 color: var(--text-secondary);
 pointer-events: none;
}

/* Chat List Item */
.chat-list-item {
 background: rgba(255, 255, 255, 0.05);
 border: 1px solid rgba(255, 255, 255, 0.1);
 border-radius: 12px;
 padding: 12px;
 display: flex;
 align-items: center;
 gap: 12px;
 cursor: pointer;
 transition: all 0.2s ease;
 margin-bottom: 8px;
}

.chat-list-item:hover {
 background: rgba(var(--accent-green-rgb), 0.1);
 border-color: rgba(var(--accent-green-rgb), 0.3);
}

.chat-list-item.active {
 background: linear-gradient(135deg, rgba(var(--accent-purple-rgb), 0.2), rgba(var(--accent-green-rgb), 0.2));
 border-color: var(--accent-purple);
}

</style>
</head>
<body class="text-white">
<div class="myanmar-pattern"></div>
<div class="myanmar-waves"></div>

 Connection Status 
<div id="connection-status" class="connection-status status-connecting">
<i class="fas fa-wifi"></i> ချိတ်ဆက်နေသည်...
</div>

 Main Container 
<div class="container mx-auto px-2 py-4 max-w-6xl">
 Header 
<div class="text-center mb-6 fade-in">
 <h1 class="text-2xl md:text-3xl lg:text-4xl font-orbitron font-bold mb-2 text-accent-purple">
   <i class="fas fa-shield-alt mr-2"></i>
   FPS GFX Tool
 </h1>
 <h2 class="text-lg md:text-xl lg:text-2xl font-orbitron font-semibold text-accent-green mb-2">
   ADMIN PANEL
 </h2>
 <div class="inline-block px-4 py-2 bg-gradient-to-r from-accent-purple to-accent-green text-black rounded-full font-bold text-sm">
   <i class="fas fa-user-shield mr-1"></i> ADMINISTRATOR INTERFACE
 </div>
</div>

 Notification Container 
<div id="notification-container"></div>

 Login Section 
<div id="login-section" class="max-w-md mx-auto fade-in">
 <div class="app-card p-6">
   <h3 class="text-xl md:text-2xl font-orbitron font-bold text-center mb-6 text-accent-purple">
     <i class="fas fa-user-shield mr-2"></i>
     ADMIN LOGIN
   </h3>
   <div class="space-y-4">
     <div class="relative search-input-container">
       <input
         type="text"
         id="admin-username"
         placeholder="Admin Username"
         class="app-input w-full"
       >
       <i class="fas fa-user search-icon"></i>
     </div>
     <div class="relative search-input-container">
       <input
         type="password"
         id="admin-password"
         placeholder="Admin Password"
         class="app-input w-full"
       >
       <i class="fas fa-lock search-icon"></i>
     </div>
     <button
       onclick="adminLogin()"
       id="login-btn"
       class="myanmar-btn w-full flex items-center justify-center space-x-2"
     >
       <i class="fas fa-sign-in-alt"></i>
       <span id="login-text">LOGIN</span>
     </button>
   </div>
 </div>
</div>

 Main Admin Content 
<div id="admin-content" class="hidden">
   Navigation 
 <div class="flex flex-wrap justify-center gap-2 md:gap-4 mb-6">
   <button onclick="showSection('dashboard', this)" class="nav-btn active">
     <i class="fas fa-tachometer-alt mr-1"></i>
     <span class="hidden sm:inline">DASHBOARD</span>
     <span class="sm:hidden">Dash</span>
   </button>
   <button onclick="showSection('users', this)" class="nav-btn">
     <i class="fas fa-users mr-1"></i>
     <span class="hidden sm:inline">USERS</span>
     <span class="sm:hidden">Users</span>
   </button>
   <button onclick="showSection('keys', this)" class="nav-btn">
     <i class="fas fa-key mr-1"></i>
     <span class="hidden sm:inline">KEYS</span>
     <span class="sm:hidden">Keys</span>
   </button>
   <button onclick="showSection('news', this)" class="nav-btn">
     <i class="fas fa-newspaper mr-1"></i>
     <span class="hidden sm:inline">NEWS</span>
     <span class="sm:hidden">News</span>
   </button>
   <button onclick="showSection('products', this)" class="nav-btn">
     <i class="fas fa-box-open mr-1"></i>
     <span class="hidden sm:inline">PRODUCTS</span>
     <span class="sm:hidden">Products</span>
   </button>
   <button onclick="showSection('user-products', this)" class="nav-btn">
     <i class="fas fa-store mr-1"></i>
     <span class="hidden sm:inline">USER PRODUCTS</span>
     <span class="sm:hidden">U-Prods</span>
   </button>
   <button onclick="showSection('orders', this)" class="nav-btn">
     <i class="fas fa-receipt mr-1"></i>
     <span class="hidden sm:inline">ORDERS</span>
     <span class="sm:hidden">Orders</span>
   </button>
   <button onclick="showSection('payment-methods', this)" class="nav-btn">
     <i class="fas fa-wallet mr-1"></i>
     <span class="hidden sm:inline">PAYMENT METHODS</span>
     <span class="sm:hidden">Payments</span>
   </button>
   <button onclick="showSection('chat', this)" class="nav-btn">
     <i class="fas fa-comments mr-1"></i>
     <span class="hidden sm:inline">CHAT</span>
     <span class="sm:hidden">Chat</span>
   </button>
   <button onclick="showSection('support', this)" class="nav-btn">
     <i class="fas fa-headset mr-1"></i>
     <span class="hidden sm:inline">SUPPORT</span>
     <span class="sm:hidden">Support</span>
   </button>
   <button onclick="showSection('about', this)" class="nav-btn">
     <i class="fas fa-info-circle mr-1"></i>
     <span class="hidden sm:inline">ABOUT</span>
     <span class="sm:hidden">About</span>
   </button>
   <button onclick="adminLogout()" class="nav-btn btn-danger">
     <i class="fas fa-sign-out-alt mr-1"></i>
     <span class="hidden sm:inline">LOGOUT</span>
     <span class="sm:hidden">Logout</span>
   </button>
 </div>

   Dashboard Section 
 <div id="dashboard-section" class="admin-section">
   <div class="app-card p-4 md:p-8 text-center">
     <h3 class="text-lg md:text-xl font-orbitron font-bold mb-4 text-accent-purple">
       <i class="fas fa-tachometer-alt mr-2"></i>
       ADMIN DASHBOARD OVERVIEW
     </h3>
     <p class="text-text-secondary">
       Welcome, <span id="admin-name" class="font-semibold text-accent-green">Admin</span>!
     </p>
     <div class="mt-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
       <div class="stats-card p-4">
         <i class="fas fa-users text-2xl text-blue-400 mb-2"></i>
         <h4 class="text-sm font-semibold text-text-secondary">TOTAL USERS</h4>
         <p id="total-users" class="text-lg font-bold text-accent-purple">0</p>
       </div>
       <div class="stats-card p-4">
         <i class="fas fa-key text-2xl text-yellow-400 mb-2"></i>
         <h4 class="text-sm font-semibold text-text-secondary">ACTIVE KEYS</h4>
         <p id="active-keys" class="text-lg font-bold text-accent-green">0</p>
       </div>
       <div class="stats-card p-4">
         <i class="fas fa-newspaper text-2xl text-purple-400 mb-2"></i>
         <h4 class="text-sm font-semibold text-text-secondary">TOTAL NEWS POSTS</h4>
         <p id="total-news" class="text-lg font-bold text-accent-purple">0</p>
       </div>
       <div class="stats-card p-4">
         <i class="fas fa-box-open text-2xl text-orange-400 mb-2"></i>
         <h4 class="text-sm font-semibold text-text-secondary">TOTAL ADMIN PRODUCTS</h4>
         <p id="total-admin-products" class="text-lg font-bold text-accent-green">0</p>
       </div>
       <div class="stats-card p-4">
         <i class="fas fa-store text-2xl text-red-400 mb-2"></i>
         <h4 class="text-sm font-semibold text-text-secondary">TOTAL USER PRODUCTS</h4>
         <p id="total-user-products" class="text-lg font-bold text-accent-purple">0</p>
       </div>
       <div class="stats-card p-4">
         <i class="fas fa-receipt text-2xl text-green-400 mb-2"></i>
         <h4 class="text-sm font-semibold text-text-secondary">PENDING ORDERS</h4>
         <p id="pending-orders" class="text-lg font-bold text-accent-red">0</p>
       </div>
     </div>
   </div>
 </div>

   Users Section 
 <div id="users-section" class="admin-section hidden">
   <div class="app-card p-4 md:p-8">
     <h3 class="text-lg md:text-xl font-orbitron font-bold mb-6 text-accent-purple flex items-center">
       <i class="fas fa-users mr-3"></i>
       MANAGE USERS
     </h3>
     <div class="relative search-input-container mb-4">
       <input type="text" id="search-users" placeholder="Search Users by Username or Name..." class="app-input w-full" onkeyup="filterTable('users-table-body', this.value)">
       <i class="fas fa-search search-icon"></i>
     </div>
     <div class="overflow-x-auto">
       <table class="app-table w-full">
         <thead>
           <tr>
             <th class="text-left">USERNAME</th>
             <th class="text-left">NAME</th>
             <th class="text-left">KEY ID</th>
             <th class="text-left">STATUS</th>
             <th class="text-left">ACTIONS</th>
           </tr>
         </thead>
         <tbody id="users-table-body">
           <tr>
             <td colspan="5" class="text-center text-text-secondary py-8">
               <div class="loading-spinner mx-auto mb-2"></div>
               Loading users...
             </td>
           </tr>
         </tbody>
       </table>
     </div>
   </div>
 </div>

   Keys Section 
 <div id="keys-section" class="admin-section hidden">
   <div class="app-card p-4 md:p-8">
     <h3 class="text-lg md:text-xl font-orbitron font-bold mb-6 text-accent-purple flex items-center">
       <i class="fas fa-key mr-3"></i>
       MANAGE KEYS
     </h3>
     <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6 mb-6">
       <div>
         <label class="block text-sm font-medium mb-2 text-text-secondary">KEY TEXT</label>
         <input type="text" id="new-key-text" placeholder="Unique Key" class="app-input w-full">
       </div>
       <div>
         <label class="block text-sm font-medium mb-2 text-text-secondary">EXPIRY DATE (Optional)</label>
         <input type="date" id="new-key-expiry" class="app-input w-full">
       </div>
       <div class="md:col-span-2">
         <button onclick="addKey()" class="myanmar-btn w-full flex items-center justify-center space-x-2">
           <i class="fas fa-plus-circle"></i>
           <span>ADD NEW KEY</span>
         </button>
       </div>
     </div>

     <div class="relative search-input-container mb-4">
       <input type="text" id="search-keys" placeholder="Search Keys..." class="app-input w-full" onkeyup="filterTable('keys-table-body', this.value)">
       <i class="fas fa-search search-icon"></i>
     </div>
     <div class="overflow-x-auto">
       <table class="app-table w-full">
         <thead>
           <tr>
             <th class="text-left">KEY</th>
             <th class="text-left">EXPIRY</th>
             <th class="text-left">STATUS</th>
             <th class="text-left">USED BY</th>
             <th class="text-left">ACTIONS</th>
           </tr>
         </thead>
         <tbody id="keys-table-body">
           <tr>
             <td colspan="5" class="text-center text-text-secondary py-8">
               <div class="loading-spinner mx-auto mb-2"></div>
               Loading keys...
             </td>
           </tr>
         </tbody>
       </table>
     </div>
   </div>
 </div>

   News Section 
 <div id="news-section" class="admin-section hidden">
   <div class="app-card p-4 md:p-8">
     <h3 class="text-lg md:text-xl font-orbitron font-bold mb-6 text-accent-purple flex items-center">
       <i class="fas fa-newspaper mr-3"></i>
       MANAGE NEWS
     </h3>
      News Sub-navigation 
     <div class="flex flex-wrap justify-center gap-2 md:gap-4 mb-6">
       <button onclick="showNewsSubSection('admin-news', this)" class="nav-btn active">
         <i class="fas fa-user-shield mr-1"></i>
         <span class="hidden sm:inline">ADMIN NEWS</span>
         <span class="sm:hidden">Admin</span>
       </button>
       <button onclick="showNewsSubSection('user-news', this)" class="nav-btn">
         <i class="fas fa-users mr-1"></i>
         <span class="hidden sm:inline">USER NEWS</span>
         <span class="sm:hidden">User</span>
       </button>
     </div>

      Admin News Subsection 
     <div id="admin-news-subsection" class="news-subsection">
       <h4 class="text-md font-orbitron font-bold mb-4 text-accent-green flex items-center">
         <i class="fas fa-plus-circle mr-2"></i>
         POST NEW ADMIN NEWS
       </h4>
       <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6 mb-6">
         <div>
           <label class="block text-sm font-medium mb-2 text-text-secondary">NEWS TITLE</label>
           <input type="text" id="admin-news-title" placeholder="News Title" class="app-input w-full">
         </div>
         <div class="md:col-span-2">
           <label class="block text-sm font-medium mb-2 text-text-secondary">NEWS CONTENT</label>
           <textarea id="admin-news-content" placeholder="News Content..." rows="4" class="app-input w-full resize-none"></textarea>
         </div>
         <div>
           <label class="block text-sm font-medium mb-2 text-text-secondary">MEDIA (IMAGE/VIDEO) OPTIONAL</label>
           <input type="file" id="admin-news-media" accept="image/*,video/*" multiple class="app-input w-full">
         </div>
         <div>
           <label class="block text-sm font-medium mb-2 text-text-secondary">YOUTUBE LINK (OPTIONAL)</label>
           <input type="url" id="admin-news-youtube" placeholder="https://youtube.com/..." class="app-input w-full">
         </div>
         <div>
           <label class="block text-sm font-medium mb-2 text-text-secondary">TIKTOK LINK (OPTIONAL)</label>
           <input type="url" id="admin-news-tiktok" placeholder="https://tiktok.com/@..." class="app-input w-full">
         </div>
         <div>
           <label class="block text-sm font-medium mb-2 text-text-secondary">TELEGRAM LINK (OPTIONAL)</label>
           <input type="url" id="admin-news-telegram" placeholder="https://t.me/..." class="app-input w-full">
         </div>
         <div>
           <label class="block text-sm font-medium mb-2 text-text-secondary">FACEBOOK LINK (OPTIONAL)</label>
           <input type="url" id="admin-news-facebook" placeholder="https://facebook.com/..." class="app-input w-full">
         </div>
         <div class="flex items-end">
           <button onclick="postAdminNews()" id="post-admin-news-btn" class="myanmar-btn w-full flex items-center justify-center space-x-2">
             <i class="fas fa-paper-plane"></i>
             <span>POST NEWS</span>
           </button>
         </div>
       </div>

       <h4 class="text-md font-orbitron font-bold mb-4 mt-8 text-accent-green flex items-center">
         <i class="fas fa-list-alt mr-2"></i>
         ADMIN NEWS LIST
       </h4>
       <div class="relative search-input-container mb-4">
         <input type="text" id="search-admin-news" placeholder="Search Admin News..." class="app-input w-full" onkeyup="filterTable('admin-news-table-body', this.value)">
         <i class="fas fa-search search-icon"></i>
       </div>
       <div class="overflow-x-auto">
         <table class="app-table w-full">
           <thead>
             <tr>
               <th class="text-left">TITLE</th>
               <th class="text-left">VIEWS</th>
               <th class="text-left">LIKES</th>
               <th class="text-left">PUBLISHED</th>
               <th class="text-left">ACTIONS</th>
             </tr>
           </thead>
           <tbody id="admin-news-table-body">
             <tr>
               <td colspan="5" class="text-center text-text-secondary py-8">
                 <div class="loading-spinner mx-auto mb-2"></div>
                 Loading admin news...
               </td>
             </tr>
           </tbody>
         </table>
       </div>
     </div>

      User News Subsection 
     <div id="user-news-subsection" class="news-subsection hidden">
       <h4 class="text-md font-orbitron font-bold mb-4 text-accent-green flex items-center">
         <i class="fas fa-list-alt mr-2"></i>
         USER POSTED NEWS
       </h4>
       <div class="relative search-input-container mb-4">
         <input type="text" id="search-user-news" placeholder="Search User News..." class="app-input w-full" onkeyup="filterTable('user-news-table-body', this.value)">
         <i class="fas fa-search search-icon"></i>
       </div>
       <div class="overflow-x-auto">
         <table class="app-table w-full">
           <thead>
             <tr>
               <th class="text-left">TITLE</th>
               <th class="text-left">AUTHOR</th>
               <th class="text-left">VIEWS</th>
               <th class="text-left">LIKES</th>
               <th class="text-left">PUBLISHED</th>
               <th class="text-left">ACTIONS</th>
             </tr>
           </thead>
           <tbody id="user-news-table-body">
             <tr>
               <td colspan="6" class="text-center text-text-secondary py-8">
                 <div class="loading-spinner mx-auto mb-2"></div>
                 Loading user news...
               </td>
             </tr>
           </tbody>
         </table>
       </div>
     </div>
   </div>
 </div>

   Products Section (Admin Products) 
 <div id="products-section" class="admin-section hidden">
   <div class="app-card p-4 md:p-8">
     <h3 class="text-lg md:text-xl font-orbitron font-bold mb-6 text-accent-purple flex items-center">
       <i class="fas fa-box-open mr-3"></i>
       MANAGE ADMIN PRODUCTS & APKS
     </h3>
     <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6 mb-6">
       <div>
         <label class="block text-sm font-medium mb-2 text-text-secondary">PRODUCT NAME</label>
         <input type="text" id="product-name" placeholder="Product Name" class="app-input w-full">
       </div>
       <div>
         <label class="block text-sm font-medium mb-2 text-text-secondary">PRICE (MMK)</label>
         <input type="number" id="product-price" placeholder="0.00" min="0" step="0.01" class="app-input w-full">
       </div>
       <div class="md:col-span-2">
         <label class="block text-sm font-medium mb-2 text-text-secondary">DESCRIPTION</label>
         <textarea id="product-description" placeholder="Product Description..." rows="3" class="app-input w-full resize-none"></textarea>
       </div>
       <div>
         <label class="block text-sm font-medium mb-2 text-text-secondary">APK FILE</label>
         <input type="file" id="product-file" accept=".apk,.zip,.rar" class="app-input w-full">
       </div>
       <div>
         <label class="block text-sm font-medium mb-2 text-text-secondary">APK ICON (Optional)</label>
         <input type="file" id="product-icon" accept="image/*" class="app-input w-full">
       </div>
       <div class="md:col-span-2">
         <button onclick="uploadProduct()" id="upload-product-btn" class="myanmar-btn w-full flex items-center justify-center space-x-2">
           <i class="fas fa-upload"></i>
           <span>UPLOAD PRODUCT</span>
         </button>
       </div>
     </div>

     <h4 class="text-md font-orbitron font-bold mb-4 mt-8 text-accent-green flex items-center">
       <i class="fas fa-list-alt mr-2"></i>
       ADMIN PRODUCT LIST
     </h4>
     <div class="relative search-input-container mb-4">
       <input type="text" id="search-products" placeholder="Search Products..." class="app-input w-full" onkeyup="filterTable('products-table-body', this.value)">
       <i class="fas fa-search search-icon"></i>
     </div>
     <div class="overflow-x-auto">
       <table class="app-table w-full">
         <thead>
           <tr>
             <th class="text-left">ICON</th>
             <th class="text-left">NAME</th>
             <th class="text-left">PRICE</th>
             <th class="text-left">FILE SIZE</th>
             <th class="text-left">ACTIVE</th>
             <th class="text-left">ACTIONS</th>
           </tr>
         </thead>
         <tbody id="products-table-body">
           <tr>
             <td colspan="6" class="text-center text-text-secondary py-8">
               <div class="loading-spinner mx-auto mb-2"></div>
               Loading products...
             </td>
           </tr>
         </tbody>
       </table>
     </div>
   </div>
 </div>

   User Products Section 
 <div id="user-products-section" class="admin-section hidden">
   <div class="app-card p-4 md:p-8">
     <h3 class="text-lg md:text-xl font-orbitron font-bold mb-6 text-accent-purple flex items-center">
       <i class="fas fa-store mr-3"></i>
       MANAGE USER PRODUCTS
     </h3>
     <div class="relative search-input-container mb-4">
       <input type="text" id="search-user-products" placeholder="Search User Products..." class="app-input w-full" onkeyup="filterTable('user-products-table-body', this.value)">
       <i class="fas fa-search search-icon"></i>
     </div>
     <div class="overflow-x-auto">
       <table class="app-table w-full">
         <thead>
           <tr>
             <th class="text-left">IMAGE</th>
             <th class="text-left">NAME</th>
             <th class="text-left">SELLER</th>
             <th class="text-left">PRICE</th>
             <th class="text-left">ACTIVE</th>
             <th class="text-left">SOLD OUT</th>
             <th class="text-left">ACTIONS</th>
           </tr>
         </thead>
         <tbody id="user-products-table-body">
           <tr>
             <td colspan="7" class="text-center text-text-secondary py-8">
               <div class="loading-spinner mx-auto mb-2"></div>
               Loading user products...
             </td>
           </tr>
         </tbody>
       </table>
     </div>
   </div>
 </div>

   Orders Section 
 <div id="orders-section" class="admin-section hidden">
   <div class="app-card p-4 md:p-8">
     <h3 class="text-lg md:text-xl font-orbitron font-bold mb-6 text-accent-purple flex items-center">
       <i class="fas fa-receipt mr-3"></i>
       MANAGE ORDERS
     </h3>
      Orders Sub-navigation 
     <div class="flex flex-wrap justify-center gap-2 md:gap-4 mb-6">
       <button onclick="showOrdersSubSection('admin-product-orders', this)" class="nav-btn active">
         <i class="fas fa-box-open mr-1"></i>
         <span class="hidden sm:inline">ADMIN PRODUCT ORDERS</span>
         <span class="sm:hidden">Admin Prod</span>
       </button>
       <button onclick="showOrdersSubSection('user-product-orders', this)" class="nav-btn">
         <i class="fas fa-store mr-1"></i>
         <span class="hidden sm:inline">USER PRODUCT ORDERS</span>
         <span class="sm:hidden">User Prod</span>
       </button>
     </div>

      Admin Product Orders Subsection 
     <div id="admin-product-orders-subsection" class="orders-subsection">
       <h4 class="text-md font-orbitron font-bold mb-4 text-accent-green flex items-center">
         <i class="fas fa-list-alt mr-2"></i>
         ADMIN PRODUCT ORDERS LIST
       </h4>
       <div class="relative search-input-container mb-4">
         <input type="text" id="search-admin-orders" placeholder="Search Admin Product Orders..." class="app-input w-full" onkeyup="filterTable('admin-orders-table-body', this.value)">
         <i class="fas fa-search search-icon"></i>
       </div>
       <div class="overflow-x-auto">
         <table class="app-table w-full">
           <thead>
             <tr>
               <th class="text-left">BUYER</th>
               <th class="text-left">PRODUCT</th>
               <th class="text-left">AMOUNT</th>
               <th class="text-left">RECEIPT</th>
               <th class="text-left">STATUS</th>
               <th class="text-left">ACTIONS</th>
             </tr>
           </thead>
           <tbody id="admin-orders-table-body">
             <tr>
               <td colspan="6" class="text-center text-text-secondary py-8">
                 <div class="loading-spinner mx-auto mb-2"></div>
                 Loading admin product orders...
               </td>
             </tr>
           </tbody>
         </table>
       </div>
     </div>

      User Product Orders Subsection 
     <div id="user-product-orders-subsection" class="orders-subsection hidden">
       <h4 class="text-md font-orbitron font-bold mb-4 text-accent-green flex items-center">
         <i class="fas fa-list-alt mr-2"></i>
         USER PRODUCT ORDERS LIST
       </h4>
       <div class="relative search-input-container mb-4">
         <input type="text" id="search-user-orders" placeholder="Search User Product Orders..." class="app-input w-full" onkeyup="filterTable('user-orders-table-body', this.value)">
         <i class="fas fa-search search-icon"></i>
       </div>
       <div class="overflow-x-auto">
         <table class="app-table w-full">
           <thead>
             <tr>
               <th class="text-left">BUYER</th>
               <th class="text-left">SELLER</th>
               <th class="text-left">PRODUCT</th>
               <th class="text-left">AMOUNT</th>
               <th class="text-left">RECEIPT</th>
               <th class="text-left">STATUS</th>
               <th class="text-left">ACTIONS</th>
             </tr>
           </thead>
           <tbody id="user-orders-table-body">
             <tr>
               <td colspan="7" class="text-center text-text-secondary py-8">
                 <div class="loading-spinner mx-auto mb-2"></div>
                 Loading user product orders...
               </td>
             </tr>
           </tbody>
         </table>
       </div>
     </div>
   </div>
 </div>

   Payment Methods Section 
 <div id="payment-methods-section" class="admin-section hidden">
   <div class="app-card p-4 md:p-8">
     <h3 class="text-lg md:text-xl font-orbitron font-bold mb-6 text-accent-purple flex items-center">
       <i class="fas fa-wallet mr-3"></i>
       MANAGE PAYMENT METHODS
     </h3>
     <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6 mb-6">
       <div>
         <label class="block text-sm font-medium mb-2 text-text-secondary">METHOD NAME</label>
         <input type="text" id="payment-method-name" placeholder="KBZ Pay / Wave Money" class="app-input w-full">
       </div>
       <div>
         <label class="block text-sm font-medium mb-2 text-text-secondary">ACCOUNT INFO</label>
         <input type="text" id="payment-account-info" placeholder="Phone Number / Account Number" class="app-input w-full">
       </div>
       <div class="md:col-span-2">
         <label class="block text-sm font-medium mb-2 text-text-secondary">INSTRUCTIONS</label>
         <textarea id="payment-instructions" placeholder="Instructions for transfer..." rows="2" class="app-input w-full resize-none"></textarea>
       </div>
       <div>
         <label class="block text-sm font-medium mb-2 text-text-secondary">QR CODE IMAGE (OPTIONAL)</label>
         <input type="file" id="payment-qr-code" accept="image/*" class="app-input w-full">
       </div>
       <div class="flex items-end">
         <button onclick="addPaymentMethod()" class="myanmar-btn w-full flex items-center justify-center space-x-2">
           <i class="fas fa-plus"></i>
           <span>ADD NEW METHOD</span>
         </button>
       </div>
     </div>

     <div class="relative search-input-container mb-4">
       <input type="text" id="search-payment-methods" placeholder="Search Payment Methods..." class="app-input w-full" onkeyup="filterTable('payment-methods-table-body', this.value)">
       <i class="fas fa-search search-icon"></i>
     </div>
     <div class="overflow-x-auto">
       <table class="app-table w-full">
         <thead>
           <tr>
             <th class="text-left">METHOD</th>
             <th class="text-left">ACCOUNT INFO</th>
             <th class="text-left">QR CODE</th>
             <th class="text-left">STATUS</th>
             <th class="text-left">ACTIONS</th>
           </tr>
         </thead>
         <tbody id="payment-methods-table-body">
           <tr>
             <td colspan="5" class="text-center text-text-secondary py-8">
               <div class="loading-spinner mx-auto mb-2"></div>
               Loading payment methods...
             </td>
           </tr>
         </tbody>
       </table>
     </div>
   </div>
 </div>

   Chat Section (Global Chat & Private Chat List) 
 <div id="chat-section" class="admin-section hidden">
   <div class="app-card p-4 md:p-8">
     <h3 class="text-lg md:text-xl font-orbitron font-bold mb-6 text-accent-purple flex items-center">
       <i class="fas fa-comments mr-3"></i>
       CHAT
     </h3>
      Chat Sub-navigation 
     <div class="flex flex-wrap justify-center gap-2 md:gap-4 mb-6">
       <button onclick="showChatSubSection('global-chat', this)" class="nav-btn active">
         <i class="fas fa-globe mr-1"></i>
         <span class="hidden sm:inline">GLOBAL CHAT</span>
         <span class="sm:hidden">Global</span>
       </button>
       <button onclick="showChatSubSection('private-chats', this)" class="nav-btn">
         <i class="fas fa-user-friends mr-1"></i>
         <span class="hidden sm:inline">PRIVATE CHATS</span>
         <span class="sm:hidden">Private</span>
       </button>
     </div>

      Global Chat Subsection 
     <div id="global-chat-subsection" class="chat-subsection">
       <h4 class="text-md font-orbitron font-bold mb-4 text-accent-green flex items-center">
         <i class="fas fa-globe mr-2"></i>
         GLOBAL CHAT WITH USERS
       </h4>
       <div id="chat-messages" class="bg-black bg-opacity-30 rounded-xl p-4 h-64 md:h-96 overflow-y-auto mb-6 border border-gray-700">
         <div class="loading-spinner mx-auto mb-4"></div>
         <p class="text-center text-text-secondary">Loading messages...</p>
       </div>
       <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-4">
         <textarea id="chat-input" placeholder="Type your message..." rows="3"
                   class="app-input flex-1 resize-none"></textarea>
         <button onclick="sendChatMessage()"
                 class="myanmar-btn flex items-center justify-center space-x-2 md:self-end">
           <i class="fas fa-paper-plane"></i>
           <span>SEND</span>
         </button>
       </div>
     </div>

      Private Chats Subsection 
     <div id="private-chats-subsection" class="chat-subsection hidden">
       <h4 class="text-md font-orbitron font-bold mb-4 text-accent-green flex items-center">
         <i class="fas fa-user-friends mr-2"></i>
         PRIVATE CONVERSATIONS WITH USERS
       </h4>
       <div id="private-chat-list" class="space-y-2">
         <div class="loading-spinner mx-auto mb-4"></div>
         <p class="text-center text-text-secondary">Loading private chats...</p>
       </div>
     </div>
   </div>
 </div>

   Support Section 
 <div id="support-section" class="admin-section hidden">
   <div class="app-card p-4 md:p-8">
     <h3 class="text-lg md:text-xl font-orbitron font-bold mb-6 text-accent-purple flex items-center">
       <i class="fas fa-headset mr-3"></i>
       MANAGE SUPPORT MESSAGES
     </h3>
     <div class="relative search-input-container mb-4">
       <input type="text" id="search-support-messages" placeholder="Search Support Messages..." class="app-input w-full" onkeyup="filterTable('support-messages-table-body', this.value)">
       <i class="fas fa-search search-icon"></i>
     </div>
     <div class="overflow-x-auto">
       <table class="app-table w-full">
         <thead>
           <tr>
             <th class="text-left">SENDER</th>
             <th class="text-left">MESSAGE</th>
             <th class="text-left">SENT AT</th>
             <th class="text-left">STATUS</th>
             <th class="text-left">ACTIONS</th>
           </tr>
         </thead>
         <tbody id="support-messages-table-body">
           <tr>
             <td colspan="5" class="text-center text-text-secondary py-8">
               <div class="loading-spinner mx-auto mb-2"></div>
               Loading support messages...
             </td>
           </tr>
         </tbody>
       </table>
     </div>
   </div>
 </div>

   About Section 
 <div id="about-section" class="admin-section hidden">
   <div class="app-card p-4 md:p-8">
     <h3 class="text-lg md:text-xl font-orbitron font-bold mb-6 text-accent-purple flex items-center">
       <i class="fas fa-info-circle mr-3"></i>
       MANAGE ABOUT US CONTENT
     </h3>
     <div class="space-y-4">
       <div>
         <label class="block text-sm font-medium mb-2 text-text-secondary">ABOUT US CONTENT</label>
         <textarea id="about-content-input" placeholder="Enter About Us content here..." rows="10" class="app-input w-full resize-none"></textarea>
       </div>
       <button onclick="updateAboutContent()" class="myanmar-btn w-full flex items-center justify-center space-x-2">
         <i class="fas fa-save"></i>
         <span>SAVE ABOUT CONTENT</span>
       </button>
     </div>
   </div>
 </div>

</div>
</div>

 News Detail Modal (for Admin News) 
<div id="news-modal" class="modal hidden">
<div class="modal-content max-w-2xl">
 <div class="flex justify-between items-center mb-4">
   <h2 class="text-xl font-orbitron font-bold text-accent-purple">NEWS DETAILS</h2>
   <button onclick="closeNewsModal()" class="text-text-secondary hover:text-accent-red">
     <i class="fas fa-times"></i>
   </button>
 </div>
 <div id="news-modal-content">
   <div class="loading-spinner mx-auto mb-4"></div>
   <p class="text-center text-text-secondary">Loading...</p>
 </div>
</div>
</div>

 News Detail Modal (for User News) 
<div id="user-news-modal" class="modal hidden">
 <div class="modal-content max-w-2xl">
   <div class="flex justify-between items-center mb-4">
     <h2 class="text-xl font-orbitron font-bold text-accent-purple">USER NEWS DETAILS</h2>
     <button onclick="closeUserNewsModal()" class="text-text-secondary hover:text-accent-red">
       <i class="fas fa-times"></i>
     </button>
   </div>
   <div id="user-news-modal-content">
     <div class="loading-spinner mx-auto mb-4"></div>
     <p class="text-center text-text-secondary">Loading...</p>
   </div>
 </div>
</div>

 Product Detail Modal (for Admin Products) 
<div id="product-modal" class="modal hidden">
<div class="modal-content max-w-2xl">
 <div class="flex justify-between items-center mb-4">
   <h2 class="text-xl font-orbitron font-bold text-accent-purple">PRODUCT DETAILS</h2>
   <button onclick="closeProductModal()" class="text-text-secondary hover:text-accent-red">
     <i class="fas fa-times"></i>
   </button>
 </div>
 <div id="product-modal-content">
   <div class="loading-spinner mx-auto mb-4"></div>
   <p class="text-center text-text-secondary">Loading...</p>
 </div>
</div>
</div>

 User Product Detail Modal 
<div id="user-product-modal" class="modal hidden">
 <div class="modal-content max-w-2xl">
   <div class="flex justify-between items-center mb-4">
     <h2 class="text-xl font-orbitron font-bold text-accent-purple">USER PRODUCT DETAILS</h2>
     <button onclick="closeUserProductModal()" class="text-text-secondary hover:text-accent-red">
       <i class="fas fa-times"></i>
     </button>
   </div>
   <div id="user-product-modal-content">
     <div class="loading-spinner mx-auto mb-4"></div>
     <p class="text-center text-text-secondary">Loading...</p>
   </div>
 </div>
</div>

 Order Details Modal (for Admin Product Orders) 
<div id="admin-order-details-modal" class="modal hidden">
 <div class="modal-content max-w-2xl">
   <div class="flex justify-between items-center mb-4">
     <h2 class="text-xl font-orbitron font-bold text-accent-purple">ADMIN PRODUCT ORDER DETAILS</h2>
     <button onclick="closeAdminOrderDetailsModal()" class="text-text-secondary hover:text-accent-red">
       <i class="fas fa-times"></i>
     </button>
   </div>
   <div id="admin-order-details-modal-content">
     <div class="loading-spinner mx-auto mb-4"></div>
     <p class="text-center text-text-secondary">Loading...</p>
   </div>
 </div>
</div>

 Order Details Modal (for User Product Orders) 
<div id="user-order-details-modal" class="modal hidden">
 <div class="modal-content max-w-2xl">
   <div class="flex justify-between items-center mb-4">
     <h2 class="text-xl font-orbitron font-bold text-accent-purple">USER PRODUCT ORDER DETAILS</h2>
     <button onclick="closeUserOrderDetailsModal()" class="text-text-secondary hover:text-accent-red">
       <i class="fas fa-times"></i>
     </button>
   </div>
   <div id="user-order-details-modal-content">
     <div class="loading-spinner mx-auto mb-4"></div>
     <p class="text-center text-text-secondary">Loading...</p>
   </div>
 </div>
</div>

 Buyer-Seller Chat Modal 
<div id="buyer-seller-chat-modal" class="modal hidden">
 <div class="modal-content max-w-2xl">
   <div class="flex justify-between items-center mb-4">
     <h2 class="text-xl font-orbitron font-bold text-accent-purple" id="chat-modal-title">CHAT WITH USER</h2>
     <button onclick="closeBuyerSellerChatModal()" class="text-text-secondary hover:text-accent-red">
       <i class="fas fa-times"></i>
     </button>
   </div>
   <div id="buyer-seller-chat-messages" class="bg-black bg-opacity-30 rounded-xl p-4 h-64 md:h-96 overflow-y-auto mb-6 border border-gray-700">
     <div class="loading-spinner mx-auto mb-4"></div>
     <p class="text-center text-text-secondary">Loading messages...</p>
   </div>
   <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-4">
     <textarea id="buyer-seller-chat-input" placeholder="Type your message..." rows="3"
               class="app-input flex-1 resize-none"></textarea>
     <button onclick="sendBuyerSellerChatMessage()"
             class="myanmar-btn flex items-center justify-center space-x-2 md:self-end">
       <i class="fas fa-paper-plane"></i>
       <span>SEND</span>
     </button>
   </div>
   <div class="mt-4 flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-4">
       <button onclick="showOrderListToSendMessage()" class="myanmar-btn flex-1 btn-small">
         <i class="fas fa-clipboard-list mr-2"></i>
         SEND ORDER LIST
       </button>
       <input type="file" id="buyer-seller-chat-file-upload" accept="image/*,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document" class="app-input flex-1 btn-small">
       <button onclick="uploadBuyerSellerChatFile()" class="myanmar-btn flex-1 btn-small">
         <i class="fas fa-paperclip mr-2"></i>
         UPLOAD FILE
       </button>
   </div>
 </div>
</div>

 Confirm Delete Modal 
<div id="confirm-modal" class="modal hidden">
<div class="modal-content max-w-md">
 <div class="text-center">
   <i class="fas fa-exclamation-triangle text-4xl text-accent-red mb-4"></i>
   <h3 class="text-xl font-orbitron font-bold text-text-primary mb-4">ARE YOU SURE?</h3>
   <p id="confirm-message" class="text-text-secondary mb-6">This action cannot be undone.</p>
   <div class="flex space-x-4">
     <button onclick="closeConfirmModal()" class="myanmar-btn flex-1">
       <i class="fas fa-times mr-2"></i>
       CANCEL
     </button>
     <button onclick="confirmAction()" class="btn-danger myanmar-btn flex-1">
       <i class="fas fa-trash mr-2"></i>
       DELETE
     </button>
   </div>
 </div>
</div>
</div>

 Loading Overlay 
<div id="loading-overlay" class="fixed inset-0 loading-overlay flex items-center justify-center z-50 hidden">
<div class="app-card p-8 text-center">
 <div class="loading-spinner mx-auto mb-4" style="width: 40px; height: 40px;"></div>
 <p class="text-text-primary font-semibold">PROCESSING...</p>
</div>
</div>

 Scripts 
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
<script>
// Configuration
const CONFIG = {
 SUPABASE_URL: 'https://rmeudvhvqlddqqkiziyo.supabase.co',
 SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJtZXVkdmh2cWxkZHFxa2l6aXlvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM5OTMxOTIsImV4cCI6MjA2OTU2OTE5Mn0.xFgMv-K5o5yyTpe4U2YJK5jC9GPJp98G4cgD9p5W4ak',
 MAX_RETRY_ATTEMPTS: 3,
 RETRY_DELAY: 2000
};

// State
let state = {
 supabase: null,
 isAuthenticated: false,
 currentSection: 'dashboard',
 currentNewsSubSection: 'admin-news',
 currentOrdersSubSection: 'admin-product-orders',
 currentChatSubSection: 'global-chat',
 reconnectAttempts: 0,
 isConnected: false,
 confirmCallback: null,
 adminProfile: null, // Stores current admin's profile data
 newsRealtime: null,
 profileNewsRealtime: null,
 productsRealtime: null,
 userProductsRealtime: null,
 ordersRealtime: null,
 userOrdersRealtime: null,
 chatRealtime: null,
 supportRealtime: null,
 buyerSellerConversationsRealtime: null,
 buyerSellerMessagesRealtime: null,
 currentBuyerSellerConversationId: null,
 currentChatPartnerProfileId: null,
};

// Utility Functions
const utils = {
 formatFileSize(bytes) {
   if (bytes === 0) return '0 Bytes';
   const k = 1024;
   const sizes = ['Bytes', 'KB', 'MB', 'GB'];
   const i = Math.floor(Math.log(bytes) / Math.log(k));
   return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
 },
 getMediaType(fileType) {
   if (fileType.startsWith('image/')) return 'image';
   if (fileType.startsWith('video/')) return 'video';
   if (fileType.startsWith('audio/')) return 'audio';
   return 'file';
 },
 formatPrice(price) {
   return `${parseFloat(price).toFixed(2)} MMK`;
 }
};

// Initialize
document.addEventListener('DOMContentLoaded', initializeApp);

async function initializeApp() {
 updateConnectionStatus('connecting');

 try {
   // Check if Supabase config is set
   if (!CONFIG.SUPABASE_URL || CONFIG.SUPABASE_URL === 'YOUR_SUPABASE_URL_HERE') {
     throw new Error('Supabase URL လိုအပ်ပါတယ်! CONFIG အပိုင်းထဲမှာ သင့် Supabase URL ကို ထည့်ပါ။');
   }

   if (!CONFIG.SUPABASE_ANON_KEY || CONFIG.SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY_HERE') {
     throw new Error('Supabase Anon Key လိုအပ်ပါတယ်! CONFIG အပိုင်းထဲမှာ သင့် Supabase Anon Key ကို ထည့်ပါ။');
   }

   // Initialize Supabase
   if (typeof supabase !== 'undefined') {
     state.supabase = supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY, {
       auth: { persistSession: false },
       realtime: { params: { eventsPerSecond: 10 } }
     });

     // Test connection
     const { data, error } = await state.supabase.from('admin_profiles').select('id').limit(1);

     if (error && error.code !== 'PGRST116') { // PGRST116 means table not found, which is fine for initial setup
       throw new Error(`Database connection failed: ${error.message}`);
     }

     updateConnectionStatus('online');
     showNotification('Database connected successfully! Admin Panel အသုံးပြုရန် အသင့်ဖြစ်ပါတယ်။', 'success');

     state.isConnected = true;
     state.reconnectAttempts = 0;

     // Check for existing admin session (simple check for this HTML example)
     const storedAdminUsername = localStorage.getItem('admin_username');
     if (storedAdminUsername) {
       document.getElementById('admin-username').value = storedAdminUsername;
       // In a real app, you'd re-authenticate or check session validity
       // For this example, we'll just assume if username is stored, they were logged in
       // and try to load data. A proper session management would be more robust.
       // For now, we'll rely on the adminLogin function to re-verify.
     }

   } else {
     throw new Error('Supabase library မတင်လို့ရပါ');
   }
 } catch (error) {
   console.error('Initialization error:', error);
   updateConnectionStatus('offline');
   showNotification(`Connection failed: ${error.message}`, 'error');

   // Retry connection
   if (state.reconnectAttempts < CONFIG.MAX_RETRY_ATTEMPTS) {
     state.reconnectAttempts++;
     setTimeout(() => {
       console.log(`Retrying connection (${state.reconnectAttempts}/${CONFIG.MAX_RETRY_ATTEMPTS})...`);
       initializeApp();
     }, CONFIG.RETRY_DELAY);
   }
 }

 // Add enter key listener for login inputs
 document.getElementById('admin-username').addEventListener('keypress', function(event) {
   if (event.key === 'Enter') {
     document.getElementById('admin-password').focus();
   }
 });
 document.getElementById('admin-password').addEventListener('keypress', function(event) {
   if (event.key === 'Enter') {
     adminLogin();
   }
 });
}

function updateConnectionStatus(status) {
 const statusElement = document.getElementById('connection-status');
 statusElement.className = 'connection-status';

 switch (status) {
   case 'online':
     statusElement.classList.add('status-online');
     statusElement.innerHTML = '<i class="fas fa-check-circle"></i> ONLINE';
     break;
   case 'offline':
     statusElement.classList.add('status-offline');
     statusElement.innerHTML = '<i class="fas fa-exclamation-triangle"></i> OFFLINE';
     break;
   case 'connecting':
     statusElement.classList.add('status-connecting');
     statusElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ချိတ်ဆက်နေသည်...';
     break;
 }
}

function showNotification(message, type = 'info', duration = 5000) {
 const container = document.getElementById('notification-container');
 const notification = document.createElement('div');

 const bgColors = {
   success: 'bg-green-600',
   error: 'bg-red-600',
   info: 'bg-blue-600',
   warning: 'bg-yellow-600'
 };

 const icons = {
   success: 'fa-check-circle',
   error: 'fa-exclamation-triangle',
   info: 'fa-info-circle',
   warning: 'fa-exclamation-circle'
 };

 notification.className = `notification ${bgColors[type]}`;
 notification.innerHTML = `
   <div class="flex items-center justify-between">
     <div class="flex items-center">
       <i class="fas ${icons[type]} mr-2"></i>
       <span>${message}</span>
     </div>
     <button onclick="this.parentElement.parentElement.remove()" class="ml-4 hover:text-gray-200">
       <i class="fas fa-times"></i>
     </button>
   </div>
 `;

 container.appendChild(notification);

 setTimeout(() => {
   if (notification.parentElement) {
     notification.remove();
   }
 }, duration);
}

async function adminLogin() {
 if (!state.isConnected) {
   showNotification('Waiting for database connection...', 'warning');
   return;
 }

 const username = document.getElementById('admin-username').value.trim();
 const password = document.getElementById('admin-password').value.trim();
 const loginBtn = document.getElementById('login-btn');
 const loginText = document.getElementById('login-text');

 if (!username || !password) {
   showNotification('Please enter username and password', 'warning');
   return;
 }

 try {
   loginBtn.disabled = true;
   loginText.textContent = 'LOGGING IN...';
   showLoading(true);

   const { data, error } = await state.supabase.rpc('admin_login', {
     input_username: username,
     input_password: password
   });

   if (error) throw error;

   if (data && data.length > 0) {
     state.adminProfile = data[0];
     state.isAuthenticated = true;
     localStorage.setItem('admin_username', username); // Simple persistence

     // Manually set the Supabase session for RLS to work with auth.uid()
     // This is a workaround for pure HTML/JS without a proper auth flow.
     // In a real app, you'd use `supabase.auth.signInWithPassword` etc.
     await state.supabase.auth.setSession({
       access_token: CONFIG.SUPABASE_ANON_KEY, // Using anon key as a dummy token
       refresh_token: CONFIG.SUPABASE_ANON_KEY,
       user: {
         id: state.adminProfile.id, // Use admin_profile_id as auth.uid()
         aud: 'authenticated',
         role: 'authenticated', // Or 'admin' if you set up custom roles
         email: 'admin@example.com',
         app_metadata: {},
         user_metadata: {},
         created_at: new Date().toISOString(),
         updated_at: new Date().toISOString(),
       }
     });

     document.getElementById('login-section').classList.add('hidden');
     document.getElementById('admin-content').classList.remove('hidden');
     document.getElementById('admin-name').textContent = state.adminProfile.name || state.adminProfile.username;

     showNotification('Admin login successful!', 'success');
     await loadDashboardData();
     setupRealtimeSubscriptions();
     showSection('dashboard', document.querySelector('.nav-btn.active'));

   } else {
     throw new Error('Invalid username or password');
   }

 } catch (error) {
   console.error('Admin login error:', error);
   showNotification(error.message, 'error');
   adminLogout(); // Ensure logout on error
 } finally {
   loginBtn.disabled = false;
   loginText.textContent = 'LOGIN';
   showLoading(false);
 }
}

function adminLogout() {
 state.isAuthenticated = false;
 state.adminProfile = null;
 localStorage.removeItem('admin_username');
 // Invalidate Supabase session (if any was set)
 state.supabase.auth.signOut();

 // Unsubscribe from all realtime channels
 if (state.newsRealtime) state.supabase.removeChannel(state.newsRealtime);
 if (state.profileNewsRealtime) state.supabase.removeChannel(state.profileNewsRealtime);
 if (state.productsRealtime) state.supabase.removeChannel(state.productsRealtime);
 if (state.userProductsRealtime) state.supabase.removeChannel(state.userProductsRealtime);
 if (state.ordersRealtime) state.supabase.removeChannel(state.ordersRealtime);
 if (state.userOrdersRealtime) state.supabase.removeChannel(state.userOrdersRealtime);
 if (state.chatRealtime) state.supabase.removeChannel(state.chatRealtime);
 if (state.supportRealtime) state.supabase.removeChannel(state.supportRealtime);
 if (state.buyerSellerConversationsRealtime) state.supabase.removeChannel(state.buyerSellerConversationsRealtime);
 if (state.buyerSellerMessagesRealtime) state.supabase.removeChannel(state.buyerSellerMessagesRealtime);


 document.getElementById('admin-content').classList.add('hidden');
 document.getElementById('login-section').classList.remove('hidden');
 document.getElementById('admin-password').value = ''; // Clear password field
 showNotification('Logged out successfully.', 'info');
}

async function loadDashboardData() {
 if (!state.isAuthenticated) return;

 try {
   const [
     usersResult,
     keysResult,
     adminNewsResult,
     profileNewsResult,
     adminProductsResult,
     userProductsResult,
     pendingAdminOrdersResult,
     pendingUserOrdersResult
   ] = await Promise.all([
     state.supabase.from('profiles').select('id', { count: 'exact' }),
     state.supabase.from('keys').select('id', { count: 'exact' }).eq('is_active', true),
     state.supabase.from('news').select('id', { count: 'exact' }),
     state.supabase.from('profile_news').select('id', { count: 'exact' }),
     state.supabase.from('products').select('id', { count: 'exact' }),
     state.supabase.from('user_products').select('id', { count: 'exact' }),
     state.supabase.from('orders').select('id', { count: 'exact' }).eq('status', 'pending'),
     state.supabase.from('user_orders').select('id', { count: 'exact' }).eq('status', 'pending')
   ]);

   document.getElementById('total-users').textContent = usersResult.count || 0;
   document.getElementById('active-keys').textContent = keysResult.count || 0;
   document.getElementById('total-news').textContent = (adminNewsResult.count + profileNewsResult.count) || 0;
   document.getElementById('total-admin-products').textContent = adminProductsResult.count || 0;
   document.getElementById('total-user-products').textContent = userProductsResult.count || 0;
   document.getElementById('pending-orders').textContent = (pendingAdminOrdersResult.count + pendingUserOrdersResult.count) || 0;

 } catch (error) {
   console.error('Error loading dashboard data:', error);
   showNotification('Failed to retrieve dashboard data', 'error');
 }
}

function setupRealtimeSubscriptions() {
 if (!state.isAuthenticated) return;

 // Unsubscribe from previous channels if they exist
 if (state.newsRealtime) state.supabase.removeChannel(state.newsRealtime);
 if (state.profileNewsRealtime) state.supabase.removeChannel(state.profileNewsRealtime);
 if (state.productsRealtime) state.supabase.removeChannel(state.productsRealtime);
 if (state.userProductsRealtime) state.supabase.removeChannel(state.userProductsRealtime);
 if (state.ordersRealtime) state.supabase.removeChannel(state.ordersRealtime);
 if (state.userOrdersRealtime) state.supabase.removeChannel(state.userOrdersRealtime);
 if (state.chatRealtime) state.supabase.removeChannel(state.chatRealtime);
 if (state.supportRealtime) state.supabase.removeChannel(state.supportRealtime);
 if (state.buyerSellerConversationsRealtime) state.supabase.removeChannel(state.buyerSellerConversationsRealtime);
 if (state.buyerSellerMessagesRealtime) state.supabase.removeChannel(state.buyerSellerMessagesRealtime);


 // News realtime updates (Admin News)
 state.newsRealtime = state.supabase
   .channel('news_changes_admin')
   .on('postgres_changes',
     { event: '*', schema: 'public', table: 'news' },
     (payload) => {
       if (state.currentSection === 'news' && state.currentNewsSubSection === 'admin-news') {
         loadAdminNews();
       }
       loadDashboardData();
     }
   )
   .subscribe();

 // Profile News realtime updates (User News)
 state.profileNewsRealtime = state.supabase
   .channel('profile_news_changes_admin')
   .on('postgres_changes',
     { event: '*', schema: 'public', table: 'profile_news' },
     (payload) => {
       if (state.currentSection === 'news' && state.currentNewsSubSection === 'user-news') {
         loadUserNews();
       }
       loadDashboardData();
     }
   )
   .subscribe();

 // Products realtime updates (Admin Products)
 state.productsRealtime = state.supabase
   .channel('products_changes_admin')
   .on('postgres_changes',
     { event: '*', schema: 'public', table: 'products' },
     (payload) => {
       if (state.currentSection === 'products') {
         loadProducts();
       }
       loadDashboardData();
     }
   )
   .subscribe();

 // User Products realtime updates
 state.userProductsRealtime = state.supabase
   .channel('user_products_changes_admin')
   .on('postgres_changes',
     { event: '*', schema: 'public', table: 'user_products' },
     (payload) => {
       if (state.currentSection === 'user-products') {
         loadUserProducts();
       }
       loadDashboardData();
     }
   )
   .subscribe();

 // Orders realtime updates (Admin Product Orders)
 state.ordersRealtime = state.supabase
   .channel('orders_changes_admin')
   .on('postgres_changes',
     { event: '*', schema: 'public', table: 'orders' },
     (payload) => {
       if (state.currentSection === 'orders' && state.currentOrdersSubSection === 'admin-product-orders') {
         loadAdminProductOrders();
       }
       loadDashboardData();
     }
   )
   .subscribe();

 // User Orders realtime updates
 state.userOrdersRealtime = state.supabase
   .channel('user_orders_changes_admin')
   .on('postgres_changes',
     { event: '*', schema: 'public', table: 'user_orders' },
     (payload) => {
       if (state.currentSection === 'orders' && state.currentOrdersSubSection === 'user-product-orders') {
         loadUserProductOrders();
       }
       loadDashboardData();
     }
   )
   .subscribe();

 // Chat messages realtime (Global Chat)
 if (state.adminProfile && state.adminProfile.id) {
   state.chatRealtime = state.supabase
     .channel(`chat_changes_admin:${state.adminProfile.id}`)
     .on('postgres_changes',
       {
         event: '*',
         schema: 'public',
         table: 'chat_messages',
         filter: `conversation_id.in.(select id from chat_conversations where user1_id='${state.adminProfile.id}' or user2_id='${state.adminProfile.id}')`
       },
       (payload) => {
         if (state.currentSection === 'chat' && state.currentChatSubSection === 'global-chat') {
           loadGlobalChatMessages();
         }
       }
     )
     .subscribe();
 }

 // Support messages realtime
 state.supportRealtime = state.supabase
   .channel('support_changes_admin')
   .on('postgres_changes',
     { event: '*', schema: 'public', table: 'support_messages' },
     (payload) => {
       if (state.currentSection === 'support') {
         loadSupportMessages();
       }
     }
   )
   .subscribe();

 // Buyer-Seller Conversations Realtime
 if (state.adminProfile && state.adminProfile.id) {
   state.buyerSellerConversationsRealtime = state.supabase
     .channel(`buyer_seller_conversations_admin:${state.adminProfile.id}`)
     .on('postgres_changes',
       {
         event: '*',
         schema: 'public',
         table: 'buyer_seller_conversations',
         filter: `profile1_id=eq.${state.adminProfile.id}.or.profile2_id=eq.${state.adminProfile.id}`
       },
       (payload) => {
         if (state.currentSection === 'chat' && state.currentChatSubSection === 'private-chats') {
           loadPrivateChatList();
         }
         // If the chat modal is open and concerns this conversation, refresh messages
         if (state.currentBuyerSellerConversationId && (payload.new.profile1_id === state.adminProfile.id || payload.new.profile2_id === state.adminProfile.id)) {
           loadBuyerSellerChatMessages(state.currentBuyerSellerConversationId, state.currentChatPartnerProfileId);
         }
       }
     )
     .subscribe();

   // Buyer-Seller Messages Realtime
   state.buyerSellerMessagesRealtime = state.supabase
     .channel(`buyer_seller_messages_admin:${state.adminProfile.id}`)
     .on('postgres_changes',
       {
         event: '*',
         schema: 'public',
         table: 'buyer_seller_messages',
         filter: `sender_profile_id=eq.${state.adminProfile.id}.or.conversation_id.in.(select id from buyer_seller_conversations where profile1_id='${state.adminProfile.id}' or profile2_id='${state.adminProfile.id}')`
       },
       (payload) => {
         if (state.currentBuyerSellerConversationId && payload.new.conversation_id === state.currentBuyerSellerConversationId) {
           loadBuyerSellerChatMessages(state.currentBuyerSellerConversationId, state.currentChatPartnerProfileId);
         }
       }
     )
     .subscribe();
 }
}

function showSection(section, buttonElement) {
 if (!state.isAuthenticated) {
   showNotification('Please login to access admin panel.', 'warning');
   return;
 }

 // Hide all sections
 document.querySelectorAll('.admin-section').forEach(sec => {
   sec.classList.add('hidden');
 });

 // Update navigation
 document.querySelectorAll('.nav-btn').forEach(btn => {
   btn.classList.remove('active');
 });

 // Show selected section
 const sectionElement = document.getElementById(`${section}-section`);
 if (sectionElement) {
   sectionElement.classList.remove('hidden');
   sectionElement.classList.add('fade-in');
 }

 // Update active nav
 if (buttonElement) {
   buttonElement.classList.add('active');
 }
 state.currentSection = section;

 // Load section data
 switch (section) {
   case 'dashboard':
     loadDashboardData();
     break;
   case 'users':
     loadUsers();
     break;
   case 'keys':
     loadKeys();
     break;
   case 'news':
     showNewsSubSection(state.currentNewsSubSection, document.querySelector(`#news-section .nav-btn.active`) || document.querySelector(`#news-section .nav-btn:first-child`));
     break;
   case 'products':
     loadProducts();
     break;
   case 'user-products':
     loadUserProducts();
     break;
   case 'orders':
     showOrdersSubSection(state.currentOrdersSubSection, document.querySelector(`#orders-section .nav-btn.active`) || document.querySelector(`#orders-section .nav-btn:first-child`));
     break;
   case 'payment-methods':
     loadPaymentMethods();
     break;
   case 'chat':
     showChatSubSection(state.currentChatSubSection, document.querySelector(`#chat-section .nav-btn.active`) || document.querySelector(`#chat-section .nav-btn:first-child`));
     break;
   case 'support':
     loadSupportMessages();
     break;
   case 'about':
     loadAboutContent();
     break;
 }
}

// News Sub-Sections
function showNewsSubSection(subSection, buttonElement) {
 document.querySelectorAll('.news-subsection').forEach(sec => {
   sec.classList.add('hidden');
 });
 document.querySelectorAll('#news-section .nav-btn').forEach(btn => {
   btn.classList.remove('active');
 });

 const subSectionElement = document.getElementById(`${subSection}-subsection`);
 if (subSectionElement) {
   subSectionElement.classList.remove('hidden');
   subSectionElement.classList.add('fade-in');
 }

 if (buttonElement) {
   buttonElement.classList.add('active');
 }
 state.currentNewsSubSection = subSection;

 switch (subSection) {
   case 'admin-news':
     loadAdminNews();
     break;
   case 'user-news':
     loadUserNews();
     break;
 }
}

// Orders Sub-Sections
function showOrdersSubSection(subSection, buttonElement) {
 document.querySelectorAll('.orders-subsection').forEach(sec => {
   sec.classList.add('hidden');
 });
 document.querySelectorAll('#orders-section .nav-btn').forEach(btn => {
   btn.classList.remove('active');
 });

 const subSectionElement = document.getElementById(`${subSection}-subsection`);
 if (subSectionElement) {
   subSectionElement.classList.remove('hidden');
   subSectionElement.classList.add('fade-in');
 }

 if (buttonElement) {
   buttonElement.classList.add('active');
 }
 state.currentOrdersSubSection = subSection;

 switch (subSection) {
   case 'admin-product-orders':
     loadAdminProductOrders();
     break;
   case 'user-product-orders':
     loadUserProductOrders();
     break;
 }
}

// Chat Sub-Sections
function showChatSubSection(subSection, buttonElement) {
 document.querySelectorAll('.chat-subsection').forEach(sec => {
   sec.classList.add('hidden');
 });
 document.querySelectorAll('#chat-section .nav-btn').forEach(btn => {
   btn.classList.remove('active');
 });

 const subSectionElement = document.getElementById(`${subSection}-subsection`);
 if (subSectionElement) {
   subSectionElement.classList.remove('hidden');
   subSectionElement.classList.add('fade-in');
 }

 if (buttonElement) {
   buttonElement.classList.add('active');
 }
 state.currentChatSubSection = subSection;

 switch (subSection) {
   case 'global-chat':
     loadGlobalChatMessages();
     break;
   case 'private-chats':
     loadPrivateChatList();
     break;
 }
}

async function loadUsers() {
 const usersTableBody = document.getElementById('users-table-body');
 usersTableBody.innerHTML = `
   <tr>
     <td colspan="5" class="text-center text-text-secondary py-8">
       <div class="loading-spinner mx-auto mb-2"></div>
       Loading users...
     </td>
   </tr>
 `;

 try {
   const { data: users, error } = await state.supabase
     .from('profiles')
     .select(`
       *,
       keys(key_text)
     `)
     .order('created_at', { ascending: false });

   if (error) throw error;

   if (users && users.length > 0) {
     usersTableBody.innerHTML = users.map(user => {
       const statusClass = user.is_banned ? 'status-banned' : 'status-active';
       const statusText = user.is_banned ? 'BANNED' : 'ACTIVE';
       const keyText = user.keys ? user.keys.key_text : 'N/A';

       return `
         <tr>
           <td><img src="${user.profile_picture || '/placeholder.svg?height=30&width=30'}" class="w-8 h-8 rounded-full inline-block mr-2 object-cover" alt="Profile Pic">@${user.username}</td>
           <td>${user.name}</td>
           <td class="font-share-tech">${keyText}</td>
           <td class="${statusClass}">${statusText}</td>
           <td class="table-actions">
             <button onclick="toggleUserBanStatus('${user.id}', ${user.is_banned})" class="myanmar-btn btn-small">
               <i class="fas ${user.is_banned ? 'fa-user-check' : 'fa-user-slash'}"></i> ${user.is_banned ? 'Unban' : 'Ban'}
             </button>
             <button onclick="deleteUser('${user.id}')" class="btn-danger myanmar-btn btn-small">
               <i class="fas fa-trash"></i> Delete
             </button>
             <button onclick="initiateBuyerSellerChat('${user.id}', '${user.name}')" class="myanmar-btn btn-small">
               <i class="fas fa-comments"></i> Chat
             </button>
           </td>
         </tr>
       `;
     }).join('');
   } else {
     usersTableBody.innerHTML = `
       <tr>
         <td colspan="5" class="text-center text-text-secondary py-8">
           <i class="fas fa-users text-4xl mb-4"></i>
           <p>No Users Found</p>
         </td>
       </tr>
     `;
   }
 } catch (error) {
   console.error('Error loading users:', error);
   usersTableBody.innerHTML = `
     <tr>
       <td colspan="5" class="text-center text-accent-red py-8">
         <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
         <p>Failed to retrieve Users</p>
       </td>
     </tr>
   `;
 }
}

async function toggleUserBanStatus(profileId, currentStatus) {
 showLoading(true);
 try {
   const { error } = await state.supabase
     .from('profiles')
     .update({ is_banned: !currentStatus })
     .eq('id', profileId);

   if (error) throw error;

   showNotification(`User status updated to ${!currentStatus ? 'Banned' : 'Active'}`, 'success');
   loadUsers();
 } catch (error) {
   console.error('Error toggling user ban status:', error);
   showNotification('Failed to update user status', 'error');
 } finally {
   showLoading(false);
 }
}

function deleteUser(profileId) {
 showConfirmModal(
   'Are you sure you want to delete this user and all associated data (profile news, user products, orders)? This action cannot be undone.',
   async () => {
     showLoading(true);
     try {
       // Delete related data first due to foreign key constraints
       await state.supabase.from('profile_news').delete().eq('profile_id', profileId);
       await state.supabase.from('user_products').delete().eq('seller_profile_id', profileId);
       await state.supabase.from('user_orders').delete().or(`buyer_profile_id.eq.${profileId},seller_profile_id.eq.${profileId}`);
       await state.supabase.from('buyer_seller_conversations').delete().or(`profile1_id.eq.${profileId},profile2_id.eq.${profileId}`);
       await state.supabase.from('chat_conversations').delete().or(`user1_id.eq.${profileId},user2_id.eq.${profileId}`);
       await state.supabase.from('support_messages').delete().eq('profile_id', profileId);
       await state.supabase.from('orders').delete().eq('profile_id', profileId);
       await state.supabase.from('purchased_products').delete().eq('profile_id', profileId);
       await state.supabase.from('seller_payment_methods').delete().eq('profile_id', profileId);

       // Finally, delete the profile
       const { error } = await state.supabase
         .from('profiles')
         .delete()
         .eq('id', profileId);

       if (error) throw error;

       showNotification('User and all associated data deleted successfully!', 'success');
       loadUsers();
       loadDashboardData();
     } catch (error) {
       console.error('Error deleting user:', error);
       showNotification('Failed to delete user.', 'error');
     } finally {
       showLoading(false);
     }
   }
 );
}

async function loadKeys() {
 const keysTableBody = document.getElementById('keys-table-body');
 keysTableBody.innerHTML = `
   <tr>
     <td colspan="5" class="text-center text-text-secondary py-8">
       <div class="loading-spinner mx-auto mb-2"></div>
       Loading keys...
     </td>
   </tr>
 `;

 try {
   const { data: keys, error } = await state.supabase
     .from('keys')
     .select(`
       *,
       profiles(username, name)
     `)
     .order('created_at', { ascending: false });

   if (error) throw error;

   if (keys && keys.length > 0) {
     keysTableBody.innerHTML = keys.map(key => {
       const statusClass = key.is_active ? 'status-active' : 'status-inactive';
       const statusText = key.is_active ? 'ACTIVE' : 'INACTIVE';
       const expiryDate = key.expires_at ? new Date(key.expires_at).toLocaleDateString('my-MM') : 'Never';
       const usedBy = key.profiles.length > 0 ? `${key.profiles[0].name} (@${key.profiles[0].username})` : 'Not Used';

       return `
         <tr>
           <td class="font-share-tech">${key.key_text}</td>
           <td>${expiryDate}</td>
           <td class="${statusClass}">${statusText}</td>
           <td>${usedBy}</td>
           <td class="table-actions">
             <button onclick="toggleKeyStatus('${key.id}', ${key.is_active})" class="myanmar-btn btn-small">
               <i class="fas ${key.is_active ? 'fa-eye-slash' : 'fa-eye'}"></i> ${key.is_active ? 'Deactivate' : 'Activate'}
             </button>
             <button onclick="deleteKey('${key.id}')" class="btn-danger myanmar-btn btn-small">
               <i class="fas fa-trash"></i> Delete
             </button>
           </td>
         </tr>
       `;
     }).join('');
   } else {
     keysTableBody.innerHTML = `
       <tr>
         <td colspan="5" class="text-center text-text-secondary py-8">
           <i class="fas fa-key text-4xl mb-4"></i>
           <p>No Keys Found</p>
         </td>
       </tr>
     `;
   }
 } catch (error) {
   console.error('Error loading keys:', error);
   keysTableBody.innerHTML = `
     <tr>
       <td colspan="5" class="text-center text-accent-red py-8">
         <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
         <p>Failed to retrieve Keys</p>
       </td>
     </tr>
   `;
 }
}

async function addKey() {
 const keyText = document.getElementById('new-key-text').value.trim();
 const expiryDate = document.getElementById('new-key-expiry').value;

 if (!keyText) {
   showNotification('Please enter a Key Text', 'warning');
   return;
 }

 showLoading(true);

 try {
   const { error } = await state.supabase
     .from('keys')
     .insert({
       key_text: keyText,
       expires_at: expiryDate || null,
       is_active: true
     });

   if (error) throw error;

   document.getElementById('new-key-text').value = '';
   document.getElementById('new-key-expiry').value = '';
   showNotification('Key added successfully!', 'success');
   loadKeys();
   loadDashboardData();
 } catch (error) {
   console.error('Error adding key:', error);
   if (error.code === '23505') { // Unique constraint violation
     showNotification('Key already exists, please choose another.', 'error');
   } else {
     showNotification('Failed to add key', 'error');
   }
 } finally {
   showLoading(false);
 }
}

async function toggleKeyStatus(keyId, currentStatus) {
 showLoading(true);
 try {
   const { error } = await state.supabase
     .from('keys')
     .update({ is_active: !currentStatus })
     .eq('id', keyId);

   if (error) throw error;

   showNotification(`Key status updated to ${!currentStatus ? 'Active' : 'Inactive'}`, 'success');
   loadKeys();
   loadDashboardData();
 } catch (error) {
   console.error('Error toggling key status:', error);
   showNotification('Failed to update key status', 'error');
 } finally {
   showLoading(false);
 }
}

function deleteKey(keyId) {
 showConfirmModal(
   'Are you sure you want to delete this key? This will also delete any associated user profile.',
   async () => {
     showLoading(true);
     try {
       // First, find the profile associated with this key
       const { data: profileData, error: profileError } = await state.supabase
         .from('profiles')
         .select('id')
         .eq('key_id', keyId)
         .single();

       if (profileError && profileError.code !== 'PGRST116') { // PGRST116 means no row found, which is fine
         throw profileError;
       }

       if (profileData) {
         // If a profile exists, delete it (this will cascade delete other related data)
         await deleteUser(profileData.id);
       }

       // Then delete the key itself
       const { error } = await state.supabase
         .from('keys')
         .delete()
         .eq('id', keyId);

       if (error) throw error;

       showNotification('Key and associated profile (if any) deleted successfully!', 'success');
       loadKeys();
       loadUsers(); // Refresh users list as well
       loadDashboardData();
     } catch (error) {
       console.error('Error deleting key:', error);
       showNotification('Failed to delete key.', 'error');
     } finally {
       showLoading(false);
     }
   }
 );
}

async function postAdminNews() {
 if (!state.adminProfile || !state.adminProfile.id) {
   showNotification('Admin profile not loaded. Please re-login.', 'error');
   return;
 }

 const title = document.getElementById('admin-news-title').value.trim();
 const content = document.getElementById('admin-news-content').value.trim();
 const mediaFiles = document.getElementById('admin-news-media').files;
 const youtubeLink = document.getElementById('admin-news-youtube').value.trim();
 const tiktokLink = document.getElementById('admin-news-tiktok').value.trim();
 const telegramLink = document.getElementById('admin-news-telegram').value.trim();
 const facebookLink = document.getElementById('admin-news-facebook').value.trim();

 if (!title || !content) {
   showNotification('Please enter news title and content.', 'warning');
   return;
 }

 showLoading(true);

 try {
   let mediaUrls = [];
   for (let i = 0; i < mediaFiles.length; i++) {
     const file = mediaFiles[i];
     const fileExt = file.name.split('.').pop();
     const fileName = `news_media/${state.adminProfile.id}_${Date.now()}_${i}.${fileExt}`;

     const { data: uploadData, error: uploadError } = await state.supabase.storage
       .from('news_media')
       .upload(fileName, file);

     if (uploadError) throw uploadError;

     const { data: urlData } = state.supabase.storage
       .from('news_media')
       .getPublicUrl(fileName);

     mediaUrls.push({ url: urlData.publicUrl, type: file.type, size: file.size });
   }

   const { error } = await state.supabase
     .from('news')
     .insert({
       admin_profile_id: state.adminProfile.id,
       title,
       content,
       media_urls: mediaUrls,
       youtube_link: youtubeLink || null,
       tiktok_link: tiktokLink || null,
       telegram_link: telegramLink || null,
       facebook_link: facebookLink || null,
       is_published: true,
       views: 0,
       likes: 0
     });

   if (error) throw error;

   // Clear form
   document.getElementById('admin-news-title').value = '';
   document.getElementById('admin-news-content').value = '';
   document.getElementById('admin-news-media').value = '';
   document.getElementById('admin-news-youtube').value = '';
   document.getElementById('admin-news-tiktok').value = '';
   document.getElementById('admin-news-telegram').value = '';
   document.getElementById('admin-news-facebook').value = '';

   showNotification('Admin News posted successfully!', 'success');
   loadAdminNews();
   loadDashboardData();
 } catch (error) {
   console.error('Error posting admin news:', error);
   showNotification('Failed to post news', 'error');
 } finally {
   showLoading(false);
 }
}

async function loadAdminNews() {
 const adminNewsTableBody = document.getElementById('admin-news-table-body');
 adminNewsTableBody.innerHTML = `
   <tr>
     <td colspan="5" class="text-center text-text-secondary py-8">
       <div class="loading-spinner mx-auto mb-2"></div>
       Loading admin news...
     </td>
   </tr>
 `;

 try {
   const { data: news, error } = await state.supabase
     .from('news')
     .select('*')
     .order('created_at', { ascending: false });

   if (error) throw error;

   if (news && news.length > 0) {
     adminNewsTableBody.innerHTML = news.map(item => {
       const statusClass = item.is_published ? 'status-active' : 'status-inactive';
       const statusText = item.is_published ? 'PUBLISHED' : 'DRAFT';

       return `
         <tr>
           <td>${item.title}</td>
           <td>${item.views || 0}</td>
           <td>${item.likes || 0}</td>
           <td class="${statusClass}">${statusText}</td>
           <td class="table-actions">
             <button onclick="viewNews('${item.id}')" class="myanmar-btn btn-small">
               <i class="fas fa-eye"></i> View
             </button>
             <button onclick="toggleAdminNewsPublishStatus('${item.id}', ${item.is_published})" class="myanmar-btn btn-small">
               <i class="fas ${item.is_published ? 'fa-eye-slash' : 'fa-eye'}"></i> ${item.is_published ? 'Unpublish' : 'Publish'}
             </button>
             <button onclick="deleteAdminNews('${item.id}')" class="btn-danger myanmar-btn btn-small">
               <i class="fas fa-trash"></i> Delete
             </button>
           </td>
         </tr>
       `;
     }).join('');
   } else {
     adminNewsTableBody.innerHTML = `
       <tr>
         <td colspan="5" class="text-center text-text-secondary py-8">
           <i class="fas fa-newspaper text-4xl mb-4"></i>
           <p>No Admin News Posted Yet</p>
         </td>
       </tr>
     `;
   }
 } catch (error) {
   console.error('Error loading admin news:', error);
   adminNewsTableBody.innerHTML = `
     <tr>
       <td colspan="5" class="text-center text-accent-red py-8">
         <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
         <p>Failed to retrieve Admin News</p>
       </td>
     </tr>
   `;
 }
}

async function viewNews(newsId) {
 showLoading(true);
 try {
   const { data, error } = await state.supabase
     .from('news')
     .select(`
       *,
       admin_profiles(username, name, profile_picture)
     `)
     .eq('id', newsId)
     .single();

   if (error) throw error;

   const author = data.admin_profiles;
   const authorName = author?.name || 'Unknown';
   const authorUsername = author?.username || 'unknown';
   const authorAvatar = author?.profile_picture || '/placeholder.svg?height=40&width=40';

   let mediaHtml = '';
   if (data.media_urls && data.media_urls.length > 0) {
     data.media_urls.forEach(media => {
       const mediaType = utils.getMediaType(media.type);
       if (mediaType === 'image') {
         mediaHtml += `<img src="${media.url}" class="w-full rounded-lg mb-3 object-cover" alt="News image">`;
       } else if (mediaType === 'video') {
         mediaHtml += `
           <div class="video-container mb-3 w-full" style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
             <video controls playsinline webkit-playsinline class="w-full rounded-lg" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;">
               <source src="${media.url}" type="${media.type}">
             </video>
           </div>
         `;
       } else if (mediaType === 'audio') {
         mediaHtml += `
           <div class="audio-container mb-3">
             <audio controls class="w-full">
               <source src="${media.url}" type="${media.type}">
             </audio>
           </div>
         `;
       }
     });
   }

   let socialLinksHtml = '';
   if (data.youtube_link) socialLinksHtml += `<a href="${data.youtube_link}" target="_blank" class="text-red-500 hover:text-red-400"><i class="fab fa-youtube text-2xl"></i></a>`;
   if (data.tiktok_link) socialLinksHtml += `<a href="${data.tiktok_link}" target="_blank" class="text-text-secondary hover:text-text-primary"><i class="fab fa-tiktok text-2xl"></i></a>`;
   if (data.telegram_link) socialLinksHtml += `<a href="${data.telegram_link}" target="_blank" class="text-blue-400 hover:text-blue-300"><i class="fab fa-telegram text-2xl"></i></a>`;
   if (data.facebook_link) socialLinksHtml += `<a href="${data.facebook_link}" target="_blank" class="text-blue-600 hover:text-blue-500"><i class="fab fa-facebook text-2xl"></i></a>`;


   document.getElementById('news-modal-content').innerHTML = `
     <div class="space-y-4">
       <div class="flex items-center space-x-3">
         <img src="${authorAvatar}"
              alt="Author" class="w-10 h-10 rounded-full object-cover">
         <div>
           <h4 class="font-semibold text-text-primary">${authorName} (Admin)</h4>
           <p class="text-sm text-text-secondary">@${authorUsername}</p>
         </div>
       </div>

       <h3 class="text-xl font-bold text-accent-purple">${data.title}</h3>

       ${mediaHtml}

       <div class="prose prose-invert max-w-none">
         <p class="text-text-secondary whitespace-pre-wrap">${data.content}</p>
       </div>

       ${socialLinksHtml ? `<div class="flex space-x-4 mt-4">${socialLinksHtml}</div>` : ''}

       <div class="flex items-center justify-between text-sm text-text-secondary pt-4 border-t border-border-color">
         <div class="flex space-x-4">
           <span><i class="fas fa-eye mr-1"></i> ${data.views || 0} VIEWS</span>
           <span><i class="fas fa-heart mr-1"></i> ${data.likes || 0} LIKES</span>
         </div>
         <span><i class="fas fa-calendar mr-1"></i> ${new Date(data.created_at).toLocaleString('my-MM')}</span>
       </div>
     </div>
   `;

   document.getElementById('news-modal').classList.remove('hidden');

 } catch (error) {
   console.error('Error viewing news:', error);
   showNotification('Failed to view News', 'error');
 } finally {
   showLoading(false);
 }
}

function closeNewsModal() {
 document.getElementById('news-modal').classList.add('hidden');
}

async function toggleAdminNewsPublishStatus(newsId, currentStatus) {
 showLoading(true);
 try {
   const { error } = await state.supabase
     .from('news')
     .update({ is_published: !currentStatus })
     .eq('id', newsId);

   if (error) throw error;

   showNotification(`News status updated to ${!currentStatus ? 'Published' : 'Draft'}`, 'success');
   loadAdminNews();
   loadDashboardData();
 } catch (error) {
   console.error('Error toggling news publish status:', error);
   showNotification('Failed to update news status', 'error');
 } finally {
   showLoading(false);
 }
}

function deleteAdminNews(newsId) {
 showConfirmModal(
   'Are you sure you want to delete this news post?',
   async () => {
     showLoading(true);
     try {
       const { error } = await state.supabase
         .from('news')
         .delete()
         .eq('id', newsId);

       if (error) throw error;

       showNotification('News post deleted successfully!', 'success');
       loadAdminNews();
       loadDashboardData();
     } catch (error) {
       console.error('Error deleting news:', error);
       showNotification('Failed to delete news post.', 'error');
     } finally {
       showLoading(false);
     }
   }
 );
}

async function loadUserNews() {
 const userNewsTableBody = document.getElementById('user-news-table-body');
 userNewsTableBody.innerHTML = `
   <tr>
     <td colspan="6" class="text-center text-text-secondary py-8">
       <div class="loading-spinner mx-auto mb-2"></div>
       Loading user news...
     </td>
   </tr>
 `;

 try {
   const { data: news, error } = await state.supabase
     .from('profile_news')
     .select(`
       *,
       profiles(username, name, profile_picture)
     `)
     .order('created_at', { ascending: false });

   if (error) throw error;

   if (news && news.length > 0) {
     userNewsTableBody.innerHTML = news.map(item => {
       const author = item.profiles;
       const authorName = author?.name || 'Unknown';
       const authorUsername = author?.username || 'unknown';
       const authorAvatar = author?.profile_picture || '/placeholder.svg?height=30&width=30';
       const statusClass = item.is_published ? 'status-active' : 'status-inactive';
       const statusText = item.is_published ? 'PUBLISHED' : 'DRAFT';

       return `
         <tr>
           <td>${item.title}</td>
           <td><img src="${authorAvatar}" class="w-8 h-8 rounded-full inline-block mr-2 object-cover" alt="Author Pic">${authorName} (@${authorUsername})</td>
           <td>${item.views || 0}</td>
           <td>${item.likes || 0}</td>
           <td class="${statusClass}">${statusText}</td>
           <td class="table-actions">
             <button onclick="viewUserNews('${item.id}')" class="myanmar-btn btn-small">
               <i class="fas fa-eye"></i> View
             </button>
             <button onclick="toggleUserNewsPublishStatus('${item.id}', ${item.is_published})" class="myanmar-btn btn-small">
               <i class="fas ${item.is_published ? 'fa-eye-slash' : 'fa-eye'}"></i> ${item.is_published ? 'Unpublish' : 'Publish'}
             </button>
             <button onclick="deleteUserNews('${item.id}')" class="btn-danger myanmar-btn btn-small">
               <i class="fas fa-trash"></i> Delete
             </button>
           </td>
         </tr>
       `;
     }).join('');
   } else {
     userNewsTableBody.innerHTML = `
       <tr>
         <td colspan="6" class="text-center text-text-secondary py-8">
           <i class="fas fa-newspaper text-4xl mb-4"></i>
           <p>No User News Posted Yet</p>
         </td>
       </tr>
     `;
   }
 } catch (error) {
   console.error('Error loading user news:', error);
   userNewsTableBody.innerHTML = `
     <tr>
       <td colspan="6" class="text-center text-accent-red py-8">
         <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
         <p>Failed to retrieve User News</p>
       </td>
     </tr>
   `;
 }
}

async function viewUserNews(newsId) {
 showLoading(true);
 try {
   const { data, error } = await state.supabase
     .from('profile_news')
     .select(`
       *,
       profiles(username, name, profile_picture)
     `)
     .eq('id', newsId)
     .single();

   if (error) throw error;

   const author = data.profiles;
   const authorName = author?.name || 'Unknown';
   const authorUsername = author?.username || 'unknown';
   const authorAvatar = author?.profile_picture || '/placeholder.svg?height=40&width=40';

   let mediaHtml = '';
   if (data.media_urls && data.media_urls.length > 0) {
     data.media_urls.forEach(media => {
       const mediaType = utils.getMediaType(media.type);
       if (mediaType === 'image') {
         mediaHtml += `<img src="${media.url}" class="w-full rounded-lg mb-3 object-cover" alt="News image">`;
       } else if (mediaType === 'video') {
         mediaHtml += `
           <div class="video-container mb-3 w-full" style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
             <video controls playsinline webkit-playsinline class="w-full rounded-lg" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;">
               <source src="${media.url}" type="${media.type}">
             </video>
           </div>
         `;
       } else if (mediaType === 'audio') {
         mediaHtml += `
           <div class="audio-container mb-3">
             <audio controls class="w-full">
               <source src="${media.url}" type="${media.type}">
             </audio>
           </div>
         `;
       }
     });
   }

   let socialLinksHtml = '';
   if (data.youtube_link) socialLinksHtml += `<a href="${data.youtube_link}" target="_blank" class="text-red-500 hover:text-red-400"><i class="fab fa-youtube text-2xl"></i></a>`;
   if (data.tiktok_link) socialLinksHtml += `<a href="${data.tiktok_link}" target="_blank" class="text-text-secondary hover:text-text-primary"><i class="fab fa-tiktok text-2xl"></i></a>`;
   if (data.telegram_link) socialLinksHtml += `<a href="${data.telegram_link}" target="_blank" class="text-blue-400 hover:text-blue-300"><i class="fab fa-telegram text-2xl"></i></a>`;
   if (data.facebook_link) socialLinksHtml += `<a href="${data.facebook_link}" target="_blank" class="text-blue-600 hover:text-blue-500"><i class="fab fa-facebook text-2xl"></i></a>`;


   document.getElementById('user-news-modal-content').innerHTML = `
     <div class="space-y-4">
       <div class="flex items-center space-x-3">
         <img src="${authorAvatar}"
              alt="Author" class="w-10 h-10 rounded-full object-cover">
         <div>
           <h4 class="font-semibold text-text-primary">${authorName}</h4>
           <p class="text-sm text-text-secondary">@${authorUsername}</p>
         </div>
       </div>

       <h3 class="text-xl font-bold text-accent-purple">${data.title}</h3>

       ${mediaHtml}

       <div class="prose prose-invert max-w-none">
         <p class="text-text-secondary whitespace-pre-wrap">${data.content}</p>
       </div>

       ${socialLinksHtml ? `<div class="flex space-x-4 mt-4">${socialLinksHtml}</div>` : ''}

       <div class="flex items-center justify-between text-sm text-text-secondary pt-4 border-t border-border-color">
         <div class="flex space-x-4">
           <span><i class="fas fa-eye mr-1"></i> ${data.views || 0} VIEWS</span>
           <span><i class="fas fa-heart mr-1"></i> ${data.likes || 0} LIKES</span>
         </div>
         <span><i class="fas fa-calendar mr-1"></i> ${new Date(data.created_at).toLocaleString('my-MM')}</span>
       </div>
     </div>
   `;

   document.getElementById('user-news-modal').classList.remove('hidden');

 } catch (error) {
   console.error('Error viewing user news:', error);
   showNotification('Failed to view User News', 'error');
 } finally {
   showLoading(false);
 }
}

function closeUserNewsModal() {
 document.getElementById('user-news-modal').classList.add('hidden');
}

async function toggleUserNewsPublishStatus(newsId, currentStatus) {
 showLoading(true);
 try {
   const { error } = await state.supabase
     .from('profile_news')
     .update({ is_published: !currentStatus })
     .eq('id', newsId);

   if (error) throw error;

   showNotification(`User News status updated to ${!currentStatus ? 'Published' : 'Draft'}`, 'success');
   loadUserNews();
   loadDashboardData();
 } catch (error) {
   console.error('Error toggling user news publish status:', error);
   showNotification('Failed to update user news status', 'error');
 } finally {
   showLoading(false);
 }
}

function deleteUserNews(newsId) {
 showConfirmModal(
   'Are you sure you want to delete this user news post?',
   async () => {
     showLoading(true);
     try {
       const { error } = await state.supabase
         .from('profile_news')
         .delete()
         .eq('id', newsId);

       if (error) throw error;

       showNotification('User News post deleted successfully!', 'success');
       loadUserNews();
       loadDashboardData();
     } catch (error) {
       console.error('Error deleting user news:', error);
       showNotification('Failed to delete user news post.', 'error');
     } finally {
       showLoading(false);
     }
   }
 );
}

async function uploadProduct() {
 const name = document.getElementById('product-name').value.trim();
 const description = document.getElementById('product-description').value.trim();
 const price = parseFloat(document.getElementById('product-price').value);
 const file = document.getElementById('product-file').files[0];
 const icon = document.getElementById('product-icon').files[0];

 if (!name || !description || isNaN(price) || price < 0 || !file) {
   showNotification('Please fill in all required fields: Name, Description, Price, and APK File.', 'warning');
   return;
 }

 showLoading(true);

 try {
   // Upload APK file
   const fileExt = file.name.split('.').pop();
   const fileName = `products/${Date.now()}_${file.name}`;
   const { data: fileUploadData, error: fileUploadError } = await state.supabase.storage
     .from('products')
     .upload(fileName, file);
   if (fileUploadError) throw fileUploadError;
   const { data: fileUrlData } = state.supabase.storage.from('products').getPublicUrl(fileName);
   const fileUrl = fileUrlData.publicUrl;

   let iconUrl = null;
   if (icon) {
     const iconExt = icon.name.split('.').pop();
     const iconName = `product_icons/${Date.now()}_${icon.name}`;
     const { data: iconUploadData, error: iconUploadError } = await state.supabase.storage
       .from('product_icons')
       .upload(iconName, icon);
     if (iconUploadError) throw iconUploadError;
     const { data: iconUrlData } = state.supabase.storage.from('product_icons').getPublicUrl(iconName);
     iconUrl = iconUrlData.publicUrl;
   }

   const { error } = await state.supabase
     .from('products')
     .insert({
       name,
       description,
       price,
       file_url: fileUrl,
       file_size: file.size,
       apk_icon_url: iconUrl,
       is_active: true,
       downloads: 0
     });

   if (error) throw error;

   // Clear form
   document.getElementById('product-name').value = '';
   document.getElementById('product-description').value = '';
   document.getElementById('product-price').value = '';
   document.getElementById('product-file').value = '';
   document.getElementById('product-icon').value = '';

   showNotification('Product uploaded successfully!', 'success');
   loadProducts();
   loadDashboardData();
 } catch (error) {
   console.error('Error uploading product:', error);
   showNotification('Failed to upload product', 'error');
 } finally {
   showLoading(false);
 }
}

async function loadProducts() {
 const productsTableBody = document.getElementById('products-table-body');
 productsTableBody.innerHTML = `
   <tr>
     <td colspan="6" class="text-center text-text-secondary py-8">
       <div class="loading-spinner mx-auto mb-2"></div>
       Loading products...
     </td>
   </tr>
 `;

 try {
   const { data: products, error } = await state.supabase
     .from('products')
     .select('*')
     .order('created_at', { ascending: false });

   if (error) throw error;

   if (products && products.length > 0) {
     productsTableBody.innerHTML = products.map(product => {
       const statusClass = product.is_active ? 'status-active' : 'status-inactive';
       const statusText = product.is_active ? 'ACTIVE' : 'INACTIVE';

       return `
         <tr>
           <td><img src="${product.apk_icon_url || '/placeholder.svg?height=50&width=50'}" class="w-12 h-12 object-contain rounded-md" alt="${product.name}"></td>
           <td>${product.name}</td>
           <td>${utils.formatPrice(product.price)}</td>
           <td>${utils.formatFileSize(product.file_size)}</td>
           <td class="${statusClass}">${statusText}</td>
           <td class="table-actions">
             <button onclick="viewProduct('${product.id}')" class="myanmar-btn btn-small">
               <i class="fas fa-eye"></i> View
             </button>
             <button onclick="toggleProductStatus('${product.id}', ${product.is_active})" class="myanmar-btn btn-small">
               <i class="fas ${product.is_active ? 'fa-eye-slash' : 'fa-eye'}"></i>
             </button>
             <button onclick="deleteProduct('${product.id}')" class="btn-danger myanmar-btn btn-small">
               <i class="fas fa-trash"></i>
             </button>
           </td>
         </tr>
       `;
     }).join('');
   } else {
     productsTableBody.innerHTML = `
       <tr>
         <td colspan="6" class="text-center text-text-secondary py-8">
           <i class="fas fa-box-open text-4xl mb-4"></i>
           <p>No Products Uploaded Yet</p>
         </td>
       </tr>
     `;
   }
 } catch (error) {
   console.error('Error loading products:', error);
   productsTableBody.innerHTML = `
     <tr>
       <td colspan="6" class="text-center text-accent-red py-8">
         <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
         <p>Failed to retrieve Products</p>
       </td>
     </tr>
   `;
 }
}

async function viewProduct(productId) {
 showLoading(true);
 try {
   const { data, error } = await state.supabase
     .from('products')
     .select('*')
     .eq('id', productId)
     .single();

   if (error) throw error;

   document.getElementById('product-modal-content').innerHTML = `
     <div class="space-y-4">
       <div class="flex items-center space-x-3 mb-4">
         <img src="${data.apk_icon_url || '/placeholder.svg?height=64&width=64'}" alt="${data.name} icon" class="w-16 h-16 object-contain">
         <div>
           <h3 class="text-xl font-bold text-accent-purple">${data.name}</h3>
           <p class="text-text-secondary text-sm">Price: ${utils.formatPrice(data.price)}</p>
         </div>
       </div>

       <p class="text-text-secondary whitespace-pre-wrap">${data.description || 'No description provided.'}</p>

       <div class="grid grid-cols-2 gap-4 text-sm text-text-secondary">
         <p><strong>File Size:</strong> ${utils.formatFileSize(data.file_size)}</p>
         <p><strong>Downloads:</strong> ${data.downloads || 0}</p>
         <p><strong>Status:</strong> <span class="${data.is_active ? 'status-active' : 'status-inactive'}">${data.is_active ? 'Active' : 'Inactive'}</span></p>
         <p><strong>Uploaded At:</strong> ${new Date(data.created_at).toLocaleString('my-MM')}</p>
       </div>

       <div class="flex gap-4 mt-6">
         <a href="${data.file_url}" target="_blank" download class="myanmar-btn flex-1">
           <i class="fas fa-download mr-2"></i> DOWNLOAD FILE
         </a>
       </div>
     </div>
   `;

   document.getElementById('product-modal').classList.remove('hidden');

 } catch (error) {
   console.error('Error viewing product:', error);
   showNotification('Failed to view Product', 'error');
 } finally {
   showLoading(false);
 }
}

function closeProductModal() {
 document.getElementById('product-modal').classList.add('hidden');
}

async function toggleProductStatus(productId, currentStatus) {
 showLoading(true);
 try {
   const { error } = await state.supabase
     .from('products')
     .update({ is_active: !currentStatus })
     .eq('id', productId);

   if (error) throw error;

   showNotification(`Product status updated to ${!currentStatus ? 'Active' : 'Inactive'}`, 'success');
   loadProducts();
   loadDashboardData();
 } catch (error) {
   console.error('Error toggling product status:', error);
   showNotification('Failed to update product status', 'error');
 } finally {
   showLoading(false);
 }
}

function deleteProduct(productId) {
 showConfirmModal(
   'Are you sure you want to delete this product? This will also delete all associated orders and purchased records.',
   async () => {
     showLoading(true);
     try {
       // Delete associated orders and purchased products first
       await state.supabase.from('orders').delete().eq('product_id', productId);
       await state.supabase.from('purchased_products').delete().eq('product_id', productId);

       const { error } = await state.supabase
         .from('products')
         .delete()
         .eq('id', productId);

       if (error) throw error;

       showNotification('Product deleted successfully!', 'success');
       loadProducts();
       loadDashboardData();
     } catch (error) {
       console.error('Error deleting product:', error);
       showNotification('Failed to delete product.', 'error');
     } finally {
       showLoading(false);
     }
   }
 );
}

async function loadUserProducts() {
 const userProductsTableBody = document.getElementById('user-products-table-body');
 userProductsTableBody.innerHTML = `
   <tr>
     <td colspan="7" class="text-center text-text-secondary py-8">
       <div class="loading-spinner mx-auto mb-2"></div>
       Loading user products...
     </td>
   </tr>
 `;

 try {
   const { data: products, error } = await state.supabase
     .from('user_products')
     .select(`
       *,
       profiles(username, name, profile_picture)
     `)
     .order('created_at', { ascending: false });

   if (error) throw error;

   if (products && products.length > 0) {
     userProductsTableBody.innerHTML = products.map(product => {
       const seller = product.profiles;
       const sellerName = seller?.name || 'Unknown Seller';
       const sellerUsername = seller?.username || 'unknown';
       const sellerAvatar = seller?.profile_picture || '/placeholder.svg?height=30&width=30';
       const productImageUrl = product.image_urls && product.image_urls.length > 0 ? product.image_urls[0].url : '/placeholder.svg?height=50&width=50';

       const activeStatusClass = product.is_active ? 'status-active' : 'status-inactive';
       const activeStatusText = product.is_active ? 'ACTIVE' : 'INACTIVE';
       const soldOutStatusClass = product.is_sold_out ? 'status-inactive' : 'status-active';
       const soldOutStatusText = product.is_sold_out ? 'YES' : 'NO';

       return `
         <tr>
           <td><img src="${productImageUrl}" class="w-12 h-12 object-cover rounded-md" alt="${product.name}"></td>
           <td>${product.name}</td>
           <td><img src="${sellerAvatar}" class="w-8 h-8 rounded-full inline-block mr-2 object-cover" alt="Seller Pic">${sellerName} (@${sellerUsername})</td>
           <td>${utils.formatPrice(product.price)}</td>
           <td class="${activeStatusClass}">${activeStatusText}</td>
           <td class="${soldOutStatusClass}">${soldOutStatusText}</td>
           <td class="table-actions">
             <button onclick="viewUserProduct('${product.id}')" class="myanmar-btn btn-small">
               <i class="fas fa-eye"></i> View
             </button>
             <button onclick="toggleUserProductActiveStatus('${product.id}', ${product.is_active})" class="myanmar-btn btn-small">
               <i class="fas ${product.is_active ? 'fa-eye-slash' : 'fa-eye'}"></i>
             </button>
             <button onclick="toggleUserProductSoldOutStatus('${product.id}', ${product.is_sold_out})" class="myanmar-btn btn-small">
               <i class="fas ${product.is_sold_out ? 'fa-check-circle' : 'fa-times-circle'}"></i>
             </button>
             <button onclick="deleteUserProduct('${product.id}')" class="btn-danger myanmar-btn btn-small">
               <i class="fas fa-trash"></i>
             </button>
           </td>
         </tr>
       `;
     }).join('');
   } else {
     userProductsTableBody.innerHTML = `
       <tr>
         <td colspan="7" class="text-center text-text-secondary py-8">
           <i class="fas fa-store text-4xl mb-4"></i>
           <p>No User Products Found</p>
         </td>
       </tr>
     `;
   }
 } catch (error) {
   console.error('Error loading user products:', error);
   userProductsTableBody.innerHTML = `
     <tr>
       <td colspan="7" class="text-center text-accent-red py-8">
         <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
         <p>Failed to retrieve User Products</p>
       </td>
     </tr>
   `;
 }
}

async function viewUserProduct(userProductId) {
 showLoading(true);
 try {
   const { data: product, error } = await state.supabase
     .from('user_products')
     .select(`
       *,
       profiles(username, name, profile_picture)
     `)
     .eq('id', userProductId)
     .single();

   if (error) throw error;
   if (!product) throw new Error('Product not found.');

   const seller = product.profiles;
   const sellerName = seller?.name || 'Unknown Seller';
   const sellerUsername = seller?.username || 'unknown';
   const sellerAvatar = seller?.profile_picture || '/placeholder.svg?height=40&width=40';

   let imagesHtml = '';
   if (product.image_urls && product.image_urls.length > 0) {
     imagesHtml = product.image_urls.map(img => `<img src="${img.url}" class="w-full rounded-lg mb-3 object-cover max-h-96" alt="Product image">`).join('');
   } else {
     imagesHtml = `<img src="/placeholder.svg?height=300&width=500" class="w-full rounded-lg mb-3 object-cover max-h-96" alt="No image">`;
   }

   let socialLinksHtml = '';
   if (product.social_links && product.social_links.length > 0) {
     socialLinksHtml = product.social_links.map(link => `
       <a href="${link.url}" target="_blank" class="text-text-secondary hover:text-accent-purple flex items-center space-x-2">
         <i class="${link.icon || 'fas fa-link'} text-xl"></i><span>${link.name}</span>
       </a>
     `).join('');
   }

   let contactInfoHtml = '';
   if (product.contact_info && product.contact_info.length > 0) {
     contactInfoHtml = product.contact_info.map(info => `
       <p class="text-text-secondary text-sm"><i class="fas fa-info-circle mr-1"></i> ${info.name}: ${info.value}</p>
     `).join('');
   }

   document.getElementById('user-product-modal-content').innerHTML = `
     <div class="space-y-4">
       <div class="flex items-center space-x-3 mb-4">
         <img src="${sellerAvatar}"
              alt="Author" class="w-10 h-10 rounded-full object-cover">
         <div>
           <h4 class="font-semibold text-text-primary">${sellerName}</h4>
           <p class="text-sm text-text-secondary">@${sellerUsername}</p>
         </div>
       </div>

       <h3 class="text-xl font-bold text-accent-purple">${product.name}</h3>

       <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
           ${imagesHtml}
       </div>

       <p class="text-text-secondary whitespace-pre-wrap">${product.description || 'No description provided.'}</p>

       <p class="text-2xl font-bold text-accent-green mb-3">${utils.formatPrice(product.price)}</p>

       ${socialLinksHtml ? `
         <div class="mt-4">
           <h4 class="font-semibold text-text-primary mb-2">Social Media:</h4>
           <div class="flex flex-wrap gap-4">${socialLinksHtml}</div>
         </div>
       ` : ''}

       ${contactInfoHtml ? `
         <div class="mt-4">
           <h4 class="font-semibold text-text-primary mb-2">Contact Info:</h4>
           <div class="space-y-1">${contactInfoHtml}</div>
         </div>
       ` : ''}

       <div class="flex gap-4 mt-6">
         <button onclick="initiateBuyerSellerChat('${product.seller_profile_id}', '${sellerName}', '${product.name}')" class="myanmar-btn flex-1">
           <i class="fas fa-comments mr-2"></i> CHAT WITH SELLER
         </button>
       </div>
     </div>
   `;

   document.getElementById('user-product-modal').classList.remove('hidden');

 } catch (error) {
   console.error('Error viewing user product:', error);
   showNotification('Failed to view User Product', 'error');
 } finally {
   showLoading(false);
 }
}

function closeUserProductModal() {
 document.getElementById('user-product-modal').classList.add('hidden');
}

async function toggleUserProductActiveStatus(productId, currentStatus) {
 showLoading(true);
 try {
   const { error } = await state.supabase
     .from('user_products')
     .update({ is_active: !currentStatus })
     .eq('id', productId);

   if (error) throw error;

   showNotification(`User Product status updated to ${!currentStatus ? 'Active' : 'Inactive'}`, 'success');
   loadUserProducts();
   loadDashboardData();
 } catch (error) {
   console.error('Error toggling user product active status:', error);
   showNotification('Failed to update user product active status', 'error');
 } finally {
   showLoading(false);
 }
}

async function toggleUserProductSoldOutStatus(productId, currentStatus) {
 showLoading(true);
 try {
   const { error } = await state.supabase
     .from('user_products')
     .update({ is_sold_out: !currentStatus })
     .eq('id', productId);

   if (error) throw error;

   showNotification(`User Product sold out status updated to ${!currentStatus ? 'Sold Out' : 'Available'}`, 'success');
   loadUserProducts();
   loadDashboardData();
 } catch (error) {
   console.error('Error toggling user product sold out status:', error);
   showNotification('Failed to update user product sold out status', 'error');
 } finally {
   showLoading(false);
 }
}

function deleteUserProduct(productId) {
 showConfirmModal(
   'Are you sure you want to delete this user product? This will also delete any associated user orders.',
   async () => {
     showLoading(true);
     try {
       // Delete associated user orders first
       await state.supabase.from('user_orders').delete().eq('user_product_id', productId);

       const { error } = await state.supabase
         .from('user_products')
         .delete()
         .eq('id', productId);

       if (error) throw error;

       showNotification('User Product deleted successfully!', 'success');
       loadUserProducts();
       loadDashboardData();
     } catch (error) {
       console.error('Error deleting user product:', error);
       showNotification('Failed to delete user product.', 'error');
     } finally {
       showLoading(false);
     }
   }
 );
}

async function loadAdminProductOrders() {
 const adminOrdersTableBody = document.getElementById('admin-orders-table-body');
 adminOrdersTableBody.innerHTML = `
   <tr>
     <td colspan="6" class="text-center text-text-secondary py-8">
       <div class="loading-spinner mx-auto mb-2"></div>
       Loading admin product orders...
     </td>
   </tr>
 `;

 try {
   const { data: orders, error } = await state.supabase
     .from('orders')
     .select(`
       *,
       profiles(username, name, profile_picture),
       products(name, price),
       payment_methods(method_name, account_info)
     `)
     .order('ordered_at', { ascending: false });

   if (error) throw error;

   if (orders && orders.length > 0) {
     adminOrdersTableBody.innerHTML = orders.map(order => {
       const buyer = order.profiles;
       const buyerName = buyer?.name || 'Unknown Buyer';
       const buyerUsername = buyer?.username || 'unknown';
       const buyerAvatar = buyer?.profile_picture || '/placeholder.svg?height=30&width=30';
       const productName = order.products?.name || 'N/A';
       const paymentMethodName = order.payment_methods?.method_name || 'N/A';
       const statusClass = {
         'pending': 'text-yellow-400',
         'approved': 'text-accent-green',
         'rejected': 'text-accent-red'
       }[order.status] || 'text-text-secondary';

       return `
         <tr>
           <td><img src="${buyerAvatar}" class="w-8 h-8 rounded-full inline-block mr-2 object-cover" alt="Buyer Pic">${buyerName} (@${buyerUsername})</td>
           <td>${productName}</td>
           <td>${utils.formatPrice(order.amount)}</td>
           <td>
             ${order.receipt_url ? `<a href="${order.receipt_url}" target="_blank" class="text-accent-purple hover:underline"><i class="fas fa-file-image mr-1"></i> View Receipt</a>` : 'N/A'}
           </td>
           <td class="${statusClass}">${order.status.toUpperCase()}</td>
           <td class="table-actions">
             ${order.status === 'pending' ? `
               <button onclick="updateAdminOrderStatus('${order.id}', 'approved')" class="myanmar-btn btn-small">
                 <i class="fas fa-check"></i> Approve
               </button>
               <button onclick="updateAdminOrderStatus('${order.id}', 'rejected')" class="btn-danger myanmar-btn btn-small">
                 <i class="fas fa-times"></i> Reject
               </button>
             ` : ''}
             <button onclick="viewAdminOrderDetails('${order.id}')" class="myanmar-btn btn-small">
               <i class="fas fa-eye"></i> Details
             </button>
           </td>
         </tr>
       `;
     }).join('');
   } else {
     adminOrdersTableBody.innerHTML = `
       <tr>
         <td colspan="6" class="text-center text-text-secondary py-8">
           <i class="fas fa-receipt text-4xl mb-4"></i>
           <p>No Admin Product Orders Found</p>
         </td>
       </tr>
     `;
   }
 } catch (error) {
   console.error('Error loading admin product orders:', error);
   adminOrdersTableBody.innerHTML = `
     <tr>
       <td colspan="6" class="text-center text-accent-red py-8">
         <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
         <p>Failed to retrieve Admin Product Orders</p>
       </td>
     </tr>
   `;
 }
}

async function updateAdminOrderStatus(orderId, newStatus) {
 showLoading(true);
 try {
   const { error } = await state.supabase
     .from('orders')
     .update({ status: newStatus })
     .eq('id', orderId);

   if (error) throw error;

   // If approved, add to purchased_products
   if (newStatus === 'approved') {
     const { data: order, error: fetchOrderError } = await state.supabase
       .from('orders')
       .select('profile_id, product_id')
       .eq('id', orderId)
       .single();

     if (fetchOrderError) throw fetchOrderError;

     const { error: insertError } = await state.supabase
       .from('purchased_products')
       .insert({
         profile_id: order.profile_id,
         product_id: order.product_id
       });

     if (insertError) throw insertError;

     // Increment product downloads
     await state.supabase.rpc('increment_product_downloads', { product_id_input: order.product_id });
   }

   showNotification(`Order ${orderId} status updated to ${newStatus.toUpperCase()}`, 'success');
   loadAdminProductOrders();
   loadDashboardData();
 } catch (error) {
   console.error('Error updating admin order status:', error);
   showNotification('Failed to update order status', 'error');
 } finally {
   showLoading(false);
 }
}

async function viewAdminOrderDetails(orderId) {
 showLoading(true);
 try {
   const { data: order, error } = await state.supabase
     .from('orders')
     .select(`
       *,
       profiles(username, name, profile_picture),
       products(name, description, price, file_url, apk_icon_url),
       payment_methods(method_name, account_info, instructions, qr_code_url)
     `)
     .eq('id', orderId)
     .single();

   if (error) throw error;
   if (!order) throw new Error('Order not found.');

   const buyer = order.profiles;
   const buyerName = buyer?.name || 'Unknown Buyer';
   const buyerUsername = buyer?.username || 'unknown';
   const buyerAvatar = buyer?.profile_picture || '/placeholder.svg?height=40&width=40';
   const product = order.products;
   const paymentMethod = order.payment_methods;

   document.getElementById('admin-order-details-modal-content').innerHTML = `
     <div class="space-y-4">
       <h3 class="text-xl font-bold text-accent-purple">Order ID: ${order.id.substring(0, 8)}...</h3>
       <p class="text-text-secondary">Status: <span class="${{ 'pending': 'text-yellow-400', 'approved': 'text-accent-green', 'rejected': 'text-accent-red' }[order.status]}">${order.status.toUpperCase()}</span></p>
       <p class="text-text-secondary">Ordered At: ${new Date(order.ordered_at).toLocaleString('my-MM')}</p>

       <div class="app-card p-4">
         <h4 class="font-semibold text-accent-green mb-2">Buyer Details</h4>
         <div class="flex items-center space-x-3">
           <img src="${buyerAvatar}" alt="Buyer" class="w-10 h-10 rounded-full object-cover">
           <div>
             <p class="font-semibold text-text-primary">${buyerName}</p>
             <p class="text-sm text-text-secondary">@${buyerUsername}</p>
           </div>
         </div>
       </div>

       <div class="app-card p-4">
         <h4 class="font-semibold text-accent-green mb-2">Product Details</h4>
         <div class="flex items-center space-x-3 mb-2">
           <img src="${product.apk_icon_url || '/placeholder.svg?height=40&width=40'}" alt="Product Icon" class="w-10 h-10 object-contain">
           <p class="font-semibold text-text-primary">${product.name}</p>
         </div>
         <p class="text-text-secondary text-sm">${product.description}</p>
         <p class="text-lg font-bold text-accent-green mt-2">Price: ${utils.formatPrice(product.price)}</p>
         ${order.status === 'approved' ? `
           <a href="${product.file_url}" target="_blank" download class="myanmar-btn btn-small mt-4">
             <i class="fas fa-download mr-2"></i> DOWNLOAD PRODUCT
           </a>
         ` : ''}
       </div>

       <div class="app-card p-4">
         <h4 class="font-semibold text-accent-green mb-2">Payment Details</h4>
         <p class="text-text-secondary">Amount: ${utils.formatPrice(order.amount)}</p>
         <p class="text-text-secondary">Method: ${paymentMethod.method_name}</p>
         <p class="text-text-secondary">Account: ${paymentMethod.account_info}</p>
         ${order.receipt_url ? `<p class="text-text-secondary"><a href="${order.receipt_url}" target="_blank" class="text-accent-purple hover:underline"><i class="fas fa-file-image mr-1"></i> View Receipt</a></p>` : ''}
         ${paymentMethod.qr_code_url ? `<img src="${paymentMethod.qr_code_url}" class="w-32 h-32 mt-2 rounded-md border border-border-color" alt="QR Code">` : ''}
         ${paymentMethod.instructions ? `<p class="text-text-secondary text-xs mt-2">Instructions: ${paymentMethod.instructions}</p>` : ''}
       </div>

       <div class="flex gap-4 mt-6">
         ${order.status === 'pending' ? `
           <button onclick="updateAdminOrderStatus('${order.id}', 'approved')" class="myanmar-btn flex-1">
             <i class="fas fa-check mr-2"></i> APPROVE ORDER
           </button>
           <button onclick="updateAdminOrderStatus('${order.id}', 'rejected')" class="btn-danger myanmar-btn flex-1">
             <i class="fas fa-times mr-2"></i> REJECT ORDER
           </button>
         ` : ''}
       </div>
     </div>
   `;

   document.getElementById('admin-order-details-modal').classList.remove('hidden');

 } catch (error) {
   console.error('Error viewing admin order details:', error);
   showNotification('Failed to view Order Details', 'error');
 } finally {
   showLoading(false);
 }
}

function closeAdminOrderDetailsModal() {
 document.getElementById('admin-order-details-modal').classList.add('hidden');
}

async function loadUserProductOrders() {
 const userOrdersTableBody = document.getElementById('user-orders-table-body');
 userOrdersTableBody.innerHTML = `
   <tr>
     <td colspan="7" class="text-center text-text-secondary py-8">
       <div class="loading-spinner mx-auto mb-2"></div>
       Loading user product orders...
     </td>
   </tr>
 `;

 try {
   const { data: orders, error } = await state.supabase
     .from('user_orders')
     .select(`
       *,
       buyer_profile:profiles!buyer_profile_id(username, name, profile_picture),
       seller_profile:profiles!seller_profile_id(username, name, profile_picture),
       user_products(name, price)
     `)
     .order('ordered_at', { ascending: false });

   if (error) throw error;

   if (orders && orders.length > 0) {
     userOrdersTableBody.innerHTML = orders.map(order => {
       const buyer = order.buyer_profile;
       const buyerName = buyer?.name || 'Unknown Buyer';
       const buyerUsername = buyer?.username || 'unknown';
       const buyerAvatar = buyer?.profile_picture || '/placeholder.svg?height=30&width=30';

       const seller = order.seller_profile;
       const sellerName = seller?.name || 'Unknown Seller';
       const sellerUsername = seller?.username || 'unknown';
       const sellerAvatar = seller?.profile_picture || '/placeholder.svg?height=30&width=30';

       const productName = order.user_products?.name || 'N/A';
       const statusClass = {
         'pending': 'text-yellow-400',
         'approved': 'text-accent-green',
         'rejected': 'text-accent-red',
         'delivered': 'text-blue-400',
         'cancelled': 'text-gray-400'
       }[order.status] || 'text-text-secondary';

       return `
         <tr>
           <td><img src="${buyerAvatar}" class="w-8 h-8 rounded-full inline-block mr-2 object-cover" alt="Buyer Pic">${buyerName} (@${buyerUsername})</td>
           <td><img src="${sellerAvatar}" class="w-8 h-8 rounded-full inline-block mr-2 object-cover" alt="Seller Pic">${sellerName} (@${sellerUsername})</td>
           <td>${productName}</td>
           <td>${utils.formatPrice(order.amount)}</td>
           <td>
             ${order.receipt_url ? `<a href="${order.receipt_url}" target="_blank" class="text-accent-purple hover:underline"><i class="fas fa-file-image mr-1"></i> View Receipt</a>` : 'N/A'}
           </td>
           <td class="${statusClass}">${order.status.toUpperCase()}</td>
           <td class="table-actions">
             <button onclick="updateUserProductOrderStatus('${order.id}', 'approved')" class="myanmar-btn btn-small">
               <i class="fas fa-check"></i> Approve
             </button>
             <button onclick="updateUserProductOrderStatus('${order.id}', 'rejected')" class="btn-danger myanmar-btn btn-small">
               <i class="fas fa-times"></i> Reject
             </button>
             <button onclick="updateUserProductOrderStatus('${order.id}', 'delivered')" class="myanmar-btn btn-small">
               <i class="fas fa-truck"></i> Delivered
             </button>
             <button onclick="viewUserProductOrderDetails('${order.id}')" class="myanmar-btn btn-small">
               <i class="fas fa-eye"></i> Details
             </button>
           </td>
         </tr>
       `;
     }).join('');
   } else {
     userOrdersTableBody.innerHTML = `
       <tr>
         <td colspan="7" class="text-center text-text-secondary py-8">
           <i class="fas fa-receipt text-4xl mb-4"></i>
           <p>No User Product Orders Found</p>
         </td>
       </tr>
     `;
   }
 } catch (error) {
   console.error('Error loading user product orders:', error);
   userOrdersTableBody.innerHTML = `
     <tr>
       <td colspan="7" class="text-center text-accent-red py-8">
         <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
         <p>Failed to retrieve User Product Orders</p>
       </td>
     </tr>
   `;
 }
}

async function updateUserProductOrderStatus(orderId, newStatus) {
 showLoading(true);
 try {
   const { error } = await state.supabase
     .from('user_orders')
     .update({ status: newStatus })
     .eq('id', orderId);

   if (error) throw error;

   showNotification(`User Order ${orderId} status updated to ${newStatus.toUpperCase()}`, 'success');
   loadUserProductOrders();
   loadDashboardData();
 } catch (error) {
   console.error('Error updating user product order status:', error);
   showNotification('Failed to update user order status', 'error');
 } finally {
   showLoading(false);
 }
}

async function viewUserProductOrderDetails(orderId) {
 showLoading(true);
 try {
   const { data: order, error } = await state.supabase
     .from('user_orders')
     .select(`
       *,
       buyer_profile:profiles!buyer_profile_id(username, name, profile_picture),
       seller_profile:profiles!seller_profile_id(username, name, profile_picture),
       user_products(name, description, price, image_urls, social_links, contact_info),
       seller_payment_methods(method_name, account_info, instructions, qr_code_url)
     `)
     .eq('id', orderId)
     .single();

   if (error) throw error;
   if (!order) throw new Error('Order not found.');

   const buyer = order.buyer_profile;
   const buyerName = buyer?.name || 'Unknown Buyer';
   const buyerUsername = buyer?.username || 'unknown';
   const buyerAvatar = buyer?.profile_picture || '/placeholder.svg?height=40&width=40';

   const seller = order.seller_profile;
   const sellerName = seller?.name || 'Unknown Seller';
   const sellerUsername = seller?.username || 'unknown';
   const sellerAvatar = seller?.profile_picture || '/placeholder.svg?height=40&width=40';

   const product = order.user_products;
   const paymentMethod = order.seller_payment_methods;

   let productImagesHtml = '';
   if (product.image_urls && product.image_urls.length > 0) {
     productImagesHtml = product.image_urls.map(img => `<img src="${img.url}" class="w-full rounded-lg mb-3 object-cover max-h-48" alt="Product image">`).join('');
   }

   let productSocialLinksHtml = '';
   if (product.social_links && product.social_links.length > 0) {
     productSocialLinksHtml = product.social_links.map(link => `
       <a href="${link.url}" target="_blank" class="text-text-secondary hover:text-accent-purple flex items-center space-x-2">
         <i class="${link.icon || 'fas fa-link'} text-xl"></i><span>${link.name}</span>
       </a>
     `).join('');
   }

   let productContactInfoHtml = '';
   if (product.contact_info && product.contact_info.length > 0) {
     productContactInfoHtml = product.contact_info.map(info => `
       <p class="text-text-secondary text-sm"><i class="fas fa-info-circle mr-1"></i> ${info.name}: ${info.value}</p>
     `).join('');
   }

   document.getElementById('user-order-details-modal-content').innerHTML = `
     <div class="space-y-4">
       <h3 class="text-xl font-bold text-accent-purple">Order ID: ${order.id.substring(0, 8)}...</h3>
       <p class="text-text-secondary">Status: <span class="${{ 'pending': 'text-yellow-400', 'approved': 'text-accent-green', 'rejected': 'text-accent-red', 'delivered': 'text-blue-400', 'cancelled': 'text-gray-400' }[order.status]}">${order.status.toUpperCase()}</span></p>
       <p class="text-text-secondary">Ordered At: ${new Date(order.ordered_at).toLocaleString('my-MM')}</p>

       <div class="app-card p-4">
         <h4 class="font-semibold text-accent-green mb-2">Buyer Details</h4>
         <div class="flex items-center space-x-3">
           <img src="${buyerAvatar}" alt="Buyer" class="w-10 h-10 rounded-full object-cover">
           <div>
             <p class="font-semibold text-text-primary">${buyerName}</p>
             <p class="text-sm text-text-secondary">@${buyerUsername}</p>
           </div>
         </div>
         ${order.buyer_notes ? `<p class="text-text-secondary text-sm mt-2"><strong>Buyer Notes:</strong> ${order.buyer_notes}</p>` : ''}
       </div>

       <div class="app-card p-4">
         <h4 class="font-semibold text-accent-green mb-2">Seller Details</h4>
         <div class="flex items-center space-x-3">
           <img src="${sellerAvatar}" alt="Seller" class="w-10 h-10 rounded-full object-cover">
           <div>
             <p class="font-semibold text-text-primary">${sellerName}</p>
             <p class="text-sm text-text-secondary">@${sellerUsername}</p>
           </div>
         </div>
       </div>

       <div class="app-card p-4">
         <h4 class="font-semibold text-accent-green mb-2">Product Details</h4>
         <h3 class="text-xl font-bold text-accent-purple">${product.name}</h3>
         <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
             ${productImagesHtml}
         </div>
         <p class="text-text-secondary whitespace-pre-wrap">${product.description || 'No description provided.'}</p>
         <p class="text-2xl font-bold text-accent-green mt-2">Price: ${utils.formatPrice(product.price)}</p>
         ${productSocialLinksHtml ? `
           <div class="mt-4">
             <h4 class="font-semibold text-text-primary mb-2">Social Media:</h4>
             <div class="flex flex-wrap gap-4">${productSocialLinksHtml}</div>
           </div>
         ` : ''}
         ${productContactInfoHtml ? `
           <div class="mt-4">
             <h4 class="font-semibold text-text-primary mb-2">Contact Info:</h4>
             <div class="space-y-1">${productContactInfoHtml}</div>
           </div>
         ` : ''}
       </div>

       <div class="app-card p-4">
         <h4 class="font-semibold text-accent-green mb-2">Payment Details</h4>
         <p class="text-text-secondary">Amount: ${utils.formatPrice(order.amount)}</p>
         <p class="text-text-secondary">Method: ${paymentMethod.method_name}</p>
         <p class="text-text-secondary">Account: ${paymentMethod.account_info}</p>
         ${order.receipt_url ? `<p class="text-text-secondary"><a href="${order.receipt_url}" target="_blank" class="text-accent-purple hover:underline"><i class="fas fa-file-image mr-1"></i> View Receipt</a></p>` : ''}
         ${paymentMethod.qr_code_url ? `<img src="${paymentMethod.qr_code_url}" class="w-32 h-32 mt-2 rounded-md border border-border-color" alt="QR Code">` : ''}
         ${paymentMethod.instructions ? `<p class="text-text-secondary text-xs mt-2">Instructions: ${paymentMethod.instructions}</p>` : ''}
       </div>

       <div class="flex gap-4 mt-6">
         ${order.status === 'pending' ? `
           <button onclick="updateUserProductOrderStatus('${order.id}', 'approved')" class="myanmar-btn flex-1">
             <i class="fas fa-check mr-2"></i> APPROVE ORDER
           </button>
           <button onclick="updateUserProductOrderStatus('${order.id}', 'rejected')" class="btn-danger myanmar-btn flex-1">
             <i class="fas fa-times mr-2"></i> REJECT ORDER
           </button>
         ` : order.status === 'approved' ? `
           <button onclick="updateUserProductOrderStatus('${order.id}', 'delivered')" class="myanmar-btn flex-1">
             <i class="fas fa-truck mr-2"></i> MARK AS DELIVERED
           </button>
         ` : ''}
       </div>
     </div>
   `;

   document.getElementById('user-order-details-modal').classList.remove('hidden');

 } catch (error) {
   console.error('Error viewing user product order details:', error);
   showNotification('Failed to view User Product Order Details', 'error');
 } finally {
   showLoading(false);
 }
}

function closeUserOrderDetailsModal() {
 document.getElementById('user-order-details-modal').classList.add('hidden');
}

async function addPaymentMethod() {
 const methodName = document.getElementById('payment-method-name').value.trim();
 const accountInfo = document.getElementById('payment-account-info').value.trim();
 const instructions = document.getElementById('payment-instructions').value.trim();
 const qrCodeFile = document.getElementById('payment-qr-code').files[0];

 if (!methodName || !accountInfo) {
   showNotification('Please enter Method Name and Account Info.', 'warning');
   return;
 }

 showLoading(true);

 try {
   let qrCodeUrl = null;
   if (qrCodeFile) {
     const fileExt = qrCodeFile.name.split('.').pop();
     const fileName = `payment_qrcodes/${Date.now()}.${fileExt}`;

     const { data: uploadData, error: uploadError } = await state.supabase.storage
       .from('payment_qr_codes')
       .upload(fileName, qrCodeFile);

     if (uploadError) throw uploadError;

     const { data: urlData } = state.supabase.storage
       .from('payment_qr_codes')
       .getPublicUrl(fileName);

     qrCodeUrl = urlData.publicUrl;
   }

   const { error } = await state.supabase
     .from('payment_methods')
     .insert({
       method_name: methodName,
       account_info: accountInfo,
       qr_code_url: qrCodeUrl,
       instructions: instructions || null,
       is_active: true
     });

   if (error) throw error;

   // Clear form
   document.getElementById('payment-method-name').value = '';
   document.getElementById('payment-account-info').value = '';
   document.getElementById('payment-instructions').value = '';
   document.getElementById('payment-qr-code').value = '';

   showNotification('Payment method added successfully!', 'success');
   loadPaymentMethods();
 } catch (error) {
   console.error('Error adding payment method:', error);
   showNotification('Failed to add payment method', 'error');
 } finally {
   showLoading(false);
 }
}

async function loadPaymentMethods() {
 const paymentMethodsTableBody = document.getElementById('payment-methods-table-body');
 paymentMethodsTableBody.innerHTML = `
   <tr>
     <td colspan="5" class="text-center text-text-secondary py-8">
       <div class="loading-spinner mx-auto mb-2"></div>
       Loading payment methods...
     </td>
   </tr>
 `;

 try {
   const { data: methods, error } = await state.supabase
     .from('payment_methods')
     .select('*')
     .order('created_at', { ascending: false });

   if (error) throw error;

   if (methods && methods.length > 0) {
     paymentMethodsTableBody.innerHTML = methods.map(method => {
       const statusClass = method.is_active ? 'status-active' : 'status-inactive';
       const statusText = method.is_active ? 'ACTIVE' : 'INACTIVE';

       return `
         <tr>
           <td>${method.method_name}</td>
           <td>${method.account_info}</td>
           <td>
             ${method.qr_code_url ? `<img src="${method.qr_code_url}" class="w-16 h-16 object-contain rounded-md" alt="QR Code">` : 'N/A'}
           </td>
           <td class="${statusClass}">${statusText}</td>
           <td class="table-actions">
             <button onclick="togglePaymentMethodStatus('${method.id}', ${method.is_active})" class="myanmar-btn btn-small">
               <i class="fas ${method.is_active ? 'fa-eye-slash' : 'fa-eye'}"></i>
             </button>
             <button onclick="deletePaymentMethod('${method.id}')" class="btn-danger myanmar-btn btn-small">
               <i class="fas fa-trash"></i>
             </button>
           </td>
         </tr>
       `;
     }).join('');
   } else {
     paymentMethodsTableBody.innerHTML = `
       <tr>
         <td colspan="5" class="text-center text-text-secondary py-8">
           <i class="fas fa-wallet text-4xl mb-4"></i>
           <p>No Payment Methods Added Yet</p>
         </td>
       </tr>
     `;
   }
 } catch (error) {
   console.error('Error loading payment methods:', error);
   paymentMethodsTableBody.innerHTML = `
     <tr>
       <td colspan="5" class="text-center text-accent-red py-8">
         <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
         <p>Failed to retrieve Payment Methods</p>
       </td>
     </tr>
   `;
 }
}

async function togglePaymentMethodStatus(methodId, currentStatus) {
 showLoading(true);
 try {
   const { error } = await state.supabase
     .from('payment_methods')
     .update({ is_active: !currentStatus })
     .eq('id', methodId);

   if (error) throw error;

   showNotification(`Payment method status updated to ${!currentStatus ? 'Active' : 'Inactive'}`, 'success');
   loadPaymentMethods();
 } catch (error) {
   console.error('Error toggling payment method status:', error);
   showNotification('Failed to update payment method status', 'error');
 } finally {
   showLoading(false);
 }
}

function deletePaymentMethod(methodId) {
 showConfirmModal(
   'Are you sure you want to delete this payment method? This will not affect existing orders.',
   async () => {
     showLoading(true);
     try {
       const { error } = await state.supabase
         .from('payment_methods')
         .delete()
         .eq('id', methodId);

       if (error) throw error;

       showNotification('Payment method deleted successfully!', 'success');
       loadPaymentMethods();
     } catch (error) {
       console.error('Error deleting payment method:', error);
       showNotification('Failed to delete payment method.', 'error');
     } finally {
       showLoading(false);
     }
   }
 );
}

async function loadGlobalChatMessages() {
 const chatMessagesContainer = document.getElementById('chat-messages');
 chatMessagesContainer.innerHTML = `
   <div class="loading-spinner mx-auto mb-4"></div>
   <p class="text-center text-text-secondary">Loading messages...</p>
 `;
 chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight; // Scroll to bottom

 try {
   // Get or create conversation with admin's own profile (for global chat)
   const { data: conversationId, error: convError } = await state.supabase.rpc('get_or_create_conversation', {
     user1_id: state.adminProfile.id,
     user2_id: state.adminProfile.id // Admin chats with self for global chat
   });
   if (convError) throw convError;

   const { data: messages, error } = await state.supabase
     .from('chat_messages')
     .select(`
       *,
       sender:profiles!sender_id(username, name, profile_picture),
       admin_sender:admin_profiles!sender_id(username, name, profile_picture)
     `)
     .eq('conversation_id', conversationId)
     .order('created_at', { ascending: true });

   if (error) throw error;

   if (messages && messages.length > 0) {
     chatMessagesContainer.innerHTML = messages.map(msg => {
       const isSender = msg.sender_id === state.adminProfile.id;
       const senderName = isSender ? 'You (Admin)' : msg.sender?.name || 'Unknown User';
       const senderAvatar = isSender ? (state.adminProfile.profile_picture || '/placeholder.svg?height=30&width=30') : (msg.sender?.profile_picture || '/placeholder.svg?height=30&width=30');
       const messageTime = new Date(msg.created_at).toLocaleTimeString('my-MM', { hour: '2-digit', minute: '2-digit' });

       return `
         <div class="flex ${isSender ? 'justify-end' : 'justify-start'} mb-4">
           <div class="flex ${isSender ? 'flex-row-reverse' : 'flex-row'} items-start space-x-2 ${isSender ? 'space-x-reverse' : ''}">
             <img src="${senderAvatar}" alt="${senderName}" class="w-8 h-8 rounded-full object-cover">
             <div class="p-3 rounded-lg ${isSender ? 'bg-accent-purple text-black' : 'bg-secondary-bg text-text-primary'} max-w-xs md:max-w-md">
               <p class="font-semibold text-sm ${isSender ? 'text-black' : 'text-accent-green'}">${senderName}</p>
               <p class="text-text-primary whitespace-pre-wrap">${msg.content}</p>
               <p class="text-xs text-right ${isSender ? 'text-gray-800' : 'text-text-secondary'} mt-1">${messageTime}</p>
             </div>
           </div>
         </div>
       `;
     }).join('');
     chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight; // Scroll to bottom after rendering
   } else {
     chatMessagesContainer.innerHTML = `
       <div class="text-center text-text-secondary py-8">
         <i class="fas fa-comments text-4xl mb-4"></i>
         <p>No messages yet. Start the conversation!</p>
       </div>
     `;
   }
 } catch (error) {
   console.error('Error loading global chat messages:', error);
   chatMessagesContainer.innerHTML = `
     <div class="text-center text-accent-red py-8">
       <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
       <p>Failed to retrieve messages</p>
     </div>
   `;
 }
}

async function sendChatMessage() {
 if (!state.adminProfile || !state.adminProfile.id) {
   showNotification('Admin profile not loaded. Please re-login.', 'error');
   return;
 }

 const chatInput = document.getElementById('chat-input');
 const messageContent = chatInput.value.trim();

 if (!messageContent) {
   showNotification('Message cannot be empty.', 'warning');
   return;
 }

 chatInput.value = ''; // Clear input immediately

 try {
   // Get or create conversation with admin's own profile (for global chat)
   const { data: conversationId, error: convError } = await state.supabase.rpc('get_or_create_conversation', {
     user1_id: state.adminProfile.id,
     user2_id: state.adminProfile.id
   });
   if (convError) throw convError;

   const { error } = await state.supabase
     .from('chat_messages')
     .insert({
       conversation_id: conversationId,
       sender_id: state.adminProfile.id,
       content: messageContent
     });

   if (error) throw error;

   // Update last_message_at for the conversation
   await state.supabase
     .from('chat_conversations')
     .update({ last_message_at: new Date().toISOString() })
     .eq('id', conversationId);

   // Message will be reloaded by realtime subscription
 } catch (error) {
   console.error('Error sending chat message:', error);
   showNotification('Failed to send message', 'error');
 }
}

async function loadPrivateChatList() {
 const privateChatListContainer = document.getElementById('private-chat-list');
 if (!state.adminProfile || !state.adminProfile.id) {
   privateChatListContainer.innerHTML = `
     <div class="text-center text-text-secondary py-8">
       <i class="fas fa-user-friends text-4xl mb-4"></i>
       <p>Admin profile not loaded. Please re-login.</p>
     </div>
   `;
   return;
 }

 privateChatListContainer.innerHTML = `
   <div class="loading-spinner mx-auto mb-4"></div>
   <p class="text-center text-text-secondary">Loading private chats...</p>
 `;

 try {
   const { data: conversations, error } = await state.supabase
     .from('buyer_seller_conversations')
     .select(`
       id,
       profile1_id,
       profile2_id,
       last_message_at,
       profile1:profiles!profile1_id(username, name, profile_picture),
       profile2:profiles!profile2_id(username, name, profile_picture)
     `)
     .or(`profile1_id.eq.${state.adminProfile.id},profile2_id.eq.${state.adminProfile.id}`)
     .order('last_message_at', { ascending: false });

   if (error) throw error;

   if (conversations && conversations.length > 0) {
     privateChatListContainer.innerHTML = conversations.map(conv => {
       const otherProfile = conv.profile1_id === state.adminProfile.id ? conv.profile2 : conv.profile1;
       const otherProfileId = conv.profile1_id === state.adminProfile.id ? conv.profile2_id : conv.profile1_id;
       const otherName = otherProfile?.name || 'Unknown User';
       const otherUsername = otherProfile?.username || 'unknown';
       const otherAvatar = otherProfile?.profile_picture || '/placeholder.svg?height=40&width=40';
       const lastMessageTime = new Date(conv.last_message_at).toLocaleString('my-MM', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });

       return `
         <div class="chat-list-item" onclick="openPrivateChat('${conv.id}', '${otherProfileId}', '${otherName}')">
           <img src="${otherAvatar}" alt="${otherName}" class="w-10 h-10 rounded-full object-cover">
           <div class="flex-grow">
             <p class="font-semibold text-text-primary">${otherName} (@${otherUsername})</p>
             <p class="text-sm text-text-secondary">Last message: ${lastMessageTime}</p>
           </div>
           <i class="fas fa-chevron-right text-text-secondary"></i>
         </div>
       `;
     }).join('');
   } else {
     privateChatListContainer.innerHTML = `
       <div class="text-center text-text-secondary py-8">
         <i class="fas fa-user-friends text-4xl mb-4"></i>
         <p>No private conversations yet.</p>
       </div>
     `;
   }
 } catch (error) {
   console.error('Error loading private chat list:', error);
   privateChatListContainer.innerHTML = `
     <div class="text-center text-accent-red py-8">
       <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
       <p>Failed to retrieve private chats</p>
     </div>
   `;
 }
}

async function openPrivateChat(conversationId, chatPartnerProfileId, chatPartnerName) {
 if (!state.adminProfile || !state.adminProfile.id) {
   showNotification('Admin profile not loaded. Please re-login.', 'error');
   return;
 }

 showLoading(true);
 try {
   state.currentBuyerSellerConversationId = conversationId;
   state.currentChatPartnerProfileId = chatPartnerProfileId;
   document.getElementById('chat-modal-title').textContent = `CHAT WITH ${chatPartnerName}`;

   await loadBuyerSellerChatMessages(conversationId, chatPartnerProfileId);
   document.getElementById('buyer-seller-chat-modal').classList.remove('hidden');
 } catch (error) {
   console.error('Error opening private chat:', error);
   showNotification('Failed to open private chat', 'error');
 } finally {
   showLoading(false);
 }
}

async function initiateBuyerSellerChat(userProfileId, userName, productName = '') {
 if (!state.adminProfile || !state.adminProfile.id) {
   showNotification('Admin profile not loaded. Please re-login.', 'error');
   return;
 }
 if (state.adminProfile.id === userProfileId) {
   showNotification('You cannot chat with yourself.', 'warning');
   return;
 }

 showLoading(true);
 try {
   const { data, error } = await state.supabase.rpc('get_or_create_buyer_seller_conversation', {
     profile1_id: state.adminProfile.id,
     profile2_id: userProfileId
   });

   if (error) throw error;

   state.currentBuyerSellerConversationId = data;
   state.currentChatPartnerProfileId = userProfileId;
   document.getElementById('chat-modal-title').textContent = `CHAT WITH ${userName} ${productName ? `(for ${productName})` : ''}`;

   await loadBuyerSellerChatMessages(data, userProfileId);
   document.getElementById('buyer-seller-chat-modal').classList.remove('hidden');
 } catch (error) {
   console.error('Error initiating buyer-seller chat:', error);
   showNotification('Failed to start chat with user', 'error');
 } finally {
   showLoading(false);
 }
}

function closeBuyerSellerChatModal() {
 document.getElementById('buyer-seller-chat-modal').classList.add('hidden');
 state.currentBuyerSellerConversationId = null;
 state.currentChatPartnerProfileId = null;
 document.getElementById('buyer-seller-chat-input').value = '';
 document.getElementById('buyer-seller-chat-file-upload').value = '';
}

async function loadBuyerSellerChatMessages(conversationId, chatPartnerProfileId) {
 const chatMessagesContainer = document.getElementById('buyer-seller-chat-messages');
 chatMessagesContainer.innerHTML = `
   <div class="loading-spinner mx-auto mb-4"></div>
   <p class="text-center text-text-secondary">Loading messages...</p>
 `;
 chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight; // Scroll to bottom

 try {
   const { data: messages, error } = await state.supabase
     .from('buyer_seller_messages')
     .select(`
       *,
       sender_profile:profiles!sender_profile_id(username, name, profile_picture),
       admin_sender:admin_profiles!sender_profile_id(username, name, profile_picture)
     `)
     .eq('conversation_id', conversationId)
     .order('created_at', { ascending: true });

   if (error) throw error;

   if (messages && messages.length > 0) {
     chatMessagesContainer.innerHTML = messages.map(msg => {
       const isSender = msg.sender_profile_id === state.adminProfile.id;
       const senderName = isSender ? 'You (Admin)' : msg.sender_profile?.name || 'Unknown User';
       const senderAvatar = isSender ? (state.adminProfile.profile_picture || '/placeholder.svg?height=30&width=30') : (msg.sender_profile?.profile_picture || '/placeholder.svg?height=30&width=30');
       const messageTime = new Date(msg.created_at).toLocaleTimeString('my-MM', { hour: '2-digit', minute: '2-digit' });

       let contentHtml = '';
       if (msg.message_type === 'text') {
         contentHtml = `<p class="text-text-primary whitespace-pre-wrap">${msg.content}</p>`;
       } else if (msg.message_type === 'image') {
         contentHtml = `<img src="${msg.file_url}" class="max-w-xs max-h-48 rounded-lg object-contain" alt="Image">`;
       } else if (msg.message_type === 'file') {
         contentHtml = `
           <a href="${msg.file_url}" target="_blank" download class="text-accent-purple hover:underline flex items-center">
             <i class="fas fa-file mr-2"></i> ${msg.file_name || 'File'} (${utils.formatFileSize(msg.file_size)})
           </a>
         `;
       } else if (msg.message_type === 'order_list') {
         contentHtml = `
           <div class="bg-gray-800 p-3 rounded-lg border border-accent-purple">
             <p class="font-semibold text-accent-green mb-1"><i class="fas fa-clipboard-list mr-1"></i> Order List Sent:</p>
             <p class="text-sm text-text-secondary whitespace-pre-wrap">${msg.content}</p>
           </div>
         `;
       }

       return `
         <div class="flex ${isSender ? 'justify-end' : 'justify-start'} mb-4">
           <div class="flex ${isSender ? 'flex-row-reverse' : 'flex-row'} items-start space-x-2 ${isSender ? 'space-x-reverse' : ''}">
             <img src="${senderAvatar}" alt="${senderName}" class="w-8 h-8 rounded-full object-cover">
             <div class="p-3 rounded-lg ${isSender ? 'bg-accent-purple text-black' : 'bg-secondary-bg text-text-primary'} max-w-xs md:max-w-md">
               <p class="font-semibold text-sm ${isSender ? 'text-black' : 'text-accent-green'}">${senderName}</p>
               ${contentHtml}
               <p class="text-xs text-right ${isSender ? 'text-gray-800' : 'text-text-secondary'} mt-1">${messageTime}</p>
             </div>
           </div>
         </div>
       `;
     }).join('');
     chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight; // Scroll to bottom after rendering
   } else {
     chatMessagesContainer.innerHTML = `
       <div class="text-center text-text-secondary py-8">
         <i class="fas fa-comments text-4xl mb-4"></i>
         <p>No messages yet. Start the conversation!</p>
       </div>
     `;
   }
 } catch (error) {
   console.error('Error loading buyer-seller chat messages:', error);
   chatMessagesContainer.innerHTML = `
     <div class="text-center text-accent-red py-8">
       <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
       <p>Failed to retrieve messages</p>
     </div>
   `;
 }
}

async function sendBuyerSellerChatMessage() {
 if (!state.currentBuyerSellerConversationId || !state.adminProfile || !state.adminProfile.id) {
   showNotification('No active chat. Please select a user to chat with.', 'warning');
   return;
 }

 const chatInput = document.getElementById('buyer-seller-chat-input');
 const messageContent = chatInput.value.trim();

 if (!messageContent) {
   showNotification('Message cannot be empty.', 'warning');
   return;
 }

 chatInput.value = ''; // Clear input immediately

 try {
   const { error } = await state.supabase
     .from('buyer_seller_messages')
     .insert({
       conversation_id: state.currentBuyerSellerConversationId,
       sender_profile_id: state.adminProfile.id,
       content: messageContent,
       message_type: 'text'
     });

   if (error) throw error;

   // Update last_message_at for the conversation
   await state.supabase
     .from('buyer_seller_conversations')
     .update({ last_message_at: new Date().toISOString() })
     .eq('id', state.currentBuyerSellerConversationId);

   // Message will be reloaded by realtime subscription
 } catch (error) {
   console.error('Error sending buyer-seller message:', error);
   showNotification('Failed to send message', 'error');
 }
}

async function uploadBuyerSellerChatFile() {
 if (!state.currentBuyerSellerConversationId || !state.adminProfile || !state.adminProfile.id) {
   showNotification('No active chat. Please select a user to chat with.', 'warning');
   return;
 }

 const fileInput = document.getElementById('buyer-seller-chat-file-upload');
 const file = fileInput.files[0];

 if (!file) {
   showNotification('Please select a file to upload.', 'warning');
   return;
 }

 showLoading(true);

 try {
   const fileExt = file.name.split('.').pop();
   const fileName = `buyer_seller_chat_files/${state.currentBuyerSellerConversationId}_${state.adminProfile.id}_${Date.now()}.${fileExt}`;

   const { data: uploadData, error: uploadError } = await state.supabase.storage
     .from('buyer_seller_chat_files')
     .upload(fileName, file);

   if (uploadError) throw uploadError;

   const { data: urlData } = state.supabase.storage
     .from('buyer_seller_chat_files')
     .getPublicUrl(fileName);

   const fileUrl = urlData.publicUrl;
   const fileType = utils.getMediaType(file.type);

   const { error } = await state.supabase
     .from('buyer_seller_messages')
     .insert({
       conversation_id: state.currentBuyerSellerConversationId,
       sender_profile_id: state.adminProfile.id,
       content: `[${fileType.toUpperCase()} File] ${file.name}`, // Placeholder content
       message_type: fileType,
       file_url: fileUrl,
       file_name: file.name,
       file_size: file.size
     });

   if (error) throw error;

   // Update last_message_at for the conversation
   await state.supabase
     .from('buyer_seller_conversations')
     .update({ last_message_at: new Date().toISOString() })
     .eq('id', state.currentBuyerSellerConversationId);

   fileInput.value = ''; // Clear file input
   showNotification('File uploaded successfully!', 'success');
 } catch (error) {
   console.error('Error uploading chat file:', error);
   showNotification('Failed to upload file', 'error');
 } finally {
   showLoading(false);
 }
}

async function showOrderListToSendMessage() {
 if (!state.currentBuyerSellerConversationId || !state.adminProfile || !state.adminProfile.id || !state.currentChatPartnerProfileId) {
   showNotification('No active chat. Please select a user to chat with.', 'warning');
   return;
 }

 showLoading(true);
 try {
   const { data: orders, error } = await state.supabase
     .from('user_orders')
     .select(`
       *,
       user_products(name, price)
     `)
     .eq('buyer_profile_id', state.currentChatPartnerProfileId) // Get orders where the chat partner is the buyer
     .order('ordered_at', { ascending: false })
     .limit(5); // Get last 5 orders for this user

   if (error) throw error;

   let orderListContent = "User's Recent Orders:
";
   if (orders && orders.length > 0) {
     orders.forEach((order, index) => {
       orderListContent += `${index + 1}. Product: ${order.user_products?.name || 'N/A'}, Amount: ${utils.formatPrice(order.amount)}, Status: ${order.status.toUpperCase()}
`;
     });
   } else {
     orderListContent += "No recent orders from this user.";
   }

   const { error: sendError } = await state.supabase
     .from('buyer_seller_messages')
     .insert({
       conversation_id: state.currentBuyerSellerConversationId,
       sender_profile_id: state.adminProfile.id,
       content: orderListContent,
       message_type: 'order_list'
     });

   if (sendError) throw sendError;

   // Update last_message_at for the conversation
   await state.supabase
     .from('buyer_seller_conversations')
     .update({ last_message_at: new Date().toISOString() })
     .eq('id', state.currentBuyerSellerConversationId);

   showNotification('Order list sent successfully!', 'success');
 } catch (error) {
   console.error('Error sending order list:', error);
   showNotification('Failed to send order list', 'error');
 } finally {
   showLoading(false);
 }
}


async function loadSupportMessages() {
 const supportMessagesTableBody = document.getElementById('support-messages-table-body');
 supportMessagesTableBody.innerHTML = `
   <tr>
     <td colspan="5" class="text-center text-text-secondary py-8">
       <div class="loading-spinner mx-auto mb-2"></div>
       Loading support messages...
     </td>
   </tr>
 `;

 try {
   const { data: messages, error } = await state.supabase
     .from('support_messages')
     .select(`
       *,
       profiles(username, name, profile_picture)
     `)
     .order('created_at', { ascending: false });

   if (error) throw error;

   if (messages && messages.length > 0) {
     supportMessagesTableBody.innerHTML = messages.map(msg => {
       const sender = msg.profiles;
       const senderName = sender?.name || 'Unknown User';
       const senderUsername = sender?.username || 'unknown';
       const senderAvatar = sender?.profile_picture || '/placeholder.svg?height=30&width=30';
       const statusClass = msg.is_resolved ? 'status-active' : 'status-inactive';
       const statusText = msg.is_resolved ? 'RESOLVED' : 'PENDING';

       return `
         <tr>
           <td><img src="${senderAvatar}" class="w-8 h-8 rounded-full inline-block mr-2 object-cover" alt="Sender Pic">${senderName} (@${senderUsername})</td>
           <td>${msg.message.substring(0, 50)}${msg.message.length > 50 ? '...' : ''}</td>
           <td>${new Date(msg.created_at).toLocaleString('my-MM')}</td>
           <td class="${statusClass}">${statusText}</td>
           <td class="table-actions">
             <button onclick="viewSupportMessage('${msg.id}')" class="myanmar-btn btn-small">
               <i class="fas fa-eye"></i> View
             </button>
             <button onclick="toggleSupportMessageStatus('${msg.id}', ${msg.is_resolved})" class="myanmar-btn btn-small">
               <i class="fas ${msg.is_resolved ? 'fa-undo' : 'fa-check'}"></i> ${msg.is_resolved ? 'Unresolve' : 'Resolve'}
             </button>
             <button onclick="deleteSupportMessage('${msg.id}')" class="btn-danger myanmar-btn btn-small">
               <i class="fas fa-trash"></i> Delete
             </button>
           </td>
         </tr>
       `;
     }).join('');
   } else {
     supportMessagesTableBody.innerHTML = `
       <tr>
         <td colspan="5" class="text-center text-text-secondary py-8">
           <i class="fas fa-headset text-4xl mb-4"></i>
           <p>No Support Messages Found</p>
         </td>
       </tr>
     `;
   }
 } catch (error) {
   console.error('Error loading support messages:', error);
   supportMessagesTableBody.innerHTML = `
     <tr>
       <td colspan="5" class="text-center text-accent-red py-8">
         <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
         <p>Failed to retrieve Support Messages</p>
       </td>
     </tr>
   `;
 }
}

async function viewSupportMessage(messageId) {
 showNotification('View Support Message feature coming soon!', 'info');
 // Implement a modal to show full message content and reply option
}

async function toggleSupportMessageStatus(messageId, currentStatus) {
 showLoading(true);
 try {
   const { error } = await state.supabase
     .from('support_messages')
     .update({ is_resolved: !currentStatus })
     .eq('id', messageId);

   if (error) throw error;

   showNotification(`Support message status updated to ${!currentStatus ? 'Resolved' : 'Pending'}`, 'success');
   loadSupportMessages();
 } catch (error) {
   console.error('Error toggling support message status:', error);
   showNotification('Failed to update support message status', 'error');
 } finally {
   showLoading(false);
 }
}

function deleteSupportMessage(messageId) {
 showConfirmModal(
   'Are you sure you want to delete this support message?',
   async () => {
     showLoading(true);
     try {
       const { error } = await state.supabase
         .from('support_messages')
         .delete()
         .eq('id', messageId);

       if (error) throw error;

       showNotification('Support message deleted successfully!', 'success');
       loadSupportMessages();
     } catch (error) {
       console.error('Error deleting support message:', error);
       showNotification('Failed to delete support message.', 'error');
     } finally {
       showLoading(false);
     }
   }
 );
}

async function loadAboutContent() {
 const aboutContentInput = document.getElementById('about-content-input');
 aboutContentInput.value = 'Loading...';

 try {
   const { data, error } = await state.supabase
     .from('about')
     .select('content')
     .single();

   if (error && error.code !== 'PGRST116') throw error; // PGRST116 means no row found, which is fine

   if (data) {
     aboutContentInput.value = data.content || '';
   } else {
     aboutContentInput.value = 'No About Us content found. Please add some.';
   }
 } catch (error) {
   console.error('Error loading about content:', error);
   aboutContentInput.value = 'Failed to load About Us content.';
   showNotification('Failed to load About Us content', 'error');
 }
}

async function updateAboutContent() {
 const content = document.getElementById('about-content-input').value.trim();

 showLoading(true);
 try {
   // Check if a row exists, if not, insert; otherwise, update.
   const { data: existing, error: fetchError } = await state.supabase
     .from('about')
     .select('id')
     .limit(1);

   if (fetchError && fetchError.code !== 'PGRST116') throw fetchError;

   if (existing && existing.length > 0) {
     // Update existing
     const { error } = await state.supabase
       .from('about')
       .update({ content: content })
       .eq('id', existing[0].id);
     if (error) throw error;
   } else {
     // Insert new
     const { error } = await state.supabase
       .from('about')
       .insert({ content: content });
     if (error) throw error;
   }

   showNotification('About Us content updated successfully!', 'success');
 } catch (error) {
   console.error('Error updating about content:', error);
   showNotification('Failed to update About Us content', 'error');
 } finally {
   showLoading(false);
 }
}

// General UI functions
function showLoading(show) {
 const loadingOverlay = document.getElementById('loading-overlay');
 if (show) {
   loadingOverlay.classList.remove('hidden');
 } else {
   loadingOverlay.classList.add('hidden');
 }
}

function showConfirmModal(message, callback) {
 document.getElementById('confirm-message').textContent = message;
 state.confirmCallback = callback;
 document.getElementById('confirm-modal').classList.remove('hidden');
}

function closeConfirmModal() {
 document.getElementById('confirm-modal').classList.add('hidden');
 state.confirmCallback = null;
}

function confirmAction() {
 if (state.confirmCallback) {
   state.confirmCallback();
 }
 closeConfirmModal();
}

function filterTable(tableBodyId, searchText) {
 const tableBody = document.getElementById(tableBodyId);
 if (!tableBody) return;

 const rows = tableBody.getElementsByTagName('tr');
 const filter = searchText.toUpperCase();

 for (let i = 0; i < rows.length; i++) {
   let rowVisible = false;
   const cells = rows[i].getElementsByTagName('td');
   for (let j = 0; j < cells.length; j++) {
     const cell = cells[j];
     if (cell) {
       const textValue = cell.textContent || cell.innerText;
       if (textValue.toUpperCase().indexOf(filter) > -1) {
         rowVisible = true;
         break;
       }
     }
   }
   if (rowVisible) {
     rows[i].style.display = '';
   } else {
     rows[i].style.display = 'none';
   }
 }
}

</script>
</body>
</html>
