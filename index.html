<!DOCTYPE html>
<html lang="my">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>FPS GFX Tool - မြန်မာ</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Share+Tech+Mono&family=Noto+Sans+Myanmar:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
/* Custom Fonts */
body {
font-family: 'Noto Sans Myanmar', 'Inter', sans-serif;
}
h1, h2, h3, .font-orbitron {
font-family: 'Orbitron', sans-serif;
}
.font-share-tech {
font-family: 'Share Tech Mono', monospace;
}

/* New Color Palette */
:root {
--primary-bg: hsl(220 20% 8%); /* Deep Dark Blue-Grey */
--secondary-bg: hsl(220 20% 12%); /* Slightly Lighter Dark Blue-Grey */
--accent-purple: hsl(280 80% 60%); /* Vibrant Purple */
--accent-green: hsl(160 80% 50%); /* Neon Green */
--accent-red: hsl(0 80% 60%); /* Vibrant Red */
--text-primary: hsl(220 20% 90%); /* Light Grey */
--text-secondary: hsl(220 15% 60%); /* Medium Grey */
--border-color: hsl(220 15% 20%); /* Dark Grey */
--card-bg: rgba(20, 25, 35, 0.7); /* Dark Translucent */
--input-bg: rgba(30, 35, 45, 0.6); /* Darker Translucent */
--table-header-bg: rgba(var(--accent-purple-rgb), 0.15);
--table-row-hover-bg: rgba(var(--accent-purple-rgb), 0.08);

/* RGB values for easier use in rgba() */
--accent-purple-rgb: 199, 56, 255; /* From hsl(280 80% 60%) */
--accent-green-rgb: 0, 204, 136; /* From hsl(160 80% 50%) */
--accent-red-rgb: 255, 51, 51; /* From hsl(0 80% 60%) */
}

body {
background: linear-gradient(135deg, var(--primary-bg) 0%, var(--secondary-bg) 100%);
min-height: 100vh;
position: relative;
overflow-x: hidden;
color: var(--text-primary);
}

.myanmar-pattern {
background-image: 
  radial-gradient(circle at 25% 25%, rgba(var(--accent-purple-rgb), 0.15) 0%, transparent 50%),
  radial-gradient(circle at 75% 75%, rgba(var(--accent-green-rgb), 0.15) 0%, transparent 50%),
  radial-gradient(circle at 50% 50%, rgba(var(--accent-red-rgb), 0.1) 0%, transparent 50%);
animation: patternMove 25s ease-in-out infinite;
position: fixed;
top: 0;
left: 0;
right: 0;
bottom: 0;
z-index: -2;
}

@keyframes patternMove {
0%, 100% { background-position: 0% 0%, 100% 100%, 50% 50%; }
33% { background-position: 100% 100%, 0% 0%, 75% 25%; }
66% { background-position: 50% 50%, 75% 25%, 25% 75%; }
}

.myanmar-waves {
position: fixed;
bottom: 0;
left: 0;
right: 0;
height: 80px;
background: linear-gradient(45deg, 
  rgba(var(--accent-purple-rgb), 0.2), 
  rgba(var(--accent-green-rgb), 0.2), 
  rgba(var(--accent-red-rgb), 0.2));
clip-path: polygon(0 100%, 0 60%, 25% 40%, 50% 60%, 75% 30%, 100% 50%, 100% 100%);
animation: waveFloat 12s ease-in-out infinite;
z-index: -1;
}

@keyframes waveFloat {
0%, 100% { transform: translateY(0px) scaleY(1); }
50% { transform: translateY(-10px) scaleY(1.1); }
}

.app-card {
backdrop-filter: blur(20px);
background: var(--card-bg);
border: 1px solid var(--border-color);
box-shadow: 
  0 20px 40px -12px rgba(0, 0, 0, 0.8),
  0 0 0 1px rgba(var(--accent-purple-rgb), 0.1),
  inset 0 1px 0 rgba(255, 255, 255, 0.05);
transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
border-radius: 16px;
}

.app-card:hover {
transform: translateY(-2px);
box-shadow: 
  0 25px 50px -12px rgba(var(--accent-purple-rgb), 0.25),
  0 0 0 1px rgba(var(--accent-purple-rgb), 0.2),
  inset 0 1px 0 rgba(255, 255, 255, 0.1);
border-color: rgba(var(--accent-purple-rgb), 0.5);
}

.myanmar-btn {
background: linear-gradient(135deg, var(--accent-purple), var(--accent-green));
color: #000;
font-weight: 700;
position: relative;
overflow: hidden;
transition: all 0.3s ease;
text-shadow: 0 1px 2px rgba(0,0,0,0.1);
border: none;
border-radius: 12px;
padding: 12px 20px;
cursor: pointer;
box-shadow: 0 5px 15px rgba(var(--accent-purple-rgb), 0.2);
}

.myanmar-btn::before {
content: '';
position: absolute;
top: 0;
left: -100%;
width: 100%;
height: 100%;
background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
transition: left 0.6s ease;
}

.myanmar-btn:hover::before {
left: 100%;
}

.myanmar-btn:hover {
background: linear-gradient(135deg, var(--accent-green), var(--accent-purple));
transform: translateY(-1px);
box-shadow: 0 10px 25px rgba(var(--accent-green-rgb), 0.4);
}

.btn-danger {
background: linear-gradient(135deg, var(--accent-red), #FF6B6B);
color: white;
box-shadow: 0 5px 15px rgba(var(--accent-red-rgb), 0.2);
}

.btn-danger:hover {
background: linear-gradient(135deg, #FF6B6B, var(--accent-red));
box-shadow: 0 10px 25px rgba(var(--accent-red-rgb), 0.4);
}

.connection-status {
position: fixed;
top: 15px;
right: 15px;
z-index: 1000;
padding: 8px 16px;
border-radius: 20px;
font-size: 11px;
font-weight: 700;
text-transform: uppercase;
backdrop-filter: blur(10px);
animation: statusPulse 2s infinite;
color: var(--text-primary);
}

.status-online {
background: linear-gradient(135deg, var(--accent-green), #4ADE80);
color: white;
box-shadow: 0 0 20px rgba(var(--accent-green-rgb), 0.5);
}

.status-offline {
background: linear-gradient(135deg, var(--accent-red), #EF4444);
color: white;
animation: statusShake 0.5s ease-in-out;
}

.status-connecting {
background: linear-gradient(135deg, var(--accent-purple), #FCD34D);
color: #000;
animation: statusSpin 1s linear infinite;
}

@keyframes statusPulse {
0%, 100% { opacity: 1; transform: scale(1); }
50% { opacity: 0.8; transform: scale(1.05); }
}

@keyframes statusShake {
0%, 100% { transform: translateX(0); }
25% { transform: translateX(-3px); }
75% { transform: translateX(3px); }
}

@keyframes statusSpin {
from { transform: rotate(0deg); }
to { transform: rotate(360deg); }
}

.stats-card {
background: rgba(255, 255, 255, 0.05);
backdrop-filter: blur(10px);
border: 1px solid rgba(255, 255, 255, 0.1);
transition: all 0.3s ease;
position: relative;
overflow: hidden;
border-radius: 12px;
}

.stats-card::before {
content: '';
position: absolute;
top: 0;
left: 0;
right: 0;
height: 3px;
background: linear-gradient(90deg, var(--accent-purple), var(--accent-green), var(--accent-red));
opacity: 0;
transition: opacity 0.3s ease;
}

.stats-card:hover::before {
opacity: 1;
}

.stats-card:hover {
transform: translateY(-3px) scale(1.02);
box-shadow: 0 15px 35px rgba(var(--accent-purple-rgb), 0.2);
border-color: rgba(var(--accent-purple-rgb), 0.3);
}

.app-input {
background: var(--input-bg);
border: 2px solid var(--border-color);
backdrop-filter: blur(10px);
color: var(--text-primary);
transition: all 0.3s ease;
border-radius: 12px;
padding: 12px 16px;
}

.app-input:focus {
border-color: var(--accent-purple);
background: rgba(30, 35, 45, 0.8);
outline: none;
box-shadow: 0 0 25px rgba(var(--accent-purple-rgb), 0.3);
}

.app-input::placeholder {
color: var(--text-secondary);
}

.app-table {
backdrop-filter: blur(10px);
background: rgba(255, 255, 255, 0.03);
border: 1px solid rgba(255, 255, 255, 0.1);
border-radius: 12px;
overflow: hidden;
}

.app-table th {
background: var(--table-header-bg);
color: var(--accent-purple);
font-weight: 700;
text-transform: uppercase;
font-size: 12px;
letter-spacing: 0.5px;
padding: 12px 8px;
}

.app-table td {
padding: 12px 8px;
border-bottom: 1px solid rgba(255, 255, 255, 0.05);
color: var(--text-primary);
}

.app-table tr:hover {
background: var(--table-row-hover-bg);
}

.loading-spinner {
border: 3px solid rgba(var(--accent-purple-rgb), 0.3);
border-top: 3px solid var(--accent-purple);
border-radius: 50%;
width: 24px;
height: 24px;
animation: spin 1s linear infinite;
}

@keyframes spin {
0% { transform: rotate(0deg); }
100% { transform: rotate(360deg); }
}

.notification {
position: fixed;
top: 70px;
right: 15px;
left: 15px;
max-width: 400px;
margin: 0 auto;
padding: 12px 16px;
border-radius: 10px;
color: white;
font-weight: 600;
z-index: 1001;
animation: slideInRight 0.4s ease-out;
backdrop-filter: blur(15px);
box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}

@keyframes slideInRight {
from { transform: translateX(100%); opacity: 0; }
to { transform: translateX(0); opacity: 1; }
}

.nav-btn {
transition: all 0.3s ease;
position: relative;
border-radius: 8px;
padding: 8px 12px;
font-size: 14px;
color: var(--text-secondary);
background: rgba(255, 255, 255, 0.05);
border: 1px solid rgba(255, 255, 255, 0.1);
}

.nav-btn.active {
background: linear-gradient(135deg, var(--accent-purple), var(--accent-green)) !important;
color: #000 !important;
box-shadow: 0 5px 15px rgba(var(--accent-purple-rgb), 0.4);
border-color: var(--accent-purple) !important;
}

.nav-btn:not(.active):hover {
background: rgba(var(--accent-purple-rgb), 0.1);
color: var(--accent-purple);
border-color: rgba(var(--accent-purple-rgb), 0.3);
}

.fade-in {
animation: fadeInUp 0.6s ease-out forwards;
}

@keyframes fadeInUp {
from { opacity: 0; transform: translateY(20px); }
to { opacity: 1; transform: translateY(0); }
}

.status-active { color: var(--accent-green); }
.status-inactive { color: var(--accent-red); }
.status-banned { color: var(--accent-red); }

.news-card {
background: rgba(255, 255, 255, 0.05);
border: 1px solid rgba(255, 255, 255, 0.1);
border-radius: 12px;
transition: all 0.3s ease;
margin-bottom: 16px;
}

.news-card:hover {
border-color: rgba(var(--accent-purple-rgb), 0.3);
transform: translateY(-2px);
}

.modal {
position: fixed;
top: 0;
left: 0;
right: 0;
bottom: 0;
background: rgba(0, 0, 0, 0.8);
display: flex;
align-items: center;
justify-content: center;
z-index: 2000;
padding: 20px;
}

.modal-content {
background: var(--card-bg);
border: 1px solid var(--border-color);
border-radius: 16px;
padding: 24px;
max-width: 90vw;
max-height: 90vh;
overflow-y: auto;
backdrop-filter: blur(20px);
box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}

/* Mobile optimizations */
@media (max-width: 768px) {
.container { padding: 8px; }
.app-card { padding: 16px; margin: 8px; }
.connection-status { top: 10px; right: 10px; font-size: 9px; padding: 6px 12px; }
.notification { top: 50px; right: 10px; left: 10px; max-width: none; }
.stats-card { margin-bottom: 12px; }
.myanmar-btn { padding: 10px 16px; font-size: 14px; }
.app-table { font-size: 12px; }
.app-table th, .app-table td { padding: 8px 4px; }
h1 { font-size: 20px; }
h2 { font-size: 18px; }
h3 { font-size: 16px; }
.nav-btn { padding: 6px 10px; font-size: 12px; margin: 2px; }
.modal-content { padding: 16px; max-width: 95vw; }
}

@media (max-width: 480px) {
.myanmar-pattern { opacity: 0.7; }
.myanmar-waves { height: 60px; }
.app-card { padding: 12px; margin: 4px; }
.grid { gap: 8px; }
.stats-card { padding: 12px; }
.app-table th, .app-table td { padding: 6px 2px; font-size: 11px; }
}

/* Scrollbar styling */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: rgba(255,255,255,0.1); }
::-webkit-scrollbar-thumb { background: var(--accent-purple); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--accent-green); }

/* Loading overlay */
.loading-overlay {
backdrop-filter: blur(8px);
background: rgba(0,0,0,0.7);
}

.btn-small {
padding: 6px 12px;
font-size: 12px;
border-radius: 8px;
}

.table-actions {
display: flex;
gap: 4px;
flex-wrap: wrap;
}

.hidden { display: none !important; }

/* Search input specific styles */
.search-input-container {
position: relative;
}
.search-input-container .app-input {
padding-left: 40px; /* Space for icon */
}
.search-input-container .search-icon {
position: absolute;
left: 12px;
top: 50%;
transform: translateY(-50%);
color: var(--text-secondary);
pointer-events: none;
}
</style>
</head>
<body class="text-white">
<div class="myanmar-pattern"></div>
<div class="myanmar-waves"></div>

<!-- Connection Status -->
<div id="connection-status" class="connection-status status-connecting">
<i class="fas fa-wifi"></i> ချိတ်ဆက်နေသည်...
</div>

<!-- Main Container -->
<div class="container mx-auto px-2 py-4 max-w-6xl">
<!-- Header -->
<div class="text-center mb-6 fade-in">
<h1 class="text-2xl md:text-3xl lg:text-4xl font-orbitron font-bold mb-2 text-accent-purple">
  <i class="fas fa-shield-alt mr-2"></i>
  FPS GFX Tool
</h1>
<h2 class="text-lg md:text-xl lg:text-2xl font-orbitron font-semibold text-accent-green mb-2">
  MOBILE APPLICATION
</h2>
<div class="inline-block px-4 py-2 bg-gradient-to-r from-accent-purple to-accent-green text-black rounded-full font-bold text-sm">
  <i class="fas fa-mobile-alt mr-1"></i> USER INTERFACE
</div>
</div>

<!-- Notification Container -->
<div id="notification-container"></div>

<!-- Login Section -->
<div id="login-section" class="max-w-md mx-auto fade-in">
<div class="app-card p-6">
  <h3 class="text-xl md:text-2xl font-orbitron font-bold text-center mb-6 text-accent-purple">
    <i class="fas fa-sign-in-alt mr-2"></i>
    KEY LOGIN
  </h3>
  <div class="space-y-4">
    <div class="relative search-input-container">
      <input 
        type="text" 
        id="login-key" 
        placeholder="Enter Your Key..." 
        class="app-input w-full"
      >
      <i class="fas fa-key search-icon"></i>
    </div>
    <button 
      onclick="userLogin()" 
      id="login-btn"
      class="myanmar-btn w-full flex items-center justify-center space-x-2"
    >
      <i class="fas fa-sign-in-alt"></i>
      <span id="login-text">LOGIN</span>
    </button>
  </div>
</div>
</div>

<!-- Profile Creation Section -->
<div id="profile-creation-section" class="max-w-md mx-auto fade-in hidden">
<div class="app-card p-6">
  <h3 class="text-xl md:text-2xl font-orbitron font-bold text-center mb-6 text-accent-green">
    <i class="fas fa-user-plus mr-2"></i>
    CREATE PROFILE
  </h3>
  <p class="text-center text-text-secondary mb-4">
    No profile found for your key. Please create one.
  </p>
  <div class="space-y-4">
    <div class="relative search-input-container">
      <input 
        type="text" 
        id="profile-username" 
        placeholder="Username (must be unique)" 
        class="app-input w-full"
      >
      <i class="fas fa-user search-icon"></i>
    </div>
    <div class="relative search-input-container">
      <input 
        type="text" 
        id="profile-name" 
        placeholder="Your Display Name" 
        class="app-input w-full"
      >
      <i class="fas fa-signature search-icon"></i>
    </div>
    <div class="relative">
      <label for="profile-picture" class="block text-sm font-medium mb-2 text-text-secondary">Profile Picture (Optional)</label>
      <input 
        type="file" 
        id="profile-picture" 
        accept="image/*" 
        class="app-input w-full"
      >
    </div>
    <button 
      onclick="createProfile()" 
      id="create-profile-btn"
      class="myanmar-btn w-full flex items-center justify-center space-x-2"
    >
      <i class="fas fa-plus-circle"></i>
      <span id="create-profile-text">CREATE PROFILE</span>
    </button>
  </div>
</div>
</div>

<!-- Main App Content -->
<div id="app-content" class="hidden">
<!-- Navigation -->
<div class="flex flex-wrap justify-center gap-2 md:gap-4 mb-6">
  <button onclick="showSection('home', this)" class="nav-btn active">
    <i class="fas fa-home mr-1"></i>
    <span class="hidden sm:inline">HOME</span>
    <span class="sm:hidden">Home</span>
  </button>
  <button onclick="showSection('news', this)" class="nav-btn">
    <i class="fas fa-newspaper mr-1"></i>
    <span class="hidden sm:inline">NEWS</span>
    <span class="sm:hidden">News</span>
  </button>
  <button onclick="showSection('products', this)" class="nav-btn">
    <i class="fas fa-box-open mr-1"></i>
    <span class="hidden sm:inline">PRODUCTS</span>
    <span class="sm:hidden">Products</span>
  </button>
  <button onclick="showSection('shop', this)" class="nav-btn">
    <i class="fas fa-store mr-1"></i>
    <span class="hidden sm:inline">SHOP</span>
    <span class="sm:hidden">Shop</span>
  </button>
  <button onclick="showSection('chat', this)" class="nav-btn">
    <i class="fas fa-comments mr-1"></i>
    <span class="hidden sm:inline">CHAT</span>
    <span class="sm:hidden">Chat</span>
  </button>
  <button onclick="showSection('support', this)" class="nav-btn">
    <i class="fas fa-headset mr-1"></i>
    <span class="hidden sm:inline">SUPPORT</span>
    <span class="sm:hidden">Support</span>
  </button>
  <button onclick="showSection('about', this)" class="nav-btn">
    <i class="fas fa-info-circle mr-1"></i>
    <span class="hidden sm:inline">ABOUT</span>
    <span class="sm:hidden">About</span>
  </button>
  <button onclick="showSection('mi', this)" class="nav-btn">
    <i class="fas fa-user-circle mr-1"></i>
    <span class="hidden sm:inline">MI</span>
    <span class="sm:hidden">Mi</span>
  </button>
  <button onclick="userLogout()" class="nav-btn btn-danger">
    <i class="fas fa-sign-out-alt mr-1"></i>
    <span class="hidden sm:inline">LOGOUT</span>
    <span class="sm:hidden">Logout</span>
  </button>
</div>

<!-- Home Section -->
<div id="home-section" class="app-section">
  <div class="app-card p-4 md:p-8 text-center">
    <h3 class="text-lg md:text-xl font-orbitron font-bold mb-4 text-accent-purple">
      <i class="fas fa-home mr-2"></i>
      DASHBOARD OVERVIEW
    </h3>
    <p class="text-text-secondary">
      Welcome to FPS GFX Tool.
    </p>
    <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
      <div class="stats-card p-4">
        <i class="fas fa-download text-2xl text-blue-400 mb-2"></i>
        <h4 class="text-sm font-semibold text-text-secondary">TOTAL DOWNLOADS</h4>
        <p id="total-downloads" class="text-lg font-bold text-accent-purple">0</p>
      </div>
      <div class="stats-card p-4">
        <i class="fas fa-box-open text-2xl text-purple-400 mb-2"></i>
        <h4 class="text-sm font-semibold text-text-secondary">AVAILABLE PRODUCTS</h4>
        <p id="available-products" class="text-lg font-bold text-accent-green">0</p>
      </div>
    </div>
  </div>
</div>

<!-- News Section -->
<div id="news-section" class="app-section hidden">
  <div class="app-card p-4 md:p-8">
    <h3 class="text-lg md:text-xl font-orbitron font-bold mb-6 text-accent-purple flex items-center">
      <i class="fas fa-newspaper mr-3"></i>
      LATEST NEWS
    </h3>
    <div id="news-list" class="space-y-4">
      <div class="loading-spinner mx-auto mb-4"></div>
      <p class="text-center text-text-secondary">Loading news...</p>
    </div>
  </div>
</div>

<!-- Products Section -->
<div id="products-section" class="app-section hidden">
  <div class="app-card p-4 md:p-8">
    <h3 class="text-lg md:text-xl font-orbitron font-bold mb-6 text-accent-purple flex items-center">
      <i class="fas fa-box-open mr-3"></i>
      PRODUCTS & APKS
    </h3>
    <div id="products-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
      <div class="loading-spinner mx-auto mb-4 col-span-full"></div>
      <p class="text-center text-text-secondary col-span-full">Loading products...</p>
    </div>
  </div>
</div>

<!-- Shop Section -->
<div id="shop-section" class="app-section hidden">
  <div class="app-card p-4 md:p-8">
    <h3 class="text-lg md:text-xl font-orbitron font-bold mb-6 text-accent-purple flex items-center">
      <i class="fas fa-store mr-3"></i>
      USER SHOP
    </h3>
    <div id="shop-items-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
      <div class="loading-spinner mx-auto mb-4 col-span-full"></div>
      <p class="text-center text-text-secondary col-span-full">Loading shop items...</p>
    </div>
  </div>
</div>

<!-- Chat Section -->
<div id="chat-section" class="app-section hidden">
  <div class="app-card p-4 md:p-8">
    <h3 class="text-lg md:text-xl font-orbitron font-bold mb-6 text-accent-purple flex items-center">
      <i class="fas fa-comments mr-3"></i>
      GLOBAL CHAT
    </h3>
    <div id="chat-messages" class="bg-black bg-opacity-30 rounded-xl p-4 h-64 md:h-96 overflow-y-auto mb-6 border border-gray-700">
      <div class="loading-spinner mx-auto mb-4"></div>
      <p class="text-center text-text-secondary">Loading messages...</p>
    </div>
    <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-4">
      <textarea id="chat-input" placeholder="Type your message..." rows="3"
                class="app-input flex-1 resize-none"></textarea>
      <button onclick="sendChatMessage()" 
              class="myanmar-btn flex items-center justify-center space-x-2 md:self-end">
        <i class="fas fa-paper-plane"></i>
        <span>SEND</span>
      </button>
    </div>
  </div>
</div>

<!-- Support Section -->
<div id="support-section" class="app-section hidden">
  <div class="app-card p-4 md:p-8">
    <h3 class="text-lg md:text-xl font-orbitron font-bold mb-6 text-accent-purple flex items-center">
      <i class="fas fa-headset mr-3"></i>
      SUPPORT
    </h3>
    <div id="support-messages" class="bg-black bg-opacity-30 rounded-xl p-4 h-64 md:h-96 overflow-y-auto mb-6 border border-gray-700">
      <div class="loading-spinner mx-auto mb-4"></div>
      <p class="text-center text-text-secondary">Loading messages...</p>
    </div>
    <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-4">
      <textarea id="support-input" placeholder="Type your support message..." rows="3"
                class="app-input flex-1 resize-none"></textarea>
      <button onclick="sendSupportMessage()" 
              class="myanmar-btn flex items-center justify-center space-x-2 md:self-end">
        <i class="fas fa-paper-plane"></i>
        <span>SEND SUPPORT</span>
      </button>
    </div>
  </div>
</div>

<!-- About Section -->
<div id="about-section" class="app-section hidden">
  <div class="app-card p-4 md:p-8">
    <h3 class="text-lg md:text-xl font-orbitron font-bold mb-6 text-accent-purple flex items-center">
      <i class="fas fa-info-circle mr-3"></i>
      ABOUT US
    </h3>
    <div id="about-content" class="space-y-4 text-text-secondary">
      <p>Loading about information...</p>
    </div>
  </div>
</div>

<!-- Mi Section (User Profile) -->
<div id="mi-section" class="app-section hidden">
  <div class="app-card p-4 md:p-8">
    <h3 class="text-lg md:text-xl font-orbitron font-bold mb-6 text-accent-purple flex items-center">
      <i class="fas fa-user-circle mr-3"></i>
      MY PROFILE
    </h3>
    <div id="profile-details" class="space-y-4">
      <div class="flex flex-col items-center mb-6">
        <img id="mi-profile-picture" src="/placeholder.svg?height=100&width=100" alt="Profile Picture" class="w-24 h-24 rounded-full object-cover border-4 border-accent-purple mb-4">
        <h4 id="mi-name" class="text-xl font-bold text-text-primary"></h4>
        <p id="mi-username" class="text-text-secondary">@</p>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium mb-2 text-text-secondary">KEY</label>
          <input type="text" id="mi-key-text" class="app-input w-full font-share-tech" readonly>
        </div>
        <div>
          <label class="block text-sm font-medium mb-2 text-text-secondary">ACCOUNT STATUS</label>
          <input type="text" id="mi-account-status" class="app-input w-full" readonly>
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm font-medium mb-2 text-text-secondary">NEW PROFILE PICTURE (OPTIONAL)</label>
          <input type="file" id="mi-new-profile-picture" accept="image/*" class="app-input w-full">
        </div>
        <div class="md:col-span-2">
          <button onclick="updateProfile()" class="myanmar-btn w-full flex items-center justify-center space-x-2">
            <i class="fas fa-save"></i>
            <span>UPDATE PROFILE</span>
          </button>
        </div>
      </div>

        <!-- My News Section -->
        <div class="mt-8 pt-6 border-t border-border-color">
          <h4 class="text-lg font-orbitron font-bold mb-4 text-accent-green flex items-center">
            <i class="fas fa-newspaper mr-2"></i> MY NEWS POSTS
          </h4>
          <div class="app-card p-4 md:p-6 mb-6">
            <h5 class="text-md font-semibold text-accent-purple mb-4">POST NEW NEWS</h5>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium mb-2 text-text-secondary">TITLE</label>
                <input type="text" id="my-news-title" placeholder="News Title" class="app-input w-full">
              </div>
              <div>
                <label class="block text-sm font-medium mb-2 text-text-secondary">CONTENT</label>
                <textarea id="my-news-content" placeholder="News Content..." rows="3" class="app-input w-full resize-none"></textarea>
              </div>
              <div class="md:col-span-2">
                <label class="block text-sm font-medium mb-2 text-text-secondary">MEDIA (IMAGES/VIDEOS/AUDIOS)</label>
                <input type="file" id="my-news-media" accept="image/*,video/*,audio/*" multiple class="app-input w-full">
              </div>
              <div>
                <label class="block text-sm font-medium mb-2 text-text-secondary">YOUTUBE LINK (OPTIONAL)</label>
                <input type="url" id="my-news-youtube" placeholder="https://youtube.com/..." class="app-input w-full">
              </div>
              <div>
                <label class="block text-sm font-medium mb-2 text-text-secondary">TIKTOK LINK (OPTIONAL)</label>
                <input type="url" id="my-news-tiktok" placeholder="https://tiktok.com/@..." class="app-input w-full">
              </div>
              <div class="md:col-span-2">
                <button onclick="postMyNews()" class="myanmar-btn w-full flex items-center justify-center space-x-2">
                  <i class="fas fa-paper-plane"></i>
                  <span>POST MY NEWS</span>
                </button>
              </div>
            </div>
          </div>
          <div id="my-news-list" class="space-y-4">
            <div class="loading-spinner mx-auto mb-4"></div>
            <p class="text-center text-text-secondary">Loading your news...</p>
          </div>
        </div>

        <!-- My Shop Items Section -->
        <div class="mt-8 pt-6 border-t border-border-color">
          <h4 class="text-lg font-orbitron font-bold mb-4 text-accent-green flex items-center">
            <i class="fas fa-store mr-2"></i> MY SHOP ITEMS
          </h4>
          <div class="app-card p-4 md:p-6 mb-6">
            <h5 class="text-md font-semibold text-accent-purple mb-4">ADD NEW SHOP ITEM</h5>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium mb-2 text-text-secondary">ITEM NAME</label>
                <input type="text" id="shop-item-name" placeholder="Item Name" class="app-input w-full">
              </div>
              <div>
                <label class="block text-sm font-medium mb-2 text-text-secondary">PRICE (MMK)</label>
                <input type="number" id="shop-item-price" placeholder="0.00" min="0" step="0.01" class="app-input w-full">
              </div>
              <div class="md:col-span-2">
                <label class="block text-sm font-medium mb-2 text-text-secondary">DESCRIPTION</label>
                <textarea id="shop-item-description" placeholder="Item Description..." rows="3" class="app-input w-full resize-none"></textarea>
              </div>
              <div class="md:col-span-2">
                <label class="block text-sm font-medium mb-2 text-text-secondary">ITEM IMAGES (MULTIPLE)</label>
                <input type="file" id="shop-item-images" accept="image/*" multiple class="app-input w-full">
              </div>
              <div>
                <label class="block text-sm font-medium mb-2 text-text-secondary">CONTACT SOCIAL LINK</label>
                <input type="url" id="shop-item-social-link" placeholder="https://t.me/your_contact" class="app-input w-full">
              </div>
              <div>
                <label class="block text-sm font-medium mb-2 text-text-secondary">SOCIAL NAME (e.g., Telegram)</label>
                <input type="text" id="shop-item-social-name" placeholder="Telegram" class="app-input w-full">
              </div>
              <div class="md:col-span-2">
                <h6 class="text-sm font-medium mb-2 text-text-secondary">PAYMENT METHODS (Add multiple)</h6>
                <div id="shop-item-payment-methods-container" class="space-y-2 mb-2">
                  <!-- Dynamic payment method inputs will go here -->
                </div>
                <div class="flex space-x-2 mb-4">
                  <input type="text" id="new-payment-name" placeholder="Payment Name (e.g., KBZ Pay)" class="app-input flex-1">
                  <input type="text" id="new-payment-account" placeholder="Account Info (e.g., 09123456789)" class="app-input flex-1">
                  <button onclick="addShopItemPaymentMethod()" class="myanmar-btn btn-small">
                    <i class="fas fa-plus"></i>
                  </button>
                </div>
              </div>
              <div class="md:col-span-2">
                <button onclick="postShopItem()" class="myanmar-btn w-full flex items-center justify-center space-x-2">
                  <i class="fas fa-upload"></i>
                  <span>UPLOAD ITEM</span>
                </button>
              </div>
            </div>
          </div>
          <div id="my-shop-items-list" class="space-y-4">
            <div class="loading-spinner mx-auto mb-4"></div>
            <p class="text-center text-text-secondary">Loading your shop items...</p>
          </div>
        </div>

        <!-- My Sales Orders Section -->
        <div class="mt-8 pt-6 border-t border-border-color">
          <h4 class="text-lg font-orbitron font-bold mb-4 text-accent-green flex items-center">
            <i class="fas fa-receipt mr-2"></i> MY SALES ORDERS
          </h4>
          <div id="my-sales-orders-list" class="overflow-x-auto">
            <table class="app-table w-full">
              <thead>
                <tr>
                  <th class="text-left">BUYER</th>
                  <th class="text-left">ITEM</th>
                  <th class="text-left">AMOUNT</th>
                  <th class="text-left">RECEIPT</th>
                  <th class="text-left">STATUS</th>
                  <th class="text-left">ACTIONS</th>
                </tr>
              </thead>
              <tbody id="my-sales-orders-table-body">
                <tr>
                  <td colspan="6" class="text-center text-text-secondary py-8">
                    <div class="loading-spinner mx-auto mb-2"></div>
                    Loading your sales orders...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- My Purchase History Section -->
        <div class="mt-8 pt-6 border-t border-border-color">
          <h4 class="text-lg font-orbitron font-bold mb-4 text-accent-green flex items-center">
            <i class="fas fa-history mr-2"></i> MY PURCHASE HISTORY
          </h4>
          <div id="my-purchase-history-list" class="overflow-x-auto">
            <table class="app-table w-full">
              <thead>
                <tr>
                  <th class="text-left">ITEM</th>
                  <th class="text-left">SELLER</th>
                  <th class="text-left">AMOUNT</th>
                  <th class="text-left">STATUS</th>
                  <th class="text-left">ORDERED AT</th>
                  <th class="text-left">ACTIONS</th>
                </tr>
              </thead>
              <tbody id="my-purchase-history-table-body">
                <tr>
                  <td colspan="6" class="text-center text-text-secondary py-8">
                    <div class="loading-spinner mx-auto mb-2"></div>
                    Loading your purchase history...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

      </div>
    </div>
  </div>

</div>
</div>

<!-- News Detail Modal -->
<div id="news-modal" class="modal hidden">
<div class="modal-content max-w-2xl">
<div class="flex justify-between items-center mb-4">
  <h2 class="text-xl font-orbitron font-bold text-accent-purple">NEWS DETAILS</h2>
  <button onclick="closeNewsModal()" class="text-text-secondary hover:text-accent-red">
    <i class="fas fa-times"></i>
  </button>
</div>
<div id="news-modal-content">
  <div class="loading-spinner mx-auto mb-4"></div>
  <p class="text-center text-text-secondary">Loading...</p>
</div>
</div>
</div>

<!-- Product Detail Modal -->
<div id="product-modal" class="modal hidden">
<div class="modal-content max-w-2xl">
<div class="flex justify-between items-center mb-4">
  <h2 class="text-xl font-orbitron font-bold text-accent-purple">PRODUCT DETAILS</h2>
  <button onclick="closeProductModal()" class="text-text-secondary hover:text-accent-red">
    <i class="fas fa-times"></i>
  </button>
</div>
<div id="product-modal-content">
  <div class="loading-spinner mx-auto mb-4"></div>
  <p class="text-center text-text-secondary">Loading...</p>
</div>
</div>
</div>

<!-- Payment Modal -->
<div id="payment-modal" class="modal hidden">
<div class="modal-content max-w-md">
<div class="flex justify-between items-center mb-4">
  <h2 class="text-xl font-orbitron font-bold text-accent-purple">MAKE PAYMENT</h2>
  <button onclick="closePaymentModal()" class="text-text-secondary hover:text-accent-red">
    <i class="fas fa-times"></i>
  </button>
</div>
<div id="payment-modal-content" class="space-y-4">
  <!-- Payment method selection will go here -->
</div>
</div>
</div>

<!-- Confirm Delete Modal -->
<div id="confirm-modal" class="modal hidden">
<div class="modal-content max-w-md">
<div class="text-center">
  <i class="fas fa-exclamation-triangle text-4xl text-accent-red mb-4"></i>
  <h3 class="text-xl font-orbitron font-bold text-text-primary mb-4">ARE YOU SURE?</h3>
  <p id="confirm-message" class="text-text-secondary mb-6">This action cannot be undone.</p>
  <div class="flex space-x-4">
    <button onclick="closeConfirmModal()" class="myanmar-btn flex-1">
      <i class="fas fa-times mr-2"></i>
      CANCEL
    </button>
    <button onclick="confirmAction()" class="btn-danger myanmar-btn flex-1">
      <i class="fas fa-trash mr-2"></i>
      DELETE
    </button>
  </div>
</div>
</div>
</div>

<!-- Loading Overlay -->
<div id="loading-overlay" class="fixed inset-0 loading-overlay flex items-center justify-center z-50 hidden">
<div class="app-card p-8 text-center">
<div class="loading-spinner mx-auto mb-4" style="width: 40px; height: 40px;"></div>
<p class="text-text-primary font-semibold">PROCESSING...</p>
</div>
</div>

<!-- Shop Item Detail Modal -->
  <div id="shop-item-modal" class="modal hidden">
    <div class="modal-content max-w-3xl">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-orbitron font-bold text-accent-purple">ITEM DETAILS</h2>
        <button onclick="closeShopItemModal()" class="text-text-secondary hover:text-accent-red">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div id="shop-item-modal-content">
        <div class="loading-spinner mx-auto mb-4"></div>
        <p class="text-center text-text-secondary">Loading...</p>
      </div>
    </div>
  </div>

  <!-- Receipt View Modal -->
  <div id="receipt-view-modal" class="modal hidden">
    <div class="modal-content max-w-xl">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-orbitron font-bold text-accent-purple">PAYMENT RECEIPT</h2>
        <button onclick="closeReceiptViewModal()" class="text-text-secondary hover:text-accent-red">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div id="receipt-view-modal-content" class="text-center">
        <img id="receipt-image" src="/placeholder.svg" alt="Payment Receipt" class="w-full h-auto object-contain rounded-lg border border-border-color">
      </div>
    </div>
  </div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
<script>
// Configuration
const CONFIG = {
SUPABASE_URL: 'https://rmeudvhvqlddqqkiziyo.supabase.co', // သင့် Supabase URL ကို ထည့်ပါ
SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJtZXVkdmh2cWxkZHFxa2l6aXlvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM5OTMxOTIsImV4cCI6MjA2OTU2OTE5Mn0.xFgMv-K5o5yyTpe4U2YJK5jC9GPJp98G4cgD9p5W4ak', // သင့် Supabase Anon Key ကို ထည့်ပါ
MAX_RETRY_ATTEMPTS: 3,
RETRY_DELAY: 2000
};

// State
let state = {
supabase: null,
isAuthenticated: false,
currentSection: 'home',
reconnectAttempts: 0,
isConnected: false,
confirmCallback: null,
userProfile: null, // Stores current user's profile data
newsRealtime: null,
chatRealtime: null,
supportRealtime: null,
productsRealtime: null,
ordersRealtime: null, // For admin-posted product orders
userShopOrdersRealtime: null, // For user-posted shop item orders (as owner)
userPurchasesRealtime: null, // For user's own purchases of shop items (as buyer)
selectedProductForPurchase: null, // For admin-posted products
selectedShopItemForPurchase: null, // For user-posted shop items
selectedPaymentMethod: null,
selectedChatProfileId: null, // To store the profile ID of the person to chat with
};

// Utility Functions
const utils = {
formatFileSize(bytes) {
  if (bytes === 0) return '0 Bytes';
  const k = 1024;
  const sizes = ['Bytes', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
},
getMediaType(fileType) {
  if (fileType.startsWith('image/')) return 'image';
  if (fileType.startsWith('video/')) return 'video';
  if (fileType.startsWith('audio/')) return 'audio';
  return 'file';
},
// Function to get a unique device ID (simple example, can be improved)
getDeviceId() {
  let deviceId = localStorage.getItem('device_id');
  if (!deviceId) {
    deviceId = 'device_' + Math.random().toString(36).substr(2, 9);
    localStorage.setItem('device_id', deviceId);
  }
  return deviceId;
}
};

// Initialize
document.addEventListener('DOMContentLoaded', initializeApp);

async function initializeApp() {
updateConnectionStatus('connecting');

try {
  // Check if Supabase config is set
  if (!CONFIG.SUPABASE_URL || CONFIG.SUPABASE_URL === 'YOUR_SUPABASE_URL_HERE') {
    throw new Error('Supabase URL လိုအပ်ပါတယ်! CONFIG အပိုင်းထဲမှာ သင့် Supabase URL ကို ထည့်ပါ။');
  }

  if (!CONFIG.SUPABASE_ANON_KEY || CONFIG.SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY_HERE') {
    throw new Error('Supabase Anon Key လိုအပ်ပါတယ်! CONFIG အပိုင်းထဲမှာ သင့် Supabase Anon Key ကို ထည့်ပါ။');
  }

  // Initialize Supabase
  if (typeof supabase !== 'undefined') {
    state.supabase = supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY, {
      auth: { persistSession: false },
      realtime: { params: { eventsPerSecond: 10 } }
    });

    // Test connection
    const { data, error } = await state.supabase.from('about').select('id').limit(1);
    
    if (error && error.code !== 'PGRST116') {
      throw new Error(`Database connection failed: ${error.message}`);
    }

    updateConnectionStatus('online');
    showNotification('Database connected successfully! အက်ပ် အသုံးပြုရန် အသင့်ဖြစ်ပါတယ်။', 'success');
    
    state.isConnected = true;
    state.reconnectAttempts = 0;

    // Check for existing key in localStorage
    const storedKey = localStorage.getItem('user_key');
    if (storedKey) {
      document.getElementById('login-key').value = storedKey;
      userLogin(true); // Attempt silent login
    }
    
  } else {
    throw new Error('Supabase library မတင်လို့ရပါ');
  }
} catch (error) {
  console.error('Initialization error:', error);
  updateConnectionStatus('offline');
  showNotification(`Connection failed: ${error.message}`, 'error');
  
  // Retry connection
  if (state.reconnectAttempts < CONFIG.MAX_RETRY_ATTEMPTS) {
    state.reconnectAttempts++;
    setTimeout(() => {
      console.log(`Retrying connection (${state.reconnectAttempts}/${CONFIG.MAX_RETRY_ATTEMPTS})...`);
      initializeApp();
    }, CONFIG.RETRY_DELAY);
  }
}

// Add enter key listener for login key input
document.getElementById('login-key').addEventListener('keypress', function(event) {
  if (event.key === 'Enter') {
    userLogin();
  }
});
}

function updateConnectionStatus(status) {
const statusElement = document.getElementById('connection-status');
statusElement.className = 'connection-status';

switch (status) {
  case 'online':
    statusElement.classList.add('status-online');
    statusElement.innerHTML = '<i class="fas fa-check-circle"></i> ONLINE';
    break;
  case 'offline':
    statusElement.classList.add('status-offline');
    statusElement.innerHTML = '<i class="fas fa-exclamation-triangle"></i> OFFLINE';
    break;
  case 'connecting':
    statusElement.classList.add('status-connecting');
    statusElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i> CONNECTING...';
    break;
}
}

function showNotification(message, type = 'info', duration = 5000) {
const container = document.getElementById('notification-container');
const notification = document.createElement('div');

const bgColors = {
  success: 'bg-green-600',
  error: 'bg-red-600',
  info: 'bg-blue-600',
  warning: 'bg-yellow-600'
};

const icons = {
  success: 'fa-check-circle',
  error: 'fa-exclamation-triangle',
  info: 'fa-info-circle',
  warning: 'fa-exclamation-circle'
};

notification.className = `notification ${bgColors[type]}`;
notification.innerHTML = `
  <div class="flex items-center justify-between">
    <div class="flex items-center">
      <i class="fas ${icons[type]} mr-2"></i>
      <span>${message}</span>
    </div>
    <button onclick="this.parentElement.parentElement.remove()" class="ml-4 hover:text-gray-200">
      <i class="fas fa-times"></i>
    </button>
  </div>
`;

container.appendChild(notification);

setTimeout(() => {
  if (notification.parentElement) {
    notification.remove();
  }
}, duration);
}

async function userLogin(isSilent = false) {
if (!state.isConnected) {
  if (!isSilent) showNotification('Waiting for database connection...', 'warning');
  return;
}

const loginKey = document.getElementById('login-key').value.trim();
const loginBtn = document.getElementById('login-btn');
const loginText = document.getElementById('login-text');

if (!loginKey) {
  if (!isSilent) showNotification('Please enter Key', 'warning');
  return;
}

try {
  if (!isSilent) {
    loginBtn.disabled = true;
    loginText.textContent = 'LOGGING IN...';
  }
  showLoading(true);

  const { data, error } = await state.supabase.rpc('user_login', { p_key_text: loginKey });

  if (error) throw error;

  if (data && data.length > 0) {
    const userData = data[0];
    if (userData.key_is_active === false) {
      throw new Error('Your Key is inactive.');
    }
    if (userData.is_banned === true) {
      throw new Error('Your account is banned.');
    }

    localStorage.setItem('user_key', loginKey); // Persist key
    state.isAuthenticated = true;
    state.userProfile = userData;

    document.getElementById('login-section').classList.add('hidden');
    document.getElementById('profile-creation-section').classList.add('hidden');
    document.getElementById('app-content').classList.remove('hidden');
    
    if (!isSilent) showNotification('Successfully logged in!', 'success');
    
    // If profile_id is null, show profile creation section
    if (!userData.profile_id) {
      document.getElementById('app-content').classList.add('hidden');
      document.getElementById('profile-creation-section').classList.remove('hidden');
      showNotification('No profile found for your key. Please create one.', 'info', 10000);
    } else {
      // Load initial data for the app
      await loadDashboardData();
      setupRealtimeSubscriptions();
      showSection('home', document.querySelector('.nav-btn.active')); // Activate default section
    }
    
  } else {
    throw new Error('Invalid Key or Key is not usable');
  }

} catch (error) {
  console.error('Login error:', error);
  if (!isSilent) showNotification(error.message, 'error');
  userLogout(); // Ensure logout on error
} finally {
  if (!isSilent) {
    loginBtn.disabled = false;
    loginText.textContent = 'LOGIN';
  }
  showLoading(false);
}
}

async function createProfile() {
const username = document.getElementById('profile-username').value.trim();
const name = document.getElementById('profile-name').value.trim();
const profilePictureFile = document.getElementById('profile-picture').files[0];
const createProfileBtn = document.getElementById('create-profile-btn');
const createProfileText = document.getElementById('create-profile-text');

if (!username || !name) {
  showNotification('Please enter Username and Name', 'warning');
  return;
}

if (!state.userProfile || !state.userProfile.key_id) {
  showNotification('Key information missing, please re-login.', 'error');
  return;
}

try {
  createProfileBtn.disabled = true;
  createProfileText.textContent = 'CREATING PROFILE...';
  showLoading(true);

  let profilePictureUrl = null;
  if (profilePictureFile) {
    const fileExt = profilePictureFile.name.split('.').pop();
    const fileName = `profile_pictures/${state.userProfile.key_id}_${Date.now()}.${fileExt}`;
    const { data: uploadData, error: uploadError } = await state.supabase.storage
      .from('profiles')
      .upload(fileName, profilePictureFile);
    if (uploadError) throw uploadError;
    const { data: urlData } = state.supabase.storage.from('profiles').getPublicUrl(fileName);
    profilePictureUrl = urlData.publicUrl;
  }

  const { data, error } = await state.supabase
    .from('profiles')
    .insert({
      key_id: state.userProfile.key_id,
      username: username,
      name: name,
      profile_picture: profilePictureUrl,
      is_banned: false
    })
    .select()
    .single();

  if (error) throw error;

  state.userProfile.profile_id = data.id;
  state.userProfile.username = data.username;
  state.userProfile.name = data.name;
  state.userProfile.profile_picture = data.profile_picture;
  state.userProfile.is_banned = data.is_banned;

  showNotification('Profile created successfully!', 'success');
  document.getElementById('profile-creation-section').classList.add('hidden');
  document.getElementById('app-content').classList.remove('hidden');
  
  await loadDashboardData();
  setupRealtimeSubscriptions();
  showSection('home', document.querySelector('.nav-btn.active'));

} catch (error) {
  console.error('Error creating profile:', error);
  if (error.code === '23505') { // Unique constraint violation
    showNotification('Username already exists, please choose another.', 'error');
  } else {
    showNotification('Failed to create profile', 'error');
  }
} finally {
  createProfileBtn.disabled = false;
  createProfileText.textContent = 'CREATE PROFILE';
  showLoading(false);
}
}

async function loadDashboardData() {
try {
  // Load stats
  const [productsResult, downloadsResult] = await Promise.all([
    state.supabase.from('products').select('id', { count: 'exact' }).eq('is_active', true),
    state.supabase.from('orders').select('id', { count: 'exact' }).eq('status', 'approved')
  ]);

  document.getElementById('available-products').textContent = productsResult.count || 0;
  document.getElementById('total-downloads').textContent = downloadsResult.count || 0;

} catch (error) {
  console.error('Error loading dashboard data:', error);
  showNotification('Failed to retrieve dashboard data', 'error');
}
}

function setupRealtimeSubscriptions() {
// Unsubscribe from previous channels if they exist
if (state.newsRealtime) state.supabase.removeChannel(state.newsRealtime);
if (state.chatRealtime) state.supabase.removeChannel(state.chatRealtime);
if (state.supportRealtime) state.supabase.removeChannel(state.supportRealtime);
if (state.productsRealtime) state.supabase.removeChannel(state.productsRealtime);
if (state.ordersRealtime) state.supabase.removeChannel(state.ordersRealtime);
if (state.userShopOrdersRealtime) state.supabase.removeChannel(state.userShopOrdersRealtime);
if (state.userPurchasesRealtime) state.supabase.removeChannel(state.userPurchasesRealtime);

// News realtime updates
state.newsRealtime = state.supabase
  .channel('news_changes')
  .on('postgres_changes', 
    { event: '*', schema: 'public', table: 'news' }, 
    (payload) => {
      if (state.currentSection === 'news' || state.currentSection === 'mi') { // Also update if on Mi page
        loadNewsData();
        if (state.currentSection === 'mi') loadMyNews(); // Reload user's own news
      }
      loadDashboardData(); // Update stats
    }
  )
  .subscribe();

// Chat messages realtime
state.chatRealtime = state.supabase
  .channel('chat_changes')
  .on('postgres_changes', 
    { event: '*', schema: 'public', table: 'chat_messages' }, 
    (payload) => {
      if (state.currentSection === 'chat') {
        loadChatMessages();
      }
    }
  )
  .subscribe();

// Support messages realtime
state.supportRealtime = state.supabase
  .channel('support_changes')
  .on('postgres_changes', 
    { event: '*', schema: 'public', table: 'support_messages' }, 
    (payload) => {
      if (state.currentSection === 'support') {
        loadSupportMessages();
      }
    }
  )
  .subscribe();

// Products realtime (admin-posted)
state.productsRealtime = state.supabase
  .channel('products_changes')
  .on('postgres_changes', 
    { event: '*', schema: 'public', table: 'products' }, 
    (payload) => {
      if (state.currentSection === 'products') {
        loadProductsData();
      }
    }
  )
  .subscribe();

// Orders realtime (for user's own orders of admin-posted products)
state.ordersRealtime = state.supabase
  .channel('orders_changes')
  .on('postgres_changes', 
    { event: '*', schema: 'public', table: 'orders', filter: `profile_id=eq.${state.userProfile.profile_id}` }, 
    (payload) => {
      // If user is on 'Mi' section, refresh their order history
      if (state.currentSection === 'mi') {
        loadUserPurchases(); // This is for admin-posted products
      }
    }
  )
  .subscribe();

// Shop Items realtime (user-posted products)
state.userShopOrdersRealtime = state.supabase
  .channel('shop_items_changes')
  .on('postgres_changes', 
    { event: '*', schema: 'public', table: 'shop_items' }, 
    (payload) => {
      if (state.currentSection === 'shop' || state.currentSection === 'mi') {
        loadShopItems();
        if (state.currentSection === 'mi') loadMyShopItems(); // Reload user's own shop items
      }
    }
  )
  .subscribe();

// User Shop Orders realtime (for user's own shop items, as owner)
state.userPurchasesRealtime = state.supabase
  .channel('user_shop_orders_changes')
  .on('postgres_changes', 
    { event: '*', schema: 'public', table: 'user_shop_orders', filter: `owner_profile_id=eq.${state.userProfile.profile_id}` }, 
    (payload) => {
      if (state.currentSection === 'mi') {
        loadMySalesOrders(); // Reload user's sales orders
      }
    }
  )
  .subscribe();
}

function showSection(section, buttonElement) {
// Hide all sections
document.querySelectorAll('.app-section').forEach(sec => {
  sec.classList.add('hidden');
});

// Update navigation
document.querySelectorAll('.nav-btn').forEach(btn => {
  btn.classList.remove('active');
});

// Show selected section
const sectionElement = document.getElementById(`${section}-section`);
if (sectionElement) {
  sectionElement.classList.remove('hidden');
  sectionElement.classList.add('fade-in');
}

// Update active nav
if (buttonElement) {
  buttonElement.classList.add('active');
}
state.currentSection = section;

// Load section data
switch (section) {
  case 'home':
    loadDashboardData();
    break;
  case 'news':
    loadNewsData();
    break;
  case 'products':
    loadProductsData();
    break;
  case 'shop': // New Shop section
    loadShopItems();
    break;
  case 'chat':
    loadChatMessages();
    break;
  case 'support':
    loadSupportMessages();
    break;
  case 'about':
    loadAboutData();
    break;
  case 'mi':
    loadMiProfile();
    break;
}
}

async function loadNewsData() {
const newsContainer = document.getElementById('news-list');
newsContainer.innerHTML = `
  <div class="loading-spinner mx-auto mb-4"></div>
  <p class="text-center text-text-secondary">Loading news...</p>
`;

try {
  const { data, error } = await state.supabase
    .from('news')
    .select(`
      *,
      profiles(id, username, name, profile_picture),
      admin_profiles(id, username, name, profile_picture)
    `)
    .order('created_at', { ascending: false });

  if (error) throw error;

  if (data && data.length > 0) {
    newsContainer.innerHTML = data.map(news => {
      const author = news.posted_by_admin ? news.admin_profiles : news.profiles;
      const authorName = author?.name || 'Unknown';
      const authorUsername = author?.username || 'unknown';
      const authorAvatar = author?.profile_picture || '/placeholder.svg?height=40&width=40';

      let mediaHtml = '';
      if (news.media_urls && news.media_urls.length > 0) {
        news.media_urls.forEach(media => {
          const mediaType = utils.getMediaType(media.type);
          if (mediaType === 'image') {
            mediaHtml += `<img src="${media.url}" class="w-full rounded-lg mb-3" alt="News image">`;
          } else if (mediaType === 'video') {
            mediaHtml += `
              <div class="video-container mb-3">
                <video controls playsinline webkit-playsinline class="w-full rounded-lg">
                  <source src="${media.url}" type="${media.type}">
                </video>
              </div>
            `;
          } else if (mediaType === 'audio') {
            mediaHtml += `
              <div class="audio-container mb-3">
                <audio controls class="w-full">
                  <source src="${media.url}" type="${media.type}">
                </audio>
              </div>
            `;
          }
        });
      }
      
      return `
        <div class="news-card p-4">
          <div class="flex justify-between items-start mb-3">
            <div class="flex items-center space-x-3">
              <img src="${authorAvatar}" alt="Author" class="w-8 h-8 rounded-full object-cover">
              <div>
                <h4 class="text-lg font-semibold text-accent-purple mb-1">${news.title}</h4>
                <p class="text-sm text-text-secondary">
                  <i class="fas fa-user mr-1"></i> ${authorName} (@${authorUsername})
                  <span class="ml-3">
                    <i class="fas fa-calendar mr-1"></i> ${new Date(news.created_at).toLocaleDateString('en-US')}
                  </span>
                </p>
              </div>
            </div>
            <div class="flex space-x-2">
              <button onclick="viewNews('${news.id}')" class="myanmar-btn btn-small">
                <i class="fas fa-eye"></i>
              </button>
              <button onclick="shareNews('${news.id}')" class="myanmar-btn btn-small">
                <i class="fas fa-share-alt"></i>
              </button>
            </div>
          </div>
          
          ${mediaHtml}
          
          <p class="text-text-secondary text-sm mb-3">${news.content.substring(0, 150)}${news.content.length > 150 ? '...' : ''}</p>
          
          <div class="flex items-center justify-between text-sm text-text-secondary">
            <div class="flex space-x-4">
              <span><i class="fas fa-eye mr-1"></i> ${news.views || 0}</span>
              <span><i class="fas fa-heart mr-1"></i> ${news.likes || 0}</span>
            </div>
            ${news.youtube_link ? '<i class="fab fa-youtube text-red-500"></i>' : ''}
          </div>
        </div>
      `;
    }).join('');
  } else {
    newsContainer.innerHTML = `
      <div class="text-center text-text-secondary py-8">
        <i class="fas fa-newspaper text-4xl mb-4"></i>
        <p>No News Found</p>
      </div>
    `;
  }
} catch (error) {
  console.error('Error loading news:', error);
  newsContainer.innerHTML = `
    <div class="text-center text-accent-red py-8">
      <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
      <p>Failed to retrieve News</p>
    </div>
  `;
}
}

async function viewNews(newsId) {
try {
  const { data, error } = await state.supabase
    .from('news')
    .select(`
      *,
      profiles(username, name, profile_picture),
      admin_profiles(username, name, profile_picture)
    `)
    .eq('id', newsId)
    .single();

  if (error) throw error;

  const author = data.posted_by_admin ? data.admin_profiles : data.profiles;
  const authorName = author?.name || 'Unknown';
  const authorUsername = author?.username || 'unknown';
  const authorAvatar = author?.profile_picture || '/placeholder.svg?height=40&width=40';

  let mediaHtml = '';
  if (data.media_urls && data.media_urls.length > 0) {
    data.media_urls.forEach(media => {
      const mediaType = utils.getMediaType(media.type);
      if (mediaType === 'image') {
        mediaHtml += `<img src="${media.url}" class="w-full rounded-lg mb-3" alt="News image">`;
      } else if (mediaType === 'video') {
        mediaHtml += `
          <div class="video-container mb-3">
            <video controls playsinline webkit-playsinline class="w-full rounded-lg">
              <source src="${media.url}" type="${media.type}">
            </video>
          </div>
        `;
      } else if (mediaType === 'audio') {
        mediaHtml += `
          <div class="audio-container mb-3">
            <audio controls class="w-full">
              <source src="${media.url}" type="${media.type}">
            </audio>
          </div>
        `;
      }
    });
  }

  let socialLinksHtml = '';
  if (data.youtube_link) socialLinksHtml += `<a href="${data.youtube_link}" target="_blank" class="text-red-500 hover:text-red-400"><i class="fab fa-youtube text-2xl"></i></a>`;
  if (data.tiktok_link) socialLinksHtml += `<a href="${data.tiktok_link}" target="_blank" class="text-text-secondary hover:text-text-primary"><i class="fab fa-tiktok text-2xl"></i></a>`;
  if (data.telegram_link) socialLinksHtml += `<a href="${data.telegram_link}" target="_blank" class="text-blue-400 hover:text-blue-300"><i class="fab fa-telegram text-2xl"></i></a>`;
  if (data.facebook_link) socialLinksHtml += `<a href="${data.facebook_link}" target="_blank" class="text-blue-600 hover:text-blue-500"><i class="fab fa-facebook text-2xl"></i></a>`;


  document.getElementById('news-modal-content').innerHTML = `
    <div class="space-y-4">
      <div class="flex items-center space-x-3">
        <img src="${authorAvatar}" 
             alt="Author" class="w-10 h-10 rounded-full object-cover">
        <div>
          <h4 class="font-semibold text-text-primary">${authorName}</h4>
          <p class="text-sm text-text-secondary">@${authorUsername}</p>
        </div>
      </div>
      
      <h3 class="text-xl font-bold text-accent-purple">${data.title}</h3>
      
      ${mediaHtml}
      
      <div class="prose prose-invert max-w-none">
        <p class="text-text-secondary whitespace-pre-wrap">${data.content}</p>
      </div>
      
      ${socialLinksHtml ? `<div class="flex space-x-4 mt-4">${socialLinksHtml}</div>` : ''}

      <div class="flex items-center justify-between text-sm text-text-secondary pt-4 border-t border-border-color">
        <div class="flex space-x-4">
          <span><i class="fas fa-eye mr-1"></i> ${data.views || 0} VIEWS</span>
          <span><i class="fas fa-heart mr-1"></i> ${data.likes || 0} LIKES</span>
        </div>
        <span><i class="fas fa-calendar mr-1"></i> ${new Date(data.created_at).toLocaleString('en-US')}</span>
      </div>
    </div>
  `;

  document.getElementById('news-modal').classList.remove('hidden');

} catch (error) {
  console.error('Error viewing news:', error);
  showNotification('Failed to view News', 'error');
}
}

function closeNewsModal() {
document.getElementById('news-modal').classList.add('hidden');
}

async function shareNews(newsId) {
// Implement sharing functionality (e.g., copy link, share to social media)
const newsUrl = `${window.location.origin}/news/${newsId}`; // Example URL, adjust as needed
try {
  await navigator.clipboard.writeText(newsUrl);
  showNotification('News link copied to clipboard!', 'success');
} catch (err) {
  console.error('Failed to copy: ', err);
  showNotification('Failed to copy news link.', 'error');
}
}

async function loadProductsData() {
const productsList = document.getElementById('products-list');
productsList.innerHTML = `
  <div class="loading-spinner mx-auto mb-4 col-span-full"></div>
  <p class="text-center text-text-secondary col-span-full">Loading products...</p>
`;

try {
  const { data: products, error } = await state.supabase
    .from('products')
    .select('*')
    .eq('is_active', true)
    .order('created_at', { ascending: false });

  if (error) throw error;

  if (products && products.length > 0) {
    productsList.innerHTML = ''; // Clear loading
    for (const product of products) {
      let isPurchased = false;
      if (state.userProfile && state.userProfile.profile_id) { // Only check if user is logged in and has a profile
        const { data: purchasedData, error: purchasedError } = await state.supabase
          .from('purchased_products')
          .select('id')
          .eq('profile_id', state.userProfile.profile_id)
          .eq('product_id', product.id)
          .limit(1);
        isPurchased = !purchasedError && purchasedData && purchasedData.length > 0;
      }

      productsList.innerHTML += `
        <div class="app-card p-4 text-center flex flex-col justify-between items-center">
          <img src="${product.apk_icon_url || '/placeholder.svg?height=64&width=64'}" alt="${product.name} icon" class="w-16 h-16 object-contain mb-3">
          <h3 class="text-lg font-semibold text-text-primary mb-1">${product.name}</h3>
          <p class="text-text-secondary text-sm mb-2">${product.description || 'No description'}</p>
          ${product.price > 0 ? `<p class="text-xl font-bold text-accent-green mb-3">${product.price} MMK</p>` : '<p class="text-xl font-bold text-accent-green mb-3">FREE</p>'}
          ${product.price > 0 && !isPurchased ? `
            <button onclick="initiatePurchase('${product.id}', '${product.name}', ${product.price})" class="myanmar-btn w-full mt-auto">
              <i class="fas fa-shopping-cart mr-2"></i> PURCHASE
            </button>
          ` : `
            <a href="${product.file_url}" target="_blank" download class="myanmar-btn w-full mt-auto">
              <i class="fas fa-download mr-2"></i> DOWNLOAD
            </a>
          `}
        </div>
      `;
    }
  } else {
    productsList.innerHTML = '<p class="text-center col-span-full text-text-secondary">No Products Available</p>';
  }
} catch (error) {
  console.error('Error loading products:', error);
  productsList.innerHTML = '<p class="text-center col-span-full text-accent-red">Failed to retrieve Products</p>';
}
}

async function initiatePurchase(productId, productName, productPrice) {
if (!state.userProfile || !state.userProfile.profile_id) {
  showNotification('Please create a profile to purchase products.', 'info');
  return;
}
state.selectedProductForPurchase = { id: productId, name: productName, price: productPrice };

const paymentModalContent = document.getElementById('payment-modal-content');
paymentModalContent.innerHTML = `
  <h3 class="text-xl font-semibold text-text-primary mb-2">${productName}</h3>
  <p class="text-text-secondary mb-4">Price: <span class="text-accent-green font-bold">${productPrice} MMK</span></p>
  
  <h4 class="text-lg font-semibold text-accent-purple mb-3">SELECT PAYMENT METHOD</h4>
  <div id="payment-methods-list" class="space-y-3 mb-4">
    <div class="loading-spinner mx-auto mb-2"></div>
    <p class="text-center text-text-secondary">Loading payment methods...</p>
  </div>

  <div class="space-y-3">
    <label class="block text-sm font-medium text-text-secondary">UPLOAD RECEIPT IMAGE</label>
    <input type="file" id="receipt-upload" accept="image/*" class="app-input w-full">
    <button onclick="submitPurchase()" class="myanmar-btn w-full">
      <i class="fas fa-paper-plane mr-2"></i>
      CONFIRM PAYMENT
    </button>
  </div>
  <p class="text-sm text-text-secondary mt-4">
    <i class="fas fa-info-circle mr-1"></i>
    After confirming payment, Admin will review and approve your download.
  </p>
`;

document.getElementById('payment-modal').classList.remove('hidden');

const paymentMethodsList = document.getElementById('payment-methods-list');
try {
  const { data: methods, error } = await state.supabase
    .from('payment_methods')
    .select('*')
    .eq('is_active', true)
    .order('method_name', { ascending: true });

  if (error) throw error;

  if (methods && methods.length > 0) {
    paymentMethodsList.innerHTML = methods.map(method => `
      <label class="flex items-center space-x-3 p-3 bg-secondary-bg rounded-lg cursor-pointer border border-border-color">
        <input type="radio" name="payment_method" value="${method.id}" 
               onchange="state.selectedPaymentMethod = '${method.id}'" class="w-4 h-4 text-accent-purple focus:ring-accent-purple">
        <div>
          <p class="font-semibold text-text-primary">${method.method_name}</p>
          <p class="text-text-secondary text-sm">${method.account_info || ''}</p>
          ${method.qr_code_url ? `<img src="${method.qr_code_url}" class="w-24 h-24 mt-2 rounded-md border border-border-color" alt="QR Code">` : ''}
          ${method.instructions ? `<p class="text-text-secondary text-xs mt-1">${method.instructions}</p>` : ''}
        </div>
      </label>
    `).join('');
  } else {
    paymentMethodsList.innerHTML = '<p class="text-center text-text-secondary">No Payment Methods Available</p>';
  }
} catch (error) {
  console.error('Error loading payment methods:', error);
  showNotification('Failed to retrieve Payment Methods', 'error');
  paymentMethodsList.innerHTML = '<p class="text-center text-accent-red">Failed to retrieve Payment Methods</p>';
}
}

function closePaymentModal() {
document.getElementById('payment-modal').classList.add('hidden');
state.selectedProductForPurchase = null;
state.selectedShopItemForPurchase = null; // Clear this too
state.selectedPaymentMethod = null;
document.getElementById('receipt-upload').value = '';
}

async function submitPurchase() {
if (!state.selectedProductForPurchase || !state.selectedPaymentMethod) {
  showNotification('Please select a Product and Payment Method', 'warning');
  return;
}
const receiptFile = document.getElementById('receipt-upload').files[0];
if (!receiptFile) {
  showNotification('Please upload a receipt image', 'warning');
  return;
}

showNotification('Confirming payment...', 'info');
showLoading(true);

try {
  // Upload receipt image
  const fileExt = receiptFile.name.split('.').pop();
  const fileName = `receipts/${state.userProfile.profile_id}_${state.selectedProductForPurchase.id}_${Date.now()}.${fileExt}`;
  
  const { data: uploadData, error: uploadError } = await state.supabase.storage
    .from('receipts')
    .upload(fileName, receiptFile);
    
  if (uploadError) throw uploadError;
  
  const { data: urlData } = state.supabase.storage
    .from('receipts')
    .getPublicUrl(fileName);
    
  const receiptUrl = urlData.publicUrl;

  // Create order
  const { error: orderError } = await state.supabase
    .from('orders')
    .insert({
      profile_id: state.userProfile.profile_id,
      product_id: state.selectedProductForPurchase.id,
      payment_method_id: state.selectedPaymentMethod,
      amount: state.selectedProductForPurchase.price,
      receipt_url: receiptUrl,
      status: 'pending' // Admin needs to approve this
    });

  if (orderError) throw orderError;

  showNotification('Payment submitted successfully! Admin will review it.', 'success');
  closePaymentModal();
  loadProductsData(); // Reload products to update status
} catch (error) {
  console.error('Error submitting purchase:', error);
  showNotification('Failed to submit payment', 'error');
} finally {
  showLoading(false);
}
}

async function loadChatMessages() {
const chatMessagesContainer = document.getElementById('chat-messages');
chatMessagesContainer.innerHTML = `
  <div class="loading-spinner mx-auto mb-4"></div>
  <p class="text-center text-text-secondary">Loading messages...</p>
`;

if (!state.userProfile || !state.userProfile.profile_id) {
  chatMessagesContainer.innerHTML = `
    <div class="text-center text-text-secondary py-8">
      <i class="fas fa-comments text-4xl mb-4"></i>
      <p>Please create a profile to use chat.</p>
    </div>
  `;
  return;
}

let conversationId = null;
if (state.selectedChatProfileId) {
  // Get or create conversation with the selected profile
  const { data: convId, error: convError } = await state.supabase.rpc('get_or_create_conversation', {
    user1_id: state.userProfile.profile_id,
    user2_id: state.selectedChatProfileId
  });
  if (convError) {
    console.error('Error getting/creating conversation:', convError);
    showNotification('Failed to load chat conversation.', 'error');
    return;
  }
  conversationId = convId;
} else {
  // Default to global chat with admin if no specific chat selected
  const adminProfileId = 'a0eebc99-9c0b-4ef8-bb6d-6bb9bd380a11'; // Hardcoded admin ID
  const { data: convId, error: convError } = await state.supabase.rpc('get_or_create_conversation', {
    user1_id: state.userProfile.profile_id,
    user2_id: adminProfileId
  });
  if (convError) {
    console.error('Error getting/creating conversation with admin:', convError);
    showNotification('Failed to load chat conversation with admin.', 'error');
    return;
  }
  conversationId = convId;
}

try {
  const { data: messages, error } = await state.supabase
    .from('chat_messages')
    .select(`
      *,
      sender:profiles(username, name, profile_picture)
    `)
    .eq('conversation_id', conversationId)
    .order('created_at', { ascending: true })
    .limit(50); // Limit to last 50 messages

  if (error) throw error;

  if (messages && messages.length > 0) {
    chatMessagesContainer.innerHTML = messages.map(message => {
      const isCurrentUser = message.sender_id === state.userProfile.profile_id;
      const senderName = message.sender?.name || 'Unknown User';
      const senderUsername = message.sender?.username || 'unknown';
      const avatar = message.sender?.profile_picture || '/placeholder.svg?height=40&width=40';
      
      return `
        <div class="flex items-start mb-4 ${isCurrentUser ? 'justify-end' : ''}">
          ${!isCurrentUser ? `<img src="${avatar}" class="w-8 h-8 rounded-full object-cover mr-3" alt="Sender Avatar">` : ''}
          <div class="max-w-[70%] p-3 rounded-lg ${isCurrentUser ? 'bg-accent-purple text-white ml-auto' : 'bg-secondary-bg text-text-primary mr-auto'}">
            <p class="font-semibold text-sm mb-1">${isCurrentUser ? 'You' : senderName}</p>
            <p class="text-sm">${message.content}</p>
            <span class="block text-xs opacity-70 mt-1">${new Date(message.created_at).toLocaleTimeString('en-US')}</span>
          </div>
          ${isCurrentUser ? `<img src="${avatar}" class="w-8 h-8 rounded-full object-cover ml-3" alt="Your Avatar">` : ''}
        </div>
      `;
    }).join('');
    chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight; // Scroll to bottom
  } else {
    chatMessagesContainer.innerHTML = `
      <div class="text-center text-text-secondary py-8">
        <i class="fas fa-comments text-4xl mb-4"></i>
        <p>No messages yet. Start the conversation!</p>
      </div>
    `;
  }
} catch (error) {
  console.error('Error loading chat messages:', error);
  chatMessagesContainer.innerHTML = `
    <div class="text-center text-accent-red py-8">
      <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
      <p>Failed to retrieve Chat Messages</p>
    </div>
  `;
}
}

async function sendChatMessage() {
const chatInput = document.getElementById('chat-input');
const messageContent = chatInput.value.trim();

if (!messageContent) {
  showNotification('Message cannot be empty.', 'warning');
  return;
}
if (!state.userProfile || !state.userProfile.profile_id) {
  showNotification('Please create a profile to send messages.', 'info');
  return;
}

let conversationId = null;
try {
  if (state.selectedChatProfileId) {
    const { data: convId, error: convError } = await state.supabase.rpc('get_or_create_conversation', {
      user1_id: state.userProfile.profile_id,
      user2_id: state.selectedChatProfileId
    });
    if (convError) throw convError;
    conversationId = convId;
  } else {
    // Default to admin chat if no specific chat selected
    const adminProfileId = 'a0eebc99-9c0b-4ef8-bb6d-6bb9bd380a11'; // Hardcoded admin ID
    const { data: convId, error: convError } = await state.supabase.rpc('get_or_create_conversation', {
      user1_id: state.userProfile.profile_id,
      user2_id: adminProfileId
    });
    if (convError) throw convError;
    conversationId = convId;
  }

  const { error } = await state.supabase
    .from('chat_messages')
    .insert({
      conversation_id: conversationId,
      sender_id: state.userProfile.profile_id,
      content: messageContent,
      message_type: 'text'
    });

  if (error) throw error;

  chatInput.value = '';
  showNotification('Message sent!', 'success');
  loadChatMessages(); // Reload messages to show the new one
} catch (error) {
  console.error('Error sending chat message:', error);
  showNotification('Failed to send message', 'error');
}
}

async function loadSupportMessages() {
const supportMessagesContainer = document.getElementById('support-messages');
supportMessagesContainer.innerHTML = `
  <div class="loading-spinner mx-auto mb-4"></div>
  <p class="text-center text-text-secondary">Loading messages...</p>
`;

if (!state.userProfile || !state.userProfile.profile_id) {
  supportMessagesContainer.innerHTML = `
    <div class="text-center text-text-secondary py-8">
      <i class="fas fa-headset text-4xl mb-4"></i>
      <p>Please create a profile to use support chat.</p>
    </div>
  `;
  return;
}

try {
  const { data: messages, error } = await state.supabase
    .from('support_messages')
    .select(`
      *,
      profiles(username, name, profile_picture),
      admin_profiles(username, name, profile_picture)
    `)
    .or(`profile_id.eq.${state.userProfile.profile_id},admin_profile_id.eq.${state.userProfile.profile_id}`) // Fetch messages where current user is involved
    .order('created_at', { ascending: true });

  if (error) throw error;

  if (messages && messages.length > 0) {
    supportMessagesContainer.innerHTML = messages.map(message => {
      const isFromUser = message.is_from_user;
      const senderName = isFromUser ? (message.profiles?.name || 'You') : (message.admin_profiles?.name || 'Admin');
      const messageClass = isFromUser ? 'bg-accent-purple text-white ml-auto' : 'bg-secondary-bg text-text-primary mr-auto';
      
      return `
        <div class="flex items-start mb-4 ${isFromUser ? 'justify-end' : ''}">
          <div class="max-w-[70%] p-3 rounded-lg ${messageClass}">
            <p class="font-semibold text-sm mb-1">${senderName}</p>
            <p class="text-sm">${message.content}</p>
            <span class="block text-xs opacity-70 mt-1">${new Date(message.created_at).toLocaleTimeString('en-US')}</span>
          </div>
        </div>
      `;
    }).join('');
    supportMessagesContainer.scrollTop = supportMessagesContainer.scrollHeight; // Scroll to bottom
  } else {
    supportMessagesContainer.innerHTML = `
      <div class="text-center text-text-secondary py-8">
        <i class="fas fa-headset text-4xl mb-4"></i>
        <p>No support messages yet. Send us a message!</p>
      </div>
    `;
  }
} catch (error) {
  console.error('Error loading support messages:', error);
  supportMessagesContainer.innerHTML = `
    <div class="text-center text-accent-red py-8">
      <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
      <p>Failed to retrieve Support Messages</p>
    </div>
  `;
}
}

async function sendSupportMessage() {
const supportInput = document.getElementById('support-input');
const messageContent = supportInput.value.trim();

if (!messageContent) {
  showNotification('Message cannot be empty.', 'warning');
  return;
}
if (!state.userProfile || !state.userProfile.profile_id) {
  showNotification('Please create a profile to send support messages.', 'info');
  return;
}

try {
  const { error } = await state.supabase
    .from('support_messages')
    .insert({
      profile_id: state.userProfile.profile_id,
      content: messageContent,
      is_from_user: true,
      message_type: 'text'
    });

  if (error) throw error;

  supportInput.value = '';
  showNotification('Support message sent!', 'success');
  loadSupportMessages(); // Reload messages to show the new one
} catch (error) {
  console.error('Error sending support message:', error);
  showNotification('Failed to send message', 'error');
}
}

async function loadAboutData() {
const aboutContent = document.getElementById('about-content');
aboutContent.innerHTML = `
  <div class="loading-spinner mx-auto mb-4"></div>
  <p class="text-center text-text-secondary">Loading about information...</p>
`;
try {
  const { data: about, error } = await state.supabase
    .from('about')
    .select('*')
    .eq('id', 'main')
    .single();
    
  if (error) throw error;
  
  let socialLinksHtml = '';
  if (about.social_links && about.social_links.length > 0) {
    about.social_links.forEach(link => {
      socialLinksHtml += `
        <a href="${link.url}" target="_blank" class="flex items-center justify-center p-3 rounded-lg bg-secondary-bg text-text-primary hover:bg-accent-purple hover:text-white transition-colors duration-300">
          <img src="${link.icon_url || '/placeholder.svg?height=24&width=24'}" class="w-6 h-6 mr-2" alt="${link.name} icon">
          <span>${link.name}</span>
        </a>
      `;
    });
  }

  aboutContent.innerHTML = `
    <h4 class="text-lg font-semibold text-accent-green mb-2">${about.title || 'About Us'}</h4>
    <p class="text-text-secondary whitespace-pre-wrap mb-4">${about.content || 'No information available.'}</p>
    
    ${socialLinksHtml ? `
      <h5 class="text-md font-semibold text-accent-purple mb-3">FIND US ON SOCIAL MEDIA</h5>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        ${socialLinksHtml}
      </div>
    ` : ''}
  `;
} catch (error) {
  console.error('Error loading about data:', error);
  aboutContent.innerHTML = `
    <div class="text-center text-accent-red py-8">
      <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
      <p>Failed to retrieve About information</p>
    </div>
  `;
}
}

async function loadMiProfile() {
if (!state.userProfile || !state.userProfile.profile_id) {
  showNotification('Profile not loaded. Please re-login.', 'error');
  return;
}

const profileDetails = document.getElementById('profile-details');
profileDetails.innerHTML = `
  <div class="loading-spinner mx-auto mb-4"></div>
  <p class="text-center text-text-secondary">Loading profile...</p>
`;

try {
  const { data: profile, error } = await state.supabase
    .from('profiles')
    .select(`
      *,
      keys(key_text, is_active)
    `)
    .eq('id', state.userProfile.profile_id)
    .single();

  if (error) throw error;

  state.userProfile = { ...state.userProfile, ...profile }; // Update local state with fresh profile data

  document.getElementById('mi-profile-picture').src = profile.profile_picture || '/placeholder.svg?height=100&width=100';
  document.getElementById('mi-name').textContent = profile.name;
  document.getElementById('mi-username').textContent = `@${profile.username}`;
  document.getElementById('mi-key-text').value = profile.keys?.key_text || 'N/A';
  document.getElementById('mi-account-status').value = profile.is_banned ? 'BANNED' : (profile.keys?.is_active ? 'ACTIVE' : 'INACTIVE');
  document.getElementById('mi-account-status').classList.remove('status-active', 'status-inactive', 'status-banned');
  document.getElementById('mi-account-status').classList.add(profile.is_banned ? 'status-banned' : (profile.keys?.is_active ? 'status-active' : 'status-inactive'));

  // Load user's news posts
  loadMyNews();
  // Load user's shop items
  loadMyShopItems();
  // Load user's sales orders
  loadMySalesOrders();
  // Load user's purchase history (for admin-posted products)
  loadUserPurchases();

} catch (error) {
  console.error('Error loading MI profile:', error);
  showNotification('Failed to retrieve profile information', 'error');
  profileDetails.innerHTML = `
    <div class="text-center text-accent-red py-8">
      <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
      <p>Failed to load your profile.</p>
    </div>
  `;
}
}

async function updateProfile() {
if (!state.userProfile || !state.userProfile.profile_id) {
  showNotification('Profile not loaded. Please re-login.', 'error');
  return;
}

const newProfilePictureFile = document.getElementById('mi-new-profile-picture').files[0];
const updateBtn = document.querySelector('#mi-section button'); // Assuming this is the update button

try {
  updateBtn.disabled = true;
  updateBtn.querySelector('span').textContent = 'UPDATING...';
  showLoading(true);

  let profilePictureUrl = state.userProfile.profile_picture;
  if (newProfilePictureFile) {
    // Delete old picture if exists
    if (profilePictureUrl && profilePictureUrl.includes('/profile_pictures/')) {
      const oldFileName = profilePictureUrl.split('/profile_pictures/')[1].split('?')[0];
      await state.supabase.storage.from('profiles').remove([`profile_pictures/${oldFileName}`]);
    }

    const fileExt = newProfilePictureFile.name.split('.').pop();
    const fileName = `profile_pictures/${state.userProfile.profile_id}_${Date.now()}.${fileExt}`;
    const { data: uploadData, error: uploadError } = await state.supabase.storage
      .from('profiles')
      .upload(fileName, newProfilePictureFile);
    if (uploadError) throw uploadError;
    const { data: urlData } = state.supabase.storage.from('profiles').getPublicUrl(fileName);
    profilePictureUrl = urlData.publicUrl;
  }

  const { error } = await state.supabase
    .from('profiles')
    .update({ profile_picture: profilePictureUrl })
    .eq('id', state.userProfile.profile_id);

  if (error) throw error;

  state.userProfile.profile_picture = profilePictureUrl; // Update local state
  document.getElementById('mi-profile-picture').src = profilePictureUrl;
  document.getElementById('mi-new-profile-picture').value = ''; // Clear file input

  showNotification('Profile updated successfully!', 'success');
} catch (error) {
  console.error('Error updating profile:', error);
  showNotification('Failed to update profile', 'error');
} finally {
  updateBtn.disabled = false;
  updateBtn.querySelector('span').textContent = 'UPDATE PROFILE';
  showLoading(false);
}
}

async function postMyNews() {
if (!state.userProfile || !state.userProfile.profile_id) {
  showNotification('Please create a profile to post news.', 'info');
  return;
}

const title = document.getElementById('my-news-title').value.trim();
const content = document.getElementById('my-news-content').value.trim();
const mediaFiles = document.getElementById('my-news-media').files;
const youtubeLink = document.getElementById('my-news-youtube').value.trim();
const tiktokLink = document.getElementById('my-news-tiktok').value.trim();

if (!title || !content) {
  showNotification('News title and content cannot be empty.', 'warning');
  return;
}

showLoading(true);
try {
  let mediaUrls = [];
  if (mediaFiles.length > 0) {
    for (let i = 0; i < mediaFiles.length; i++) {
      const file = mediaFiles[i];
      const fileExt = file.name.split('.').pop();
      const fileName = `news_media/${state.userProfile.profile_id}_${Date.now()}_${i}.${fileExt}`;
      const { data: uploadData, error: uploadError } = await state.supabase.storage
        .from('news')
        .upload(fileName, file);
      if (uploadError) throw uploadError;
      const { data: urlData } = state.supabase.storage.from('news').getPublicUrl(fileName);
      mediaUrls.push({ url: urlData.publicUrl, type: file.type });
    }
  }

  const { error } = await state.supabase
    .from('news')
    .insert({
      profile_id: state.userProfile.profile_id,
      title: title,
      content: content,
      media_urls: mediaUrls.length > 0 ? mediaUrls : null,
      youtube_link: youtubeLink || null,
      tiktok_link: tiktokLink || null,
      posted_by_admin: false // User-posted news
    });

  if (error) throw error;

  showNotification('News posted successfully!', 'success');
  document.getElementById('my-news-title').value = '';
  document.getElementById('my-news-content').value = '';
  document.getElementById('my-news-media').value = '';
  document.getElementById('my-news-youtube').value = '';
  document.getElementById('my-news-tiktok').value = '';
  loadMyNews(); // Reload user's news
  loadNewsData(); // Reload global news feed
} catch (error) {
  console.error('Error posting news:', error);
  showNotification('Failed to post news', 'error');
} finally {
  showLoading(false);
}
}

async function loadMyNews() {
if (!state.userProfile || !state.userProfile.profile_id) {
  document.getElementById('my-news-list').innerHTML = `
    <div class="text-center text-text-secondary py-8">
      <i class="fas fa-newspaper text-4xl mb-4"></i>
      <p>Please create a profile to view your news posts.</p>
    </div>
  `;
  return;
}

const myNewsList = document.getElementById('my-news-list');
myNewsList.innerHTML = `
  <div class="loading-spinner mx-auto mb-4"></div>
  <p class="text-center text-text-secondary">Loading your news...</p>
`;

try {
  const { data, error } = await state.supabase
    .from('news')
    .select('*')
    .eq('profile_id', state.userProfile.profile_id)
    .order('created_at', { ascending: false });

  if (error) throw error;

  if (data && data.length > 0) {
    myNewsList.innerHTML = data.map(news => `
      <div class="news-card p-4 flex justify-between items-center">
        <div>
          <h4 class="text-lg font-semibold text-accent-purple">${news.title}</h4>
          <p class="text-sm text-text-secondary">${new Date(news.created_at).toLocaleDateString('en-US')}</p>
        </div>
        <div class="flex space-x-2">
          <button onclick="viewNews('${news.id}')" class="myanmar-btn btn-small">
            <i class="fas fa-eye"></i>
          </button>
          <button onclick="confirmDeleteNews('${news.id}')" class="btn-danger myanmar-btn btn-small">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      </div>
    `).join('');
  } else {
    myNewsList.innerHTML = `
      <div class="text-center text-text-secondary py-8">
        <i class="fas fa-newspaper text-4xl mb-4"></i>
        <p>You haven't posted any news yet.</p>
      </div>
    `;
  }
} catch (error) {
  console.error('Error loading my news:', error);
  myNewsList.innerHTML = `
    <div class="text-center text-accent-red py-8">
      <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
      <p>Failed to retrieve your news posts.</p>
    </div>
  `;
}
}

function confirmDeleteNews(newsId) {
state.confirmCallback = async () => {
  showLoading(true);
  try {
    const { error } = await state.supabase
      .from('news')
      .delete()
      .eq('id', newsId);
    if (error) throw error;
    showNotification('News deleted successfully!', 'success');
    loadMyNews();
    loadNewsData();
  } catch (error) {
    console.error('Error deleting news:', error);
    showNotification('Failed to delete news', 'error');
  } finally {
    showLoading(false);
    closeConfirmModal();
  }
};
document.getElementById('confirm-message').textContent = 'Are you sure you want to delete this news post? This action cannot be undone.';
document.getElementById('confirm-modal').classList.remove('hidden');
}

async function loadShopItems() {
const shopItemsList = document.getElementById('shop-items-list');
shopItemsList.innerHTML = `
  <div class="loading-spinner mx-auto mb-4 col-span-full"></div>
  <p class="text-center text-text-secondary col-span-full">Loading shop items...</p>
`;

try {
  const { data: items, error } = await state.supabase
    .from('shop_items')
    .select(`
      *,
      owner:profiles(id, username, name, profile_picture)
    `)
    .eq('is_active', true)
    .order('created_at', { ascending: false });

  if (error) throw error;

  if (items && items.length > 0) {
    shopItemsList.innerHTML = ''; // Clear loading
    for (const item of items) {
      const ownerName = item.owner?.name || 'Unknown Seller';
      const ownerUsername = item.owner?.username || 'unknown';
      const ownerAvatar = item.owner?.profile_picture || '/placeholder.svg?height=40&width=40';
      const isMyItem = state.userProfile && state.userProfile.profile_id === item.owner_profile_id;

      shopItemsList.innerHTML += `
        <div class="app-card p-4 flex flex-col justify-between">
          <div class="flex items-center mb-3">
            <img src="${ownerAvatar}" alt="Seller" class="w-8 h-8 rounded-full object-cover mr-2">
            <div>
              <p class="text-sm font-semibold text-text-primary">${ownerName}</p>
              <p class="text-xs text-text-secondary">@${ownerUsername}</p>
            </div>
          </div>
          <img src="${item.image_urls && item.image_urls.length > 0 ? item.image_urls[0].url : '/placeholder.svg?height=150&width=200'}" 
               alt="${item.name}" class="w-full h-32 object-cover rounded-lg mb-3">
          <h3 class="text-lg font-semibold text-text-primary mb-1">${item.name}</h3>
          <p class="text-text-secondary text-sm mb-2">${item.description.substring(0, 80)}${item.description.length > 80 ? '...' : ''}</p>
          <p class="text-xl font-bold text-accent-green mb-3">${item.price} MMK</p>
          <div class="flex space-x-2 mt-auto">
            <button onclick="viewShopItem('${item.id}')" class="myanmar-btn btn-small flex-1">
              <i class="fas fa-eye"></i> VIEW
            </button>
            ${!isMyItem ? `
              <button onclick="initiateShopItemPurchase('${item.id}')" class="myanmar-btn btn-small flex-1">
                <i class="fas fa-shopping-cart"></i> BUY NOW
              </button>
            ` : ''}
          </div>
        </div>
      `;
    }
  } else {
    shopItemsList.innerHTML = '<p class="text-center col-span-full text-text-secondary">No Shop Items Available</p>';
  }
} catch (error) {
  console.error('Error loading shop items:', error);
  shopItemsList.innerHTML = '<p class="text-center col-span-full text-accent-red">Failed to retrieve Shop Items</p>';
}
}

async function viewShopItem(itemId) {
try {
  const { data: item, error } = await state.supabase
    .from('shop_items')
    .select(`
      *,
      owner:profiles(id, username, name, profile_picture)
    `)
    .eq('id', itemId)
    .single();

  if (error) throw error;

  const ownerName = item.owner?.name || 'Unknown Seller';
  const ownerUsername = item.owner?.username || 'unknown';
  const ownerAvatar = item.owner?.profile_picture || '/placeholder.svg?height=40&width=40';
  const isMyItem = state.userProfile && state.userProfile.profile_id === item.owner_profile_id;

  let imagesHtml = '';
  if (item.image_urls && item.image_urls.length > 0) {
    imagesHtml = item.image_urls.map(img => `<img src="${img.url}" class="w-full rounded-lg mb-3" alt="Item image">`).join('');
  }

  document.getElementById('shop-item-modal-content').innerHTML = `
    <div class="space-y-4">
      <div class="flex items-center space-x-3">
        <img src="${ownerAvatar}" alt="Seller" class="w-10 h-10 rounded-full object-cover">
        <div>
          <h4 class="font-semibold text-text-primary">${ownerName}</h4>
          <p class="text-sm text-text-secondary">@${ownerUsername}</p>
        </div>
      </div>
      
      <h3 class="text-xl font-bold text-accent-purple">${item.name}</h3>
      <p class="text-2xl font-bold text-accent-green">${item.price} MMK</p>
      
      ${imagesHtml}
      
      <div class="prose prose-invert max-w-none">
        <p class="text-text-secondary whitespace-pre-wrap">${item.description}</p>
      </div>

      <div class="flex items-center justify-between text-sm text-text-secondary pt-4 border-t border-border-color">
        <span><i class="fas fa-calendar mr-1"></i> Posted: ${new Date(item.created_at).toLocaleDateString('en-US')}</span>
        ${item.contact_social_link ? `
          <a href="${item.contact_social_link}" target="_blank" class="text-blue-400 hover:text-blue-300 flex items-center">
            <i class="fas fa-link mr-1"></i> ${item.contact_social_name || 'Contact'}
          </a>
        ` : ''}
      </div>
      ${!isMyItem ? `
        <button onclick="initiateShopItemPurchase('${item.id}')" class="myanmar-btn w-full mt-4">
          <i class="fas fa-shopping-cart mr-2"></i> BUY NOW
        </button>
      ` : ''}
    </div>
  `;

  document.getElementById('shop-item-modal').classList.remove('hidden');

} catch (error) {
  console.error('Error viewing shop item:', error);
  showNotification('Failed to view Shop Item', 'error');
}
}

function closeShopItemModal() {
document.getElementById('shop-item-modal').classList.add('hidden');
}

async function initiateShopItemPurchase(itemId) {
if (!state.userProfile || !state.userProfile.profile_id) {
  showNotification('Please create a profile to purchase items.', 'info');
  return;
}

try {
  const { data: item, error } = await state.supabase
    .from('shop_items')
    .select(`
      *,
      owner:profiles(id, username, name, profile_picture),
      payment_methods:shop_item_payment_methods(id, method_name, account_info, qr_code_url, instructions)
    `)
    .eq('id', itemId)
    .single();

  if (error) throw error;

  state.selectedShopItemForPurchase = item;

  const paymentModalContent = document.getElementById('payment-modal-content');
  paymentModalContent.innerHTML = `
    <h3 class="text-xl font-semibold text-text-primary mb-2">${item.name}</h3>
    <p class="text-text-secondary mb-4">Price: <span class="text-accent-green font-bold">${item.price} MMK</span></p>
    <p class="text-text-secondary mb-4">Seller: <span class="font-semibold">${item.owner?.name || 'Unknown'} (@${item.owner?.username || 'unknown'})</span></p>
    
    <h4 class="text-lg font-semibold text-accent-purple mb-3">SELECT PAYMENT METHOD</h4>
    <div id="payment-methods-list" class="space-y-3 mb-4">
      ${item.payment_methods && item.payment_methods.length > 0 ? item.payment_methods.map(method => `
        <label class="flex items-center space-x-3 p-3 bg-secondary-bg rounded-lg cursor-pointer border border-border-color">
          <input type="radio" name="shop_item_payment_method" value="${method.id}" 
                 onchange="state.selectedPaymentMethod = '${method.id}'" class="w-4 h-4 text-accent-purple focus:ring-accent-purple">
          <div>
            <p class="font-semibold text-text-primary">${method.method_name}</p>
            <p class="text-text-secondary text-sm">${method.account_info || ''}</p>
            ${method.qr_code_url ? `<img src="${method.qr_code_url}" class="w-24 h-24 mt-2 rounded-md border border-border-color" alt="QR Code">` : ''}
            ${method.instructions ? `<p class="text-text-secondary text-xs mt-1">${method.instructions}</p>` : ''}
          </div>
        </label>
      `).join('') : '<p class="text-center text-text-secondary">No Payment Methods Available for this seller.</p>'}
    </div>

    <div class="space-y-3">
      <label class="block text-sm font-medium text-text-secondary">UPLOAD RECEIPT IMAGE</label>
      <input type="file" id="receipt-upload" accept="image/*" class="app-input w-full">
      <button onclick="submitShopItemPurchase()" class="myanmar-btn w-full">
        <i class="fas fa-paper-plane mr-2"></i>
        CONFIRM PURCHASE
      </button>
    </div>
    <p class="text-sm text-text-secondary mt-4">
      <i class="fas fa-info-circle mr-1"></i>
      After confirming payment, the seller will review and approve your purchase.
    </p>
  `;

  document.getElementById('payment-modal').classList.remove('hidden');

} catch (error) {
  console.error('Error initiating shop item purchase:', error);
  showNotification('Failed to initiate purchase', 'error');
}
}

async function submitShopItemPurchase() {
if (!state.selectedShopItemForPurchase || !state.selectedPaymentMethod) {
  showNotification('Please select an Item and Payment Method', 'warning');
  return;
}
const receiptFile = document.getElementById('receipt-upload').files[0];
if (!receiptFile) {
  showNotification('Please upload a receipt image', 'warning');
  return;
}

showNotification('Submitting purchase...', 'info');
showLoading(true);

try {
  // Upload receipt image
  const fileExt = receiptFile.name.split('.').pop();
  const fileName = `user_receipts/${state.userProfile.profile_id}_${state.selectedShopItemForPurchase.id}_${Date.now()}.${fileExt}`;
  
  const { data: uploadData, error: uploadError } = await state.supabase.storage
    .from('user_shop_orders')
    .upload(fileName, receiptFile);
    
  if (uploadError) throw uploadError;
  
  const { data: urlData } = state.supabase.storage
    .from('user_shop_orders')
    .getPublicUrl(fileName);
    
  const receiptUrl = urlData.publicUrl;

  // Create user_shop_order
  const { error: orderError } = await state.supabase
    .from('user_shop_orders')
    .insert({
      buyer_profile_id: state.userProfile.profile_id,
      owner_profile_id: state.selectedShopItemForPurchase.owner_profile_id,
      shop_item_id: state.selectedShopItemForPurchase.id,
      payment_method_id: state.selectedPaymentMethod,
      amount: state.selectedShopItemForPurchase.price,
      receipt_url: receiptUrl,
      status: 'pending' // Seller needs to approve this
    });

  if (orderError) throw orderError;

  showNotification('Purchase submitted successfully! Seller will review it.', 'success');
  closePaymentModal();
  loadShopItems(); // Reload shop items
  loadUserPurchases(); // Reload user's purchase history
} catch (error) {
  console.error('Error submitting shop item purchase:', error);
  showNotification('Failed to submit purchase', 'error');
} finally {
  showLoading(false);
}
}

async function postShopItem() {
if (!state.userProfile || !state.userProfile.profile_id) {
  showNotification('Please create a profile to post shop items.', 'info');
  return;
}

const itemName = document.getElementById('shop-item-name').value.trim();
const itemPrice = parseFloat(document.getElementById('shop-item-price').value);
const itemDescription = document.getElementById('shop-item-description').value.trim();
const itemImages = document.getElementById('shop-item-images').files;
const socialLink = document.getElementById('shop-item-social-link').value.trim();
const socialName = document.getElementById('shop-item-social-name').value.trim();
const paymentMethodsContainer = document.getElementById('shop-item-payment-methods-container');
const paymentMethodInputs = paymentMethodsContainer.querySelectorAll('.payment-method-input');

if (!itemName || isNaN(itemPrice) || itemPrice <= 0 || !itemDescription || itemImages.length === 0) {
  showNotification('Please fill all required fields and upload at least one image.', 'warning');
  return;
}

const paymentMethods = [];
paymentMethodInputs.forEach(inputDiv => {
  const nameInput = inputDiv.querySelector('input[placeholder="Payment Name"]');
  const accountInput = inputDiv.querySelector('input[placeholder="Account Info"]');
  if (nameInput && accountInput && nameInput.value.trim() && accountInput.value.trim()) {
    paymentMethods.push({
      method_name: nameInput.value.trim(),
      account_info: accountInput.value.trim()
    });
  }
});

if (paymentMethods.length === 0) {
  showNotification('Please add at least one payment method.', 'warning');
  return;
}

showLoading(true);
try {
  let imageUrls = [];
  for (let i = 0; i < itemImages.length; i++) {
    const file = itemImages[i];
    const fileExt = file.name.split('.').pop();
    const fileName = `shop_items/${state.userProfile.profile_id}_${Date.now()}_${i}.${fileExt}`;
    const { data: uploadData, error: uploadError } = await state.supabase.storage
      .from('shop_items')
      .upload(fileName, file);
    if (uploadError) throw uploadError;
    const { data: urlData } = state.supabase.storage.from('shop_items').getPublicUrl(fileName);
    imageUrls.push({ url: urlData.publicUrl, type: file.type });
  }

  const { data: shopItem, error: itemError } = await state.supabase
    .from('shop_items')
    .insert({
      owner_profile_id: state.userProfile.profile_id,
      name: itemName,
      price: itemPrice,
      description: itemDescription,
      image_urls: imageUrls,
      contact_social_link: socialLink || null,
      contact_social_name: socialName || null,
      is_active: true
    })
    .select()
    .single();

  if (itemError) throw itemError;

  // Insert payment methods for this shop item
  const shopItemPaymentMethods = paymentMethods.map(method => ({
    shop_item_id: shopItem.id,
    method_name: method.method_name,
    account_info: method.account_info
  }));

  const { error: paymentMethodError } = await state.supabase
    .from('shop_item_payment_methods')
    .insert(shopItemPaymentMethods);

  if (paymentMethodError) throw paymentMethodError;

  showNotification('Shop item uploaded successfully!', 'success');
  document.getElementById('shop-item-name').value = '';
  document.getElementById('shop-item-price').value = '';
  document.getElementById('shop-item-description').value = '';
  document.getElementById('shop-item-images').value = '';
  document.getElementById('shop-item-social-link').value = '';
  document.getElementById('shop-item-social-name').value = '';
  paymentMethodsContainer.innerHTML = ''; // Clear payment methods
  loadMyShopItems(); // Reload user's shop items
  loadShopItems(); // Reload global shop feed
} catch (error) {
  console.error('Error posting shop item:', error);
  showNotification('Failed to upload shop item', 'error');
} finally {
  showLoading(false);
}
}

function addShopItemPaymentMethod(methodName = '', accountInfo = '') {
const container = document.getElementById('shop-item-payment-methods-container');
const newMethodDiv = document.createElement('div');
newMethodDiv.className = 'flex space-x-2 payment-method-input';
newMethodDiv.innerHTML = `
  <input type="text" placeholder="Payment Name" value="${methodName}" class="app-input flex-1">
  <input type="text" placeholder="Account Info" value="${accountInfo}" class="app-input flex-1">
  <button onclick="this.parentElement.remove()" class="btn-danger myanmar-btn btn-small">
    <i class="fas fa-minus"></i>
  </button>
`;
container.appendChild(newMethodDiv);
}

async function loadMyShopItems() {
if (!state.userProfile || !state.userProfile.profile_id) {
  document.getElementById('my-shop-items-list').innerHTML = `
    <div class="text-center text-text-secondary py-8">
      <i class="fas fa-store text-4xl mb-4"></i>
      <p>Please create a profile to view your shop items.</p>
    </div>
  `;
  return;
}

const myShopItemsList = document.getElementById('my-shop-items-list');
myShopItemsList.innerHTML = `
  <div class="loading-spinner mx-auto mb-4"></div>
  <p class="text-center text-text-secondary">Loading your shop items...</p>
`;

try {
  const { data, error } = await state.supabase
    .from('shop_items')
    .select('*')
    .eq('owner_profile_id', state.userProfile.profile_id)
    .order('created_at', { ascending: false });

  if (error) throw error;

  if (data && data.length > 0) {
    myShopItemsList.innerHTML = data.map(item => `
      <div class="news-card p-4 flex justify-between items-center">
        <div class="flex items-center space-x-3">
          <img src="${item.image_urls && item.image_urls.length > 0 ? item.image_urls[0].url : '/placeholder.svg?height=40&width=40'}" 
               alt="${item.name}" class="w-12 h-12 object-cover rounded-md">
          <div>
            <h4 class="text-lg font-semibold text-accent-purple">${item.name}</h4>
            <p class="text-sm text-text-secondary">${item.price} MMK</p>
          </div>
        </div>
        <div class="flex space-x-2">
          <button onclick="viewShopItem('${item.id}')" class="myanmar-btn btn-small">
            <i class="fas fa-eye"></i>
          </button>
          <button onclick="confirmDeleteShopItem('${item.id}')" class="btn-danger myanmar-btn btn-small">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      </div>
    `).join('');
  } else {
    myShopItemsList.innerHTML = `
      <div class="text-center text-text-secondary py-8">
        <i class="fas fa-store text-4xl mb-4"></i>
        <p>You haven't posted any shop items yet.</p>
      </div>
    `;
  }
} catch (error) {
  console.error('Error loading my shop items:', error);
  myShopItemsList.innerHTML = `
    <div class="text-center text-accent-red py-8">
      <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
      <p>Failed to retrieve your shop items.</p>
    </div>
  `;
}
}

function confirmDeleteShopItem(itemId) {
state.confirmCallback = async () => {
  showLoading(true);
  try {
    const { error } = await state.supabase
      .from('shop_items')
      .delete()
      .eq('id', itemId);
    if (error) throw error;
    showNotification('Shop item deleted successfully!', 'success');
    loadMyShopItems();
    loadShopItems();
  } catch (error) {
    console.error('Error deleting shop item:', error);
    showNotification('Failed to delete shop item', 'error');
  } finally {
    showLoading(false);
    closeConfirmModal();
  }
};
document.getElementById('confirm-message').textContent = 'Are you sure you want to delete this shop item? This action cannot be undone.';
document.getElementById('confirm-modal').classList.remove('hidden');
}

async function loadMySalesOrders() {
if (!state.userProfile || !state.userProfile.profile_id) {
  document.getElementById('my-sales-orders-table-body').innerHTML = `
    <tr>
      <td colspan="6" class="text-center text-text-secondary py-8">
        <i class="fas fa-receipt text-4xl mb-4"></i>
        <p>Please create a profile to view your sales orders.</p>
      </td>
    </tr>
  `;
  return;
}

const tableBody = document.getElementById('my-sales-orders-table-body');
tableBody.innerHTML = `
  <tr>
    <td colspan="6" class="text-center text-text-secondary py-8">
      <div class="loading-spinner mx-auto mb-2"></div>
      Loading your sales orders...
    </td>
  </tr>
`;

try {
  const { data: orders, error } = await state.supabase
    .from('user_shop_orders')
    .select(`
      *,
      buyer:profiles(username, name),
      shop_item:shop_items(name)
    `)
    .eq('owner_profile_id', state.userProfile.profile_id)
    .order('created_at', { ascending: false });

  if (error) throw error;

  if (orders && orders.length > 0) {
    tableBody.innerHTML = orders.map(order => `
      <tr>
        <td>${order.buyer?.name || 'N/A'} (@${order.buyer?.username || 'N/A'})</td>
        <td>${order.shop_item?.name || 'N/A'}</td>
        <td>${order.amount} MMK</td>
        <td>
          <span class="font-semibold ${order.status === 'approved' ? 'text-accent-green' : order.status === 'pending' ? 'text-yellow-500' : 'text-accent-red'}">
            ${order.status.toUpperCase()}
          </span>
        </td>
        <td>${new Date(order.created_at).toLocaleDateString('en-US')}</td>
        <td class="table-actions">
          ${order.receipt_url ? `
            <button onclick="viewReceipt('${order.receipt_url}')" class="myanmar-btn btn-small">
              <i class="fas fa-receipt"></i>
            </button>
          ` : ''}
          ${order.status === 'pending' ? `
            <button onclick="approveShopOrder('${order.id}')" class="myanmar-btn btn-small">
              <i class="fas fa-check"></i>
            </button>
            <button onclick="rejectShopOrder('${order.id}')" class="btn-danger myanmar-btn btn-small">
              <i class="fas fa-times"></i>
            </button>
          ` : ''}
        </td>
      </tr>
    `).join('');
  } else {
    tableBody.innerHTML = `
      <tr>
        <td colspan="6" class="text-center text-text-secondary py-8">
          <i class="fas fa-receipt text-4xl mb-4"></i>
          <p>No sales orders yet.</p>
        </td>
      </tr>
    `;
  }
} catch (error) {
  console.error('Error loading sales orders:', error);
  tableBody.innerHTML = `
    <tr>
      <td colspan="6" class="text-center text-accent-red py-8">
        <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
        <p>Failed to retrieve your sales orders.</p>
      </td>
    </tr>
  `;
}
}

async function approveShopOrder(orderId) {
showLoading(true);
try {
  const { error } = await state.supabase
    .from('user_shop_orders')
    .update({ status: 'approved' })
    .eq('id', orderId)
    .eq('owner_profile_id', state.userProfile.profile_id); // Ensure only owner can approve

  if (error) throw error;
  showNotification('Order approved successfully!', 'success');
  loadMySalesOrders();
} catch (error) {
  console.error('Error approving order:', error);
  showNotification('Failed to approve order', 'error');
} finally {
  showLoading(false);
}
}

async function rejectShopOrder(orderId) {
showLoading(true);
try {
  const { error } = await state.supabase
    .from('user_shop_orders')
    .update({ status: 'rejected' })
    .eq('id', orderId)
    .eq('owner_profile_id', state.userProfile.profile_id); // Ensure only owner can reject

  if (error) throw error;
  showNotification('Order rejected successfully!', 'success');
  loadMySalesOrders();
} catch (error) {
  console.error('Error rejecting order:', error);
  showNotification('Failed to reject order', 'error');
} finally {
  showLoading(false);
}
}

async function loadUserPurchases() {
if (!state.userProfile || !state.userProfile.profile_id) {
  document.getElementById('my-purchase-history-table-body').innerHTML = `
    <tr>
      <td colspan="6" class="text-center text-text-secondary py-8">
        <i class="fas fa-history text-4xl mb-4"></i>
        <p>Please create a profile to view your purchase history.</p>
      </td>
    </tr>
  `;
  return;
}

const tableBody = document.getElementById('my-purchase-history-table-body');
tableBody.innerHTML = `
  <tr>
    <td colspan="6" class="text-center text-text-secondary py-8">
      <div class="loading-spinner mx-auto mb-2"></div>
      Loading your purchase history...
    </td>
  </tr>
`;

try {
  // Fetch purchases of admin-posted products
  const { data: adminProductOrders, error: adminError } = await state.supabase
    .from('orders')
    .select(`
      *,
      product:products(name, file_url),
      payment_method:payment_methods(method_name)
    `)
    .eq('profile_id', state.userProfile.profile_id)
    .order('created_at', { ascending: false });

  if (adminError) throw adminError;

  // Fetch purchases of user-posted shop items
  const { data: userShopOrders, error: userShopError } = await state.supabase
    .from('user_shop_orders')
    .select(`
      *,
      shop_item:shop_items(name),
      seller:profiles(username, name)
    `)
    .eq('buyer_profile_id', state.userProfile.profile_id)
    .order('created_at', { ascending: false });

  if (userShopError) throw userShopError;

  let allPurchases = [];

  // Format admin product orders
  if (adminProductOrders) {
    allPurchases = allPurchases.concat(adminProductOrders.map(order => ({
      type: 'product',
      id: order.id,
      itemName: order.product?.name || 'N/A',
      sellerName: 'Admin', // Admin is the seller for these
      sellerUsername: 'admin',
      amount: order.amount,
      status: order.status,
      createdAt: order.created_at,
      receiptUrl: order.receipt_url,
      downloadUrl: order.product?.file_url || null,
      isApproved: order.status === 'approved'
    })));
  }

  // Format user shop item orders
  if (userShopOrders) {
    allPurchases = allPurchases.concat(userShopOrders.map(order => ({
      type: 'shop_item',
      id: order.id,
      itemName: order.shop_item?.name || 'N/A',
      sellerName: order.seller?.name || 'N/A',
      sellerUsername: order.seller?.username || 'N/A',
      amount: order.amount,
      status: order.status,
      createdAt: order.created_at,
      receiptUrl: order.receipt_url,
      downloadUrl: null, // User-posted items don't have direct download URLs here
      isApproved: order.status === 'approved'
    })));
  }

  // Sort all purchases by creation date
  allPurchases.sort((a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime());

  if (allPurchases.length > 0) {
    tableBody.innerHTML = allPurchases.map(purchase => `
      <tr>
        <td>${purchase.itemName}</td>
        <td>${purchase.sellerName} (@${purchase.sellerUsername})</td>
        <td>${purchase.amount} MMK</td>
        <td>
          <span class="font-semibold ${purchase.status === 'approved' ? 'text-accent-green' : purchase.status === 'pending' ? 'text-yellow-500' : 'text-accent-red'}">
            ${purchase.status.toUpperCase()}
          </span>
        </td>
        <td>${new Date(purchase.createdAt).toLocaleDateString('en-US')}</td>
        <td class="table-actions">
          ${purchase.receiptUrl ? `
            <button onclick="viewReceipt('${purchase.receiptUrl}')" class="myanmar-btn btn-small">
              <i class="fas fa-receipt"></i>
            </button>
          ` : ''}
          ${purchase.isApproved && purchase.downloadUrl ? `
            <a href="${purchase.downloadUrl}" target="_blank" download class="myanmar-btn btn-small">
              <i class="fas fa-download"></i>
            </a>
          ` : ''}
        </td>
      </tr>
    `).join('');
  } else {
    tableBody.innerHTML = `
      <tr>
        <td colspan="6" class="text-center text-text-secondary py-8">
          <i class="fas fa-history text-4xl mb-4"></i>
          <p>No purchase history yet.</p>
        </td>
      </tr>
    `;
  }
} catch (error) {
  console.error('Error loading user purchases:', error);
  tableBody.innerHTML = `
    <tr>
      <td colspan="6" class="text-center text-accent-red py-8">
        <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
        <p>Failed to retrieve your purchase history.</p>
      </td>
    </tr>
  `;
}
}

function viewReceipt(receiptUrl) {
document.getElementById('receipt-image').src = receiptUrl;
document.getElementById('receipt-view-modal').classList.remove('hidden');
}

function closeReceiptViewModal() {
document.getElementById('receipt-view-modal').classList.add('hidden');
document.getElementById('receipt-image').src = '/placeholder.svg'; // Reset image
}

function userLogout() {
localStorage.removeItem('user_key');
state.isAuthenticated = false;
state.userProfile = null;
state.selectedChatProfileId = null; // Clear selected chat
// Unsubscribe from all realtime channels
if (state.newsRealtime) state.supabase.removeChannel(state.newsRealtime);
if (state.chatRealtime) state.supabase.removeChannel(state.chatRealtime);
if (state.supportRealtime) state.supabase.removeChannel(state.supportRealtime);
if (state.productsRealtime) state.supabase.removeChannel(state.productsRealtime);
if (state.ordersRealtime) state.supabase.removeChannel(state.ordersRealtime);
if (state.userShopOrdersRealtime) state.supabase.removeChannel(state.userShopOrdersRealtime);
if (state.userPurchasesRealtime) state.supabase.removeChannel(state.userPurchasesRealtime);

document.getElementById('app-content').classList.add('hidden');
document.getElementById('profile-creation-section').classList.add('hidden');
document.getElementById('login-section').classList.remove('hidden');
document.getElementById('login-key').value = '';
showNotification('Logged out successfully!', 'info');
}

function showLoading(show) {
document.getElementById('loading-overlay').classList.toggle('hidden', !show);
}

function confirmAction() {
if (state.confirmCallback) {
  state.confirmCallback();
}
}

function closeConfirmModal() {
document.getElementById('confirm-modal').classList.add('hidden');
state.confirmCallback = null;
}

// Initial section load (after login or profile creation)
// This will be called by userLogin or createProfile
// showSection('home', document.querySelector('.nav-btn.active'));
</script>
</body>
</html>
