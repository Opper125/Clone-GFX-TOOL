<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gaming Shop - Myanmar</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            font-family: 'Inter', 'Poppins', sans-serif;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .glass-morphism {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .animate-fade-in {
            animation: fadeIn 0.6s ease-in-out;
        }
        
        .animate-slide-up {
            animation: slideUp 0.8s ease-out;
        }
        
        .animate-pulse-custom {
            animation: pulseCustom 2s infinite;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes pulseCustom {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .neon-glow {
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.6);
            transition: all 0.3s ease;
        }
        
        .neon-glow:hover {
            box-shadow: 0 0 30px rgba(102, 126, 234, 0.8);
            transform: translateY(-2px);
        }
        
        .product-card {
            transition: all 0.3s ease;
            overflow: hidden;
        }
        
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease-out;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-in-out;
        }
        
        .btn-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
        }
        
        .btn-gradient:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            transform: translateY(-2px);
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 10px;
            color: white;
            z-index: 1001;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        
        .notification.success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        .notification.error {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        
        .face-scan-circle {
            width: 200px;
            height: 200px;
            border: 3px solid #667eea;
            border-radius: 50%;
            position: relative;
            animation: scanPulse 2s infinite;
        }
        
        @keyframes scanPulse {
            0% { box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(102, 126, 234, 0); }
            100% { box-shadow: 0 0 0 0 rgba(102, 126, 234, 0); }
        }
        
        .file-upload-area {
            border: 2px dashed #667eea;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .file-upload-area:hover {
            border-color: #764ba2;
            background-color: rgba(102, 126, 234, 0.05);
        }
        
        .file-upload-area.dragover {
            border-color: #764ba2;
            background-color: rgba(102, 126, 234, 0.1);
        }
        
        .preview-image {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 8px;
            position: relative;
        }
        
        .delete-btn {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
        }
        
        .navbar-blur {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.9);
        }
        
        @media (max-width: 768px) {
            .modal-content {
                width: 95%;
                margin: 10% auto;
            }
            
            .face-scan-circle {
                width: 150px;
                height: 150px;
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Loading Screen -->
    <div id="loadingScreen" class="fixed inset-0 bg-gradient-to-br from-purple-600 to-blue-600 flex items-center justify-center z-50">
        <div class="text-center text-white">
            <div class="loading-spinner mx-auto mb-4"></div>
            <h2 class="text-2xl font-bold animate-pulse-custom">Gaming Shop Loading...</h2>
            <p class="mt-2 opacity-80">Please wait...</p>
        </div>
    </div>

    <!-- Auth Container -->
    <div id="authContainer" class="min-h-screen gradient-bg flex items-center justify-center p-4" style="display: none;">
        <div class="glass-morphism rounded-2xl p-8 w-full max-w-md animate-slide-up">
            <div class="text-center mb-8">
                <div id="websiteLogo" class="mb-4">
                    <i class="fas fa-gamepad text-6xl text-white"></i>
                </div>
                <h1 class="text-3xl font-bold text-white mb-2">Gaming Shop</h1>
                <p class="text-white opacity-80">Myanmar Gaming Marketplace</p>
            </div>

            <!-- Login Form -->
            <div id="loginForm" class="space-y-6">
                <h2 class="text-2xl font-bold text-white text-center mb-6">လော့ဂ်အင်</h2>
                <div>
                    <input type="email" id="loginEmail" placeholder="Gmail လိပ်စာ" class="w-full px-4 py-3 rounded-lg border-0 focus:ring-2 focus:ring-white focus:outline-none">
                </div>
                <div>
                    <input type="password" id="loginPassword" placeholder="Password" class="w-full px-4 py-3 rounded-lg border-0 focus:ring-2 focus:ring-white focus:outline-none">
                </div>
                <button onclick="login()" class="w-full btn-gradient text-white py-3 px-6 rounded-lg font-semibold neon-glow">
                    <i class="fas fa-sign-in-alt mr-2"></i>လော့ဂ်အင်
                </button>
                <p class="text-center text-white">
                    အကောင့်မရှိဘူးလား? 
                    <button onclick="showSignup()" class="underline hover:text-yellow-300">စာရင်းသွင်းပါ</button>
                </p>
            </div>

            <!-- Signup Form -->
            <div id="signupForm" class="space-y-6" style="display: none;">
                <h2 class="text-2xl font-bold text-white text-center mb-6">စာရင်းသွင်းခင်း</h2>
                <div>
                    <input type="text" id="signupName" placeholder="နာမည်" class="w-full px-4 py-3 rounded-lg border-0 focus:ring-2 focus:ring-white focus:outline-none">
                </div>
                <div>
                    <input type="email" id="signupEmail" placeholder="Gmail လိပ်စာ" class="w-full px-4 py-3 rounded-lg border-0 focus:ring-2 focus:ring-white focus:outline-none">
                </div>
                <div>
                    <input type="text" id="signupUsername" placeholder="Username" class="w-full px-4 py-3 rounded-lg border-0 focus:ring-2 focus:ring-white focus:outline-none">
                </div>
                <div>
                    <input type="password" id="signupPassword" placeholder="Password" class="w-full px-4 py-3 rounded-lg border-0 focus:ring-2 focus:ring-white focus:outline-none">
                </div>
                <button onclick="signup()" class="w-full btn-gradient text-white py-3 px-6 rounded-lg font-semibold neon-glow">
                    <i class="fas fa-user-plus mr-2"></i>စာရင်းသွင်းပါ
                </button>
                <p class="text-center text-white">
                    အကောင့်ရှိပြီးသားလား? 
                    <button onclick="showLogin()" class="underline hover:text-yellow-300">လော့ဂ်အင်ဝင်ပါ</button>
                </p>
            </div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboard" class="min-h-screen bg-gray-50" style="display: none;">
        <!-- Header -->
        <header class="navbar-blur sticky top-0 z-40 border-b border-gray-200">
            <div class="container mx-auto px-4 py-3">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <div id="dashboardLogo" class="text-3xl">
                            <i class="fas fa-gamepad text-purple-600"></i>
                        </div>
                        <div>
                            <h1 class="text-xl font-bold text-gray-800">Gaming Shop</h1>
                            <p class="text-sm text-gray-600">Myanmar Gaming Marketplace</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="relative">
                            <img id="userAvatar" src="https://via.placeholder.com/40" alt="User" class="w-10 h-10 rounded-full cursor-pointer border-2 border-purple-300" onclick="toggleUserMenu()">
                            <div id="userMenu" class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border hidden">
                                <div class="p-3 border-b">
                                    <p class="font-semibold text-gray-800" id="userDisplayName">User Name</p>
                                    <p class="text-sm text-gray-600" id="userDisplayEmail">user@email.com</p>
                                </div>
                                <button onclick="logout()" class="w-full text-left px-4 py-2 hover:bg-gray-100 text-red-600">
                                    <i class="fas fa-sign-out-alt mr-2"></i>လော့ဂ်အောက်
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="bg-white border-b border-gray-200 sticky top-16 z-30">
            <div class="container mx-auto px-4">
                <div class="flex space-x-1 overflow-x-auto">
                    <button onclick="showTab('home')" class="tab-btn px-6 py-3 font-medium text-purple-600 border-b-2 border-purple-600 whitespace-nowrap">
                        <i class="fas fa-home mr-2"></i>HOME
                    </button>
                    <button onclick="showTab('history')" class="tab-btn px-6 py-3 font-medium text-gray-600 hover:text-purple-600 whitespace-nowrap">
                        <i class="fas fa-history mr-2"></i>History
                    </button>
                    <button onclick="showTab('news')" class="tab-btn px-6 py-3 font-medium text-gray-600 hover:text-purple-600 whitespace-nowrap">
                        <i class="fas fa-newspaper mr-2"></i>News
                    </button>
                    <button onclick="showTab('profile')" class="tab-btn px-6 py-3 font-medium text-gray-600 hover:text-purple-600 whitespace-nowrap">
                        <i class="fas fa-user mr-2"></i>Profile
                    </button>
                    <button id="sellerTab" onclick="showTab('seller')" class="tab-btn px-6 py-3 font-medium text-gray-600 hover:text-purple-600 whitespace-nowrap" style="display: none;">
                        <i class="fas fa-store mr-2"></i>Seller
                    </button>
                </div>
            </div>
        </nav>

        <!-- Content Area -->
        <main class="container mx-auto px-4 py-6">
            <!-- Home Tab -->
            <div id="homeTab" class="tab-content active">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6" id="productsGrid">
                    <!-- Products will be loaded here -->
                </div>
            </div>

            <!-- History Tab -->
            <div id="historyTab" class="tab-content">
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <h2 class="text-2xl font-bold mb-6">မှာယူမှု မှတ်တမ်း</h2>
                    <div id="orderHistory" class="space-y-4">
                        <!-- Order history will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- News Tab -->
            <div id="newsTab" class="tab-content">
                <div class="space-y-6" id="newsContainer">
                    <!-- News will be loaded here -->
                </div>
            </div>

            <!-- Profile Tab -->
            <div id="profileTab" class="tab-content">
                <div class="max-w-2xl mx-auto space-y-6">
                    <!-- Profile Info -->
                    <div class="bg-white rounded-lg shadow-sm p-6">
                        <h2 class="text-2xl font-bold mb-6">ပရိုဖိုင် အချက်အလက်</h2>
                        <div class="flex items-center space-x-6 mb-6">
                            <div class="relative">
                                <img id="profileImage" src="https://via.placeholder.com/100" alt="Profile" class="w-24 h-24 rounded-full border-4 border-purple-300">
                                <button onclick="changeProfileImage()" class="absolute bottom-0 right-0 bg-purple-600 text-white rounded-full w-8 h-8 flex items-center justify-center">
                                    <i class="fas fa-camera text-sm"></i>
                                </button>
                            </div>
                            <div>
                                <h3 class="text-xl font-semibold" id="profileName">User Name</h3>
                                <p class="text-gray-600" id="profileEmail">user@email.com</p>
                                <p class="text-sm text-gray-500">@<span id="profileUsername">username</span></p>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">နာမည်</label>
                                <input type="text" id="editName" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                                <input type="text" id="editUsername" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Gmail</label>
                                <input type="email" id="editEmail" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Password အသစ်</label>
                                <input type="password" id="editPassword" placeholder="အသစ်ပြောင်းချင်ရင်ထည့်ပါ" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none">
                            </div>
                        </div>
                        
                        <button onclick="updateProfile()" class="mt-6 btn-gradient text-white px-6 py-2 rounded-lg font-semibold">
                            <i class="fas fa-save mr-2"></i>သိမ်းဆည်းမည်
                        </button>
                    </div>

                    <!-- KYC Section -->
                    <div class="bg-white rounded-lg shadow-sm p-6">
                        <h2 class="text-2xl font-bold mb-6">KYC အတည်ပြုခြင်း</h2>
                        <div id="kycStatus">
                            <!-- KYC status will be loaded here -->
                        </div>
                    </div>

                    <!-- About Section -->
                    <div class="bg-white rounded-lg shadow-sm p-6">
                        <h2 class="text-2xl font-bold mb-6">About</h2>
                        <div id="aboutSection">
                            <!-- About links will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Seller Tab -->
            <div id="sellerTab" class="tab-content">
                <div class="space-y-6">
                    <!-- Seller Dashboard Navigation -->
                    <div class="bg-white rounded-lg shadow-sm p-6">
                        <div class="flex flex-wrap gap-4">
                            <button onclick="showSellerSection('products')" class="seller-nav-btn bg-purple-600 text-white px-4 py-2 rounded-lg font-medium">
                                <i class="fas fa-box mr-2"></i>ကျွန်ုပ်၏ Products
                            </button>
                            <button onclick="showSellerSection('add-product')" class="seller-nav-btn bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-medium">
                                <i class="fas fa-plus mr-2"></i>Product ထည့်ရန်
                            </button>
                            <button onclick="showSellerSection('payments')" class="seller-nav-btn bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-medium">
                                <i class="fas fa-credit-card mr-2"></i>Payment နည်းလမ်း
                            </button>
                            <button onclick="showSellerSection('orders')" class="seller-nav-btn bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-medium">
                                <i class="fas fa-shopping-cart mr-2"></i>Orders
                            </button>
                        </div>
                    </div>

                    <!-- Seller Content Sections -->
                    <div id="sellerProducts" class="seller-section">
                        <div class="bg-white rounded-lg shadow-sm p-6">
                            <h3 class="text-xl font-bold mb-4">ကျွန်ုပ်၏ Products</h3>
                            <div id="myProductsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                <!-- My products will be loaded here -->
                            </div>
                        </div>
                    </div>

                    <div id="sellerAddProduct" class="seller-section" style="display: none;">
                        <div class="bg-white rounded-lg shadow-sm p-6">
                            <h3 class="text-xl font-bold mb-4">Product အသစ်ထည့်ရန်</h3>
                            <form id="addProductForm" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Product နာမည်</label>
                                    <input type="text" id="productName" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">ဖော်ပြချက်</label>
                                    <textarea id="productDescription" rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none" required></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">စျေးနှုန်း (MMK)</label>
                                    <input type="number" id="productPrice" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Game အမျိုးအစား</label>
                                    <input type="text" id="productGame" placeholder="eg. PUBG Mobile" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Login Social Platform</label>
                                    <select id="productSocial" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none" required>
                                        <option value="">ရွေးချယ်ပါ</option>
                                        <option value="Google">Google</option>
                                        <option value="Facebook">Facebook</option>
                                        <option value="X">X (Twitter)</option>
                                        <option value="iCloud">iCloud</option>
                                        <option value="QR Login">QR Login</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Contact Social Name</label>
                                    <input type="text" id="contactSocialName" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Contact Link/လိပ်စာ</label>
                                    <input type="text" id="contactSocialLink" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Account ဓာတ်ပုံများ</label>
                                    <div class="file-upload-area" onclick="document.getElementById('productFiles').click()">
                                        <i class="fas fa-cloud-upload-alt text-4xl text-purple-500 mb-2"></i>
                                        <p class="text-gray-600">ဓာတ်ပုံ/ဗီဒီယို တင်ရန် နှိပ်ပါ</p>
                                        <input type="file" id="productFiles" multiple accept="image/*,video/*" style="display: none;" onchange="handleProductFiles(this.files)">
                                    </div>
                                    <div id="productFilePreview" class="mt-4 grid grid-cols-4 gap-2"></div>
                                </div>
                                <button type="submit" class="w-full btn-gradient text-white py-3 px-6 rounded-lg font-semibold">
                                    <i class="fas fa-plus mr-2"></i>Product ထည့်မည်
                                </button>
                            </form>
                        </div>
                    </div>

                    <div id="sellerPayments" class="seller-section" style="display: none;">
                        <div class="bg-white rounded-lg shadow-sm p-6">
                            <h3 class="text-xl font-bold mb-4">Payment နည်းလမ်းများ</h3>
                            <div id="myPaymentsList" class="space-y-4 mb-6">
                                <!-- My payments will be loaded here -->
                            </div>
                            <button onclick="showAddPaymentModal()" class="btn-gradient text-white px-4 py-2 rounded-lg font-medium">
                                <i class="fas fa-plus mr-2"></i>Payment နည်းလမ်း ထည့်ရန်
                            </button>
                        </div>
                    </div>

                    <div id="sellerOrders" class="seller-section" style="display: none;">
                        <div class="bg-white rounded-lg shadow-sm p-6">
                            <h3 class="text-xl font-bold mb-4">Orders</h3>
                            <div id="myOrdersList" class="space-y-4">
                                <!-- My orders will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <!-- Product Detail Modal -->
    <div id="productModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Product အသေးစိတ်</h2>
                <button onclick="closeModal('productModal')" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="productDetailContent">
                <!-- Product details will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Buy Modal -->
    <div id="buyModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">ဝယ်ယူရန်</h2>
                <button onclick="closeModal('buyModal')" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="buyContent">
                <!-- Buy content will be loaded here -->
            </div>
        </div>
    </div>

    <!-- KYC Modal -->
    <div id="kycModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">KYC အတည်ပြုခြင်း</h2>
                <button onclick="closeModal('kycModal')" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form id="kycForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">အမည်အပြည့်အစုံ</label>
                    <input type="text" id="kycName" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">မွေးသက္ကရာဇ်</label>
                    <input type="date" id="kycBirthdate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ဖုန်းနံပါတ်</label>
                    <input type="tel" id="kycPhone" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">လိပ်စာ</label>
                    <textarea id="kycAddress" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none" required></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">အထောက်အထားအမျိုးအစား</label>
                    <select id="kycIdType" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none" required>
                        <option value="">ရွေးချယ်ပါ</option>
                        <option value="NRC">NRC</option>
                        <option value="Passport">Passport</option>
                        <option value="DriverLicense">လိုင်စင်</option>
                    </select>
                </div>
                <div id="nrcSection" style="display: none;">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">NRC မျက်နှာစာ</label>
                            <input type="file" id="nrcFront" accept="image/*" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">NRC ကျောစာ</label>
                            <input type="file" id="nrcBack" accept="image/*" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none">
                        </div>
                    </div>
                </div>
                <div class="text-center">
                    <button type="button" onclick="startFaceScan()" class="btn-gradient text-white px-6 py-2 rounded-lg font-semibold">
                        <i class="fas fa-camera mr-2"></i>မျက်နှာစကန်ဖတ်ရန်
                    </button>
                </div>
                <div id="faceScanSection" style="display: none;" class="text-center">
                    <div class="face-scan-circle mx-auto mb-4 flex items-center justify-center">
                        <video id="faceScanVideo" width="180" height="180" autoplay style="border-radius: 50%;"></video>
                    </div>
                    <div id="faceScanInstructions" class="space-y-2">
                        <p id="scanInstruction" class="font-semibold text-purple-600">ကင်မရာကို တည့်မတ်ကြည့်ပါ</p>
                        <div id="scanSteps" class="text-sm text-gray-600">
                            <p>မျက်လုံးမှိတ်ပါ ✓</p>
                            <p id="blinkStep">မျက်လုံးမှိတ်ဖွင့်ပါ</p>
                            <p id="leftStep">ဘယ်ဘက်လှည့်ပါ</p>
                            <p id="rightStep">ညာဘက်လှည့်ပါ</p>
                            <p id="mouthStep">ပါးစပ်ဖွင့်ပါ</p>
                        </div>
                    </div>
                </div>
                <button type="submit" id="submitKyc" class="w-full btn-gradient text-white py-3 px-6 rounded-lg font-semibold" disabled>
                    <i class="fas fa-check mr-2"></i>KYC တင်ပြမည်
                </button>
            </form>
        </div>
    </div>

    <!-- Add Payment Modal -->
    <div id="addPaymentModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Payment နည်းလမ်း ထည့်ရန်</h2>
                <button onclick="closeModal('addPaymentModal')" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form id="addPaymentForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Payment နာမည်</label>
                    <input type="text" id="paymentName" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ဖော်ပြချက်</label>
                    <textarea id="paymentDescription" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ဖုန်းနံပါတ်/လိပ်စာ</label>
                    <input type="text" id="paymentAddress" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Payment Icon</label>
                    <input type="file" id="paymentIcon" accept="image/*" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">QR Code</label>
                    <input type="file" id="paymentQr" accept="image/*" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none" required>
                </div>
                <button type="submit" class="w-full btn-gradient text-white py-3 px-6 rounded-lg font-semibold">
                    <i class="fas fa-plus mr-2"></i>Payment ထည့်မည်
                </button>
            </form>
        </div>
    </div>

    <!-- Profile Image Modal -->
    <div id="profileImageModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Profile ဓာတ်ပုံ ပြောင်းရန်</h2>
                <button onclick="closeModal('profileImageModal')" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="text-center">
                <input type="file" id="profileImageFile" accept="image/*,.gif" class="mb-4">
                <div id="profileImagePreview" class="mb-4"></div>
                <button onclick="uploadProfileImage()" class="btn-gradient text-white px-6 py-2 rounded-lg font-semibold">
                    <i class="fas fa-upload mr-2"></i>အပ်လုပ်ဒေါ့လုပ်ရန်
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        // Fixed Cloudinary Configuration
        const CLOUDINARY_CLOUD_NAME = 'opper';
        const CLOUDINARY_UPLOAD_PRESET = 'gaming_shop_preset'; // You need to create this in Cloudinary dashboard
        const CLOUDINARY_URL = 'cloudinary://589981285168918:jMHqgkHVBL5PvVSpzIc9-FJWg8w@opper';
        
        // Fixed Supabase Configuration
        const SUPABASE_URL = 'https://rmeudvhvqlddqqkiziyo.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJtZXVkdmh2cWxkZHFxa2l6aXlvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM5OTMxOTIsImV4cCI6MjA2OTU2OTE5Mn0.xFgMv-K5o5yyTpe4U2YJK5jC9GPJp98G4cgD9p5W4ak';
        
        // Fixed Supabase client creation
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let currentUser = null;
        let currentProductFiles = [];
        let faceScanData = null;
        let stream = null;

        // Initialize
        window.onload = async function() {
            setTimeout(() => {
                document.getElementById('loadingScreen').style.display = 'none';
                document.getElementById('authContainer').style.display = 'flex';
            }, 2000);
            
            await loadWebsiteLogo();
            await loadAboutData();
        };

        // Fixed Cloudinary Upload Function
        async function uploadToCloudinary(file) {
            try {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
                
                const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/auto/upload`, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error('Upload failed');
                }
                
                const data = await response.json();
                return data.secure_url;
            } catch (error) {
                console.error('Cloudinary upload error:', error);
                throw error;
            }
        }

        // Authentication Functions
        function showSignup() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('signupForm').style.display = 'block';
        }

        function showLogin() {
            document.getElementById('signupForm').style.display = 'none';
            document.getElementById('loginForm').style.display = 'block';
        }

        async function signup() {
            const name = document.getElementById('signupName').value;
            const email = document.getElementById('signupEmail').value; // Fixed: using email consistently
            const username = document.getElementById('signupUsername').value;
            const password = document.getElementById('signupPassword').value;

            if (!name || !email || !username || !password) {
                showNotification('ကွက်လပ်များကို ဖြည့်စွက်ပါ', 'error');
                return;
            }

            try {
                // Check if email or username already exists
                const { data: existingUsers } = await supabase
                    .from('users')
                    .select('*')
                    .or(`email.eq.${email},username.eq.${username}`);

                if (existingUsers && existingUsers.length > 0) {
                    showNotification('Gmail လိပ်စာ သို့မဟုတ် Username ရှိနှင့်ပြီးဖြစ်ပါတယ်', 'error');
                    return;
                }

                // Insert new user
                const { data, error } = await supabase
                    .from('users')
                    .insert([{
                        name: name,
                        email: email, // Fixed: using email consistently
                        username: username,
                        password: password,
                        profile_image: 'https://via.placeholder.com/100',
                        created_at: new Date().toISOString()
                    }])
                    .select();

                if (error) throw error;

                showNotification('အကောင့်ဖွင့်ခြင်း အောင်မြင်ပါတယ်', 'success');
                showLogin();
            } catch (error) {
                console.error('Signup error:', error);
                showNotification('အကောင့်ဖွင့်ခြင်း မအောင်မြင်ပါ', 'error');
            }
        }

        async function login() {
            const email = document.getElementById('loginEmail').value; // Fixed: using email consistently
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                showNotification('Gmail နဲ့ Password ကို ဖြည့်စွက်ပါ', 'error');
                return;
            }

            try {
                const { data: users, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('email', email) // Fixed: using email consistently
                    .eq('password', password);

                if (error) throw error;

                if (users && users.length > 0) {
                    currentUser = users[0];
                    await loadDashboard();
                    showNotification('လော့ဂ်အင် အောင်မြင်ပါတယ်', 'success');
                } else {
                    showNotification('Gmail သို့မဟုတ် Password မှားယွင်းနေပါတယ်', 'error');
                }
            } catch (error) {
                console.error('Login error:', error);
                showNotification('လော့ဂ်အင် မအောင်မြင်ပါ', 'error');
            }
        }

        async function loadDashboard() {
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            
            // Update user info
            document.getElementById('userDisplayName').textContent = currentUser.name;
            document.getElementById('userDisplayEmail').textContent = currentUser.email; // Fixed: using email consistently
            document.getElementById('userAvatar').src = currentUser.profile_image || 'https://via.placeholder.com/40';
            
            // Load profile data
            document.getElementById('profileName').textContent = currentUser.name;
            document.getElementById('profileEmail').textContent = currentUser.email; // Fixed: using email consistently
            document.getElementById('profileUsername').textContent = currentUser.username;
            document.getElementById('profileImage').src = currentUser.profile_image || 'https://via.placeholder.com/100';
            
            document.getElementById('editName').value = currentUser.name;
            document.getElementById('editEmail').value = currentUser.email; // Fixed: using email consistently
            document.getElementById('editUsername').value = currentUser.username;
            
            await loadProducts();
            await loadNews();
            await loadOrderHistory();
            await loadKYCStatus();
            await checkSellerStatus();
        }

        function logout() {
            currentUser = null;
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('authContainer').style.display = 'flex';
            showLogin();
            showNotification('လော့ဂ်အောက် အောင်မြင်ပါတယ်', 'success');
        }

        // Tab Functions
        function showTab(tabName) {
            // Hide all tabs
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // Update tab buttons
            const tabBtns = document.querySelectorAll('.tab-btn');
            tabBtns.forEach(btn => {
                btn.classList.remove('text-purple-600', 'border-b-2', 'border-purple-600');
                btn.classList.add('text-gray-600');
            });
            
            // Find the clicked button and update its style
            const clickedBtn = event ? event.target : document.querySelector(`[onclick="showTab('${tabName}')"]`);
            if (clickedBtn) {
                clickedBtn.classList.remove('text-gray-600');
                clickedBtn.classList.add('text-purple-600', 'border-b-2', 'border-purple-600');
            }
        }

        // Product Functions
        async function loadProducts() {
            try {
                const { data: products, error } = await supabase
                    .from('products')
                    .select(`
                        *,
                        users!products_seller_id_fkey (name, username, profile_image)
                    `)
                    .eq('status', 'active');

                if (error) throw error;

                const grid = document.getElementById('productsGrid');
                grid.innerHTML = '';

                if (!products || products.length === 0) {
                    grid.innerHTML = '<div class="col-span-full text-center py-12 text-gray-500">Products မရှိသေးပါ</div>';
                    return;
                }

                products.forEach(product => {
                    const productCard = createProductCard(product);
                    grid.appendChild(productCard);
                });
            } catch (error) {
                console.error('Error loading products:', error);
                showNotification('Products တင်ခြင်း မအောင်မြင်ပါ', 'error');
            }
        }

        function createProductCard(product) {
            const div = document.createElement('div');
            div.className = 'product-card bg-white rounded-lg shadow-sm overflow-hidden cursor-pointer';
            div.onclick = () => showProductDetail(product.id);
            
            const images = product.images ? (Array.isArray(product.images) ? product.images : JSON.parse(product.images)) : [];
            const mainImage = images.length > 0 ? images[0] : 'https://via.placeholder.com/300x200';
            
            div.innerHTML = `
                <div class="relative">
                    <img src="${mainImage}" alt="${product.name}" class="w-full h-48 object-cover">
                    ${product.sold_out ? '<div class="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center"><span class="text-white font-bold text-xl">SOLD OUT</span></div>' : ''}
                </div>
                <div class="p-4">
                    <h3 class="font-semibold text-lg mb-2 truncate">${product.name}</h3>
                    <p class="text-purple-600 font-bold text-xl">${product.price ? product.price.toLocaleString() : '0'} MMK</p>
                    <p class="text-gray-600 text-sm mt-1">${product.game_type || 'Game'}</p>
                    ${product.sold_out && product.buyer_username ? `
                        <div class="mt-3 pt-3 border-t flex items-center space-x-2">
                            <img src="${product.users?.profile_image || 'https://via.placeholder.com/30'}" alt="Buyer" class="w-6 h-6 rounded-full">
                            <span class="text-sm text-gray-600">Sold to @${product.buyer_username}</span>
                        </div>
                    ` : ''}
                </div>
            `;
            
            return div;
        }

        async function showProductDetail(productId) {
            try {
                const { data: product, error } = await supabase
                    .from('products')
                    .select(`
                        *,
                        users!products_seller_id_fkey (name, username, profile_image)
                    `)
                    .eq('id', productId)
                    .single();

                if (error) throw error;

                const modal = document.getElementById('productModal');
                const content = document.getElementById('productDetailContent');
                
                const images = product.images ? (Array.isArray(product.images) ? product.images : JSON.parse(product.images)) : [];
                const videos = product.videos ? (Array.isArray(product.videos) ? product.videos : JSON.parse(product.videos)) : [];
                
                let mediaHtml = '';
                if (images.length > 0) {
                    mediaHtml += '<div class="grid grid-cols-2 gap-2 mb-4">';
                    images.forEach(img => {
                        mediaHtml += `<img src="${img}" alt="Product" class="w-full h-32 object-cover rounded">`;
                    });
                    mediaHtml += '</div>';
                }
                
                if (videos.length > 0) {
                    videos.forEach(video => {
                        mediaHtml += `<video controls playsinline webkit-playsinline class="w-full mb-4 rounded"><source src="${video}" type="video/mp4"></video>`;
                    });
                }
                
                content.innerHTML = `
                    ${mediaHtml}
                    <h3 class="text-xl font-bold mb-2">${product.name}</h3>
                    <p class="text-2xl font-bold text-purple-600 mb-4">${product.price ? product.price.toLocaleString() : '0'} MMK</p>
                    <div class="space-y-2 mb-4">
                        <p><strong>Game:</strong> ${product.game_type || 'N/A'}</p>
                        <p><strong>Login Platform:</strong> ${product.login_social || 'N/A'}</p>
                        <p><strong>Contact:</strong> ${product.contact_name || 'N/A'}</p>
                        <p><strong>Contact Info:</strong> ${product.contact_address || 'N/A'}</p>
                    </div>
                    <p class="text-gray-600 mb-4">${product.description || ''}</p>
                    <div class="flex items-center space-x-3 mb-4">
                        <img src="${product.users?.profile_image || 'https://via.placeholder.com/40'}" alt="Seller" class="w-10 h-10 rounded-full">
                        <div>
                            <p class="font-semibold">${product.users?.name || 'Unknown'}</p>
                            <p class="text-sm text-gray-500">@${product.users?.username || 'unknown'}</p>
                        </div>
                    </div>
                    ${!product.sold_out && currentUser && currentUser.id !== product.seller_id ? 
                        `<button onclick="buyProduct('${product.id}')" class="w-full btn-gradient text-white py-3 px-6 rounded-lg font-semibold">
                            <i class="fas fa-shopping-cart mr-2"></i>ဝယ်ယူမည်
                        </button>` : 
                        product.sold_out ? '<p class="text-center text-red-500 font-bold">ရောင်းပြီးပါပြီ</p>' : ''
                    }
                `;
                
                modal.style.display = 'flex';
            } catch (error) {
                console.error('Error loading product detail:', error);
                showNotification('Product အသေးစိတ် ရယူခြင်း မအောင်မြင်ပါ', 'error');
            }
        }

        async function buyProduct(productId) {
            if (!currentUser) {
                showNotification('ဝယ်ယူရန် လော့ဂ်အင်ဝင်ပါ', 'error');
                return;
            }

            try {
                // Get product details and seller's payment methods
                const { data: product } = await supabase
                    .from('products')
                    .select('*, users!products_seller_id_fkey(name)')
                    .eq('id', productId)
                    .single();

                const { data: paymentMethods } = await supabase
                    .from('payment_methods')
                    .select('*')
                    .or(`seller_id.eq.${product.seller_id},is_admin_method.eq.true`);

                closeModal('productModal');
                
                const buyModal = document.getElementById('buyModal');
                const buyContent = document.getElementById('buyContent');
                
                let paymentMethodsHtml = '';
                if (paymentMethods && paymentMethods.length > 0) {
                    paymentMethodsHtml = paymentMethods.map(method => `
                        <div class="payment-method p-3 border rounded-lg cursor-pointer hover:bg-gray-50" onclick="selectPaymentMethod('${method.id}')">
                            <div class="flex items-center space-x-3">
                                ${method.icon_url ? `<img src="${method.icon_url}" alt="${method.name}" class="w-8 h-8">` : '<i class="fas fa-credit-card text-2xl"></i>'}
                                <div>
                                    <p class="font-semibold">${method.name}</p>
                                    <p class="text-sm text-gray-600">${method.phone_or_address}</p>
                                </div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    paymentMethodsHtml = '<p class="text-center text-gray-500">Payment နည်းလမ်း မရှိပါ</p>';
                }
                
                buyContent.innerHTML = `
                    <div class="space-y-4">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="font-semibold mb-2">${product.name}</h4>
                            <p class="text-xl font-bold text-purple-600">${product.price ? product.price.toLocaleString() : '0'} MMK</p>
                            <p class="text-sm text-gray-600">Seller: ${product.users?.name}</p>
                        </div>
                        
                        <div>
                            <h4 class="font-semibold mb-3">Payment နည်းလမ်း ရွေးချယ်ပါ:</h4>
                            <div class="space-y-2" id="paymentMethodsList">
                                ${paymentMethodsHtml}
                            </div>
                        </div>
                        
                        <div id="selectedPaymentDetails" style="display: none;" class="bg-blue-50 p-4 rounded-lg">
                            <!-- Selected payment details will show here -->
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Receipt ဓာတ်ပုံ တင်ပါ:</label>
                            <input type="file" id="receiptImages" multiple accept="image/*" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">မှတ်ချက် (စိတ်ကြိုက်):</label>
                            <textarea id="buyerNote" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="သင့်မှတ်ချက်ကို ရေးပါ..."></textarea>
                        </div>
                        
                        <button onclick="submitOrder('${productId}')" class="w-full btn-gradient text-white py-3 px-6 rounded-lg font-semibold" disabled id="submitOrderBtn">
                            <i class="fas fa-check mr-2"></i>မှာယူမည်
                        </button>
                    </div>
                `;
                
                buyModal.style.display = 'flex';
            } catch (error) {
                console.error('Error preparing buy modal:', error);
                showNotification('ဝယ်ယူခြင်း ပြင်ဆင်မှု မအောင်မြင်ပါ', 'error');
            }
        }

        let selectedPaymentMethodId = null;

        function selectPaymentMethod(methodId) {
            selectedPaymentMethodId = methodId;
            
            // Update UI to show selected payment method
            document.querySelectorAll('.payment-method').forEach(el => {
                el.classList.remove('bg-blue-100', 'border-blue-500');
                el.classList.add('border-gray-300');
            });
            
            event.currentTarget.classList.add('bg-blue-100', 'border-blue-500');
            event.currentTarget.classList.remove('border-gray-300');
            
            // Enable submit button
            document.getElementById('submitOrderBtn').disabled = false;
            
            // Show payment details if available
            // You can add QR code display here if needed
        }

        async function submitOrder(productId) {
            if (!selectedPaymentMethodId) {
                showNotification('Payment နည်းလမ်း ရွေးချယ်ပါ', 'error');
                return;
            }

            const receiptFiles = document.getElementById('receiptImages').files;
            const buyerNote = document.getElementById('buyerNote').value;

            try {
                let receiptUrls = [];
                
                // Upload receipt images
                if (receiptFiles.length > 0) {
                    for (let file of receiptFiles) {
                        const url = await uploadToCloudinary(file);
                        receiptUrls.push(url);
                    }
                }

                // Get product details for total amount
                const { data: product } = await supabase
                    .from('products')
                    .select('price, seller_id')
                    .eq('id', productId)
                    .single();

                // Create order
                const { data, error } = await supabase
                    .from('orders')
                    .insert([{
                        product_id: productId,
                        buyer_id: currentUser.id,
                        seller_id: product.seller_id,
                        payment_method_id: selectedPaymentMethodId,
                        receipt_images: receiptUrls,
                        total_amount: product.price,
                        buyer_note: buyerNote,
                        status: 'pending'
                    }])
                    .select();

                if (error) throw error;

                closeModal('buyModal');
                showNotification('မှာယူမှု အောင်မြင်ပါတယ်! Seller က အတည်ပြုမှုကို စောင့်ပါ', 'success');
                
                // Refresh order history
                await loadOrderHistory();
                
            } catch (error) {
                console.error('Error submitting order:', error);
                showNotification('မှာယူမှု မအောင်မြင်ပါ', 'error');
            }
        }

        // Load Order History
        async function loadOrderHistory() {
            if (!currentUser) return;

            try {
                const { data: orders, error } = await supabase
                    .from('orders')
                    .select(`
                        *,
                        products(name, price, images),
                        users!orders_seller_id_fkey(name, username)
                    `)
                    .eq('buyer_id', currentUser.id)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const container = document.getElementById('orderHistory');
                container.innerHTML = '';

                if (!orders || orders.length === 0) {
                    container.innerHTML = '<p class="text-center text-gray-500 py-8">မှာယူမှု မှတ်တမ်း မရှိပါ</p>';
                    return;
                }

                orders.forEach(order => {
                    const orderCard = document.createElement('div');
                    orderCard.className = 'bg-gray-50 p-4 rounded-lg';
                    
                    const statusColor = {
                        'pending': 'text-yellow-600 bg-yellow-100',
                        'approved': 'text-green-600 bg-green-100',
                        'rejected': 'text-red-600 bg-red-100',
                        'completed': 'text-blue-600 bg-blue-100'
                    };
                    
                    const statusText = {
                        'pending': 'စောင့်ဆိုင်း',
                        'approved': 'အတည်ပြုပြီး',
                        'rejected': 'ငြင်းပယ်ခံရ',
                        'completed': 'ပြီးဆုံး'
                    };
                    
                    orderCard.innerHTML = `
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex-1">
                                <h4 class="font-semibold">${order.products?.name || 'Unknown Product'}</h4>
                                <p class="text-purple-600 font-bold">${order.total_amount ? order.total_amount.toLocaleString() : '0'} MMK</p>
                                <p class="text-sm text-gray-600">Seller: ${order.users?.name || 'Unknown'}</p>
                            </div>
                            <span class="px-3 py-1 rounded-full text-xs font-medium ${statusColor[order.status] || 'text-gray-600 bg-gray-100'}">
                                ${statusText[order.status] || order.status}
                            </span>
                        </div>
                        <p class="text-sm text-gray-500">မှာယူသည့်ရက်: ${new Date(order.created_at).toLocaleDateString('my-MM')}</p>
                        ${order.buyer_note ? `<p class="text-sm text-gray-600 mt-2">မှတ်ချက်: ${order.buyer_note}</p>` : ''}
                    `;
                    
                    container.appendChild(orderCard);
                });
            } catch (error) {
                console.error('Error loading order history:', error);
            }
        }

        // Load News
        async function loadNews() {
            try {
                const { data: news, error } = await supabase
                    .from('news')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const container = document.getElementById('newsContainer');
                container.innerHTML = '';

                if (!news || news.length === 0) {
                    container.innerHTML = '<p class="text-center text-gray-500 py-8">သတင်းများ မရှိပါ</p>';
                    return;
                }

                news.forEach(item => {
                    const newsCard = document.createElement('div');
                    newsCard.className = 'bg-white rounded-lg shadow-sm p-6';
                    
                    const mediaFiles = item.media_files ? (Array.isArray(item.media_files) ? item.media_files : JSON.parse(item.media_files)) : [];
                    let mediaHtml = '';
                    
                    if (mediaFiles.length > 0) {
                        mediaHtml = '<div class="grid grid-cols-2 gap-2 mb-4">';
                        mediaFiles.forEach(file => {
                            if (file.includes('.mp4') || file.includes('video')) {
                                mediaHtml += `<video controls playsinline webkit-playsinline class="w-full h-32 object-cover rounded"><source src="${file}" type="video/mp4"></video>`;
                            } else {
                                mediaHtml += `<img src="${file}" alt="News" class="w-full h-32 object-cover rounded">`;
                            }
                        });
                        mediaHtml += '</div>';
                    }
                    
                    const socialLinks = item.social_links ? (typeof item.social_links === 'string' ? JSON.parse(item.social_links) : item.social_links) : {};
                    let socialHtml = '';
                    
                    if (Object.keys(socialLinks).length > 0) {
                        socialHtml = '<div class="flex space-x-3 mt-4">';
                        Object.entries(socialLinks).forEach(([platform, link]) => {
                            const iconClass = {
                                'telegram': 'fab fa-telegram',
                                'facebook': 'fab fa-facebook',
                                'youtube': 'fab fa-youtube',
                                'x': 'fab fa-x-twitter',
                                'tiktok': 'fab fa-tiktok'
                            };
                            socialHtml += `<a href="${link}" target="_blank" class="text-blue-600 hover:text-blue-800">
                                <i class="${iconClass[platform] || 'fas fa-link'}"></i>
                            </a>`;
                        });
                        socialHtml += '</div>';
                    }
                    
                    newsCard.innerHTML = `
                        ${mediaHtml}
                        <h3 class="text-xl font-bold mb-3">${item.title}</h3>
                        <p class="text-gray-700 mb-4">${item.content}</p>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-500">${new Date(item.created_at).toLocaleDateString('my-MM')}</span>
                            ${socialHtml}
                        </div>
                    `;
                    
                    container.appendChild(newsCard);
                });
            } catch (error) {
                console.error('Error loading news:', error);
            }
        }

        // Load KYC Status
        async function loadKYCStatus() {
            if (!currentUser) return;

            try {
                const { data: kycData, error } = await supabase
                    .from('kyc_submissions')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('submitted_at', { ascending: false })
                    .limit(1);

                if (error) throw error;

                const container = document.getElementById('kycStatus');
                
                if (!kycData || kycData.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-8">
                            <p class="text-gray-600 mb-4">KYC အတည်ပြုခြင်း မလုပ်ရသေးပါ</p>
                            <button onclick="showModal('kycModal')" class="btn-gradient text-white px-6 py-2 rounded-lg font-semibold">
                                <i class="fas fa-id-card mr-2"></i>KYC စတင်ရန်
                            </button>
                        </div>
                    `;
                } else {
                    const kyc = kycData[0];
                    const statusText = {
                        'pending': { text: 'စောင့်ဆိုင်း', color: 'text-yellow-600 bg-yellow-100' },
                        'approved': { text: 'အတည်ပြုပြီး', color: 'text-green-600 bg-green-100' },
                        'rejected': { text: 'ငြင်းပယ်ခံရ', color: 'text-red-600 bg-red-100' }
                    };
                    
                    const status = statusText[kyc.status] || { text: kyc.status, color: 'text-gray-600 bg-gray-100' };
                    
                    container.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="font-semibold">KYC Status</p>
                                <span class="px-3 py-1 rounded-full text-sm font-medium ${status.color}">
                                    ${status.text}
                                </span>
                                <p class="text-sm text-gray-500 mt-2">တင်ပြသည့်ရက်: ${new Date(kyc.submitted_at).toLocaleDateString('my-MM')}</p>
                            </div>
                            ${kyc.status === 'rejected' ? `
                                <button onclick="showModal('kycModal')" class="btn-gradient text-white px-4 py-2 rounded-lg font-medium">
                                    <i class="fas fa-redo mr-2"></i>ပြန်လည်တင်ပြရန်
                                </button>
                            ` : ''}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading KYC status:', error);
            }
        }

        // Check Seller Status
        async function checkSellerStatus() {
            if (!currentUser) return;

            if (currentUser.seller_approved) {
                document.getElementById('sellerTab').style.display = 'block';
                await loadMyProducts();
                await loadMyPayments();
                await loadMyOrders();
            }
        }

        // Load Website Logo
        async function loadWebsiteLogo() {
            try {
                const { data: settings, error } = await supabase
                    .from('website_settings')
                    .select('*')
                    .limit(1);

                if (error) throw error;

                if (settings && settings.length > 0 && settings[0].logo_url) {
                    document.getElementById('websiteLogo').innerHTML = `<img src="${settings[0].logo_url}" alt="Logo" class="h-16 mx-auto">`;
                    document.getElementById('dashboardLogo').innerHTML = `<img src="${settings[0].logo_url}" alt="Logo" class="h-8">`;
                }
            } catch (error) {
                console.error('Error loading website logo:', error);
            }
        }

        // Load About Data
        async function loadAboutData() {
            try {
                const { data: aboutLinks, error } = await supabase
                    .from('about_social_links')
                    .select('*');

                if (error) throw error;

                const container = document.getElementById('aboutSection');
                if (!container) return;

                if (!aboutLinks || aboutLinks.length === 0) {
                    container.innerHTML = '<p class="text-center text-gray-500">ဆက်သွယ်ရန် အချက်အလက် မရှိပါ</p>';
                    return;
                }

                let html = '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">';
                aboutLinks.forEach(link => {
                    const iconClass = {
                        'telegram': 'fab fa-telegram text-blue-500',
                        'facebook': 'fab fa-facebook text-blue-600',
                        'wechat': 'fab fa-weixin text-green-500',
                        'youtube': 'fab fa-youtube text-red-500',
                        'telegram_channel': 'fab fa-telegram text-blue-500',
                        'gmail': 'fas fa-envelope text-red-500',
                        'x': 'fab fa-x-twitter text-black',
                        'tiktok': 'fab fa-tiktok text-black'
                    };
                    
                    html += `
                        <a href="${link.link_url.startsWith('http') ? link.link_url : 'mailto:' + link.link_url}" 
                           target="_blank" 
                           class="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                            <i class="${iconClass[link.platform] || 'fas fa-link'} text-xl"></i>
                            <div>
                                <p class="font-medium capitalize">${link.platform.replace('_', ' ')}</p>
                                <p class="text-sm text-gray-600">${link.link_url}</p>
                            </div>
                        </a>
                    `;
                });
                html += '</div>';
                
                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading about data:', error);
            }
        }

        // Seller Functions
        async function loadMyProducts() {
            if (!currentUser) return;

            try {
                const { data: products, error } = await supabase
                    .from('products')
                    .select('*')
                    .eq('seller_id', currentUser.id)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const container = document.getElementById('myProductsList');
                container.innerHTML = '';

                if (!products || products.length === 0) {
                    container.innerHTML = '<div class="col-span-full text-center py-8 text-gray-500">Products မရှိသေးပါ</div>';
                    return;
                }

                products.forEach(product => {
                    const productCard = createMyProductCard(product);
                    container.appendChild(productCard);
                });
            } catch (error) {
                console.error('Error loading my products:', error);
            }
        }

        function createMyProductCard(product) {
            const div = document.createElement('div');
            div.className = 'bg-gray-50 rounded-lg p-4';
            
            const images = product.images ? (Array.isArray(product.images) ? product.images : JSON.parse(product.images)) : [];
            const mainImage = images.length > 0 ? images[0] : 'https://via.placeholder.com/200x150';
            
            div.innerHTML = `
                <img src="${mainImage}" alt="${product.name}" class="w-full h-32 object-cover rounded mb-3">
                <h4 class="font-semibold mb-2">${product.name}</h4>
                <p class="text-purple-600 font-bold mb-2">${product.price ? product.price.toLocaleString() : '0'} MMK</p>
                <div class="flex justify-between items-center">
                    <span class="px-2 py-1 text-xs rounded-full ${product.sold_out ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}">
                        ${product.sold_out ? 'Sold Out' : 'Available'}
                    </span>
                    <button onclick="toggleProductStatus('${product.id}', ${!product.sold_out})" 
                            class="text-sm px-3 py-1 rounded ${product.sold_out ? 'bg-green-500 hover:bg-green-600' : 'bg-red-500 hover:bg-red-600'} text-white">
                        ${product.sold_out ? 'Mark Available' : 'Mark Sold'}
                    </button>
                </div>
            `;
            
            return div;
        }

        async function toggleProductStatus(productId, soldOut) {
            try {
                const { error } = await supabase
                    .from('products')
                    .update({ 
                        sold_out: soldOut,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', productId);

                if (error) throw error;

                await loadMyProducts();
                await loadProducts(); // Refresh main products grid
                showNotification('Product status အပ်ဒိတ်လုပ်ပြီးပါပြီ', 'success');
            } catch (error) {
                console.error('Error updating product status:', error);
                showNotification('Product status အပ်ဒိတ်လုပ်ခြင်း မအောင်မြင်ပါ', 'error');
            }
        }

        async function loadMyPayments() {
            if (!currentUser) return;

            try {
                const { data: payments, error } = await supabase
                    .from('payment_methods')
                    .select('*')
                    .eq('seller_id', currentUser.id)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const container = document.getElementById('myPaymentsList');
                container.innerHTML = '';

                if (!payments || payments.length === 0) {
                    container.innerHTML = '<p class="text-center text-gray-500 py-4">Payment နည်းလမ်း မရှိသေးပါ</p>';
                    return;
                }

                payments.forEach(payment => {
                    const paymentCard = document.createElement('div');
                    paymentCard.className = 'flex items-center justify-between p-4 bg-gray-50 rounded-lg';
                    
                    paymentCard.innerHTML = `
                        <div class="flex items-center space-x-3">
                            ${payment.icon_url ? `<img src="${payment.icon_url}" alt="${payment.name}" class="w-8 h-8">` : '<i class="fas fa-credit-card text-2xl"></i>'}
                            <div>
                                <p class="font-semibold">${payment.name}</p>
                                <p class="text-sm text-gray-600">${payment.phone_or_address}</p>
                            </div>
                        </div>
                        <button onclick="deletePaymentMethod('${payment.id}')" class="text-red-500 hover:text-red-700">
                            <i class="fas fa-trash"></i>
                        </button>
                    `;
                    
                    container.appendChild(paymentCard);
                });
            } catch (error) {
                console.error('Error loading my payments:', error);
            }
        }

        async function loadMyOrders() {
            if (!currentUser) return;

            try {
                const { data: orders, error } = await supabase
                    .from('orders')
                    .select(`
                        *,
                        products(name, price),
                        users!orders_buyer_id_fkey(name, username)
                    `)
                    .eq('seller_id', currentUser.id)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const container = document.getElementById('myOrdersList');
                container.innerHTML = '';

                if (!orders || orders.length === 0) {
                    container.innerHTML = '<p class="text-center text-gray-500 py-4">Orders မရှိသေးပါ</p>';
                    return;
                }

                orders.forEach(order => {
                    const orderCard = document.createElement('div');
                    orderCard.className = 'bg-gray-50 p-4 rounded-lg';
                    
                    const statusColor = {
                        'pending': 'text-yellow-600 bg-yellow-100',
                        'approved': 'text-green-600 bg-green-100',
                        'rejected': 'text-red-600 bg-red-100',
                        'completed': 'text-blue-600 bg-blue-100'
                    };
                    
                    orderCard.innerHTML = `
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h4 class="font-semibold">${order.products?.name || 'Unknown Product'}</h4>
                                <p class="text-purple-600 font-bold">${order.total_amount ? order.total_amount.toLocaleString() : '0'} MMK</p>
                                <p class="text-sm text-gray-600">Buyer: ${order.users?.name || 'Unknown'} (@${order.users?.username || 'unknown'})</p>
                            </div>
                            <span class="px-3 py-1 rounded-full text-xs font-medium ${statusColor[order.status] || 'text-gray-600 bg-gray-100'}">
                                ${order.status}
                            </span>
                        </div>
                        ${order.buyer_note ? `<p class="text-sm text-gray-600 mb-3">မှတ်ချက်: ${order.buyer_note}</p>` : ''}
                        ${order.receipt_images && order.receipt_images.length > 0 ? `
                            <div class="mb-3">
                                <p class="text-sm font-medium mb-2">Receipt ဓာတ်ပုံများ:</p>
                                <div class="flex space-x-2">
                                    ${order.receipt_images.map(img => `<img src="${img}" alt="Receipt" class="w-16 h-16 object-cover rounded">`).join('')}
                                </div>
                            </div>
                        ` : ''}
                        ${order.status === 'pending' ? `
                            <div class="flex space-x-2">
                                <button onclick="updateOrderStatus('${order.id}', 'approved')" class="flex-1 bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded text-sm">
                                    အတည်ပြုမည်
                                </button>
                                <button onclick="updateOrderStatus('${order.id}', 'rejected')" class="flex-1 bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded text-sm">
                                    ငြင်းပယ်မည်
                                </button>
                            </div>
                        ` : ''}
                    `;
                    
                    container.appendChild(orderCard);
                });
            } catch (error) {
                console.error('Error loading my orders:', error);
            }
        }

        async function updateOrderStatus(orderId, status) {
            try {
                const { error } = await supabase
                    .from('orders')
                    .update({ 
                        status: status,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', orderId);

                if (error) throw error;

                // If approved, optionally mark product as sold
                if (status === 'approved') {
                    // Get order details to update product
                    const { data: order } = await supabase
                        .from('orders')
                        .select('product_id, buyer_id, users!orders_buyer_id_fkey(username)')
                        .eq('id', orderId)
                        .single();

                    if (order) {
                        await supabase
                            .from('products')
                            .update({ 
                                sold_out: true,
                                sold_to_user_id: order.buyer_id,
                                buyer_username: order.users?.username,
                                updated_at: new Date().toISOString()
                            })
                            .eq('id', order.product_id);
                    }
                }

                await loadMyOrders();
                await loadProducts(); // Refresh main products grid
                showNotification(`Order ${status === 'approved' ? 'အတည်ပြုပြီး' : 'ငြင်းပယ်ပြီး'}ပါပြီ`, 'success');
            } catch (error) {
                console.error('Error updating order status:', error);
                showNotification('Order status အပ်ဒိတ်လုပ်ခြင်း မအောင်မြင်ပါ', 'error');
            }
        }

        // Seller section navigation
        function showSellerSection(sectionName) {
            // Hide all seller sections
            document.querySelectorAll('.seller-section').forEach(section => {
                section.style.display = 'none';
            });
            
            // Show selected section
            document.getElementById('seller' + sectionName.charAt(0).toUpperCase() + sectionName.slice(1).replace('-', '')).style.display = 'block';
            
            // Update button styles
            document.querySelectorAll('.seller-nav-btn').forEach(btn => {
                btn.classList.remove('bg-purple-600', 'text-white');
                btn.classList.add('bg-gray-200', 'text-gray-700');
            });
            
            event.target.classList.remove('bg-gray-200', 'text-gray-700');
            event.target.classList.add('bg-purple-600', 'text-white');
        }

        // Form handlers
        document.addEventListener('DOMContentLoaded', function() {
            // Add Product Form
            document.getElementById('addProductForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                await handleAddProduct();
            });

            // Add Payment Form
            document.getElementById('addPaymentForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                await handleAddPayment();
            });

            // KYC Form
            document.getElementById('kycForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                await handleKYCSubmission();
            });

            // KYC ID Type change
            document.getElementById('kycIdType').addEventListener('change', function() {
                const nrcSection = document.getElementById('nrcSection');
                if (this.value === 'NRC') {
                    nrcSection.style.display = 'block';
                } else {
                    nrcSection.style.display = 'none';
                }
            });
        });

        async function handleAddProduct() {
            const name = document.getElementById('productName').value;
            const description = document.getElementById('productDescription').value;
            const price = parseFloat(document.getElementById('productPrice').value);
            const game = document.getElementById('productGame').value;
            const social = document.getElementById('productSocial').value;
            const contactName = document.getElementById('contactSocialName').value;
            const contactLink = document.getElementById('contactSocialLink').value;
            const files = document.getElementById('productFiles').files;

            try {
                let imageUrls = [];
                let videoUrls = [];

                // Upload files
                for (let file of files) {
                    const url = await uploadToCloudinary(file);
                    if (file.type.startsWith('image/')) {
                        imageUrls.push(url);
                    } else if (file.type.startsWith('video/')) {
                        videoUrls.push(url);
                    }
                }

                // Upload contact icon if provided
                let contactIconUrl = null;
                const contactIconFile = document.getElementById('contactSocialIcon')?.files[0];
                if (contactIconFile) {
                    contactIconUrl = await uploadToCloudinary(contactIconFile);
                }

                const { data, error } = await supabase
                    .from('products')
                    .insert([{
                        name: name,
                        description: description,
                        price: price,
                        game_type: game,
                        login_social: social,
                        contact_social: social,
                        contact_name: contactName,
                        contact_address: contactLink,
                        contact_icon: contactIconUrl,
                        images: imageUrls,
                        videos: videoUrls,
                        seller_id: currentUser.id,
                        status: 'active'
                    }])
                    .select();

                if (error) throw error;

                // Reset form
                document.getElementById('addProductForm').reset();
                document.getElementById('productFilePreview').innerHTML = '';
                currentProductFiles = [];

                await loadMyProducts();
                await loadProducts();
                showNotification('Product အောင်မြင်စွာ ထည့်ပါပြီ', 'success');
                showSellerSection('products');
            } catch (error) {
                console.error('Error adding product:', error);
                showNotification('Product ထည့်ခြင်း မအောင်မြင်ပါ', 'error');
            }
        }

        async function handleAddPayment() {
            const name = document.getElementById('paymentName').value;
            const description = document.getElementById('paymentDescription').value;
            const address = document.getElementById('paymentAddress').value;
            const iconFile = document.getElementById('paymentIcon').files[0];
            const qrFile = document.getElementById('paymentQr').files[0];

            try {
                let iconUrl = null;
                let qrUrl = null;

                if (iconFile) {
                    iconUrl = await uploadToCloudinary(iconFile);
                }

                if (qrFile) {
                    qrUrl = await uploadToCloudinary(qrFile);
                }

                const { data, error } = await supabase
                    .from('payment_methods')
                    .insert([{
                        name: name,
                        description: description,
                        phone_or_address: address,
                        icon_url: iconUrl,
                        qr_code_url: qrUrl,
                        seller_id: currentUser.id
                    }])
                    .select();

                if (error) throw error;

                closeModal('addPaymentModal');
                document.getElementById('addPaymentForm').reset();
                await loadMyPayments();
                showNotification('Payment နည်းလမ်း အောင်မြင်စွာ ထည့်ပါပြီ', 'success');
            } catch (error) {
                console.error('Error adding payment method:', error);
                showNotification('Payment နည်းလမ်း ထည့်ခြင်း မအောင်မြင်ပါ', 'error');
            }
        }

        async function deletePaymentMethod(paymentId) {
            if (!confirm('ဤ Payment နည်းလမ်းကို ဖျက်ရန် သေချာပါသလား?')) return;

            try {
                const { error } = await supabase
                    .from('payment_methods')
                    .delete()
                    .eq('id', paymentId);

                if (error) throw error;

                await loadMyPayments();
                showNotification('Payment နည်းလမ်း ဖျက်ပြီးပါပြီ', 'success');
            } catch (error) {
                console.error('Error deleting payment method:', error);
                showNotification('Payment နည်းလမ်း ဖျက်ခြင်း မအောင်မြင်ပါ', 'error');
            }
        }

        async function handleKYCSubmission() {
            const name = document.getElementById('kycName').value;
            const birthdate = document.getElementById('kycBirthdate').value;
            const phone = document.getElementById('kycPhone').value;
            const address = document.getElementById('kycAddress').value;
            const idType = document.getElementById('kycIdType').value;
            const nrcFrontFile = document.getElementById('nrcFront').files[0];
            const nrcBackFile = document.getElementById('nrcBack').files[0];

            try {
                let frontImageUrl = null;
                let backImageUrl = null;

                if (nrcFrontFile) {
                    frontImageUrl = await uploadToCloudinary(nrcFrontFile);
                }

                if (nrcBackFile) {
                    backImageUrl = await uploadToCloudinary(nrcBackFile);
                }

                const { data, error } = await supabase
                    .from('kyc_submissions')
                    .insert([{
                        user_id: currentUser.id,
                        full_name: name,
                        birth_date: birthdate,
                        phone_number: phone,
                        address: address,
                        id_type: idType,
                        id_front_image: frontImageUrl,
                        id_back_image: backImageUrl,
                        face_scan_video: faceScanData,
                        status: 'pending'
                    }])
                    .select();

                if (error) throw error;

                closeModal('kycModal');
                document.getElementById('kycForm').reset();
                await loadKYCStatus();
                showNotification('KYC အတည်ပြုခြင်း အောင်မြင်စွာ တင်ပြပါပြီ', 'success');
            } catch (error) {
                console.error('Error submitting KYC:', error);
                showNotification('KYC တင်ပြခြင်း မအောင်မြင်ပါ', 'error');
            }
        }

        // File handling
        function handleProductFiles(files) {
            currentProductFiles = Array.from(files);
            const preview = document.getElementById('productFilePreview');
            preview.innerHTML = '';

            currentProductFiles.forEach((file, index) => {
                const div = document.createElement('div');
                div.className = 'relative';

                if (file.type.startsWith('image/')) {
                    const img = document.createElement('img');
                    img.src = URL.createObjectURL(file);
                    img.className = 'preview-image';
                    div.appendChild(img);
                } else if (file.type.startsWith('video/')) {
                    const video = document.createElement('video');
                    video.src = URL.createObjectURL(file);
                    video.className = 'preview-image';
                    video.controls = true;
                    div.appendChild(video);
                }

                const deleteBtn = document.createElement('div');
                deleteBtn.className = 'delete-btn';
                deleteBtn.innerHTML = '×';
                deleteBtn.onclick = () => removeProductFile(index);
                div.appendChild(deleteBtn);

                preview.appendChild(div);
            });
        }

        function removeProductFile(index) {
            currentProductFiles.splice(index, 1);
            
            // Update file input
            const dt = new DataTransfer();
            currentProductFiles.forEach(file => dt.items.add(file));
            document.getElementById('productFiles').files = dt.files;
            
            handleProductFiles(currentProductFiles);
        }

        // Face scan functionality
        function startFaceScan() {
            document.getElementById('faceScanSection').style.display = 'block';
            
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(mediaStream => {
                    stream = mediaStream;
                    const video = document.getElementById('faceScanVideo');
                    video.srcObject = stream;
                    
                    // Simulate face scan steps
                    simulateFaceScan();
                })
                .catch(error => {
                    console.error('Error accessing camera:', error);
                    showNotification('ကင်မရာကို ဖွင့်ခြင်း မအောင်မြင်ပါ', 'error');
                });
        }

        function simulateFaceScan() {
            const steps = [
                { id: 'blinkStep', text: 'မျက်လုံးမှိတ်ဖွင့်ပါ ✓', delay: 2000 },
                { id: 'leftStep', text: 'ဘယ်ဘက်လှည့်ပါ ✓', delay: 2000 },
                { id: 'rightStep', text: 'ညာဘက်လှည့်ပါ ✓', delay: 2000 },
                { id: 'mouthStep', text: 'ပါးစပ်ဖွင့်ပါ ✓', delay: 2000 }
            ];
            
            let currentStep = 0;
            
            function processStep() {
                if (currentStep < steps.length) {
                    const step = steps[currentStep];
                    document.getElementById(step.id).innerHTML = step.text;
                    document.getElementById(step.id).classList.add('text-green-600');
                    
                    setTimeout(() => {
                        currentStep++;
                        processStep();
                    }, step.delay);
                } else {
                    // Face scan completed
                    document.getElementById('scanInstruction').textContent = 'မျက်နှာစကန်ဖတ်ခြင်း ပြီးဆုံးပါပြီ ✓';
                    document.getElementById('scanInstruction').classList.add('text-green-600');
                    
                    // Stop camera
                    if (stream) {
                        stream.getTracks().forEach(track => track.stop());
                    }
                    
                    // Enable submit button
                    document.getElementById('submitKyc').disabled = false;
                    
                    // Set face scan data (in real implementation, you'd capture actual video data)
                    faceScanData = 'face_scan_completed_' + Date.now();
                }
            }
            
            processStep();
        }

        // Profile functions
        function changeProfileImage() {
            showModal('profileImageModal');
        }

        async function uploadProfileImage() {
            const file = document.getElementById('profileImageFile').files[0];
            if (!file) {
                showNotification('ဓာတ်ပုံ ရွေးချယ်ပါ', 'error');
                return;
            }

            try {
                const imageUrl = await uploadToCloudinary(file);
                
                const { error } = await supabase
                    .from('users')
                    .update({ profile_image: imageUrl })
                    .eq('id', currentUser.id);

                if (error) throw error;

                currentUser.profile_image = imageUrl;
                document.getElementById('profileImage').src = imageUrl;
                document.getElementById('userAvatar').src = imageUrl;
                
                closeModal('profileImageModal');
                showNotification('Profile ဓာတ်ပုံ အပ်ဒိတ်လုပ်ပြီးပါပြီ', 'success');
            } catch (error) {
                console.error('Error uploading profile image:', error);
                showNotification('Profile ဓာတ်ပုံ အပ်လုပ်ဒေါ့လုပ်ခြင်း မအောင်မြင်ပါ', 'error');
            }
        }

        async function updateProfile() {
            const name = document.getElementById('editName').value;
            const email = document.getElementById('editEmail').value; // Fixed: using email consistently
            const username = document.getElementById('editUsername').value;
            const password = document.getElementById('editPassword').value;

            try {
                const updateData = {
                    name: name,
                    email: email, // Fixed: using email consistently
                    username: username,
                    updated_at: new Date().toISOString()
                };

                if (password) {
                    updateData.password = password;
                }

                const { error } = await supabase
                    .from('users')
                    .update(updateData)
                    .eq('id', currentUser.id);

                if (error) throw error;

                // Update current user data
                currentUser.name = name;
                currentUser.email = email; // Fixed: using email consistently
                currentUser.username = username;
                if (password) currentUser.password = password;

                // Update UI
                document.getElementById('userDisplayName').textContent = name;
                document.getElementById('userDisplayEmail').textContent = email; // Fixed: using email consistently
                document.getElementById('profileName').textContent = name;
                document.getElementById('profileEmail').textContent = email; // Fixed: using email consistently
                document.getElementById('profileUsername').textContent = username;

                showNotification('Profile အပ်ဒိတ်လုပ်ပြီးပါပြီ', 'success');
            } catch (error) {
                console.error('Error updating profile:', error);
                showNotification('Profile အပ်ဒိတ်လုပ်ခြင်း မအောင်မြင်ပါ', 'error');
            }
        }

        // Modal functions
        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function showAddPaymentModal() {
            showModal('addPaymentModal');
        }

        // User menu toggle
        function toggleUserMenu() {
            const menu = document.getElementById('userMenu');
            menu.classList.toggle('hidden');
        }

        // Click outside to close user menu
        document.addEventListener('click', function(event) {
            const menu = document.getElementById('userMenu');
            const avatar = document.getElementById('userAvatar');
            
            if (!menu.contains(event.target) && !avatar.contains(event.target)) {
                menu.classList.add('hidden');
            }
        });

        // Notification function
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div class="flex items-center">
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'} mr-2"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }
    </script>
</body>
</html>
